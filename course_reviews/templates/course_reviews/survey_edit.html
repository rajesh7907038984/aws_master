{% extends 'base.html' %}
{% load static %}

{% block title %}Edit Survey - {{ survey.title }}{% endblock %}

{% block extra_css %}
<style>
    /* Enhanced Survey Edit Page Styling - Matching Quiz Form Style */
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-label {
        display: block;
        font-weight: 500;
        font-size: 0.875rem;
        line-height: 1.25rem;
        color: #374151;
        margin-bottom: 0.5rem;
    }

    .form-control, .form-select {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #E5E7EB;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        color: #374151;
        background-color: white;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    
    .form-control:focus, .form-select:focus {
        outline: none;
        border-color: #2563EB;
        box-shadow: 0 0 0 1px #2563EB;
    }
    
    .form-error {
        margin-top: 0.25rem;
        font-size: 0.875rem;
        color: #dc2626;
        font-weight: 500;
        display: block;
    }
    
    .field-error {
        border-color: #dc2626 !important;
        box-shadow: 0 0 0 1px #dc2626;
    }
    
    .form-help {
        margin-top: 0.25rem;
        font-size: 0.75rem;
        color: #6b7280;
    }
    
    .required-field::after {
        content: "*";
        color: #dc2626;
        margin-left: 0.25rem;
    }
    
    .formset-row {
        background: #F9FAFB;
        border: 1px solid #E5E7EB;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1rem;
        transition: all 0.2s ease;
    }
    
    .formset-row:hover {
        background: #F3F4F6;
        border-color: #D1D5DB;
    }
    
    .field-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid #E5E7EB;
    }
    
    .field-number {
        background: #6B7280;
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 0.375rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.875rem;
    }
    
    .field-type-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.625rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 500;
        background: #E5E7EB;
        color: #374151;
    }
    
    .delete-field-btn {
        background: #FEE2E2;
        color: #991B1B;
        border: 1px solid #FCA5A5;
        border-radius: 0.375rem;
        padding: 0.5rem 0.75rem;
        font-size: 0.75rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .delete-field-btn:hover {
        background: #FCA5A5;
        color: #7F1D1D;
    }
    
    .delete-checkbox {
        display: none;
    }
    
    .required-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        background: #DBEAFE;
        color: #1E3A8A;
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .status-toggle {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .status-toggle input {
        width: auto;
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem;
        background-color: #F9FAFB;
        border: 1px solid #E5E7EB;
        border-radius: 0.5rem;
    }
    
    .empty-state i {
        font-size: 3rem;
        color: #9CA3AF;
        margin-bottom: 1rem;
    }
    
    .empty-state h3 {
        font-size: 1.125rem;
        font-weight: 500;
        color: #374151;
        margin-bottom: 0.5rem;
    }
    
    .empty-state p {
        color: #6B7280;
        font-size: 0.875rem;
    }
    
    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.125rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .status-badge.active {
        background-color: #DEF7EC;
        color: #03543F;
    }

    .status-badge.inactive {
        background-color: #FDE8E8;
        color: #9B1C1C;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Breadcrumbs -->
    {% include 'components/breadcrumb.html' with breadcrumbs=breadcrumbs %}
    
    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
        <!-- Header -->
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-semibold text-gray-900">Edit Survey: {{ survey.title }}</h1>
                    <p class="mt-1 text-sm text-gray-600">Update survey details and fields</p>
                </div>
                <a href="{% url 'course_reviews:survey_preview' survey.id %}" 
                   class="inline-flex items-center px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                    <svg class="-ml-1 mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                    </svg>
                    Preview
                </a>
            </div>
        </div>

        <!-- Form -->
        <form method="post" class="divide-y divide-gray-200" id="surveyForm">
            {% csrf_token %}
            
            {% if form.non_field_errors %}
            <div class="px-6 py-4 bg-red-50 border-l-4 border-red-500">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-red-500" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-red-800">Form Validation Errors</h3>
                        <div class="mt-2 text-sm text-red-700">
                            {% for error in form.non_field_errors %}
                                <p class="mb-1">{{ error }}</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="px-6 py-4 space-y-6">
                <!-- Survey Details Section -->
                <div>
                    <h2 class="text-lg font-medium text-gray-900 mb-4">Survey Details</h2>
                    
                    <!-- Title -->
                    <div class="form-group">
                        <label for="{{ form.title.id_for_label }}" class="form-label">
                            Survey Title <span class="text-red-500">*</span>
                        </label>
                        {{ form.title }}
                        {% if form.title.errors %}
                        <p class="form-error">{{ form.title.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <!-- Description -->
                    <div class="form-group">
                        <label for="{{ form.description.id_for_label }}" class="form-label">
                            Description
                        </label>
                        {{ form.description }}
                        {% if form.description.errors %}
                        <p class="form-error">{{ form.description.errors.0 }}</p>
                        {% endif %}
                        <p class="form-help">Optional description for your survey</p>
                    </div>

                    <!-- Status -->
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <div class="status-toggle">
                            {{ form.is_active }}
                            <span>Active</span>
                        </div>
                        <p class="form-help">Active surveys are visible to students and can be submitted.</p>
                    </div>
                </div>

                <!-- Survey Fields Section -->
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h2 class="text-lg font-medium text-gray-900">Survey Fields</h2>
                            <p class="text-sm text-gray-600">{{ formset.total_form_count }} field{{ formset.total_form_count|pluralize }} configured</p>
                        </div>
                        <div class="flex gap-2">
                            <button type="button" class="inline-flex items-center px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50" onclick="addNewField()">
                                <svg class="-ml-1 mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                </svg>
                                Add New Field
                            </button>
                        </div>
                    </div>

                    {{ formset.management_form }}
                    
                    {% if formset.non_form_errors %}
                        <div class="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded mb-4">
                            {{ formset.non_form_errors }}
                        </div>
                    {% endif %}

                    <div id="formset-container">
                        {% for form in formset %}
                        <div class="formset-row" data-field-index="{{ forloop.counter }}">
                            {{ form.id }}
                            
                            <!-- Field Header -->
                            <div class="field-header">
                                <div class="flex items-center gap-3">
                                    <div class="field-number">{{ forloop.counter }}</div>
                                    <div>
                                        <span class="field-type-badge" data-field-type="{{ form.field_type.value }}">
                                            <span class="field-type-text">{{ form.field_type.value|default:"text" }}</span>
                                        </span>
                                        {% if form.is_required.value %}
                                        <span class="required-badge ml-2">
                                            Required
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                {% if formset.can_delete %}
                                <div class="field-actions">
                                    <label class="delete-field-btn" onclick="toggleDelete(this)">
                                        Remove
                                    </label>
                                    <div class="delete-checkbox">
                                        {{ form.DELETE }}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Field Content -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div class="form-group">
                                    <label class="form-label">Question/Label <span class="text-red-500">*</span></label>
                                    {{ form.label }}
                                    {% if form.label.errors %}
                                        <p class="form-error">{{ form.label.errors.0 }}</p>
                                    {% endif %}
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Field Type <span class="text-red-500">*</span></label>
                                    {{ form.field_type }}
                                    {% if form.field_type.errors %}
                                        <p class="form-error">{{ form.field_type.errors.0 }}</p>
                                    {% endif %}
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Placeholder</label>
                                    {{ form.placeholder }}
                                    {% if form.placeholder.errors %}
                                        <p class="form-error">{{ form.placeholder.errors.0 }}</p>
                                    {% endif %}
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Help Text</label>
                                    {{ form.help_text }}
                                    {% if form.help_text.errors %}
                                        <p class="form-error">{{ form.help_text.errors.0 }}</p>
                                    {% endif %}
                                </div>
                                
                                <div class="form-group max-rating-field">
                                    <label class="form-label">Max Rating</label>
                                    {{ form.max_rating }}
                                    {% if form.max_rating.errors %}
                                        <p class="form-error">{{ form.max_rating.errors.0 }}</p>
                                    {% endif %}
                                    <p class="form-help">Only for rating fields (1-5 stars)</p>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Order</label>
                                    {{ form.order }}
                                    {% if form.order.errors %}
                                        <p class="form-error">{{ form.order.errors.0 }}</p>
                                    {% endif %}
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Required</label>
                                    <div class="flex items-center">
                                        {{ form.is_required }}
                                        <label class="ml-2 text-sm text-gray-700">Yes</label>
                                    </div>
                                    {% if form.is_required.errors %}
                                        <p class="form-error">{{ form.is_required.errors.0 }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="empty-state">
                            <i class="fas fa-question-circle"></i>
                            <h3>No fields added yet</h3>
                            <p>Add your first question to start building your survey.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="px-6 py-4 bg-gray-50 flex justify-end space-x-3">
                <a href="{% url 'course_reviews:survey_list' %}" 
                   class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Cancel
                </a>
                <button type="submit" 
                        class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <span id="submitButtonText">Save Changes</span>
                    <span id="submitButtonLoading" style="display: none;">
                        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Saving...
                    </span>
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Enhanced Survey Edit Page JavaScript
    document.addEventListener('DOMContentLoaded', function() {
        
        
        // Function to toggle delete checkbox
        window.toggleDelete = function(button) {
            const formsetRow = button.closest('.formset-row');
            const deleteCheckbox = formsetRow.querySelector('[name*="DELETE"]');
            
            if (deleteCheckbox) {
                deleteCheckbox.checked = !deleteCheckbox.checked;
                
                if (deleteCheckbox.checked) {
                    formsetRow.style.opacity = '0.5';
                    formsetRow.style.background = '#FEE2E2';
                    button.textContent = 'Undo';
                    button.style.background = '#FCA5A5';
                } else {
                    formsetRow.style.opacity = '1';
                    formsetRow.style.background = '#F9FAFB';
                    button.textContent = 'Remove';
                    button.style.background = '#FEE2E2';
                }
            }
        };
        
        // Update field type text dynamically and show/hide Max Rating field
        const fieldTypeSelects = document.querySelectorAll('[name*="field_type"]');
        fieldTypeSelects.forEach(function(select) {
            const row = select.closest('.formset-row');
            const fieldTypeText = row ? row.querySelector('.field-type-text') : null;
            const maxRatingField = row ? row.querySelector('.max-rating-field') : null;
            
            function updateFieldType() {
                if (fieldTypeText) {
                    fieldTypeText.textContent = select.value || 'text';
                }
                
                // Show/hide Max Rating field based on field type
                if (maxRatingField) {
                    if (select.value === 'rating') {
                        maxRatingField.style.display = 'block';
                    } else {
                        maxRatingField.style.display = 'none';
                    }
                }
            }
            
            updateFieldType();
            select.addEventListener('change', updateFieldType);
        });
        
        // Update required badge dynamically
        const requiredCheckboxes = document.querySelectorAll('[name*="is_required"]');
        requiredCheckboxes.forEach(function(checkbox) {
            checkbox.addEventListener('change', function() {
                const row = checkbox.closest('.formset-row');
                const header = row ? row.querySelector('.field-header > div') : null;
                
                if (header) {
                    let requiredBadge = header.querySelector('.required-badge');
                    
                    if (checkbox.checked && !requiredBadge) {
                        requiredBadge = document.createElement('span');
                        requiredBadge.className = 'required-badge ml-2';
                        requiredBadge.textContent = 'Required';
                        header.appendChild(requiredBadge);
                    } else if (!checkbox.checked && requiredBadge) {
                        requiredBadge.remove();
                    }
                }
            });
        });
        
        
        // Add new field functionality
        window.addNewField = function() {
            const totalFormsInput = document.querySelector('input[name$="TOTAL_FORMS"]');
            if (!totalFormsInput) return;
            
            const currentTotal = parseInt(totalFormsInput.value);
            const newIndex = currentTotal;
            
            // Create new form HTML
            const container = document.getElementById('formset-container');
            const emptyForm = container.querySelector('.formset-row');
            
            if (!emptyForm) {
                // If no existing forms, create a basic structure
                const newForm = document.createElement('div');
                newForm.className = 'formset-row';
                newForm.setAttribute('data-field-index', newIndex + 1);
                newForm.innerHTML = `
                    <div class="field-header">
                        <div class="flex items-center gap-3">
                            <div class="field-number">${newIndex + 1}</div>
                            <div>
                                <span class="field-type-badge">
                                    <span class="field-type-text">text</span>
                                </span>
                            </div>
                        </div>
                        <div class="field-actions">
                            <label class="delete-field-btn" onclick="toggleDelete(this)">Remove</label>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <p class="text-sm text-gray-600 col-span-full">Please save the form to add more details to this field.</p>
                    </div>
                `;
                container.appendChild(newForm);
            } else {
                // Clone existing form structure
                const lastForm = container.querySelector('.formset-row:last-child');
                if (lastForm) {
                    const newForm = lastForm.cloneNode(true);
                    newForm.setAttribute('data-field-index', newIndex + 1);
                    
                    // Update field number
                    const fieldNumber = newForm.querySelector('.field-number');
                    if (fieldNumber) fieldNumber.textContent = newIndex + 1;
                    
                    // Clear ALL input values for the new field
                    const inputs = newForm.querySelectorAll('input:not([type="hidden"]), textarea, select');
                    inputs.forEach(input => {
                        if (input.type === 'checkbox') {
                            input.checked = false;
                        } else {
                            input.value = '';
                        }
                    });
                    
                    // Update input name attributes to use the new index
                    const allInputs = newForm.querySelectorAll('input, textarea, select');
                    allInputs.forEach(input => {
                        if (input.name) {
                            // Replace the old index with new index in the name attribute
                            input.name = input.name.replace(/fields-\d+/, `fields-${newIndex}`);
                        }
                        if (input.id) {
                            // Replace the old index with new index in the id attribute
                            input.id = input.id.replace(/fields-\d+/, `fields-${newIndex}`);
                        }
                    });
                    
                    // Update label 'for' attributes
                    const labels = newForm.querySelectorAll('label[for]');
                    labels.forEach(label => {
                        if (label.getAttribute('for')) {
                            label.setAttribute('for', label.getAttribute('for').replace(/fields-\d+/, `fields-${newIndex}`));
                        }
                    });
                    
                    // Auto-fill the Order field with next sequential number
                    const orderInput = newForm.querySelector('[name*="order"]');
                    if (orderInput) {
                        // Find the highest order value from all existing fields
                        let maxOrder = 0;
                        const allOrderInputs = container.querySelectorAll('[name*="order"]');
                        allOrderInputs.forEach(input => {
                            const orderValue = parseInt(input.value) || 0;
                            if (orderValue > maxOrder) {
                                maxOrder = orderValue;
                            }
                        });
                        // Set the new field's order to maxOrder + 1
                        orderInput.value = maxOrder + 1;
                    }
                    
                    container.appendChild(newForm);
                    
                    // Set up Max Rating field visibility for the new form
                    const newFieldTypeSelect = newForm.querySelector('[name*="field_type"]');
                    const newMaxRatingField = newForm.querySelector('.max-rating-field');
                    
                    if (newFieldTypeSelect && newMaxRatingField) {
                        // Hide by default (since default type is 'text')
                        newMaxRatingField.style.display = 'none';
                        
                        // Add event listener to show/hide based on selection
                        newFieldTypeSelect.addEventListener('change', function() {
                            if (this.value === 'rating') {
                                newMaxRatingField.style.display = 'block';
                            } else {
                                newMaxRatingField.style.display = 'none';
                            }
                        });
                    }
                }
            }
            
            // Update TOTAL_FORMS count
            totalFormsInput.value = newIndex + 1;
            
            // Update field count display
            const fieldCountText = document.querySelector('.text-sm.text-gray-600');
            if (fieldCountText) {
                const newCount = newIndex + 1;
                fieldCountText.textContent = `${newCount} field${newCount !== 1 ? 's' : ''} configured`;
            }
            
            // Scroll to new field
            setTimeout(() => {
                const newField = container.querySelector('.formset-row:last-child');
                if (newField) {
                    newField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
        };
        
        // Form submission handling
        const form = document.getElementById('surveyForm');
        if (form) {
            form.addEventListener('submit', function() {
                const submitButton = this.querySelector('button[type="submit"]');
                const submitText = document.getElementById('submitButtonText');
                const submitLoading = document.getElementById('submitButtonLoading');
                
                if (submitText && submitLoading) {
                    submitText.style.display = 'none';
                    submitLoading.style.display = 'inline';
                }
            });
        }
    });
</script>
{% endblock %}
