{% extends 'base.html' %}
{% load static %}

{% block title %}Edit Survey - {{ survey.title }}{% endblock %}

{% block extra_css %}
<style>
    /* Simple Survey Edit Page Styling */
    .form-label {
        font-weight: 500;
        color: #374151;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
    }
    
    .form-control, .form-select {
        border: 1px solid #E5E7EB;
        border-radius: 6px;
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #9CA3AF;
        outline: none;
        box-shadow: none;
    }
    
    .formset-row {
        background: #F9FAFB;
        border: 1px solid #E5E7EB;
        border-radius: 6px;
        padding: 1.25rem;
        margin-bottom: 1rem;
    }
    
    .formset-row:hover {
        background: #F3F4F6;
    }
    
    .field-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid #E5E7EB;
    }
    
    .field-number {
        background: #6B7280;
        color: white;
        width: 28px;
        height: 28px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 500;
        font-size: 0.875rem;
    }
    
    .field-type-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.625rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
        background: #E5E7EB;
        color: #374151;
    }
    
    .delete-field-btn {
        background: #FEE2E2;
        color: #991B1B;
        border: 1px solid #FCA5A5;
        border-radius: 4px;
        padding: 0.375rem 0.75rem;
        font-size: 0.75rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .delete-field-btn:hover {
        background: #FCA5A5;
        color: #7F1D1D;
    }
    
    .delete-checkbox {
        display: none;
    }
    
    .required-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        background: #DBEAFE;
        color: #1E3A8A;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.125rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .status-badge.active {
        background-color: #DEF7EC;
        color: #03543F;
    }

    .status-badge.inactive {
        background-color: #FDE8E8;
        color: #9B1C1C;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Breadcrumbs -->
    {% include 'components/breadcrumb.html' with breadcrumbs=breadcrumbs %}
    
    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
        <!-- Header -->
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-semibold text-gray-900">Edit Survey: {{ survey.title }}</h1>
                    <p class="mt-1 text-sm text-gray-600">Update survey details and fields</p>
                </div>
                <a href="{% url 'course_reviews:survey_preview' survey.id %}" 
                   class="inline-flex items-center px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                    <svg class="-ml-1 mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                    </svg>
                    Preview
                </a>
            </div>
        </div>

        <!-- Form -->
        <form method="post" novalidate class="px-6 py-4">
            {% csrf_token %}
            
            <!-- Survey Details Section -->
            <div class="mb-6">
                <h2 class="text-lg font-medium text-gray-900 mb-4">Survey Details</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="md:col-span-2">
                        <label for="{{ form.title.id_for_label }}" class="form-label">
                            Survey Title <span class="text-danger">*</span>
                        </label>
                        {{ form.title }}
                        {% if form.title.errors %}
                            <div class="text-red-600 text-sm mt-1">{{ form.title.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label class="form-label">Status</label>
                        <div class="form-check form-switch" style="padding-top: 0.5rem;">
                            {{ form.is_active }}
                            <label class="form-check-label text-sm" for="{{ form.is_active.id_for_label }}">
                                Survey is Active
                            </label>
                        </div>
                    </div>
                </div>

                <div>
                    <label for="{{ form.description.id_for_label }}" class="form-label">Description</label>
                    {{ form.description }}
                    {% if form.description.errors %}
                        <div class="text-red-600 text-sm mt-1">{{ form.description.errors }}</div>
                    {% endif %}
                </div>
            </div>

            <!-- Survey Fields Section -->
            <div class="mb-6">
                <div class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom" style="border-color: #E5E7EB;">
                    <div>
                        <h2 class="mb-1" style="font-size: 1.125rem; font-weight: 500; color: #111827;">Survey Fields</h2>
                        <p class="mb-0" style="font-size: 0.875rem; color: #6B7280;">{{ formset.total_form_count }} field{{ formset.total_form_count|pluralize }} configured</p>
                    </div>
                    <button type="button" class="btn btn-outline-secondary btn-sm d-inline-flex align-items-center" onclick="addNewField()" style="gap: 0.5rem;">
                        <svg style="width: 16px; height: 16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                        </svg>
                        Add New Field
                    </button>
                </div>

                {{ formset.management_form }}
                
                {% if formset.non_form_errors %}
                    <div class="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded mb-4">
                        {{ formset.non_form_errors }}
                    </div>
                {% endif %}

                <div id="formset-container">
                    {% for form in formset %}
                    <div class="formset-row" data-field-index="{{ forloop.counter }}">
                        {{ form.id }}
                        
                        <!-- Field Header -->
                        <div class="field-header">
                            <div class="d-flex align-items-center gap-3">
                                <div class="field-number">{{ forloop.counter }}</div>
                                <div>
                                    <span class="field-type-badge" data-field-type="{{ form.field_type.value }}">
                                        <span class="field-type-text">{{ form.field_type.value|default:"text" }}</span>
                                    </span>
                                    {% if form.is_required.value %}
                                    <span class="required-badge ms-2">
                                        Required
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            {% if formset.can_delete %}
                            <div class="field-actions">
                                <label class="delete-field-btn" onclick="toggleDelete(this)">
                                    Remove
                                </label>
                                <div class="delete-checkbox">
                                    {{ form.DELETE }}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Field Content -->
                        <div class="field-row-content">
                            <div class="row g-2 align-items-end">
                                <div class="col-md-3">
                                    <label class="form-label small">Question/Label <span class="text-danger">*</span></label>
                                    {{ form.label }}
                                    {% if form.label.errors %}
                                        <div class="text-danger small">{{ form.label.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Field Type <span class="text-danger">*</span></label>
                                    {{ form.field_type }}
                                    {% if form.field_type.errors %}
                                        <div class="text-danger small">{{ form.field_type.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Placeholder</label>
                                    {{ form.placeholder }}
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Help Text</label>
                                    {{ form.help_text }}
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label small">Max Rating</label>
                                    {{ form.max_rating }}
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label small">Order</label>
                                    {{ form.order }}
                                    {% if form.order.errors %}
                                        <div class="text-danger small">{{ form.order.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label small d-block">Required</label>
                                    <div class="form-check">
                                        {{ form.is_required }}
                                        <label class="form-check-label small">Yes</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-8 bg-gray-50 rounded border border-gray-200">
                        <p class="text-gray-500">No fields added yet. Add your first question to start building your survey.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex justify-content-between align-items-center pt-4 border-top" style="border-color: #E5E7EB;">
                <a href="{% url 'course_reviews:survey_list' %}" class="btn btn-outline-secondary">
                    Cancel
                </a>
                <button type="submit" class="btn text-white" style="background-color: #1c2260;" onmouseover="this.style.backgroundColor='#181f56'" onmouseout="this.style.backgroundColor='#1c2260'">
                    Save Changes
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Simple Survey Edit Page JavaScript
    document.addEventListener('DOMContentLoaded', function() {
        
        // Function to toggle delete checkbox
        window.toggleDelete = function(button) {
            const formsetRow = button.closest('.formset-row');
            const deleteCheckbox = formsetRow.querySelector('[name*="DELETE"]');
            
            if (deleteCheckbox) {
                deleteCheckbox.checked = !deleteCheckbox.checked;
                
                if (deleteCheckbox.checked) {
                    formsetRow.style.opacity = '0.5';
                    formsetRow.style.background = '#FEE2E2';
                    button.textContent = 'Undo';
                    button.style.background = '#FCA5A5';
                } else {
                    formsetRow.style.opacity = '1';
                    formsetRow.style.background = '#F9FAFB';
                    button.textContent = 'Remove';
                    button.style.background = '#FEE2E2';
                }
            }
        };
        
        // Update field type text dynamically
        const fieldTypeSelects = document.querySelectorAll('[name*="field_type"]');
        fieldTypeSelects.forEach(function(select) {
            const row = select.closest('.formset-row');
            const fieldTypeText = row ? row.querySelector('.field-type-text') : null;
            
            function updateFieldType() {
                if (fieldTypeText) {
                    fieldTypeText.textContent = select.value || 'text';
                }
            }
            
            updateFieldType();
            select.addEventListener('change', updateFieldType);
        });
        
        // Update required badge dynamically
        const requiredCheckboxes = document.querySelectorAll('[name*="is_required"]');
        requiredCheckboxes.forEach(function(checkbox) {
            checkbox.addEventListener('change', function() {
                const row = checkbox.closest('.formset-row');
                const header = row ? row.querySelector('.field-header > div') : null;
                
                if (header) {
                    let requiredBadge = header.querySelector('.required-badge');
                    
                    if (checkbox.checked && !requiredBadge) {
                        requiredBadge = document.createElement('span');
                        requiredBadge.className = 'required-badge ms-2';
                        requiredBadge.textContent = 'Required';
                        header.appendChild(requiredBadge);
                    } else if (!checkbox.checked && requiredBadge) {
                        requiredBadge.remove();
                    }
                }
            });
        });
        
        // Add new field functionality
        window.addNewField = function() {
            const totalFormsInput = document.querySelector('input[name$="TOTAL_FORMS"]');
            if (!totalFormsInput) return;
            
            const currentTotal = parseInt(totalFormsInput.value);
            const newIndex = currentTotal;
            
            // Create new form HTML
            const container = document.getElementById('formset-container');
            const emptyForm = container.querySelector('.formset-row');
            
            if (!emptyForm) {
                // If no existing forms, create a basic structure
                const newForm = document.createElement('div');
                newForm.className = 'formset-row';
                newForm.setAttribute('data-field-index', newIndex + 1);
                newForm.innerHTML = `
                    <div class="field-header">
                        <div class="d-flex align-items-center gap-3">
                            <div class="field-number">${newIndex + 1}</div>
                            <div>
                                <span class="field-type-badge">
                                    <span class="field-type-text">text</span>
                                </span>
                            </div>
                        </div>
                        <div class="field-actions">
                            <label class="delete-field-btn" onclick="toggleDelete(this)">Remove</label>
                        </div>
                    </div>
                    <div class="field-row-content">
                        <p class="text-sm text-gray-600 mb-3">Please save the form to add more details to this field.</p>
                    </div>
                `;
                container.appendChild(newForm);
            } else {
                // Clone existing form structure
                const lastForm = container.querySelector('.formset-row:last-child');
                if (lastForm) {
                    const newForm = lastForm.cloneNode(true);
                    newForm.setAttribute('data-field-index', newIndex + 1);
                    
                    // Update field number
                    const fieldNumber = newForm.querySelector('.field-number');
                    if (fieldNumber) fieldNumber.textContent = newIndex + 1;
                    
                    // Clear input values
                    const inputs = newForm.querySelectorAll('input:not([type="hidden"]), textarea, select');
                    inputs.forEach(input => {
                        if (input.type === 'checkbox') {
                            input.checked = false;
                        } else {
                            input.value = '';
                        }
                    });
                    
                    container.appendChild(newForm);
                }
            }
            
            // Update TOTAL_FORMS count
            totalFormsInput.value = newIndex + 1;
            
            // Update field count display
            const fieldCountText = document.querySelector('.text-sm.text-gray-600');
            if (fieldCountText) {
                const newCount = newIndex + 1;
                fieldCountText.textContent = `${newCount} field${newCount !== 1 ? 's' : ''} configured`;
            }
            
            // Scroll to new field
            setTimeout(() => {
                const newField = container.querySelector('.formset-row:last-child');
                if (newField) {
                    newField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
        };
    });
</script>
{% endblock %}
