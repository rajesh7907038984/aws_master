{% extends 'base.html' %}
{% load static %}

{% block title %}{% if is_edit %}Edit{% else %}Add{% endif %} Question - {{ quiz.title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'tinymce_editor/css/tinymce-fixes.css' %}">
<link rel="stylesheet" href="{% static 'tinymce_editor/css/force-toolbar.css' %}">
<link rel="stylesheet" href="{% static 'quiz/css/question_types/drag_drop_matching.css' %}">
<link rel="stylesheet" href="{% static 'quiz/css/question_types/multiple_choice.css' %}">
<link rel="stylesheet" href="{% static 'quiz/css/question_types/multiple_select.css' %}">
<link rel="stylesheet" href="{% static 'quiz/css/style.css' %}">
<style>
    /* Form styles */
    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: #374151;
        margin-bottom: 0.5rem;
    }

    .form-control {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #E5E7EB;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        color: #374151;
        background-color: white;
        transition: border-color 0.15s ease-in-out;
    }

    .form-control:focus {
        outline: none;
        border-color: #2563EB;
        box-shadow: 0 0 0 1px #2563EB;
    }

    /* Enhanced question text area styles */
    .tinymce-editor {
        width: 100% !important;
        min-height: 120px;
        border: 1px solid #E5E7EB;
        border-radius: 0.375rem;
        padding: 0.75rem;
        font-size: 0.875rem;
        line-height: 1.5;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    .tinymce-editor:focus {
        border-color: #2563EB;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    /* TinyMCE container improvements */
    .tox-tinymce {
        border-radius: 0.375rem !important;
        border: 1px solid #E5E7EB !important;
    }

    .tox-editor-header {
        border-bottom: 1px solid #E5E7EB !important;
    }

    .form-text {
        font-size: 0.75rem;
        color: #6B7280;
        margin-top: 0.25rem;
    }

    .invalid-feedback {
        font-size: 0.75rem;
        color: #DC2626;
        margin-top: 0.25rem;
    }

    /* Input group styles */
    .input-group {
        position: relative;
        display: flex;
        flex-wrap: wrap;
        align-items: stretch;
        width: 100%;
        margin-bottom: 0.75rem;
    }

    .input-group > .form-control {
        position: relative;
        flex: 1 1 auto;
        width: 1%;
        min-width: 0;
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
    }

    .input-group > .form-control:focus {
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
        z-index: 1;
    }

    /* Matching pairs styles */
    .matching-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    .matching-pair {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 0.5rem;
        align-items: center;
    }

    .matching-pair .form-control {
        border-radius: 0.375rem;
    }

    .matching-pair .btn-remove {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        line-height: 1.25rem;
        border-radius: 0.375rem;
    }

    /* Radio button and checkbox styles - improved alignment with square radio buttons */
    input[type="radio"], input[type="checkbox"] {
        margin: 0;
        cursor: pointer;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        width: 1.25rem;
        height: 1.25rem;
        border: 2px solid #D1D5DB;
        background-color: white;
        position: relative;
        transition: all 0.2s ease;
        flex-shrink: 0;
        align-self: center;
    }

    input[type="radio"] {
        border-radius: 0.25rem;
    }

    input[type="checkbox"] {
        border-radius: 0.375rem;
    }

    input[type="radio"]:hover, input[type="checkbox"]:hover {
        border-color: #9CA3AF;
        transform: scale(1.05);
    }

    input[type="radio"]:checked, input[type="checkbox"]:checked {
        background-color: #2563EB;
        border-color: #2563EB;
        transform: scale(1.05);
    }

    input[type="radio"]:checked::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 0.375rem;
        height: 0.375rem;
        background-color: white;
        border-radius: 0.125rem;
    }

    input[type="checkbox"]:checked::after {
        content: 'âœ“';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 0.875rem;
        font-weight: bold;
        line-height: 1;
    }

    /* Improved input group alignment */
    .input-group {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
        padding: 0.75rem;
        border: 1px solid #E5E7EB;
        border-radius: 0.5rem;
        background-color: #FAFAFA;
        transition: all 0.2s ease;
    }

    .input-group:hover {
        border-color: #D1D5DB;
        background-color: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .input-group .form-control {
        flex: 1;
        margin-bottom: 0;
        background-color: transparent;
        border: none;
        padding: 0.5rem 0;
    }

    .input-group .form-control:focus {
        box-shadow: none;
        outline: none;
    }

    .input-group .btn {
        flex-shrink: 0;
        margin: 0;
    }

    /* Fix for header display issues on quiz add question page */
    header {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        z-index: 50 !important;
    }

    /* Desktop search responsive behavior - managed in header.html */

    /* Mobile search toggle responsive behavior - managed in header.html */

    /* Ensure header icons are visible */
    .header-icon,
    .discussion-icon,
    .notification-icon {
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
    }

    /* Fix for header icons SVG */
    .header-icon svg,
    .discussion-icon svg,
    .notification-icon svg {
        display: inline !important;
        visibility: visible !important;
        opacity: 1 !important;
    }

    /* Fix for notification dots */
    .header-icon span,
    .discussion-icon span,
    .notification-icon span {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }

    /* Override any TinyMCE styles that might affect header */
    .tox-tinymce {
        z-index: 10 !important;
    }

    .tox-toolbar {
        z-index: 10 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    {% with breadcrumbs=breadcrumbs %}
        {% include 'components/breadcrumb.html' %}
    {% endwith %}

    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-semibold text-gray-900">{% if is_edit %}Edit{% else %}Add{% endif %} Question</h1>
                    <p class="mt-1 text-sm text-gray-600">Configure your question settings below.</p>
                </div>
            </div>
        </div>
        <div class="px-6 py-4">
            <form method="post" id="questionForm" class="needs-validation" novalidate>
                {% csrf_token %}
                <input type="hidden" name="is_edit" value="{% if is_edit %}true{% else %}false{% endif %}">

                {% if form.non_field_errors or form_errors %}
                <div class="alert alert-danger mb-4">
                    {% for error in form.non_field_errors %}
                        <p>{{ error }}</p>
                    {% endfor %}
                    {% if form_errors %}
                        <p>{{ form_errors }}</p>
                    {% endif %}
                </div>
                {% endif %}

                <div class="space-y-6">
                    <div class="form-group">
                        <label for="{{ form.question_text.id_for_label }}" class="form-label required-field">Question Text</label>
                        <textarea id="question_text_editor" name="question_text" class="tinymce-editor" required>{{ form.question_text.value|default:'' }}</textarea>
                        {% if form.question_text.errors %}
                        <div class="invalid-feedback">
                            {{ form.question_text.errors.0 }}
                        </div>
                        {% endif %}
                        {% if form.question_text.help_text %}
                        <div class="form-text">{{ form.question_text.help_text }}</div>
                        {% endif %}
                    </div>



                    <!-- Assessment Level Field (Initial Assessment Only) -->
                    {% if quiz.is_initial_assessment %}
                    <div class="form-group">
                        <label for="{{ form.assessment_level.id_for_label }}" class="form-label">Assessment Level</label>
                        {{ form.assessment_level }}
                        {% if form.assessment_level.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.assessment_level.errors.0 }}
                        </div>
                        {% endif %}
                        {% if form.assessment_level.help_text %}
                        <div class="form-text">{{ form.assessment_level.help_text }}</div>
                        {% endif %}
                    </div>
                    {% endif %}

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="form-group">
                            <label for="{{ form.question_type.id_for_label }}" class="form-label">Question Type *</label>
                            {{ form.question_type }}
                            {% if form.question_type.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.question_type.errors.0 }}
                            </div>
                            {% endif %}
                            {% if form.question_type.help_text %}
                            <div class="form-text">{{ form.question_type.help_text }}</div>
                            {% endif %}
                        </div>

                        {% if not quiz.is_vak_test %}
                        <div class="form-group">
                            <label for="{{ form.points.id_for_label }}" class="form-label">Points *</label>
                            {{ form.points }}
                            {% if form.points.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.points.errors.0 }}
                            </div>
                            {% endif %}
                            {% if form.points.help_text %}
                            <div class="form-text">{{ form.points.help_text }}</div>
                            {% endif %}
                        </div>
                        {% endif %}

                        <div class="form-group">
                            <label for="{{ form.order.id_for_label }}" class="form-label">Order</label>
                            {{ form.order }}
                            {% if form.order.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.order.errors.0 }}
                            </div>
                            {% endif %}
                            {% if form.order.help_text %}
                            <div class="form-text">{{ form.order.help_text }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Dynamic Answer Fields -->
                    <div id="answerFields" class="space-y-6">
                        <!-- This section will be populated by JavaScript based on question type -->
                    </div>

                    <div class="flex justify-end space-x-3">
                        <a href="{% url 'quiz:edit_quiz' quiz_id=quiz.id %}" class="btn btn-secondary">
                            <i class="fas fa-times me-1"></i>
                            Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas {% if is_edit %}fa-save{% else %}fa-plus-circle{% endif %} me-1"></i>
                            {% if is_edit %}Save Changes{% else %}Add Question{% endif %}
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ form.media.js }}
<script src="{% static 'tinymce_editor/js/tinymce-json-handler.js' %}"></script>
<script src="{% static 'tinymce_editor/js/toolbar-fixer.js' %}"></script>
<script>
    console.log('=== Static files loading ===');
    console.log('Question form JavaScript will load after TinyMCE...');
</script>
<script>
    // Initialize TinyMCE for question text
    document.addEventListener('DOMContentLoaded', function() {
        const questionTextEditor = document.getElementById('question_text_editor');
        
        // Process JSON content if present
        if (questionTextEditor) {
            window.TinyMCEJsonHandler.processJsonContentField(questionTextEditor);
        }
        
        if (typeof tinymce !== 'undefined') {
            tinymce.init({
                selector: '#question_text_editor',
                height: 400,
                menubar: false,
                plugins: [
                    'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
                    'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
                    'insertdatetime', 'media', 'table', 'wordcount', 'aiwriter'
                ],
                toolbar: 'undo redo | blocks | ' +
                        'bold italic forecolor | alignleft aligncenter ' +
                        'alignright alignjustify | bullist numlist outdent indent | ' +
                        'removeformat | image media | aiwriter',
                content_style: 'body { font-family:Helvetica,Arial,sans-serif; font-size:14px }',
                image_advtab: true,
                image_uploadtab: true,
                images_upload_url: '/courses/upload-editor-image/',
                automatic_uploads: true,
                file_picker_types: 'image media',
                media_upload_url: '/tinymce/upload_media_file/',
                media_live_embeds: true,
                media_filter_html: false,
                browser_spellcheck: true,
                contextmenu: false,
                statusbar: true,
                resize: true,
                branding: false,
                promotion: false,
                external_plugins: {
                    'aiwriter': '/static/tinymce_editor/js/plugins/aiwriter/plugin.js',
                    'media': '/static/tinymce_editor/tinymce/plugins/media/plugin.min.js'
                },
                setup: function(editor) {
                    editor.on('change', function() {
                        editor.save();
                    });
                }
            });
            
            // Setup form submission handler
            const questionForm = document.getElementById('questionForm');
            if (questionForm) {
                window.TinyMCEJsonHandler.setupFormSubmissionHandler(
                    questionForm,
                    ['question_text_editor']
                );
            }
            
            // Force toolbar visibility after a delay
            setTimeout(function() {
                document.querySelectorAll('.tox-toolbar__primary, .tox-toolbar__group, .tox-tbtn, .tox-editor-header, .tox-toolbar-overlord').forEach(function(el) {
                    el.style.display = el.classList.contains('tox-toolbar__group') || el.classList.contains('tox-tbtn') ? 'flex' : 'block';
                    el.style.visibility = 'visible';
                    el.style.opacity = '1';
                });
                
                // Hide overflow buttons
                document.querySelectorAll('.tox-tbtn[aria-label="More..."], .tox-tbtn[data-mce-name="overflow-button"]').forEach(function(el) {
                    el.style.display = 'none';
                });
            }, 500);
        }
    });
    
    // Initialize data for question types
    // Initialize quiz data safely to avoid CSP violations
    try {
        window.options_json = {{ options_json|safe }};
        window.correct_answers_json = {{ correct_answers_json|safe }};
        window.learning_styles_json = {{ learning_styles_json|safe }};
        window.multiple_blank_answers_json = {{ multiple_blank_answers_json|safe }};
        window.matching_pairs_json = {{ matching_pairs_json|safe }};
        window.blank_answer = {{ blank_answer|safe }};
        window.is_vak_test = {{ quiz.is_vak_test|yesno:"true,false" }};
        window.is_initial_assessment = {{ quiz.is_initial_assessment|yesno:"true,false" }};
        
        // Debug logging for initialized data (only in development)
        if (false || false) {
            console.log('Quiz data initialized successfully');
        }
    } catch (error) {
        console.error('Error initializing quiz data:', error);
        // Fallback values
        window.options_json = [];
        window.correct_answers_json = [];
        window.learning_styles_json = [];
        window.multiple_blank_answers_json = [];
        window.matching_pairs_json = [];
        window.blank_answer = '';
        window.is_vak_test = false;
        window.is_initial_assessment = false;
    }
</script>
<!-- Load question type scripts in correct order -->
<script src="{% static 'quiz/js/question_types/true_false.js' %}" defer></script>
<script src="{% static 'quiz/js/question_types/multiple_choice.js' %}" defer></script>
<script src="{% static 'quiz/js/question_types/multiple_select.js' %}" defer></script>
<script src="{% static 'quiz/js/question_types/fill_blank.js' %}" defer></script>
<script src="{% static 'quiz/js/question_types/multi_blank.js' %}" defer></script>
<script src="{% static 'quiz/js/question_types/matching.js' %}" defer></script>
<script src="{% static 'quiz/js/question_types/drag_drop_matching.js' %}" defer></script>
<script>
    console.log('=== Loading question form script ===');
    console.log('About to load:', '{% static "quiz/js/question_form.js" %}');
</script>
<script src="{% static 'quiz/js/question_form.js' %}?v=1.2"></script>
<script>
    console.log('=== Question form script loaded ===');
    
    // Note: Question type handling is now managed by the main question_form.js script
    // This duplicate code has been removed to prevent conflicts

    // Fix for header display issues on quiz add question page
    document.addEventListener('DOMContentLoaded', function() {
        console.log('=== Fixing header display issues ===');
        
        // Ensure header is visible
        const header = document.querySelector('header');
        if (header) {
            header.style.display = 'block';
            header.style.visibility = 'visible';
            header.style.opacity = '1';
            header.style.zIndex = '50';
            console.log('Header fixed');
        }

        // Search container responsive behavior is handled in header.html

        // Mobile search toggle responsive behavior is handled in header.html

        // Fix header icons
        const headerIcons = document.querySelectorAll('.header-icon, .discussion-icon, .notification-icon');
        headerIcons.forEach(icon => {
            icon.style.display = 'flex';
            icon.style.visibility = 'visible';
            icon.style.opacity = '1';
            
            // Fix SVG icons
            const svg = icon.querySelector('svg');
            if (svg) {
                svg.style.display = 'inline';
                svg.style.visibility = 'visible';
                svg.style.opacity = '1';
            }
            
            // Fix notification dots
            const span = icon.querySelector('span');
            if (span) {
                span.style.display = 'block';
                span.style.visibility = 'visible';
                span.style.opacity = '1';
            }
        });
        console.log('Header icons fixed');

        // Ensure TinyMCE doesn't interfere with header
        const tinymceElements = document.querySelectorAll('.tox-tinymce, .tox-toolbar');
        tinymceElements.forEach(el => {
            el.style.zIndex = '10';
        });
        console.log('TinyMCE z-index fixed');
    });
</script>
{% endblock %}