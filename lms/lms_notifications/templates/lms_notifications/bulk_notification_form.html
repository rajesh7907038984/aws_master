{% extends "base.html" %}
{% load static %}

{% block title %}{{ action }} Bulk Notification - {{ block.super }}{% endblock %}

{% block global_breadcrumbs %}
<!-- Breadcrumb -->
{% include 'components/breadcrumb.html' with breadcrumbs=breadcrumbs %}
{% endblock %}

{% block extra_css %}
<style>
.section-box {
    border-radius: 8px;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    background-color: white;
    padding: 1.25rem;
    margin-bottom: 1rem;
}

.form-field {
    margin-bottom: 1.5rem;
}

.form-label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    color: rgb(55 65 81);
    margin-bottom: 0.5rem;
}

.form-input, .form-select, .form-textarea {
    display: block;
    width: 100%;
    padding: 0.5rem 0.75rem;
    border: 1px solid rgb(209 213 219);
    border-radius: 0.375rem;
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    font-size: 0.875rem;
}

.form-input:focus, .form-select:focus, .form-textarea:focus {
    outline: none;
    border-color: rgb(59 130 246);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.checkbox-group {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 0.5rem;
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid rgb(209 213 219);
    border-radius: 0.375rem;
    padding: 0.75rem;
}

.checkbox-item {
    display: flex;
    align-items: center;
    padding: 0.25rem;
}

.checkbox-item input[type="checkbox"] {
    margin-right: 0.5rem;
}

.recipient-options {
    display: none;
    margin-top: 1rem;
    padding: 1rem;
    border: 1px solid rgb(229 231 235);
    border-radius: 0.375rem;
    background-color: rgb(249 250 251);
}

.recipient-options.active {
    display: block;
}

.help-text {
    font-size: 0.75rem;
    color: rgb(107 114 128);
    margin-top: 0.25rem;
}

.error-message {
    font-size: 0.75rem;
    color: rgb(220 38 38);
    margin-top: 0.25rem;
}
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-semibold text-gray-900">{{ action }} Bulk Notification</h1>
            <p class="text-gray-600 mt-1">
                {% if action == 'Create' %}
                    Create a new bulk notification to send to multiple users
                {% else %}
                    Edit the bulk notification details
                {% endif %}
            </p>
        </div>
        <div class="flex gap-3">
            <a href="{% url 'lms_notifications:bulk_notification_list' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                <i class="fas fa-arrow-left mr-2"></i> Back to List
            </a>
        </div>
    </div>

    <!-- Form -->
    <div class="section-box">
        <form method="POST" id="bulk-notification-form">
            {% csrf_token %}
            
            <!-- Basic Information -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="form-field">
                    <label for="{{ form.title.id_for_label }}" class="form-label">{{ form.title.label }}</label>
                    {{ form.title }}
                    {% if form.title.errors %}
                        <div class="error-message">{{ form.title.errors.0 }}</div>
                    {% endif %}
                    <div class="help-text">A clear, descriptive title for your notification</div>
                </div>

                <div class="form-field">
                    <label for="{{ form.notification_type.id_for_label }}" class="form-label">{{ form.notification_type.label }}</label>
                    {{ form.notification_type }}
                    {% if form.notification_type.errors %}
                        <div class="error-message">{{ form.notification_type.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="form-field">
                <label for="{{ form.short_message.id_for_label }}" class="form-label">{{ form.short_message.label }}</label>
                {{ form.short_message }}
                {% if form.short_message.errors %}
                    <div class="error-message">{{ form.short_message.errors.0 }}</div>
                {% endif %}
                <div class="help-text">Brief summary that will appear in notification lists</div>
            </div>

            <div class="form-field">
                <label for="{{ form.message.id_for_label }}" class="form-label">{{ form.message.label }}</label>
                {{ form.message }}
                {% if form.message.errors %}
                    <div class="error-message">{{ form.message.errors.0 }}</div>
                {% endif %}
                <div class="help-text">Full notification message content</div>
            </div>

            <!-- Recipients -->
            <div class="form-field">
                <label for="{{ form.recipient_type.id_for_label }}" class="form-label">{{ form.recipient_type.label }}</label>
                {{ form.recipient_type }}
                {% if form.recipient_type.errors %}
                    <div class="error-message">{{ form.recipient_type.errors.0 }}</div>
                {% endif %}

                <!-- Role Selection -->
                <div id="role-options" class="recipient-options">
                    <h4 class="font-medium text-gray-900 mb-3">Select Roles</h4>
                    <div class="checkbox-group">
                        {% for choice in form.target_roles.field.choices %}
                        <div class="checkbox-item">
                            <input type="checkbox" name="target_roles" value="{{ choice.0 }}" id="role_{{ choice.0 }}"
                                   {% if choice.0 in form.target_roles.value %}checked{% endif %}>
                            <label for="role_{{ choice.0 }}">{{ choice.1 }}</label>
                        </div>
                        {% endfor %}
                    </div>
                    {% if form.target_roles.errors %}
                        <div class="error-message">{{ form.target_roles.errors.0 }}</div>
                    {% endif %}
                </div>

                <!-- Branch Selection -->
                <div id="branch-options" class="recipient-options">
                    <h4 class="font-medium text-gray-900 mb-3">Select Branches</h4>
                    <div class="checkbox-group">
                        {% for choice in form.target_branches %}
                        <div class="checkbox-item">
                            {{ choice.tag }}
                            <label for="{{ choice.id_for_label }}">{{ choice.choice_label }}</label>
                        </div>
                        {% endfor %}
                    </div>
                    {% if form.target_branches.errors %}
                        <div class="error-message">{{ form.target_branches.errors.0 }}</div>
                    {% endif %}
                </div>

                <!-- Group Selection -->
                <div id="group-options" class="recipient-options">
                    <h4 class="font-medium text-gray-900 mb-3">Select Groups</h4>
                    <div class="checkbox-group">
                        {% for choice in form.target_groups %}
                        <div class="checkbox-item">
                            {{ choice.tag }}
                            <label for="{{ choice.id_for_label }}">{{ choice.choice_label }}</label>
                        </div>
                        {% endfor %}
                    </div>
                    {% if form.target_groups.errors %}
                        <div class="error-message">{{ form.target_groups.errors.0 }}</div>
                    {% endif %}
                </div>

                <!-- Course Selection -->
                <div id="course-options" class="recipient-options">
                    <h4 class="font-medium text-gray-900 mb-3">Select Courses</h4>
                    <div class="checkbox-group">
                        {% for choice in form.target_courses %}
                        <div class="checkbox-item">
                            {{ choice.tag }}
                            <label for="{{ choice.id_for_label }}">{{ choice.choice_label }}</label>
                        </div>
                        {% endfor %}
                    </div>
                    {% if form.target_courses.errors %}
                        <div class="error-message">{{ form.target_courses.errors.0 }}</div>
                    {% endif %}
                </div>

                <!-- Custom Recipients -->
                <div id="custom-options" class="recipient-options">
                    <h4 class="font-medium text-gray-900 mb-3">Select Users</h4>
                    <div class="checkbox-group">
                        {% for choice in form.custom_recipients %}
                        <div class="checkbox-item">
                            {{ choice.tag }}
                            <label for="{{ choice.id_for_label }}">{{ choice.choice_label }}</label>
                        </div>
                        {% endfor %}
                    </div>
                    {% if form.custom_recipients.errors %}
                        <div class="error-message">{{ form.custom_recipients.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>

            <!-- Additional Settings -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="form-field">
                    <label for="{{ form.priority.id_for_label }}" class="form-label">{{ form.priority.label }}</label>
                    {{ form.priority }}
                    {% if form.priority.errors %}
                        <div class="error-message">{{ form.priority.errors.0 }}</div>
                    {% endif %}
                </div>

                <div class="form-field">
                    <label for="{{ form.action_url.id_for_label }}" class="form-label">{{ form.action_url.label }}</label>
                    {{ form.action_url }}
                    {% if form.action_url.errors %}
                        <div class="error-message">{{ form.action_url.errors.0 }}</div>
                    {% endif %}
                    <div class="help-text">Optional URL for action button</div>
                </div>

                <div class="form-field">
                    <label for="{{ form.action_text.id_for_label }}" class="form-label">{{ form.action_text.label }}</label>
                    {{ form.action_text }}
                    {% if form.action_text.errors %}
                        <div class="error-message">{{ form.action_text.errors.0 }}</div>
                    {% endif %}
                    <div class="help-text">Text for action button</div>
                </div>
            </div>

            <div class="form-field">
                <label for="{{ form.scheduled_for.id_for_label }}" class="form-label">{{ form.scheduled_for.label }}</label>
                {{ form.scheduled_for }}
                {% if form.scheduled_for.errors %}
                    <div class="error-message">{{ form.scheduled_for.errors.0 }}</div>
                {% endif %}
                <div class="help-text">Leave empty to send immediately, or schedule for later</div>
            </div>

            <!-- Submit Buttons -->
            <div class="flex justify-end space-x-3 pt-6 border-t border-gray-200">
                <a href="{% url 'lms_notifications:bulk_notification_list' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                    Cancel
                </a>
                <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white" style="background-color: #1c2260;" onmouseover="this.style.backgroundColor='#181f56'" onmouseout="this.style.backgroundColor='#1c2260'">
                    <i class="fas fa-save mr-2"></i> {{ action }} Notification
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const recipientTypeSelect = document.getElementById('{{ form.recipient_type.id_for_label }}');
    const recipientOptions = document.querySelectorAll('.recipient-options');

    function updateRecipientOptions() {
        const selectedType = recipientTypeSelect.value;
        
        // Hide all options
        recipientOptions.forEach(option => {
            option.classList.remove('active');
        });

        // Show relevant option
        const optionMap = {
            'role': 'role-options',
            'branch': 'branch-options',
            'group': 'group-options',
            'course': 'course-options',
            'custom': 'custom-options'
        };

        if (optionMap[selectedType]) {
            const targetOption = document.getElementById(optionMap[selectedType]);
            if (targetOption) {
                targetOption.classList.add('active');
            }
        }
    }

    // Initialize and bind event
    updateRecipientOptions();
    recipientTypeSelect.addEventListener('change', updateRecipientOptions);

    // Form validation
    const form = document.getElementById('bulk-notification-form');
    form.addEventListener('submit', function(e) {
        const recipientType = recipientTypeSelect.value;
        let hasRecipients = false;

        if (recipientType === 'all_users') {
            hasRecipients = true;
        } else if (recipientType === 'role') {
            hasRecipients = document.querySelectorAll('input[name="target_roles"]:checked').length > 0;
        } else if (recipientType === 'branch') {
            hasRecipients = document.querySelectorAll('input[name="target_branches"]:checked').length > 0;
        } else if (recipientType === 'group') {
            hasRecipients = document.querySelectorAll('input[name="target_groups"]:checked').length > 0;
        } else if (recipientType === 'course') {
            hasRecipients = document.querySelectorAll('input[name="target_courses"]:checked').length > 0;
        } else if (recipientType === 'custom') {
            hasRecipients = document.querySelectorAll('input[name="custom_recipients"]:checked').length > 0;
        }

        if (!hasRecipients && recipientType !== 'all_users') {
            e.preventDefault();
            alert('Please select at least one recipient for the chosen recipient type.');
            return false;
        }

        return true;
    });
});
</script>
{% endblock %} 