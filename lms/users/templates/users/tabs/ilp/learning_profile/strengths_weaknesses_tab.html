<!-- Strengths & Weaknesses Sub-Tab -->
<div id="strengths-weaknesses-tab" class="learning-profile-tab-content" style="display: none;">
    <div class="card shadow-sm">
        <div class="card-body p-6">
            <div class="flex items-center justify-between mb-8">
                <div>
                    <h4 class="text-lg font-semibold text-gray-900">Skills & Competency Analysis</h4>
                    <p class="text-sm text-gray-600 mt-1">Comprehensive analysis of current skills, strengths, and development areas (integrates with Work Experience Records)</p>
                </div>
            </div>

            <!-- Instructor View -->
            {% if user.role == 'admin' or user.role == 'instructor' or user.role == 'superadmin' %}
            <div class="space-y-8">
                
                <!-- Strengths Section -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                    <div class="flex items-center mb-4">
                        <div class="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-star text-white"></i>
                        </div>
                        <h5 class="text-lg font-medium text-green-800">Strengths</h5>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label for="strengths" class="block text-sm font-medium text-green-700 mb-2">
                                Strengths Assessment:
                            </label>
                            <textarea 
                                id="strengths_content" 
                                name="strengths_content" 
                                rows="6" 
                                class="w-full p-4 border border-green-300 rounded-md focus:ring-green-500 focus:border-green-500" 
                                placeholder="Describe the learner's strengths and positive attributes..."
                            >{% if sw_data and sw_data.strengths_content %}{{ sw_data.strengths_content }}{% endif %}</textarea>
                        </div>

                        <!-- Show learner feedback if exists -->
                        {% if sw_data and sw_data.strengths_approval and sw_data.strengths_approval != 'pending' %}
                        <div class="mt-4 p-4 bg-white border border-green-300 rounded-md">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-user text-blue-600 mr-2"></i>
                                <span class="text-sm font-medium text-gray-700">Learner Response:</span>
                                <span class="ml-2 px-2 py-1 text-xs rounded-full {% if sw_data.strengths_approval == 'approved' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                    {{ sw_data.get_strengths_approval_display }}
                                </span>
                            </div>
                            {% if sw_data.strengths_learner_comment %}
                            <p class="text-gray-700 mb-3">{{ sw_data.strengths_learner_comment }}</p>
                            {% endif %}
                            
                            <div>
                                <label for="strengths_instructor_reply" class="block text-sm font-medium text-green-700 mb-2">
                                    Your Reply:
                                </label>
                                <textarea 
                                    id="strengths_instructor_reply" 
                                    name="strengths_instructor_reply" 
                                    rows="3" 
                                    class="w-full p-3 border border-green-300 rounded-md focus:ring-green-500 focus:border-green-500" 
                                    placeholder="Reply to learner's feedback..."
                                >{% if sw_data and sw_data.strengths_instructor_reply %}{{ sw_data.strengths_instructor_reply }}{% endif %}</textarea>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Areas for Development Section -->
                <div class="bg-orange-50 border border-orange-200 rounded-lg p-6">
                    <div class="flex items-center mb-4">
                        <div class="w-8 h-8 bg-orange-600 rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-chart-line text-white"></i>
                        </div>
                        <h5 class="text-lg font-medium text-orange-800">Areas for Development</h5>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label for="weaknesses" class="block text-sm font-medium text-orange-700 mb-2">
                                Development Areas Assessment:
                            </label>
                            <textarea 
                                id="development_content" 
                                name="development_content" 
                                rows="6" 
                                class="w-full p-4 border border-orange-300 rounded-md focus:ring-orange-500 focus:border-orange-500" 
                                placeholder="Describe areas where the learner can improve and develop..."
                            >{% if sw_data and sw_data.development_content %}{{ sw_data.development_content }}{% endif %}</textarea>
                        </div>

                        <!-- Show learner feedback if exists -->
                        {% if sw_data and sw_data.development_approval and sw_data.development_approval != 'pending' %}
                        <div class="mt-4 p-4 bg-white border border-orange-300 rounded-md">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-user text-blue-600 mr-2"></i>
                                <span class="text-sm font-medium text-gray-700">Learner Response:</span>
                                <span class="ml-2 px-2 py-1 text-xs rounded-full {% if sw_data.development_approval == 'approved' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                    {{ sw_data.get_development_approval_display }}
                                </span>
                            </div>
                            {% if sw_data.development_learner_comment %}
                            <p class="text-gray-700 mb-3">{{ sw_data.development_learner_comment }}</p>
                            {% endif %}
                            
                            <div>
                                <label for="development_instructor_reply" class="block text-sm font-medium text-orange-700 mb-2">
                                    Your Reply:
                                </label>
                                <textarea 
                                    id="development_instructor_reply" 
                                    name="development_instructor_reply" 
                                    rows="3" 
                                    class="w-full p-3 border border-orange-300 rounded-md focus:ring-orange-500 focus:border-orange-500" 
                                    placeholder="Reply to learner's feedback..."
                                >{% if sw_data and sw_data.development_instructor_reply %}{{ sw_data.development_instructor_reply }}{% endif %}</textarea>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>


            </div>

            <!-- Learner View -->
            {% elif user.role == 'learner' and user.id == profile_user.id %}
            <div class="space-y-8">
                
                <!-- Strengths Section for Learner -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                    <div class="flex items-center mb-4">
                        <div class="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-star text-white"></i>
                        </div>
                        <h5 class="text-lg font-medium text-green-800">Strengths</h5>
                    </div>
                    
                    {% if sw_data and sw_data.strengths_content %}
                    <div class="space-y-4">
                        <div class="p-4 bg-white border border-green-300 rounded-md">
                            <p class="text-sm text-gray-600 mb-2">
                                <i class="fas fa-user-tie mr-1"></i>
                                Instructor Assessment:
                            </p>
                            <p class="text-gray-800">{{ sw_data.strengths_content }}</p>
                        </div>

                        <!-- Approval Section -->
                        <div class="border-t border-green-200 pt-4">
                            <label class="block text-sm font-medium text-green-700 mb-3">Do you agree with this assessment?</label>
                            <div class="space-y-3">
                                <div class="flex items-center">
                                    <input 
                                        id="strengths_approve" 
                                        name="strengths_approval" 
                                        type="radio" 
                                        value="approved" 
                                        class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300"
                                        {% if sw_data.strengths_approval == 'approved' %}checked{% endif %}
                                    >
                                    <label for="strengths_approve" class="ml-3 text-sm text-gray-700">
                                        <i class="fas fa-thumbs-up text-green-600 mr-1"></i>
                                        Approve
                                    </label>
                                </div>
                                <div class="flex items-center">
                                    <input 
                                        id="strengths_unapprove" 
                                        name="strengths_approval" 
                                        type="radio" 
                                        value="not_approved" 
                                        class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300"
                                        {% if sw_data.strengths_approval == 'not_approved' %}checked{% endif %}
                                    >
                                    <label for="strengths_unapprove" class="ml-3 text-sm text-gray-700">
                                        <i class="fas fa-thumbs-down text-red-600 mr-1"></i>
                                        Do not approve
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <label for="strengths_learner_comment" class="block text-sm font-medium text-green-700 mb-2">
                                    Your Comments:
                                </label>
                                <textarea 
                                    id="strengths_learner_comment" 
                                    name="strengths_learner_comment" 
                                    rows="3" 
                                    class="w-full p-3 border border-green-300 rounded-md focus:ring-green-500 focus:border-green-500" 
                                    placeholder="Add your comments about this assessment..."
                                >{% if sw_data and sw_data.strengths_learner_comment %}{{ sw_data.strengths_learner_comment }}{% endif %}</textarea>
                            </div>
                        </div>

                        <!-- Show instructor reply if exists -->
                        {% if sw_data and sw_data.strengths_instructor_reply %}
                        <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-md">
                            <p class="text-sm text-blue-600 mb-1">
                                <i class="fas fa-reply mr-1"></i>
                                Instructor Reply:
                            </p>
                            <p class="text-gray-800">{{ sw_data.strengths_instructor_reply }}</p>
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="text-center py-8">
                        <div class="text-gray-400 mb-4">
                            <i class="fas fa-clock text-4xl"></i>
                        </div>
                        <p class="text-gray-600">Your instructor hasn't added strengths assessment yet.</p>
                    </div>
                    {% endif %}
                </div>

                <!-- Areas for Development Section for Learner -->
                <div class="bg-orange-50 border border-orange-200 rounded-lg p-6">
                    <div class="flex items-center mb-4">
                        <div class="w-8 h-8 bg-orange-600 rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-chart-line text-white"></i>
                        </div>
                        <h5 class="text-lg font-medium text-orange-800">Areas for Development</h5>
                    </div>
                    
                    {% if sw_data and sw_data.development_content %}
                    <div class="space-y-4">
                        <div class="p-4 bg-white border border-orange-300 rounded-md">
                            <p class="text-sm text-gray-600 mb-2">
                                <i class="fas fa-user-tie mr-1"></i>
                                Instructor Assessment:
                            </p>
                            <p class="text-gray-800">{{ sw_data.development_content }}</p>
                        </div>

                        <!-- Approval Section -->
                        <div class="border-t border-orange-200 pt-4">
                            <label class="block text-sm font-medium text-orange-700 mb-3">Do you agree with this assessment?</label>
                            <div class="space-y-3">
                                <div class="flex items-center">
                                    <input 
                                        id="development_approve" 
                                        name="development_approval" 
                                        type="radio" 
                                        value="approved" 
                                        class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300"
                                        {% if sw_data.development_approval == 'approved' %}checked{% endif %}
                                    >
                                    <label for="development_approve" class="ml-3 text-sm text-gray-700">
                                        <i class="fas fa-thumbs-up text-green-600 mr-1"></i>
                                        Approve
                                    </label>
                                </div>
                                <div class="flex items-center">
                                    <input 
                                        id="development_unapprove" 
                                        name="development_approval" 
                                        type="radio" 
                                        value="not_approved" 
                                        class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300"
                                        {% if sw_data.development_approval == 'not_approved' %}checked{% endif %}
                                    >
                                    <label for="development_unapprove" class="ml-3 text-sm text-gray-700">
                                        <i class="fas fa-thumbs-down text-red-600 mr-1"></i>
                                        Do not approve
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <label for="development_learner_comment" class="block text-sm font-medium text-orange-700 mb-2">
                                    Your Comments:
                                </label>
                                <textarea 
                                    id="development_learner_comment" 
                                    name="development_learner_comment" 
                                    rows="3" 
                                    class="w-full p-3 border border-orange-300 rounded-md focus:ring-orange-500 focus:border-orange-500" 
                                    placeholder="Add your comments about this assessment..."
                                >{% if sw_data and sw_data.development_learner_comment %}{{ sw_data.development_learner_comment }}{% endif %}</textarea>
                            </div>
                        </div>

                        <!-- Show instructor reply if exists -->
                        {% if sw_data and sw_data.development_instructor_reply %}
                        <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-md">
                            <p class="text-sm text-blue-600 mb-1">
                                <i class="fas fa-reply mr-1"></i>
                                Instructor Reply:
                            </p>
                            <p class="text-gray-800">{{ sw_data.development_instructor_reply }}</p>
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="text-center py-8">
                        <div class="text-gray-400 mb-4">
                            <i class="fas fa-clock text-4xl"></i>
                        </div>
                        <p class="text-gray-600">Your instructor hasn't added development areas assessment yet.</p>
                    </div>
                    {% endif %}
                </div>


            </div>

            <!-- Other roles view -->
            {% else %}
            <div class="text-center py-8">
                <div class="text-gray-400 mb-4">
                    <i class="fas fa-lock text-4xl"></i>
                </div>
                <p class="text-gray-600">You do not have permission to view this assessment.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Instructor fields are now integrated with the main form - no separate submission needed

// Learner fields are now integrated with the main form - no separate submission needed

// Simple message function
function showMessage(message, type) {
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 px-4 py-2 rounded shadow-lg z-50 text-white ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Ensure tab state is preserved when making updates in this tab
document.addEventListener('DOMContentLoaded', function() {
    // Set tab state for form submission
    function updateTabState() {
        // Update global tab state explicitly for this tab
        if (typeof currentTabState !== 'undefined') {
            currentTabState.mainTab = 'ilp-tab';
            currentTabState.subTab = 'learning-profile-tab';
            currentTabState.nestedTab = 'strengths-weaknesses-tab';
            
            console.log('Strengths & Weaknesses tab: Setting tab state to:', currentTabState);
            
            // Update hidden form fields directly
            var activeTabField = document.getElementById('activeTabField');
            var activeSubTabField = document.getElementById('activeSubTabField');
            var activeNestedTabField = document.getElementById('activeNestedTabField');
            
            if (activeTabField) activeTabField.value = currentTabState.mainTab;
            if (activeSubTabField) activeSubTabField.value = currentTabState.subTab;
            if (activeNestedTabField) activeNestedTabField.value = currentTabState.nestedTab;
        }
    }
    
    // Update tab state when the tab becomes visible
    var tabElement = document.getElementById('strengths-weaknesses-tab');
    if (tabElement) {
        // Create a mutation observer to detect when the tab becomes visible
        var observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && 
                    mutation.attributeName === 'style' &&
                    tabElement.style.display !== 'none') {
                    updateTabState();
                }
                
                if (mutation.type === 'attributes' && 
                    mutation.attributeName === 'class' &&
                    tabElement.classList.contains('active')) {
                    updateTabState();
                }
            });
        });
        
        observer.observe(tabElement, { attributes: true });
        
        // Also check if it's already visible
        if (tabElement.style.display !== 'none' || tabElement.classList.contains('active')) {
            updateTabState();
        }
    }
    
    // Add input listeners to all form elements in this tab
    var formElements = document.querySelectorAll('#strengths-weaknesses-tab input, #strengths-weaknesses-tab textarea, #strengths-weaknesses-tab select');
    formElements.forEach(function(element) {
        element.addEventListener('focus', updateTabState);
        element.addEventListener('change', updateTabState);
    });
});

// Override the existing functions to include tab state
function editStrengthWeakness(questionId) {
    // Make the description editable inline
    const questionElement = document.querySelector(`[data-question-id="${questionId}"]`);
    if (!questionElement) {
        // Find by question ID in any way possible
        const allQuestions = document.querySelectorAll('[id*="question_"]');
        for (let q of allQuestions) {
            if (q.innerHTML.includes(`question.id == ${questionId}`) || 
                q.querySelector(`[onclick*="${questionId}"]`)) {
                questionElement = q;
                break;
            }
        }
    }
    
    if (questionElement) {
        const descriptionP = questionElement.querySelector('p.text-sm.text-gray-800');
        if (descriptionP) {
            const currentText = descriptionP.textContent.trim();
            
            // Create textarea for editing
            const textarea = document.createElement('textarea');
            textarea.value = currentText;
            textarea.className = 'w-full p-2 border border-gray-300 rounded text-sm';
            textarea.rows = 3;
            
            // Create save/cancel buttons
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'flex space-x-2 mt-2';
            
            const saveBtn = document.createElement('button');
            saveBtn.textContent = 'Save';
            saveBtn.className = 'px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700';
            
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Cancel';
            cancelBtn.className = 'px-3 py-1 bg-gray-600 text-white rounded text-sm hover:bg-gray-700';
            
            buttonContainer.appendChild(saveBtn);
            buttonContainer.appendChild(cancelBtn);
            
            // Replace description with textarea
            const originalContent = descriptionP.innerHTML;
            descriptionP.innerHTML = '';
            descriptionP.appendChild(textarea);
            descriptionP.appendChild(buttonContainer);
            
            // Set tab state
            function setNestedTabState() {
                if (typeof currentTabState !== 'undefined') {
                    currentTabState.mainTab = 'ilp-tab';
                    currentTabState.subTab = 'learning-profile-tab';
                    currentTabState.nestedTab = 'strengths-weaknesses-tab';
                }
            }
            setNestedTabState();
            
            // Save function
            saveBtn.addEventListener('click', function() {
                const newDescription = textarea.value.trim();
                if (!newDescription) {
                    alert('Description cannot be empty.');
                    return;
                }
                
                const formData = new FormData();
                formData.append('action', 'edit_strength_weakness');
                formData.append('question_id', questionId);
                formData.append('description', newDescription);
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        if (csrfToken) formData.append('csrfmiddlewaretoken', csrfToken);
                
                // Include tab state information
                formData.append('active_tab', 'ilp-tab');
                formData.append('active_subtab', 'learning-profile-tab');
                formData.append('active_nestedtab', 'strengths-weaknesses-tab');
                
                fetch(window.location.href, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
                .then(data => {
                    if (data.success) {
                        // Instead of reloading, try to preserve tab state
                        if (data.redirect_url) {
                            window.location.href = data.redirect_url;
                        } else {
                            window.location.href = window.location.pathname + '?tab=ilp-tab&subtab=learning-profile-tab&nestedtab=strengths-weaknesses-tab';
                        }
                    } else {
                        alert(data.message || 'Error updating strength/weakness');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error updating strength/weakness. Please try again.');
                });
            });
            
            // Cancel function
            cancelBtn.addEventListener('click', function() {
                descriptionP.innerHTML = originalContent;
            });
            
            // Focus on textarea
            textarea.focus();
        }
    }
}

function deleteStrengthWeakness(questionId) {
    if (confirm('Are you sure you want to delete this strength/weakness item? This action cannot be undone.')) {
        const formData = new FormData();
        formData.append('action', 'delete_strength_weakness');
        formData.append('question_id', questionId);
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        if (csrfToken) formData.append('csrfmiddlewaretoken', csrfToken);
        
        // Include tab state information
        formData.append('active_tab', 'ilp-tab');
        formData.append('active_subtab', 'learning-profile-tab');
        formData.append('active_nestedtab', 'strengths-weaknesses-tab');
        
        fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
        .then(data => {
            if (data.success) {
                // Instead of reloading, try to preserve tab state
                if (data.redirect_url) {
                    window.location.href = data.redirect_url;
                } else {
                    window.location.href = window.location.pathname + '?tab=ilp-tab&subtab=learning-profile-tab&nestedtab=strengths-weaknesses-tab';
                }
            } else {
                alert(data.message || 'Error deleting strength/weakness');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting strength/weakness. Please try again.');
        });
    }
}

function toggleInstructorConfirmation(questionId) {
    const formData = new FormData();
    formData.append('action', 'toggle_instructor_confirmation');
    formData.append('question_id', questionId);
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        if (csrfToken) formData.append('csrfmiddlewaretoken', csrfToken);
    
    // Include tab state information
    formData.append('active_tab', 'ilp-tab');
    formData.append('active_subtab', 'learning-profile-tab');
    formData.append('active_nestedtab', 'strengths-weaknesses-tab');
    
    fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Instead of reloading, try to preserve tab state
            if (data.redirect_url) {
                window.location.href = data.redirect_url;
            } else {
                window.location.href = window.location.pathname + '?tab=ilp-tab&subtab=learning-profile-tab&nestedtab=strengths-weaknesses-tab';
            }
        } else {
            alert(data.message || 'Error updating confirmation status');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating confirmation status. Please try again.');
    });
}

function addStrengthWeakness(type) {
    const description = prompt(`Enter ${type === 'strength' ? 'strength' : 'area for development'} description:`);
    if (!description || !description.trim()) {
        return;
    }
    
    const formData = new FormData();
    formData.append('action', 'add_strength_weakness');
    formData.append('type', type);
    formData.append('description', description.trim());
    formData.append('user_id', '{{ profile_user.id }}');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        if (csrfToken) formData.append('csrfmiddlewaretoken', csrfToken);
    
    // Include tab state information
    formData.append('active_tab', 'ilp-tab');
    formData.append('active_subtab', 'learning-profile-tab');
    formData.append('active_nestedtab', 'strengths-weaknesses-tab');
    
    fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Instead of reloading, try to preserve tab state
            if (data.redirect_url) {
                window.location.href = data.redirect_url;
            } else {
                window.location.href = window.location.pathname + '?tab=ilp-tab&subtab=learning-profile-tab&nestedtab=strengths-weaknesses-tab';
            }
        } else {
            alert(data.message || 'Error adding strength/weakness');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error adding strength/weakness. Please try again.');
    });
}
</script> 