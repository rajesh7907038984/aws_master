<!-- Work Experience Records Tab Content -->
{% if not is_edit_mode or is_edit_mode and profile_user.role == 'learner' %}
<div id="employment-tab" class="tab-content">
    <div class="mb-6 flex justify-between items-center">
        <div>
            <h3 class="text-lg font-semibold">Work Experience Records</h3>
            <p class="text-sm text-gray-600 mt-1">Add and manage your work experience records</p>
        </div>
        <button type="button" id="add-employment" class="px-4 py-2 text-white rounded-lg transition-colors" style="background-color: #1c2260;" onmouseover="this.style.backgroundColor='#181f56'" onmouseout="this.style.backgroundColor='#1c2260'">
            <i class="fas fa-plus mr-2"></i> Add Work Experience Record
        </button>
    </div>

    <!-- Employment Records Accordion -->
    <div id="employment-records-accordion" class="space-y-4 mb-6">
        <!-- Existing employment records will be populated here -->
        {% if form.instance and form.instance.id %}
            <!-- Load existing employment records if in edit mode -->
            <div id="existing-employment-record" class="employment-record bg-white border border-gray-200 rounded-lg shadow-sm">
                <!-- Accordion Header -->
                <div class="employment-header px-6 py-4 bg-gray-50 border-b border-gray-200 cursor-pointer hover:bg-gray-100 transition-colors" onclick="toggleEmploymentRecord(this)">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-briefcase text-green-600 text-sm"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-900 employment-title">
                                    {% if form.job_role.value and form.job_role.value != '' %}
                                        {{ form.job_role.value|default:"Work Experience Record" }}
                                    {% else %}
                                        Work Experience Record
                                    {% endif %}
                                </h4>
                                <p class="text-sm text-gray-600 employment-summary">
                                    {% if form.industry.value and form.duration.value %}
                                        {{ form.get_industry_display }} â€¢ {{ form.get_duration_display }}
                                    {% elif form.industry.value %}
                                        {{ form.get_industry_display }}
                                    {% else %}
                                        Click to expand and view details
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            {% if form.job_role.value %}
                                <span class="employment-status-badge px-2 py-1 text-xs rounded-full bg-green-100 text-green-600">Completed</span>
                            {% else %}
                                <span class="employment-status-badge px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-600">Draft</span>
                            {% endif %}
                            <i class="fas fa-chevron-down accordion-icon text-gray-400 transition-transform"></i>
                        </div>
                    </div>
                </div>

                <!-- Accordion Content -->
                <div class="employment-content p-6" style="display: none;">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-group">
                            <label for="{{ form.job_role.id_for_label }}" class="form-label">Job Role *</label>
                            {{ form.job_role }}
                            {% if form.job_role.errors %}
                            <div class="error-message">{{ form.job_role.errors.0 }}</div>
                            {% endif %}
                            <div class="form-help-text">{{ form.job_role.help_text }}</div>
                        </div>

                        <div class="form-group">
                            <label for="{{ form.industry.id_for_label }}" class="form-label">Industry *</label>
                            {{ form.industry }}
                            {% if form.industry.errors %}
                            <div class="error-message">{{ form.industry.errors.0 }}</div>
                            {% endif %}
                            <div class="form-help-text">{{ form.industry.help_text }}</div>
                        </div>

                        <div class="form-group industry-other-container" style="display: {% if form.industry.value == 'Other' %}block{% else %}none{% endif %};">
                            <label for="{{ form.industry_other.id_for_label }}" class="form-label">Other Industry *</label>
                            {{ form.industry_other }}
                            {% if form.industry_other.errors %}
                            <div class="error-message">{{ form.industry_other.errors.0 }}</div>
                            {% endif %}
                            <div class="form-help-text">{{ form.industry_other.help_text }}</div>
                        </div>

                        <div class="form-group">
                            <label for="{{ form.duration.id_for_label }}" class="form-label">Duration</label>
                            {{ form.duration }}
                            {% if form.duration.errors %}
                            <div class="error-message">{{ form.duration.errors.0 }}</div>
                            {% endif %}
                            <div class="form-help-text">{{ form.duration.help_text }}</div>
                        </div>

                        <div class="form-group">
                            <label for="{{ form.key_skills.id_for_label }}" class="form-label">Key Skills</label>
                            {{ form.key_skills }}
                            {% if form.key_skills.errors %}
                            <div class="error-message">{{ form.key_skills.errors.0 }}</div>
                            {% endif %}
                            <div class="form-help-text">{{ form.key_skills.help_text }}</div>
                            <div class="form-help-text text-blue-600"><i class="fas fa-info-circle"></i> Skills analysis and development planning available in ILP</div>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- No Employment Records Message -->
    <div id="no-employment-message" class="text-center py-8 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300" style="display: {% if form.instance and form.instance.id and form.job_role.value %}none{% else %}block{% endif %};">
        <div class="text-gray-400 mb-4">
            <i class="fas fa-briefcase text-4xl"></i>
        </div>
        <h4 class="text-lg font-medium text-gray-900 mb-2">No Additional Work Experience Records</h4>
        <p class="text-gray-600 mb-4">Add your work experience records to build your complete profile.</p>
        <button type="button" onclick="addEmploymentRecord()" class="px-4 py-2 text-white rounded-lg transition-colors" style="background-color: #1c2260;" onmouseover="this.style.backgroundColor='#181f56'" onmouseout="this.style.backgroundColor='#1c2260'">
            <i class="fas fa-plus mr-2"></i> Add Work Experience Record
        </button>
    </div>

    <!-- Employment Record Template -->
    <template id="employment-record-template">
        <div class="employment-record bg-white border border-gray-200 rounded-lg shadow-sm">
            <!-- Accordion Header -->
            <div class="employment-header px-6 py-4 bg-gray-50 border-b border-gray-200 cursor-pointer hover:bg-gray-100 transition-colors" onclick="toggleEmploymentRecord(this)">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-briefcase text-green-600 text-sm"></i>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-900 employment-title">New Work Experience Record</h4>
                            <p class="text-sm text-gray-600 employment-summary">Click to expand and add details</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="employment-status-badge px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-600">Draft</span>
                        <button type="button" class="delete-employment text-red-500 hover:text-red-700 p-1" onclick="event.stopPropagation(); deleteEmploymentRecord(this)">
                            <i class="fas fa-trash text-sm"></i>
                        </button>
                        <i class="fas fa-chevron-down accordion-icon text-gray-400 transition-transform"></i>
                    </div>
                </div>
            </div>

            <!-- Accordion Content -->
            <div class="employment-content p-6" style="display: none;">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="form-group">
                        <label class="form-label">Job Role *</label>
                        <input type="text" name="job_role" class="form-input employment-job-role" placeholder="e.g., Office Administrator" required>
                        <div class="form-help-text">Your job title or role</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Industry *</label>
                        <select name="industry" class="form-select industry-select" required>
                            <option value="">Select industry...</option>
                            {% for value, text in form.industry.field.choices %}
                            <option value="{{ value }}">{{ text }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-help-text">{{ form.industry.help_text }}</div>
                    </div>

                    <div class="form-group industry-other-container" style="display: none;">
                        <label class="form-label">Other Industry *</label>
                        <input type="text" name="industry_other" class="form-input" placeholder="Please specify your industry">
                        <div class="form-help-text">{{ form.industry_other.help_text }}</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Duration</label>
                        <select name="duration" class="form-select employment-duration">
                            <option value="">Select duration...</option>
                            {% for value, text in form.duration.field.choices %}
                            <option value="{{ value }}">{{ text }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-help-text">{{ form.duration.help_text }}</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Company Name</label>
                        <input type="text" name="company_name" class="form-input employment-company" placeholder="e.g., ABC Corporation">
                        <div class="form-help-text">Name of the company or organization</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Key Skills</label>
                        <textarea name="key_skills" class="form-textarea employment-skills" rows="3" placeholder="e.g., Team Leadership, Data Analysis, Customer Service"></textarea>
                        <div class="form-help-text">{{ form.key_skills.help_text }}</div>
                        <div class="form-help-text text-blue-600"><i class="fas fa-info-circle"></i> Skills analysis and development planning available in ILP</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Start Date</label>
                        <input type="date" name="start_date" class="form-input employment-start-date">
                        <div class="form-help-text">When you started this position</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">End Date</label>
                        <input type="date" name="end_date" class="form-input employment-end-date">
                        <div class="form-help-text">Leave blank if currently employed</div>
                    </div>

                    <div class="form-group col-span-2">
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="currently_employed" class="form-checkbox employment-current">
                            <span class="form-label">I am currently employed in this position</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </template>
    
    <!-- Hidden count field to track number of employment entries -->
    <input type="hidden" name="employment_entry_count" id="employment_entry_count" value="1">
</div>

<script>
// Employment records functionality
document.addEventListener('DOMContentLoaded', function() {
    console.log('Employment tab script loaded');
    
    // Load existing employment records if we're in edit mode
    loadExistingEmploymentRecords();
    
    // Set up event listeners
    setupEmploymentEventListeners();
});

function loadExistingEmploymentRecords() {
    console.log('Loading existing employment records...');
    
    // Check if we have existing employment records data from the backend
    {% if existing_employment_records_json %}
        const existingRecords = {{ existing_employment_records_json|safe }};
        console.log('Found existing employment records:', existingRecords);
        
        if (existingRecords && existingRecords.length > 0) {
            const accordion = document.getElementById('employment-records-accordion');
            const noRecordsMessage = document.getElementById('no-employment-message');
            const countField = document.getElementById('employment_entry_count');
            
            if (accordion && noRecordsMessage && countField) {
                // Hide the "no records" message
                noRecordsMessage.style.display = 'none';
                
                // Clear existing content
                accordion.innerHTML = '';
                
                // Create records for each existing entry
                existingRecords.forEach((record, index) => {
                    createEmploymentRecordFromData(record, index + 1);
                });
                
                // Update the count
                countField.value = existingRecords.length;
                
                console.log(`Loaded ${existingRecords.length} employment records`);
            }
        } else {
            console.log('No existing employment records found');
        }
    {% else %}
        console.log('No employment records data available');
    {% endif %}
}

function createEmploymentRecordFromData(employData, index) {
    console.log('Creating employment record from data:', employData, 'Index:', index);
    
    const template = document.getElementById('employment-record-template');
    const accordion = document.getElementById('employment-records-accordion');
    
    if (!template || !accordion) {
        console.error('Employment template or accordion not found');
        return;
    }
    
    // Clone the template
    const newRecord = template.content.cloneNode(true);
    const recordElement = newRecord.querySelector('.employment-record');
    
    // Update the header
    const title = recordElement.querySelector('.employment-title');
    const summary = recordElement.querySelector('.employment-summary');
    const statusBadge = recordElement.querySelector('.employment-status-badge');
    
    if (title) {
        title.textContent = employData.job_role || `Work Experience Record ${index}`;
    }
    
    if (summary) {
        let summaryText = '';
        if (employData.industry && employData.duration) {
            summaryText = `${employData.industry} â€¢ ${employData.duration}`;
        } else if (employData.industry) {
            summaryText = employData.industry;
        } else if (employData.company_name) {
            summaryText = employData.company_name;
        } else {
            summaryText = 'Click to expand and view details';
        }
        summary.textContent = summaryText;
    }
    
    if (statusBadge) {
        if (employData.job_role) {
            statusBadge.textContent = 'Completed';
            statusBadge.className = 'employment-status-badge px-2 py-1 text-xs rounded-full bg-green-100 text-green-600';
        } else {
            statusBadge.textContent = 'Draft';
            statusBadge.className = 'employment-status-badge px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-600';
        }
    }
    
    // Populate form fields
    const fields = [
        { name: 'job_role', selector: '.employment-job-role' },
        { name: 'industry', selector: '.industry-select' },
        { name: 'industry_other', selector: 'input[name="industry_other"]' },
        { name: 'duration', selector: '.employment-duration' },
        { name: 'company_name', selector: '.employment-company' },
        { name: 'key_skills', selector: '.employment-skills' },
        { name: 'start_date', selector: '.employment-start-date' },
        { name: 'end_date', selector: '.employment-end-date' },
        { name: 'currently_employed', selector: '.employment-current' }
    ];
    
    fields.forEach(field => {
        const element = recordElement.querySelector(field.selector);
        if (element && employData[field.name] !== undefined) {
            if (field.name === 'currently_employed') {
                element.checked = !!employData[field.name];
            } else {
                element.value = employData[field.name] || '';
            }
        }
    });
    
    // Update field names with index
    recordElement.querySelectorAll('input, select, textarea').forEach(input => {
        const originalName = input.name;
        if (originalName) {
            input.name = `${originalName}_${index}`;
            input.id = `id_${originalName}_${index}`;
        }
    });
    
    // Handle industry "Other" field visibility
    const industrySelect = recordElement.querySelector('.industry-select');
    const otherContainer = recordElement.querySelector('.industry-other-container');
    if (industrySelect && otherContainer) {
        if (employData.industry === 'Other') {
            otherContainer.style.display = 'block';
        }
    }
    
    // Add to accordion
    accordion.appendChild(recordElement);
    
    // Set up progress listeners for this record
    setupIndustryChangeListener(recordElement);
    
    console.log(`Employment record ${index} created successfully`);
}

function setupEmploymentEventListeners() {
    const addButton = document.getElementById('add-employment');
    if (addButton) {
        addButton.addEventListener('click', addEmploymentRecord);
    }
}

function addEmploymentRecord() {
    console.log('Adding new employment record');
    
    const accordion = document.getElementById('employment-records-accordion');
    const template = document.getElementById('employment-record-template');
    const countField = document.getElementById('employment_entry_count');
    const noRecordsMessage = document.getElementById('no-employment-message');
    
    if (!accordion || !template || !countField) {
        console.error('Required elements not found for adding employment record');
        return;
    }
    
    // Hide "no records" message
    if (noRecordsMessage) {
        noRecordsMessage.style.display = 'none';
    }
    
    // Get current count and increment
    let currentCount = parseInt(countField.value) || 0;
    currentCount++;
    countField.value = currentCount;
    
    // Clone template
    const newRecord = template.content.cloneNode(true);
    const recordElement = newRecord.querySelector('.employment-record');
    
    // Update field names with index
    recordElement.querySelectorAll('input, select, textarea').forEach(input => {
        const originalName = input.name;
        if (originalName) {
            input.name = `${originalName}_${currentCount}`;
            input.id = `id_${originalName}_${currentCount}`;
        }
    });
    
    // Update title
    const title = recordElement.querySelector('.employment-title');
    if (title) {
        title.textContent = `Work Experience Record ${currentCount}`;
    }
    
    // Add to accordion
    accordion.appendChild(recordElement);
    
    // Set up industry change listener for the new record
    setupIndustryChangeListener(recordElement);
    
    // Auto-expand the new record
    const header = recordElement.querySelector('.employment-header');
    if (header) {
        setTimeout(() => toggleEmploymentRecord(header), 100);
    }
    
    // Trigger progress update for new record
    triggerProgressUpdate();
    
    console.log(`Added new employment record ${currentCount}`);
}

function toggleEmploymentRecord(headerElement) {
    const content = headerElement.parentElement.querySelector('.employment-content');
    const icon = headerElement.querySelector('.accordion-icon');
    
    if (content && icon) {
        if (content.style.display === 'none' || !content.style.display) {
            content.style.display = 'block';
            icon.style.transform = 'rotate(180deg)';
        } else {
            content.style.display = 'none';
            icon.style.transform = 'rotate(0deg)';
        }
    }
}

function deleteEmploymentRecord(deleteButton) {
    if (confirm('Are you sure you want to delete this work experience record?')) {
        const record = deleteButton.closest('.employment-record');
        const accordion = document.getElementById('employment-records-accordion');
        const countField = document.getElementById('employment_entry_count');
        const noRecordsMessage = document.getElementById('no-employment-message');
        
        if (record) {
            record.remove();
            
            // Update count
            if (countField) {
                let currentCount = parseInt(countField.value) || 0;
                currentCount = Math.max(0, currentCount - 1);
                countField.value = currentCount;
            }
            
            // Show "no records" message if no records left
            if (accordion && noRecordsMessage) {
                const remainingRecords = accordion.querySelectorAll('.employment-record');
                if (remainingRecords.length === 0) {
                    noRecordsMessage.style.display = 'block';
                }
            }
            
            // Renumber remaining records
            renumberEmploymentRecords();
            
            // Trigger progress update after deletion
            triggerProgressUpdate();
        }
    }
}

function renumberEmploymentRecords() {
    const records = document.querySelectorAll('#employment-records-accordion .employment-record');
    
    records.forEach((record, index) => {
        const newIndex = index + 1;
        
        // Update title
        const title = record.querySelector('.employment-title');
        if (title && title.textContent.startsWith('Work Experience Record')) {
            title.textContent = `Work Experience Record ${newIndex}`;
        }
        
        // Update field names
        record.querySelectorAll('input, select, textarea').forEach(input => {
            const name = input.name;
            if (name) {
                // Remove old index and add new one
                const baseName = name.replace(/_\d+$/, '');
                input.name = `${baseName}_${newIndex}`;
                input.id = `id_${baseName}_${newIndex}`;
            }
        });
    });
}

function setupIndustryChangeListener(recordElement) {
    const industrySelect = recordElement.querySelector('.industry-select');
    const otherContainer = recordElement.querySelector('.industry-other-container');
    
    if (industrySelect && otherContainer) {
        industrySelect.addEventListener('change', function() {
            if (this.value === 'Other') {
                otherContainer.style.display = 'block';
                const otherInput = otherContainer.querySelector('input');
                if (otherInput) {
                    otherInput.required = true;
                }
            } else {
                otherContainer.style.display = 'none';
                const otherInput = otherContainer.querySelector('input');
                if (otherInput) {
                    otherInput.required = false;
                    otherInput.value = '';
                }
            }
            // Trigger progress update
            triggerProgressUpdate();
        });
    }
    
    // Add progress update listeners to all form fields in this record
    const formFields = recordElement.querySelectorAll('input, select, textarea');
    formFields.forEach(field => {
        field.addEventListener('change', triggerProgressUpdate);
        field.addEventListener('input', triggerProgressUpdate);
    });
}

function triggerProgressUpdate() {
    // Debounce the update to avoid too frequent calls
    clearTimeout(window.employmentProgressTimeout);
    window.employmentProgressTimeout = setTimeout(() => {
        if (typeof updateProgressDisplay === 'function') {
            updateProgressDisplay();
        } else if (typeof window.updateProgressDisplay === 'function') {
            window.updateProgressDisplay();
        }
    }, 500);
}

// Set up global listeners for dynamically added records
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('industry-select')) {
        const record = e.target.closest('.employment-record');
        if (record) {
            setupIndustryChangeListener(record);
            // Trigger the change event to handle the current value
            e.target.dispatchEvent(new Event('change'));
        }
    }
});

// Set up progress listeners for existing employment record when page loads
document.addEventListener('DOMContentLoaded', function() {
    const existingRecord = document.getElementById('existing-employment-record');
    if (existingRecord) {
        // Add progress update listeners to all form fields in existing record
        const formFields = existingRecord.querySelectorAll('input, select, textarea');
        formFields.forEach(field => {
            field.addEventListener('change', triggerProgressUpdate);
            field.addEventListener('input', triggerProgressUpdate);
        });
    }
});

// Ensure tab state is preserved when making updates in this tab
document.addEventListener('DOMContentLoaded', function() {
    // Set tab state for form submission
    function updateTabState() {
        // Update global tab state explicitly for this tab
        if (typeof currentTabState !== 'undefined') {
            currentTabState.mainTab = 'employment-tab';
            
            console.log('Employment tab: Setting tab state to:', currentTabState);
            
            // Update hidden form fields directly
            var activeTabField = document.getElementById('activeTabField');
            if (activeTabField) activeTabField.value = currentTabState.mainTab;
        }
    }
    
    // Update tab state when the tab becomes visible
    var tabElement = document.getElementById('employment-tab');
    if (tabElement) {
        // Create a mutation observer to detect when the tab becomes visible
        var observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && 
                    mutation.attributeName === 'style' &&
                    tabElement.style.display !== 'none') {
                    updateTabState();
                }
                
                if (mutation.type === 'attributes' && 
                    mutation.attributeName === 'class' &&
                    tabElement.classList.contains('active')) {
                    updateTabState();
                }
            });
        });
        
        observer.observe(tabElement, { attributes: true });
        
        // Also check if it's already visible
        if (tabElement.style.display !== 'none' || tabElement.classList.contains('active')) {
            updateTabState();
        }
    }
    
    // Add input listeners to all form elements in this tab
    var formElements = document.querySelectorAll('#employment-tab input, #employment-tab textarea, #employment-tab select');
    formElements.forEach(function(element) {
        element.addEventListener('focus', updateTabState);
        element.addEventListener('change', updateTabState);
    });
});
</script>
{% endif %} 