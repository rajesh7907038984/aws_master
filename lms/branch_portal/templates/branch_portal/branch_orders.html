{% extends 'base.html' %}
{% load static %}

{% block title %}Order Management{% endblock %}

{% block content %}
<div class="flex-1 overflow-x-hidden overflow-y-auto bg-white">
    <div class="p-6 space-y-6 bg-white">
        <!-- Breadcrumb -->
        {% include 'components/breadcrumb.html' with breadcrumbs=breadcrumbs %}

        <!-- Main Content -->
        <div class="container mx-auto">
            <!-- Page Title -->
            <div class="mb-6 flex justify-between items-center">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Order Management</h1>
                
                <a href="{% url 'branch_portal:branch_dashboard' %}" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">
                    <i class="fas fa-chart-bar mr-2"></i> Dashboard
                </a>
            </div>

            <!-- Filters -->
            <div class="bg-white shadow-sm rounded-lg overflow-hidden border border-gray-200 mb-6">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-medium text-gray-900">Filters</h2>
                </div>
                <div class="p-6">
                    <form method="get" action="{% url 'branch_portal:branch_orders' %}" class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
                        {% if user.is_superuser and branches %}
                        <div class="sm:col-span-2">
                            <label for="branch" class="block text-sm font-medium text-gray-700">Branch</label>
                            <select id="branch" name="branch" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <option value="">All Branches</option>
                                {% for branch in branches %}
                                <option value="{{ branch.id }}" {% if request.GET.branch == branch.id|stringformat:"i" %}selected{% endif %}>{{ branch.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endif %}
                        
                        <div class="sm:col-span-{% if user.is_superuser %}1{% else %}2{% endif %}">
                            <label for="status" class="block text-sm font-medium text-gray-700">Status</label>
                            <select id="status" name="status" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <option value="">All</option>
                                <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pending</option>
                                <option value="approved" {% if status_filter == 'approved' %}selected{% endif %}>Approved</option>
                                <option value="rejected" {% if status_filter == 'rejected' %}selected{% endif %}>Rejected</option>
                                <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Completed</option>
                                <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>Cancelled</option>
                            </select>
                        </div>
                        
                        <div class="sm:col-span-{% if user.is_superuser %}1{% else %}2{% endif %}">
                            <label for="payment_status" class="block text-sm font-medium text-gray-700">Payment Status</label>
                            <select id="payment_status" name="payment_status" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <option value="">All</option>
                                <option value="pending" {% if payment_status_filter == 'pending' %}selected{% endif %}>Pending</option>
                                <option value="paid" {% if payment_status_filter == 'paid' %}selected{% endif %}>Paid</option>
                                <option value="failed" {% if payment_status_filter == 'failed' %}selected{% endif %}>Failed</option>
                                <option value="refunded" {% if payment_status_filter == 'refunded' %}selected{% endif %}>Refunded</option>
                                <option value="waived" {% if payment_status_filter == 'waived' %}selected{% endif %}>Waived</option>
                            </select>
                        </div>
                        
                        <div class="sm:col-span-{% if user.is_superuser %}1{% else %}2{% endif %}">
                            <label for="sort" class="block text-sm font-medium text-gray-700">Sort By</label>
                            <select id="sort" name="sort" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <option value="-created_at" {% if sort_by == '-created_at' %}selected{% endif %}>Newest First</option>
                                <option value="created_at" {% if sort_by == 'created_at' %}selected{% endif %}>Oldest First</option>
                                <option value="-total" {% if sort_by == '-total' %}selected{% endif %}>Highest Amount</option>
                                <option value="total" {% if sort_by == 'total' %}selected{% endif %}>Lowest Amount</option>
                                <option value="status" {% if sort_by == 'status' %}selected{% endif %}>Status (A-Z)</option>
                                <option value="-status" {% if sort_by == '-status' %}selected{% endif %}>Status (Z-A)</option>
                            </select>
                        </div>
                        
                        <div class="sm:col-span-{% if user.is_superuser %}2{% else %}3{% endif %}">
                            <label for="q" class="block text-sm font-medium text-gray-700">Search</label>
                            <div class="mt-1 flex rounded-md shadow-sm">
                                <input type="text" name="q" id="q" value="{{ search_query|default:'' }}" class="focus:ring-indigo-500 focus:border-indigo-500 flex-1 block w-full rounded-md sm:text-sm border-gray-300" placeholder="Order #, User, Email...">
                                <button type="submit" class="ml-3 inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">
                                    <i class="fas fa-search mr-2"></i> Search
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Orders Table -->
            <div class="bg-white shadow overflow-hidden sm:rounded-lg border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-medium text-gray-900">Orders</h2>
                    {% if not user.is_superuser and user_branch %}
                    <p class="text-sm text-gray-500 mt-1">Showing orders for {{ user_branch.name }}</p>
                    {% endif %}
                </div>
                
                {% if orders %}
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order #</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                {% if user.is_superuser %}
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Branch</th>
                                {% endif %}
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Payment</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for order in orders %}
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                    {{ order.order_number }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    <div class="flex items-center">
                                        <div class="text-sm font-medium text-gray-900">{{ order.user.get_full_name|default:order.user.username }}</div>
                                        <div class="text-sm text-gray-500">{{ order.user.email }}</div>
                                    </div>
                                </td>
                                {% if user.is_superuser %}
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    {{ order.branch.name }}
                                </td>
                                {% endif %}
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    {{ order.created_at|date:"M d, Y" }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                        {% if order.status == 'pending' %}bg-yellow-100 text-yellow-800
                                        {% elif order.status == 'approved' %}bg-green-100 text-green-800
                                        {% elif order.status == 'rejected' %}bg-red-100 text-red-800
                                        {% elif order.status == 'completed' %}bg-blue-100 text-blue-800
                                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                                        {{ order.get_status_display }}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                        {% if order.payment_status == 'pending' %}bg-yellow-100 text-yellow-800
                                        {% elif order.payment_status == 'paid' %}bg-green-100 text-green-800
                                        {% elif order.payment_status == 'failed' %}bg-red-100 text-red-800
                                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                                        {{ order.get_payment_status_display }}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    ${{ order.total }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                    <a href="{% url 'branch_portal:order_detail' order_number=order.order_number %}" class="text-indigo-600 hover:text-indigo-900">
                                        View Details
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                {% if orders.has_other_pages %}
                <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 sm:px-6">
                    <nav class="flex items-center justify-between" aria-label="Pagination">
                        <div class="hidden sm:block">
                            <p class="text-sm text-gray-700">
                                Showing <span class="font-medium">{{ orders.start_index }}</span> to <span class="font-medium">{{ orders.end_index }}</span> of <span class="font-medium">{{ orders.paginator.count }}</span> results
                            </p>
                        </div>
                        <div class="flex-1 flex justify-between sm:justify-end">
                            {% if orders.has_previous %}
                            <a href="?page={{ orders.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                Previous
                            </a>
                            {% endif %}
                            {% if orders.has_next %}
                            <a href="?page={{ orders.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                Next
                            </a>
                            {% endif %}
                        </div>
                    </nav>
                </div>
                {% endif %}
                
                {% else %}
                <div class="text-center py-16">
                    <div class="mx-auto h-24 w-24 text-gray-400">
                        <i class="fas fa-shopping-bag text-6xl"></i>
                    </div>
                    <h3 class="mt-2 text-lg font-medium text-gray-900">No orders found</h3>
                    <p class="mt-1 text-sm text-gray-500">
                        {% if search_query or status_filter or payment_status_filter %}
                        Try adjusting your search or filter criteria.
                        {% else %}
                        There are no orders to display yet.
                        {% endif %}
                    </p>
                    {% if search_query or status_filter or payment_status_filter %}
                    <div class="mt-6">
                        <a href="{% url 'branch_portal:branch_orders' %}" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">
                            Clear Filters
                        </a>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %} 