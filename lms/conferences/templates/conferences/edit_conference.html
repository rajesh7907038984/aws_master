{% extends 'base.html' %}
{% load static %}
{% load tinymce_tags %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    /* Form styles */
    .form-group {
        margin-bottom: 1.5rem;
    }



    .form-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: #374151;
        margin-bottom: 0.5rem;
    }

    .form-input {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #D1D5DB;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        color: #374151;
        transition: all 0.2s;
    }

    .form-input:focus {
        outline: none;
        border-color: #3B82F6;
        box-shadow: 0 0 0 1px #3B82F6;
    }

    .form-select {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #D1D5DB;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        color: #374151;
        background-color: white;
        cursor: pointer;
        transition: all 0.2s;
    }

    .form-select:focus {
        outline: none;
        border-color: #3B82F6;
        box-shadow: 0 0 0 1px #3B82F6;
    }

    .form-textarea {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #D1D5DB;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        color: #374151;
        min-height: 100px;
        transition: all 0.2s;
    }

    .form-textarea:focus {
        outline: none;
        border-color: #3B82F6;
        box-shadow: 0 0 0 1px #3B82F6;
    }

    .form-error {
        color: #DC2626;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }
    
    /* Integration selection styles */
    .integration-option {
        border: 1px solid #E5E7EB;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .integration-option:hover {
        border-color: #D1D5DB;
        background-color: #F9FAFB;
    }
    
    .integration-option.selected {
        border-color: #3B82F6;
        background-color: #EFF6FF;
    }
    
    .integration-option-header {
        display: flex;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    
    .integration-logo {
        width: 24px;
        height: 24px;
        margin-right: 0.5rem;
    }
    
    .integration-title {
        font-weight: 500;
        font-size: 0.875rem;
        color: #374151;
    }
    
    .integration-description {
        font-size: 0.75rem;
        color: #6B7280;
    }
    
    /* Ensure all form fields have 100% width */
    .form-group input,
    .form-group select,
    .form-group textarea,
    form input[type="text"],
    form input[type="email"],
    form input[type="url"],
    form input[type="date"],
    form input[type="time"],
    form input[type="datetime-local"],
    form input[type="password"],
    form select,
    form textarea {
        width: 100% !important;
        box-sizing: border-box;
    }

    /* Standardized Button Styles */
    .btn-standard {
        background-color: #050c50 !important;
        color: white !important;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 500;
        transition: all 0.2s ease;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        display: inline-flex;
        align-items: center;
        text-decoration: none;
        cursor: pointer;
    }
    
    .btn-standard:hover {
        background-color: #040a42 !important;
        color: white !important;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .btn-standard:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(5, 12, 80, 0.2);
    }
    
    .btn-standard:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }
    
    .btn-standard svg {
        margin-right: 0.5rem;
    }
    
    .btn-standard.btn-small {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
    }
    
    .btn-standard.btn-large {
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
    }
    
    .btn-standard.btn-secondary {
        background-color: #6b7280 !important;
        color: white !important;
    }
    
    .btn-standard.btn-secondary:hover {
        background-color: #4b5563 !important;
        color: white !important;
    }

    .btn-secondary {
        background-color: #6b7280 !important;
        color: white !important;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 500;
        transition: all 0.2s ease;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        display: inline-flex;
        align-items: center;
        text-decoration: none;
        cursor: pointer;
    }

    .btn-secondary:hover:not(:disabled) {
        background-color: #4b5563 !important;
        color: white !important;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .btn-secondary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Breadcrumbs -->
    {% with breadcrumbs=breadcrumbs %}
        {% include 'components/breadcrumb.html' %}
    {% endwith %}

    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
        <div class="px-6 py-4 border-b border-gray-200">
            <h1 class="text-xl font-semibold text-gray-900">{{ title }}</h1>
            <p class="mt-1 text-sm text-gray-600">{{ description }}</p>
        </div>

        <div class="px-6 py-4">
            <div class="grid grid-cols-1 gap-4">
                <form method="post" class="conference-form p-6 bg-white rounded-lg shadow">
                    {% csrf_token %}
                    
                    <!-- Form-wide errors -->
                    {% if form.non_field_errors %}
                    <div class="form-group">
                        <div class="bg-red-50 border border-red-200 rounded-md p-4">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-exclamation-triangle text-red-400"></i>
                                </div>
                                <div class="ml-3">
                                    <h4 class="text-sm font-medium text-red-800">Form Errors</h4>
                                    <div class="mt-1 text-sm text-red-700">
                                        {% for error in form.non_field_errors %}
                                        <p>{{ error }}</p>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Individual field errors -->
                    {% if form.errors %}
                    <div class="form-group">
                        <div class="bg-red-50 border border-red-200 rounded-md p-4">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-exclamation-triangle text-red-400"></i>
                                </div>
                                <div class="ml-3">
                                    <h4 class="text-sm font-medium text-red-800">Please correct the following errors:</h4>
                                    <div class="mt-1 text-sm text-red-700">
                                        {% for field, errors in form.errors.items %}
                                        <p><strong>{{ field|title }}:</strong> {{ errors|join:", " }}</p>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="grid grid-cols-1 gap-6">
                        <!-- Title -->
                        <div class="mb-4">
                            <label for="id_title" class="block text-gray-700 font-bold mb-2">Title</label>
                            {{ form.title }}
                            {% if form.title.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.title.errors }}</p>
                            {% endif %}
                            <p class="mt-1 text-xs text-gray-500">The title of your conference.</p>
                        </div>
                        
                        <!-- Description -->
                        <div class="mb-4">
                            <label for="id_description" class="block text-gray-700 font-bold mb-2">Description</label>
                            {{ form.description }}
                            {% if form.description.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.description.errors }}</p>
                            {% endif %}
                            <p class="mt-1 text-xs text-gray-500">Describe the purpose of this conference.</p>
                        </div>
                        

                        
                        <!-- Date and Time Section -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-group">
                                <label for="id_date" class="form-label">Date</label>
                                <input type="date" name="date" id="id_date" class="form-input" value="{{ form.date.value|date:'Y-m-d' }}" required>
                                {% if form.date.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.date.errors }}</p>
                                {% endif %}
                            </div>
                            
                            <div class="form-group">
                                <label for="id_timezone" class="form-label">Time Zone</label>
                                {{ form.timezone }}
                                {% if form.timezone.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.timezone.errors }}</p>
                                {% endif %}
                                <p class="mt-1 text-xs text-gray-500">Select the timezone for this conference.</p>
                            </div>
                        </div>
                        
                        <!-- Time Section -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-group">
                                <label for="id_start_time" class="form-label">Start Time</label>
                                <input type="time" name="start_time" id="id_start_time" class="form-input" value="{{ form.start_time.value|time:'H:i' }}" required>
                                {% if form.start_time.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.start_time.errors }}</p>
                                {% endif %}
                            </div>
                            
                            <div class="form-group">
                                <label for="id_end_time" class="form-label">End Time</label>
                                <input type="time" name="end_time" id="id_end_time" class="form-input" value="{{ form.end_time.value|time:'H:i' }}" required>
                                {% if form.end_time.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.end_time.errors }}</p>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Platform Selection -->
                        <div class="form-group">
                            <label for="integration_selection" class="form-label">Select Meeting Platform</label>
                            <select id="integration_selection" class="form-select">
                                <option value="">-- Select a platform --</option>
                                
                                <!-- Zoom Integrations -->
                                {% if zoom_integrations %}
                                <optgroup label="Zoom">
                                    {% for integration in zoom_integrations %}
                                    <option value="zoom:{{ integration.id }}" {% if conference.meeting_platform == 'zoom' %}selected{% endif %}>{{ integration.name }}</option>
                                    {% endfor %}
                                </optgroup>
                                {% endif %}
                                
                                <!-- Teams Integrations -->
                                {% if teams_integrations %}
                                <optgroup label="Microsoft Teams">
                                    {% for integration in teams_integrations %}
                                    <option value="teams:{{ integration.id }}" {% if conference.meeting_platform == 'teams' %}selected{% endif %}>{{ integration.name }}</option>
                                    {% endfor %}
                                </optgroup>
                                {% endif %}
                            </select>
                            {% if user.role == 'instructor' %}
                                <p class="mt-1 text-xs text-gray-500">Select the platform integration to use for this meeting. These integrations are configured by your branch administrator.</p>
                            {% else %}
                                <p class="mt-1 text-xs text-gray-500">Select the platform integration to use for this meeting. These integrations are configured in your <a href="{% url 'account_settings:settings' %}?tab=integrations" class="text-blue-600 hover:underline">Account Settings</a>.</p>
                            {% endif %}
                            
                            <!-- Create Meeting Button -->
                            <div class="mt-3">
                                <button type="button" id="create_meeting_btn" class="btn-secondary">
                                    <i class="fas fa-video mr-2"></i> Update Meeting
                                </button>
                                <span id="meeting_status" class="ml-2 text-sm text-gray-500"></span>
                            </div>
                        </div>
                        
                        <!-- Meeting Details Section (Hidden - details handled automatically) -->
                        <div id="meeting_details_section" class="hidden">
                            <!-- Meeting Platform (hidden) -->
                            <div class="form-group hidden">
                                <label for="id_meeting_platform" class="form-label">Meeting Platform</label>
                                {{ form.meeting_platform }}
                            </div>
                            
                            <!-- Hidden fields to store meeting data -->
                            <div class="hidden">
                                {{ form.meeting_link }}
                                {{ form.meeting_password }}
                                {{ form.meeting_id }}
                                {{ form.host_url }}
                            </div>
                        </div>
                        
                        <!-- Rubric -->
                        <div class="form-group">
                            <label for="id_rubric" class="form-label">Rubric</label>
                            {{ form.rubric }}
                            {% if form.rubric.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.rubric.errors }}</p>
                            {% endif %}
                            <p class="mt-1 text-xs text-gray-500">Optional rubric for evaluating participation.</p>
                        </div>
                        
                        <!-- Visibility Section (Hidden - always set to public) -->
                        {{ form.visibility }}
                        
                        <!-- Status Section -->
                        <div class="form-group">
                            <label for="id_status" class="form-label">Status</label>
                            {{ form.status }}
                            {% if form.status.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.status.errors }}</p>
                            {% endif %}
                            <p class="mt-1 text-xs text-gray-500">Conference publication status (draft, published).</p>
                        </div>
                        
                        <!-- Access Information -->
                        <div class="form-group">
                            <div class="bg-blue-50 border border-blue-200 rounded-md p-4">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-info-circle text-blue-400"></i>
                                    </div>
                                    <div class="ml-3">
                                        <h4 class="text-sm font-medium text-blue-800">Conference Access Settings</h4>
                                        <div class="mt-1 text-sm text-blue-700">
                                            <p><strong>Access:</strong> {{ conference.get_default_join_type_display|default:"Course registered users only" }}</p>
                                            <p><strong>Join Experience:</strong> {{ conference.get_join_experience_display|default:"Standard form (name + email auto-filled)" }}</p>
                                            <p class="mt-2 text-xs">User names and emails are automatically passed to the meeting link.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Submit Button -->
                        <div class="flex justify-end space-x-3">
                            <a href="{% url 'conferences:conference_list' %}" 
                            class="btn-standard btn-secondary">
                                Cancel
                            </a>
                            <button type="submit" 
                                class="btn-standard">
                                Update Conference
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Form handling for conference creation
        const form = document.querySelector('form');
        const integrationSelect = document.getElementById('integration_selection');
        const meetingDetailsSection = document.getElementById('meeting_details_section');
        const meetingPlatformInput = document.getElementById('id_meeting_platform');
        const createMeetingBtn = document.getElementById('create_meeting_btn');
        const meetingStatusSpan = document.getElementById('meeting_status');
        
        // Show/hide meeting details based on platform selection
        integrationSelect?.addEventListener('change', function() {
            const selectedValue = integrationSelect.value;
            
            if (selectedValue) {
                createMeetingBtn.disabled = false;
                
                // Set the platform in the hidden input
                if (selectedValue.startsWith('zoom:')) {
                    meetingPlatformInput.value = 'zoom';
                } else if (selectedValue.startsWith('teams:')) {
                    meetingPlatformInput.value = 'teams';
                }
                
                // Hide meeting details initially for platform integrations
                // They'll be shown after creating the meeting
                meetingDetailsSection.classList.add('hidden');
            } else {
                // No selection
                createMeetingBtn.disabled = true;
                meetingDetailsSection.classList.add('hidden');
                meetingPlatformInput.value = '';
            }
        });
        
        // Meeting details are handled automatically and remain hidden
        
        // Validate form before submission
        form.addEventListener('submit', function(e) {
            // Validate date and time
            const startTime = document.getElementById('id_start_time').value;
            const endTime = document.getElementById('id_end_time').value;
            
            if (startTime && endTime && startTime >= endTime) {
                e.preventDefault();
                alert('End time must be after start time');
                return;
            }
            
            // Check if meeting platform is selected
            const meetingPlatform = meetingPlatformInput.value;
            if (!meetingPlatform) {
                e.preventDefault();
                alert('Please select a meeting platform');
                return;
            }
            
            // Meeting details are handled automatically when platform is selected
        });

        // Set up event listener for create meeting button
        createMeetingBtn?.addEventListener('click', function() {
            const selectedValue = integrationSelect.value;
            
            if (!selectedValue) {
                alert('Please select a platform integration first.');
                return;
            }
            
            createMeeting();
        });
    });

    // Create meeting via API
    function createMeeting() {
        // Get selected integration
        const integrationSelect = document.getElementById('integration_selection');
        const meetingDetailsSection = document.getElementById('meeting_details_section');
        const selectedValue = integrationSelect.value;
        const meetingStatusSpan = document.getElementById('meeting_status');
        
        if (!selectedValue) {
            alert('Please select a platform integration.');
            return;
        }
        
        // Parse the platform and integration ID
        const [platform, integrationId] = selectedValue.split(':');
        
        // Get meeting details
        const title = document.getElementById('id_title').value;
        const description = document.getElementById('id_description').value;
        const date = document.getElementById('id_date').value;
        const startTime = document.getElementById('id_start_time').value;
        const endTime = document.getElementById('id_end_time').value;
        
        if (!title || !date || !startTime || !endTime) {
            alert('Please fill in all required meeting details (title, date, start and end time).');
            return;
        }
        
        // Show loading indicator
        const button = document.getElementById('create_meeting_btn');
        const originalText = button.textContent;
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Updating...';
        meetingStatusSpan.textContent = 'Updating meeting...';
        
        // Update hidden input with the platform
        document.getElementById('id_meeting_platform').value = platform;
        
        // Combine date and time fields to create ISO datetime strings
        const startDateTime = new Date(`${date}T${startTime}`).toISOString();
        const endDateTime = new Date(`${date}T${endTime}`).toISOString();
        
        // Make API request
        fetch('{% url "conferences:create_meeting_api" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                platform: platform,
                integration_id: integrationId,
                title: title,
                description: description,
                start_datetime: startDateTime,
                end_datetime: endDateTime
            })
        })
        .then(response => {
            // First check if response is ok before parsing JSON
            if (!response.ok) {
                // Get status code for better error handling
                const status = response.status;
                
                // Try to parse error JSON first
                return response.json().then(errorData => {
                    // Throw error with the API message if available
                    throw new Error(errorData.error || `Server error (${status})`);
                }).catch(jsonError => {
                    // If JSON parsing fails, use status text
                    throw new Error(`Server error (${status}): ${response.statusText}`);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Set the meeting data in the hidden inputs
                document.getElementById('id_meeting_link').value = data.meeting_link || '';
                document.getElementById('id_meeting_password').value = data.password || '';
                document.getElementById('id_meeting_id').value = data.meeting_id || '';
                document.getElementById('id_host_url').value = data.host_url || '';
                
                // Meeting details are stored but not displayed to user
                
                // Show success message
                meetingStatusSpan.textContent = 'Meeting updated successfully!';
                
                // Update the button
                button.innerHTML = '<i class="fas fa-check mr-2"></i> Updated!';
                setTimeout(() => {
                    button.disabled = false;
                    button.innerHTML = 'Update Meeting';
                }, 2000);
            } else {
                throw new Error(data.error || 'Failed to update meeting');
            }
        })
        .catch(error => {
            console.error('Error updating meeting:', error);
            meetingStatusSpan.textContent = `Error: ${error.message}`;
            button.disabled = false;
            button.innerHTML = originalText;
        });
    }
    
    // Helper function to show toast notifications
    function showToast(message, type = 'info') {
        // Check if toast container exists, create if not
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            toastContainer.className = 'fixed top-4 right-4 z-50';
            document.body.appendChild(toastContainer);
        }
        
        // Create toast element
        const toast = document.createElement('div');
        toast.className = `py-2 px-4 mb-3 rounded shadow-md transform transition-all duration-500 ease-in-out`;
        
        // Set color based on type
        if (type === 'success') {
            toast.className += ' bg-green-100 border-l-4 border-green-500 text-green-700';
        } else if (type === 'error') {
            toast.className += ' bg-red-100 border-l-4 border-red-500 text-red-700';
        } else {
            toast.className += ' bg-blue-100 border-l-4 border-blue-500 text-blue-700';
        }
        
        // Set content
        toast.innerHTML = `
            <div class="flex items-center">
                <div class="py-1">
                    <p class="text-sm">${message}</p>
                </div>
            </div>
        `;
        
        // Add to container
        toastContainer.appendChild(toast);
        
        // Remove after 3 seconds
        setTimeout(() => {
            toast.classList.add('opacity-0', 'translate-x-full');
            setTimeout(() => {
                toastContainer.removeChild(toast);
            }, 500);
        }, 3000);
    }
</script>

<!-- Initialize TinyMCE for description field -->
{% tinymce_js %}
{% tinymce_init %}
{% endblock %}

 