{% extends "base.html" %}
{% load static %}
{% load course_filters %}

{% block title %}Edit Course - {{ course.title }}{% endblock %}

{% block extra_head %}
<meta name="page-context" content="course-creation">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
{% endblock %}

{% block extra_css %}
<link href="{% static 'core/css/course_create.css' %}" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<!-- Include TinyMCE Widget Components with AI Support -->
<script src="{% static 'tinymce_editor/tinymce/tinymce.min.js' %}"></script>
<script src="{% static 'tinymce_editor/js/tinymce-widget.js' %}"></script>
<link href="{% static 'tinymce_editor/css/tinymce-widget.css' %}" rel="stylesheet">
<link href="{% static 'tinymce_editor/css/aiwriter.css' %}" rel="stylesheet">

<!-- Include DOMPurify for XSS protection -->
<script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.7/dist/purify.min.js"></script>







<style>
    /* Color picker styles */
    .simple-color-picker {
        position: absolute;
        z-index: 1000;
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 5px;
        background-color: white;
        border-radius: 4px;
        padding: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        max-width: 250px;
    }

    .color-swatch {
        width: 20px;
        height: 20px;
        border-radius: 3px;
        cursor: pointer;
        border: 1px solid #ddd;
        transition: transform 0.1s ease;
    }

    .color-swatch:hover {
        transform: scale(1.2);
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
    }

    .tooltip.color-picker button::after {
        content: "";
        display: block;
        width: 14px;
        height: 3px;
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        border-radius: 1px;
    }

    #text-color-btn, #bg-color-btn {
        position: relative;
    }



    /* Enhanced Text Editor styles */
    .custom-editor-toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 0.375rem 0.375rem 0 0;
        padding: 10px 15px;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .custom-editor-toolbar button {
        background: #ffffff;
        border: 1px solid #e5e7eb;
        padding: 6px 8px;
        cursor: pointer;
        font-size: 16px;
        color: #1f2937;
        height: 36px;
        min-width: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        border-radius: 4px;
    }

    .custom-editor-toolbar button:hover {
        background: #f3f4f6;
        color: #111827;
    }

    .custom-editor-toolbar button:active,
    .custom-editor-toolbar button.active {
        background: #3b82f6;
        color: #ffffff;
    }

    .custom-text-editor {
        min-height: 300px;
        background: #ffffff;
        color: #1f2937;
        font-family: 'Inter', sans-serif;
        font-size: 14px;
        line-height: 1.5;
        padding: 16px;
        border: 1px solid #e5e7eb;
        border-top: none;
        border-radius: 0 0 0.375rem 0.375rem;
        outline: none;
        overflow-y: auto;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Editor stats */
    .editor-stats {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: #4b5563;
        padding: 6px 10px;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-top: none;
        border-radius: 0 0 0.375rem 0.375rem;
    }

    /* Format dropdown */
    .format-dropdown {
        height: 36px;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        padding: 0 10px;
        background: #ffffff;
        font-size: 14px;
        color: #1f2937;
        cursor: pointer;
        min-width: 120px;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%231f2937'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 8px center;
        background-size: 16px;
        padding-right: 30px;
    }

    /* Custom text editor content styles */
    .custom-text-editor h1,
    .custom-text-editor h2,
    .custom-text-editor h3,
    .custom-text-editor h4 {
        color: #111827;
    }

    .custom-text-editor h1 {
        font-size: 1.75rem;
        font-weight: 700;
        margin-top: 1.5rem;
        margin-bottom: 1rem;
    }
    
    .custom-text-editor h2 {
        font-size: 1.5rem;
        font-weight: 600;
        margin-top: 1.25rem;
        margin-bottom: 0.75rem;
    }
    
    .custom-text-editor h3 {
        font-size: 1.25rem;
        font-weight: 600;
        margin-top: 1rem;
        margin-bottom: 0.5rem;
    }
    
    .custom-text-editor h4 {
        font-size: 1.125rem;
        font-weight: 600;
        margin-top: 0.75rem;
        margin-bottom: 0.5rem;
    }

    .custom-text-editor blockquote {
        border-left: 3px solid #3b82f6;
        padding-left: 1rem;
        margin-left: 0;
        margin-right: 0;
        font-style: italic;
        color: #4b5563;
        background-color: rgba(59, 130, 246, 0.1);
    }

    /* Enhanced Section Title Styles for Bottom Tabs */
    .tab-section-title {
        position: relative;
        color: #374151;
        font-weight: 600;
        font-size: 1.25rem;
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #f3f4f6;
        background: linear-gradient(90deg, #f8fafc 0%, #ffffff 100%);
        padding-left: 0.75rem;
        border-radius: 0.25rem 0.25rem 0 0;
    }

    .tab-section-title::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background: linear-gradient(180deg, #3b82f6, #1d4ed8);
        border-radius: 2px;
    }

    .tab-section-title:hover {
        color: #1f2937;
        border-bottom-color: #e5e7eb;
    }
        padding: 0.75rem 1rem;
        border-radius: 0.25rem;
    }
    
    .custom-text-editor pre {
        background-color: #f3f4f6;
        padding: 1rem;
        border-radius: 0.375rem;
        overflow-x: auto;
        font-family: 'Courier New', monospace;
        margin-bottom: 1rem;
        border: 1px solid #e5e7eb;
    }
    
    .custom-text-editor code {
        font-family: 'Courier New', monospace;
        background-color: #f3f4f6;
        padding: 0.125rem 0.25rem;
        border-radius: 0.25rem;
        font-size: 0.875em;
        color: #1f2937;
    }
    
    /* Link styles */
    .custom-text-editor a {
        color: #3b82f6;
        text-decoration: underline;
    }

    .custom-text-editor a:hover {
        color: #2563eb;
    }

    /* Table styles */
    .editor-table {
        border-collapse: collapse;
        width: 100%;
        margin: 15px 0;
        font-size: 14px;
        color: #1f2937;
    }
    
    .editor-table th,
    .editor-table td {
        border: 1px solid #e5e7eb;
        padding: 8px;
    }
    
    .editor-table th {
        font-weight: bold;
        background-color: transparent;
    }
    
    .editor-table tr:nth-child(even) {
        background-color: #f9fafb;
    }
    
    .editor-table tr:hover {
        background-color: #f3f4f6;
    }

    /* Image resize controls */
    .image-resize-controls,
    .video-resize-controls {
        background: white;
        border: 1px solid #e5e7eb;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .resize-control-header {
        background: #f9fafb;
        color: #1f2937;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .resize-control-options button {
        background: #ffffff;
        border: 1px solid #e5e7eb;
        color: #1f2937;
    }
    
    .resize-control-options button:hover {
        background: #f3f4f6;
    }

    /* Mobile optimization */
    @media (max-width: 768px) {
        .custom-editor-toolbar {
            flex-wrap: wrap;
            gap: 5px;
            padding: 8px;
        }

        .custom-editor-toolbar button {
            padding: 5px;
            font-size: 14px;
            height: 32px;
            min-width: 32px;
        }

        .format-dropdown {
            min-width: 100px;
            height: 32px;
            font-size: 13px;
        }

        .toolbar-separator {
            height: 20px;
        }

        /* Mobile form improvements */
        .container {
            padding-left: 1rem;
            padding-right: 1rem;
        }

        /* Make inputs more touch-friendly */
        input[type="text"],
        input[type="email"],
        input[type="file"],
        textarea,
        select {
            min-height: 44px;
            padding: 12px;
            font-size: 16px; /* Prevents zoom on iOS */
        }

        /* Better spacing for mobile */
        .space-y-4 > * + * {
            margin-top: 1.5rem;
        }

        .gap-6 {
            gap: 1rem;
        }

        /* Mobile file upload container */
        .file-upload-container {
            padding: 1rem;
        }

        .file-upload-container .flex {
            flex-direction: column;
            align-items: stretch;
            gap: 1rem;
        }

        .file-upload-container .w-full {
            margin-bottom: 1rem;
        }

        /* Fix image preview container spacing and positioning */
        .course-image-container {
            margin-top: 1rem;
            clear: both;
            width: 100%;
        }

        /* Ensure upload controls don't overlap with preview */
        .file-upload-container .space-y-4 > * + * {
            margin-top: 1rem;
        }

        /* Better mobile layout for upload sections */
        .file-upload-container > div {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* Prevent button position conflicts on mobile */
        .file-upload-container .flex.flex-col.sm\\:flex-row {
            flex-direction: column !important;
            align-items: stretch !important;
            gap: 0.75rem !important;
        }

        /* Upload label button mobile fix */
        .file-upload-container .file-upload-label {
            width: 100%;
            text-align: center;
            justify-content: center;
            display: flex;
            align-items: center;
        }

        /* Additional mobile styles for upload controls */
        .upload-controls {
            display: flex;
            flex-direction: column !important;
            align-items: stretch !important;
            gap: 1rem !important;
            width: 100%;
        }

        .upload-controls > div {
            margin-bottom: 0 !important;
        }

        /* Ensure proper spacing for upload info text */
        .upload-controls .flex.items-center.space-x-2 {
            justify-content: center;
            margin-bottom: 0.75rem;
        }

        /* Make buttons more touch-friendly */
        button,
        .file-upload-label,
        .btn {
            min-height: 44px;
            padding: 12px 16px;
            font-size: 16px;
        }

        /* Section and topic management mobile styles */
        .section-item,
        .topic-item {
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .section-item .flex,
        .topic-item .flex {
            flex-direction: column;
            gap: 0.75rem;
        }

        /* Hide less important elements on very small screens */
        @media (max-width: 480px) {
            .text-sm {
                font-size: 14px;
            }
            
            .space-y-4 > * + * {
                margin-top: 1rem;
            }
        }

        /* Mobile accordion styles for tabs */
        .tab-accordion-container {
            display: block;
        }
        
        .tab-headers-desktop {
            display: none;
        }

        .tab-accordion-item {
            border-bottom: 1px solid #e5e7eb;
        }

        .tab-accordion-header {
            width: 100%;
            padding: 1rem;
            text-align: left;
            background: #f9fafb;
            border: none;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }

        .tab-accordion-header:hover {
            background: #f3f4f6;
        }

        .tab-accordion-header.active {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .tab-accordion-icon {
            transition: transform 0.2s;
            margin-left: auto;
        }

        .tab-accordion-header.active .tab-accordion-icon {
            transform: rotate(180deg);
        }

        .tab-accordion-content {
            display: none;
            padding: 1rem;
            background: white;
        }

        .tab-accordion-content.active {
            display: block;
        }
    }

    /* Desktop tab styles */
    @media (min-width: 769px) {
        .tab-accordion-container {
            display: none;
        }
        
        .tab-headers-desktop {
            display: flex;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Ensure desktop tab content container is visible */
        .desktop-tab-content-container {
            display: block;
        }
    }

    /* Additional mobile optimizations for tab content */
    @media (max-width: 768px) {
        /* Hide desktop tab content area on mobile */
        .desktop-tab-content-container {
            display: none;
        }
        
        /* Ensure accordion content is properly spaced */
        .tab-accordion-content {
            line-height: 1.6;
        }
        
        .tab-accordion-content .space-y-4 > * + * {
            margin-top: 1rem;
        }
        
        .tab-accordion-content .mb-6 {
            margin-bottom: 1rem;
        }
    }

    /* Focus and hover indicators */
    .custom-text-editor:focus-within {
        border-color: #60a5fa;
        box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.2);
    }

    .description-editor-container {
        position: relative;
        margin-bottom: 20px;
    }

    /* Editor state handling */

    /* Responsive image handling */
    .custom-text-editor img {
        max-width: 100%;
        height: auto;
        border-radius: 4px;
    }

    /* Accessibility improvements */
    .custom-editor-toolbar button:focus {
        outline: 2px solid #60a5fa;
        outline-offset: 2px;
    }

    /* Custom Text Editor styles */
    .custom-editor-toolbar button {
        background: transparent;
        border: none;
        padding: 6px 8px;
        cursor: pointer;
        font-size: 16px;
        color: #374151;
        height: 32px;
        min-width: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        border-radius: 4px;
    }

    .custom-editor-toolbar button:hover {
        background: #f3f4f6;
    }

    .custom-editor-toolbar button:active {
        background: #e5e7eb;
    }

    .toolbar-separator {
        width: 1px;
        height: 24px;
        background: #e5e7eb;
        margin: 0 4px;
    }

    .custom-text-editor {
        min-height: 300px;
        background: #ffffff;
        color: #1f2937;
        font-family: 'Inter', sans-serif;
        font-size: 14px;
        line-height: 1.5;
        padding: 16px;
        border: 1px solid #e5e7eb;
        border-top: none;
        outline: none;
    }

    .custom-text-editor:focus {
        border-color: #3b82f6;
    }

    .format-dropdown {
        height: 32px;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        padding: 0 10px;
        background: #ffffff;
        font-size: 14px;
        color: #374151;
        cursor: pointer;
        min-width: 120px;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 8px center;
        background-size: 16px;
        padding-right: 30px;
    }

    .format-dropdown:hover {
        border-color: #d1d5db;
    }

    .format-dropdown:focus {
        outline: none;
        border-color: #3b82f6;
    }

    .color-picker {
        position: relative;
    }

    .color-picker input[type="color"] {
        position: absolute;
        top: 32px;
        left: 0;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s, visibility 0.2s;
    }

    .color-picker input[type="color"].visible {
        opacity: 1;
        visibility: visible;
        z-index: 10;
    }

    /* Ensure tab content is shown properly */
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    /* Prevent inactive tab content from creating blank space */
    .tab-content:not(.active) {
        height: 0 !important;
        overflow: hidden !important;
        padding: 0 !important;
        margin: 0 !important;
    }
    
    /* Fix for topic container layout */
    .topic-item .flex.items-center {
        display: flex;
        align-items: center;
        width: 80%;
        overflow: hidden;
    }
    
    /* Fix for section header layout */
    .section-item .flex.items-center {
        display: flex;
        align-items: center;
        width: 100%;
        overflow: hidden;
    }
    
    /* Styles for resize controls */
    .image-resize-controls,
    .video-resize-controls {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        padding: 0;
        z-index: 100;
        overflow: hidden;
        width: 200px;
    }
    
    /* TinyMCE Editor White Background Styling */
    .tox-tinymce {
        background-color: white !important;
        border: 1px solid #e5e7eb !important;
        border-radius: 0.375rem !important;
    }
    
    .tox-edit-area,
    .tox-edit-area iframe {
        background-color: white !important;
    }
    
    #course_description_parent .tox-tinymce,
    #course_description_parent .tox-edit-area,
    #course_description_parent .tox-edit-area iframe {
        background-color: white !important;
        color: #1f2937 !important;
    }
    
    /* Ensure TinyMCE toolbar has proper styling */
    .tox-toolbar {
        background-color: #f9fafb !important;
        border-bottom: 1px solid #e5e7eb !important;
    }
    
    /* Status bar styling */
    .tox-statusbar {
        background-color: #f9fafb !important;
        border-top: 1px solid #e5e7eb !important;
    }
    
    /* Override gray backgrounds to white */
    .bg-gray-700 {
        background-color: rgb(255, 255, 255) !important;
        color: black !important;
        border-color: #e5e7eb !important; /* Light gray border */
    }
    
    .resize-control-header {
        background: #f3f4f6;
        padding: 6px 10px;
        font-size: 14px;
        font-weight: 500;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .resize-control-options {
        display: flex;
        flex-wrap: wrap;
        padding: 8px;
        gap: 4px;
    }
    
    .resize-control-options button {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        padding: 4px 8px;
        font-size: 12px;
        cursor: pointer;
        flex-grow: 1;
        min-width: 40px;
    }
    
    .resize-control-options button:hover {
        background: #f3f4f6;
        border-color: #d1d5db;
    }
    
    /* Selected image/video styles */
    .img-selected,
    .video-selected {
        outline: 2px solid #3b82f6;
        border-radius: 2px;
    }
    
    /* Table styles */
    .editor-table {
        border-collapse: collapse;
        width: 100%;
        margin: 15px 0;
        font-size: 14px;
        color: #f3f4f6;
    }
    
    .editor-table th,
    .editor-table td {
        border: 1px solid #4b5563;
        padding: 8px;
    }
    
    .editor-table th {
        background-color: #374151;
        font-weight: bold;
    }
    
    .editor-table tr:hover {
        background-color: #374151;
    }
    
    /* Custom video container styles */
    .custom-text-editor .video-container {
        position: relative;
        padding-bottom: 56.25%; /* 16:9 aspect ratio */
        height: 0;
        overflow: hidden;
        max-width: 100%;
        margin: 15px 0;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    
    .custom-text-editor .video-container iframe,
    .custom-text-editor .video-container video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border-radius: 4px;
    }
    
    .custom-text-editor .video-container iframe,
    .custom-text-editor .video-container video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border-radius: 4px;
    }
    
    .custom-editor-toolbar button.active {
        background-color: #e5e7eb;
        color: #1f2937;
    }

    /* Make the editor container look cleaner */
    .description-editor-container {
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        overflow: hidden;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    }
    
    /* Styling for uploaded images in the editor */
    .custom-text-editor img {
        max-width: 100%;
        height: auto;
        border-radius: 4px;
        margin: 8px 0;
        display: block;
    }
    
    .custom-text-editor img:hover {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    /* Image selection styles */
    .img-selected {
        outline: 2px solid #3b82f6;
        border-radius: 4px;
    }
    
    /* Drag and Drop Styles */
    .sortable-ghost {
        opacity: 0.4;
        background: #f3f4f6;
        border: 2px dashed #9ca3af;
    }
    
    .sortable-chosen {
        background: #dbeafe;
        border-color: #3b82f6;
    }
    
    .sortable-drag {
        transform: rotate(5deg);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }
    
    .section-dragging-active .section-item:not(.is-dragging) {
        opacity: 0.7;
    }
    
    .topic-dragging-active .topic-item:not(.is-dragging) {
        opacity: 0.7;
    }
    
    .section-drag-handle,
    .topic-drag-handle {
        cursor: grab;
        transition: opacity 0.2s ease;
    }
    
    .section-drag-handle:active,
    .topic-drag-handle:active {
        cursor: grabbing;
    }
    
    .section-drag-handle:hover,
    .topic-drag-handle:hover {
        opacity: 1 !important;
    }
    
    /* Section Accordion Styles */
    .section-toggle {
        transition: transform 0.2s ease;
        cursor: pointer;
    }
    
    .section-collapsed .section-toggle {
        transform: rotate(-90deg);
    }
    
    .section-topics {
        transition: all 0.3s ease;
        overflow: hidden;
    }
    
    .section-collapsed .section-topics {
        max-height: 0;
        padding: 0;
        margin: 0;
        opacity: 0;
    }
    
    /* Video button dropdown styles */
    .video-btn-container {
        position: relative;
        display: inline-block;
    }
    
    .video-options {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        background-color: white;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        z-index: 10;
        min-width: 160px;
    }
    
    .video-options button {
        display: block;
        width: 100%;
        text-align: left;
        padding: 8px 12px;
        border: none;
        background: none;
    }
    
    .video-options button:hover {
        background-color: #f3f4f6;
    }
    
    .video-btn-container:hover .video-options {
        display: block;
    }
    
    /* Video styles in editor */
    .custom-text-editor .video-embed {
        max-width: 100%;
        margin: 8px 0;
    }
    
    /* Video container styles */
    .video-container {
        position: relative;
        padding-bottom: 56.25%;
        height: 0;
        overflow: hidden;
        max-width: 100%;
        margin: 15px 0;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .video-container iframe,
    .video-container video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border-radius: 4px;
    }
    
    /* Loading spinner styles */
    .img-loading {
        display: flex;
        align-items: center;
        padding: 12px;
        margin: 8px 0;
        background-color: #f3f4f6;
        border-radius: 4px;
        border: 1px dashed #d1d5db;
    }
    
    .img-loading-spinner {
        width: 20px;
        height: 20px;
        border: 2px solid #e5e7eb;
        border-top-color: #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 8px;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .img-upload-error {
        display: inline-block;
        padding: 8px;
        margin: 8px 0;
        background-color: #fee2e2;
        color: #ef4444;
        border-radius: 4px;
        border: 1px solid #fecaca;
    }

    /* Custom text editor content styles */
    .custom-text-editor h1 {
        font-size: 1.75rem;
        font-weight: 700;
        margin-top: 1.5rem;
        margin-bottom: 1rem;
        color: #f9fafb;
    }
    
    .custom-text-editor h2 {
        font-size: 1.5rem;
        font-weight: 600;
        margin-top: 1.25rem;
        margin-bottom: 0.75rem;
        color: #f9fafb;
    }
    
    .custom-text-editor h3 {
        font-size: 1.25rem;
        font-weight: 600;
        margin-top: 1rem;
        margin-bottom: 0.5rem;
        color: #f9fafb;
    }
    
    .custom-text-editor h4 {
        font-size: 1.125rem;
        font-weight: 600;
        margin-top: 0.75rem;
        margin-bottom: 0.5rem;
        color: #f9fafb;
    }
    
    .custom-text-editor p {
        margin-bottom: 1rem;
        line-height: 1.6;
    }
    
    .custom-text-editor ul, 
    .custom-text-editor ol {
        margin-bottom: 1rem;
        padding-left: 1.5rem;
    }
    
    .custom-text-editor ul li {
        list-style-type: disc;
        margin-bottom: 0.25rem;
    }
    
    .custom-text-editor ol li {
        list-style-type: decimal;
        margin-bottom: 0.25rem;
    }
    
    .custom-text-editor blockquote {
        border-left: 3px solid #60a5fa;
        padding-left: 1rem;
        margin-left: 0;
        margin-right: 0;
        font-style: italic;
        color: #d1d5db;
        background-color: rgba(96, 165, 250, 0.1);
        padding: 0.75rem 1rem;
        border-radius: 0.25rem;
    }
    
    .custom-text-editor pre {
        background-color: #111827;
        padding: 1rem;
        border-radius: 0.375rem;
        overflow-x: auto;
        font-family: 'Courier New', monospace;
        margin-bottom: 1rem;
        border: 1px solid #374151;
    }
    
    .custom-text-editor code {
        font-family: 'Courier New', monospace;
        background-color: #111827;
        padding: 0.125rem 0.25rem;
        border-radius: 0.25rem;
        font-size: 0.875em;
    }
    
    /* Link styles */
    .custom-text-editor a {
        color: #60a5fa;
        text-decoration: underline;
    }

    .custom-text-editor a:hover {
        color: #93c5fd;
    }
    
    /* Image selection styles */
    .custom-text-editor .img-selected {
        outline: 2px solid #60a5fa;
        box-shadow: 0 0 0 4px rgba(96, 165, 250, 0.3);
    }
    
    /* Video container styles */
    .custom-text-editor .video-container {
        border: 1px solid #4b5563;
        background-color: #111827;
    }
    
    /* Image resize controls */
    .image-resize-controls,
    .video-resize-controls {
        background: #1f2937;
        border: 1px solid #4b5563;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    
    .resize-control-header {
        background: #374151;
        color: #f3f4f6;
        border-bottom: 1px solid #4b5563;
    }
    
    .resize-control-options button {
        background: #4b5563;
        border: 1px solid #6b7280;
        color: #f3f4f6;
    }
    
    .resize-control-options button:hover {
        background: #6b7280;
    }

    /* Improved format buttons */
    .custom-editor-toolbar .format-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        min-width: 32px;
        height: 32px;
        border: 1px solid #e5e7eb;
        background: #ffffff;
        border-radius: 4px;
        transition: all 0.2s ease;
    }
    
    .custom-editor-toolbar .format-btn:hover {
        background: #f3f4f6;
    }
    
    .custom-editor-toolbar .format-btn.active {
        background: #3b82f6;
        color: #ffffff;
        border-color: #3b82f6;
    }
    
    .custom-editor-toolbar .format-btn .text-xs {
        font-size: 10px;
        margin-left: 2px;
        font-weight: bold;
    }
    
    /* Updated tooltip style to be more visible */
    .custom-editor-toolbar .tooltip .tooltip-text {
        visibility: hidden;
        width: auto;
        min-width: 60px;
        background-color: #374151;
        color: #ffffff;
        text-align: center;
        padding: 4px 8px;
        border-radius: 4px;
        position: absolute;
        z-index: 100;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        opacity: 0;
        transition: opacity 0.2s;
        font-size: 11px;
        pointer-events: none;
        font-weight: normal;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }
    
    .custom-editor-toolbar .tooltip:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
    }

    .custom-editor-toolbar .format-btn.heading-btn {
        font-family: 'Inter', sans-serif;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #111827;
    }
    
    .custom-editor-toolbar .format-btn.heading-btn:hover {
        background-color: #f3f4f6;
    }
    
    .custom-editor-toolbar .format-btn.heading-btn.active {
        background-color: #3b82f6;
        color: #ffffff;
    }
    
    .custom-editor-toolbar .format-btn.heading-btn strong {
        font-weight: 600;
    }

    .tooltip color-picker {
        position: relative;
    }

    .tooltip color-picker input[type="color"] {
        position: absolute;
        top: 32px;
        left: 0;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s;
    }

    .tooltip color-picker input[type="color"].visible {
        opacity: 1;
        visibility: visible;
        z-index: 10;
    }

    /* Fix for color picker */
    .tooltip.color-picker {
        position: relative;
    }

    .tooltip.color-picker input[type="color"] {
        position: absolute;
        top: 32px;
        left: 0;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s;
    }

    .tooltip.color-picker input[type="color"].visible {
        opacity: 1;
        visibility: visible;
        z-index: 10;
    }

    /* Add MathJax stylesheet for equation styling */
    .math-equation {
        display: inline-block;
        padding: 2px 4px;
        margin: 0 2px;
        background-color: #f8f9fa;
        border-radius: 4px;
        font-family: 'Latin Modern Math', 'STIX Two Math', 'Times New Roman', serif;
    }

    /* Enhanced color picker functionality */
    .tooltip.color-picker {
        position: relative;
    }

    .tooltip.color-picker::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 10px;
        height: 3px;
        background-color: transparent;
        transition: background-color 0.2s;
    }

    .tooltip.color-picker.active::after {
        background-color: #3b82f6;
    }

    .tooltip.color-picker input[type="color"] {
        position: absolute;
        top: 32px;
        left: 0;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s, visibility 0.2s;
        z-index: 100;
        width: 40px;
        height: 40px;
        cursor: pointer;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        padding: 2px;
    }

    .tooltip.color-picker input[type="color"].visible {
        opacity: 1;
        visibility: visible;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    /* Improved color picker */
    .tooltip.color-picker input[type="color"] {
        position: absolute;
        top: 34px;
        left: 0;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s, visibility 0.2s;
        z-index: 1000;
        width: 40px;
        height: 40px;
        cursor: pointer;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        padding: 2px;
        background-color: white;
    }

    .tooltip.color-picker input[type="color"].visible {
        opacity: 1;
        visibility: visible;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    /* Color indicator on buttons */
    #text-color-btn:after,
    #bg-color-btn:after {
        content: "";
        display: block;
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 16px;
        height: 3px;
        border-radius: 1px;
    }

    #text-color-btn:after {
        background-color: #000;
    }

    #bg-color-btn:after {
        background-color: #fff;
    }

    /* Improved color picker visibility */
    .tooltip.color-picker input[type="color"] {
        position: absolute;
        top: 34px;
        left: 0;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s, visibility 0.2s;
        z-index: 1000;
        width: 40px;
        height: 40px;
        cursor: pointer;
    }

    .tooltip.color-picker input[type="color"].visible {
        opacity: 1;
        visibility: visible;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    /* Improved color picker visibility */
    .tooltip.color-picker {
        position: relative;
    }

    .tooltip.color-picker input[type="color"] {
        position: absolute;
        top: 40px;
        left: 0;
        width: 40px;
        height: 40px;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s, visibility 0.2s;
        z-index: 1000;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        background-color: white;
        padding: 2px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .tooltip.color-picker input[type="color"].visible {
        opacity: 1;
        visibility: visible;
    }

    /* Color indicators for the buttons */
    #text-color-btn::after,
    #bg-color-btn::after {
        content: "";
        display: block;
        position: absolute;
        bottom: -2px;
        left: 50%;
        transform: translateX(-50%);
        width: 80%;
        height: 3px;
        border-radius: 1.5px;
    }

    #text-color-btn::after {
        background-color: #000000;
    }

    #bg-color-btn::after {
        background-color: #ffffff;
    }

    /* Fix for course submit button - override global button styles with higher specificity */
    form#courseCreateForm button#course-submit-button[type="submit"] {
        background-color: #1c2260 !important;
        color: white !important;
        border: none !important;
        padding: 0.5rem 1rem !important;
        border-radius: 0.375rem !important;
        font-weight: 500 !important;
        transition: all 0.2s ease !important;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05) !important;
    }

    form#courseCreateForm button#course-submit-button[type="submit"]:hover {
        background-color: #181f56 !important;
        color: white !important;
        transform: translateY(-1px) !important;
        box-shadow: 0 4px 6px rgba(28, 34, 96, 0.2) !important;
    }

    form#courseCreateForm button#course-submit-button[type="submit"]:focus {
        outline: none !important;
        box-shadow: 0 0 0 2px #3b82f6 !important;
    }

    /* Fallback with even higher specificity */
    div.mt-6 form#courseCreateForm button#course-submit-button[type="submit"][name="direct_submit"] {
        background-color: #1c2260 !important;
    }
    
    div.mt-6 form#courseCreateForm button#course-submit-button[type="submit"][name="direct_submit"]:hover {
        background-color: #181f56 !important;
    }

    /* Enhanced color picker */
    .tooltip.color-picker {
        position: relative;
    }

    .tooltip.color-picker input[type="color"] {
        position: absolute;
        top: 34px;
        left: -10px;
        width: 60px;
        height: 60px;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
        z-index: 9999;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        background-color: white;
        padding: 4px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        cursor: pointer;
    }

    .tooltip.color-picker input[type="color"].visible {
        opacity: 1;
        visibility: visible;
    }

    /* Color indicators for the buttons */
    #text-color-btn::after,
    #bg-color-btn::after {
        content: "";
        display: block;
        position: absolute;
        bottom: -4px;
        left: 50%;
        transform: translateX(-50%);
        width: 80%;
        height: 4px;
        border-radius: 2px;
    }

    #text-color-btn::after {
        background-color: #000000;
    }

    #bg-color-btn::after {
        background-color: #ffffff;
        border: 1px solid #d1d5db;
    }

    /* Remove conflicting styles */
    .tooltip color-picker,
    .color-picker,
    .tooltip.color-picker::after {
        /* Clear old styles */
    }

    /* Enhanced color picker - Fix display issues */
    .tooltip.color-picker {
        position: relative !important;
    }

    .tooltip.color-picker input[type="color"] {
        position: fixed !important; /* Changed from absolute to fixed for better positioning */
        width: 80px !important;
        height: 80px !important;
        opacity: 1 !important; /* Always keep it visible once activated */
        visibility: hidden;
        transition: visibility 0.3s !important;
        z-index: 99999 !important; /* Ensure it's above everything */
        border: 1px solid #e5e7eb !important;
        border-radius: 4px !important;
        background-color: white !important;
        padding: 4px !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
        cursor: pointer !important;
    }

    .tooltip.color-picker input[type="color"].visible {
        visibility: visible !important;
    }

    /* Remove conflicting styles */
    .tooltip color-picker,
    .color-picker,
    .tooltip.color-picker::after {
        /* Clear old styles */
    }

    /* Updated color button click handler */
    if (textColorBtn && textColorPicker) {
        textColorBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation(); // Prevent event bubbling
            
            // Position the color picker near the button
            const rect = this.getBoundingClientRect();
            textColorPicker.style.top = (rect.bottom + 5) + 'px';
            textColorPicker.style.left = rect.left + 'px';
            
            // Close the other color picker if open
            if (bgColorPicker && bgColorPicker.classList.contains('visible')) {
                bgColorPicker.classList.remove('visible');
                if (bgColorBtn && bgColorBtn.parentNode) {
                    bgColorBtn.parentNode.classList.remove('active');
                }
            }
            
            // Toggle this color picker
            textColorPicker.classList.toggle('visible');
            this.parentNode.classList.toggle('active');
            
            // If visible, directly click it (works better across browsers)
            if (textColorPicker.classList.contains('visible')) {
                textColorPicker.click();
            }
        });
        
        // Ensure the color picker stays visible during interaction
        textColorPicker.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    }

    if (bgColorBtn && bgColorPicker) {
        bgColorBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation(); // Prevent event bubbling
            
            // Position the color picker near the button
            const rect = this.getBoundingClientRect();
            bgColorPicker.style.top = (rect.bottom + 5) + 'px';
            bgColorPicker.style.left = rect.left + 'px';
            
            // Close the other color picker if open
            if (textColorPicker && textColorPicker.classList.contains('visible')) {
                textColorPicker.classList.remove('visible');
                if (textColorBtn && textColorBtn.parentNode) {
                    textColorBtn.parentNode.classList.remove('active');
                }
            }
            
            // Toggle this color picker
            bgColorPicker.classList.toggle('visible');
            this.parentNode.classList.toggle('active');
            
            // If visible, directly click it (works better across browsers)
            if (bgColorPicker.classList.contains('visible')) {
                bgColorPicker.click();
            }
        });
        
        // Ensure the color picker stays visible during interaction
        bgColorPicker.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    }

    /* Define a set of preset colors for the color picker */
    .color-preset-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 5px;
        padding: 10px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        position: absolute;
        z-index: 9999;
        top: 100%;
        left: 0;
        width: 160px;
    }

    .color-preset {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        border: 1px solid rgba(0,0,0,0.1);
        cursor: pointer;
        transition: transform 0.1s;
    }

    .color-preset:hover {
        transform: scale(1.1);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    /* Hide the original color picker inputs */
    .tooltip.color-picker input[type="color"] {
        display: none;
    }

    /* Simple fade animation for the color grid */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .color-preset-grid {
        animation: fadeIn 0.2s ease-out;
    }

    /* Replace the color picker click handlers with our custom implementation */
    if (textColorBtn) {
        textColorBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // Close any open color pickers
            const existingPickers = document.querySelectorAll('.color-preset-grid');
            existingPickers.forEach(picker => picker.remove());
            
            // Create a color preset grid
            const presetColors = [
                '#000000', '#434343', '#666666', '#999999', '#b7b7b7',
                '#ff0000', '#ff4d00', '#ffb800', '#ffff00', '#8cff00',
                '#00ff00', '#00ff99', '#00ffff', '#0099ff', '#0000ff',
                '#9900ff', '#ff00ff', '#ff0099', '#990000', '#994d00',
                '#997000', '#999900', '#4d9900', '#009900', '#009999'
            ];
            
            const colorGrid = document.createElement('div');
            colorGrid.className = 'color-preset-grid';
            
            presetColors.forEach(color => {
                const colorButton = document.createElement('div');
                colorButton.className = 'color-preset';
                colorButton.style.backgroundColor = color;
                colorButton.title = color;
                
                colorButton.addEventListener('click', function() {
                    // Apply text color to selected text
                    applyTextColor(color);
                    
                    // Update button indicator
                    updateTextColorIndicator(color);
                    
                    // Close the color picker
                    colorGrid.remove();
                });
                
                colorGrid.appendChild(colorButton);
            });
            
            // Add a custom color option at the bottom
            const customColorBtn = document.createElement('div');
            customColorBtn.className = 'color-preset';
            customColorBtn.style.background = 'linear-gradient(135deg, red, blue)';
            customColorBtn.title = 'Custom color';
            customColorBtn.style.gridColumn = '1 / -1';
            customColorBtn.style.height = '20px';
            customColorBtn.style.marginTop = '5px';
            customColorBtn.style.textAlign = 'center';
            
            customColorBtn.addEventListener('click', function() {
                // Create a temporary input type=color and click it
                const tempColorInput = document.createElement('input');
                tempColorInput.type = 'color';
                tempColorInput.style.position = 'absolute';
                tempColorInput.style.visibility = 'hidden';
                document.body.appendChild(tempColorInput);
                
                tempColorInput.addEventListener('change', function() {
                    const color = this.value;
                    applyTextColor(color);
                    updateTextColorIndicator(color);
                    colorGrid.remove();
                    this.remove();
                });
                
                tempColorInput.click();
            });
            
            colorGrid.appendChild(customColorBtn);
            
            // Position the grid relative to the button
            const buttonRect = this.getBoundingClientRect();
            colorGrid.style.top = (buttonRect.bottom + window.scrollY) + 'px';
            colorGrid.style.left = (buttonRect.left + window.scrollX) + 'px';
            document.body.appendChild(colorGrid);
            
            // Close when clicking outside
            document.addEventListener('click', function closeColorGrid(e) {
                if (!colorGrid.contains(e.target) && e.target !== textColorBtn) {
                    colorGrid.remove();
                    document.removeEventListener('click', closeColorGrid);
                }
            });
            
            // Helper function to apply color to selected text
            function applyTextColor(color) {
                // Make sure we have selection or focus in the editor
                const selection = window.getSelection();
                
                if (selection.rangeCount === 0 && descriptionEditor) {
                    // If no selection, focus the editor
                    descriptionEditor.focus();
                }
                
                // Apply the color
                document.execCommand('foreColor', false, color);
                
                // Update hidden input with new content
                if (descriptionEditor && hiddenInput) {
                    const html = DOMPurify ? DOMPurify.sanitize(descriptionEditor.innerHTML) : descriptionEditor.innerHTML;
                    hiddenInput.value = JSON.stringify({
                        delta: {},
                        html: html
                    });
                    updateTextStats();
                }
            }
            
            // Helper function to update the color indicator on the button
            function updateTextColorIndicator(color) {
                // Update the visual indicator
                textColorBtn.setAttribute('data-current-color', color);
                textColorBtn.style.borderBottom = `3px solid ${color}`;
            }
        });
    }

    if (bgColorBtn) {
        bgColorBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // Close any open color pickers
            const existingPickers = document.querySelectorAll('.color-preset-grid');
            existingPickers.forEach(picker => picker.remove());
            
            // Create a color preset grid
            const presetColors = [
                '#ffffff', '#f8f9fa', '#e9ecef', '#dee2e6', '#ced4da',
                '#ffcccb', '#ffcc99', '#ffffcc', '#ccffcc', '#ccffff',
                '#ccccff', '#ffccff', '#f8d7da', '#d1e7dd', '#cff4fc',
                '#fff3cd', '#f8f9fa', '#e2e3e5', '#d9d9d9', '#bfbfbf',
                '#ffe6e6', '#fff9e6', '#ffffea', '#f1f8e9', '#e0f7fa'
            ];
            
            const colorGrid = document.createElement('div');
            colorGrid.className = 'color-preset-grid';
            
            presetColors.forEach(color => {
                const colorButton = document.createElement('div');
                colorButton.className = 'color-preset';
                colorButton.style.backgroundColor = color;
                colorButton.title = color;
                
                colorButton.addEventListener('click', function() {
                    // Apply background color to selected text
                    applyBgColor(color);
                    
                    // Update button indicator
                    updateBgColorIndicator(color);
                    
                    // Close the color picker
                    colorGrid.remove();
                });
                
                colorGrid.appendChild(colorButton);
            });
            
            // Add a custom color option at the bottom
            const customColorBtn = document.createElement('div');
            customColorBtn.className = 'color-preset';
            customColorBtn.style.background = 'linear-gradient(135deg, lightblue, white)';
            customColorBtn.title = 'Custom color';
            customColorBtn.style.gridColumn = '1 / -1';
            customColorBtn.style.height = '20px';
            customColorBtn.style.marginTop = '5px';
            customColorBtn.style.textAlign = 'center';
            
            customColorBtn.addEventListener('click', function() {
                // Create a temporary input type=color and click it
                const tempColorInput = document.createElement('input');
                tempColorInput.type = 'color';
                tempColorInput.style.position = 'absolute';
                tempColorInput.style.visibility = 'hidden';
                document.body.appendChild(tempColorInput);
                
                tempColorInput.addEventListener('change', function() {
                    const color = this.value;
                    applyBgColor(color);
                    updateBgColorIndicator(color);
                    colorGrid.remove();
                    this.remove();
                });
                
                tempColorInput.click();
            });
            
            colorGrid.appendChild(customColorBtn);
            
            // Position the grid relative to the button
            const buttonRect = this.getBoundingClientRect();
            colorGrid.style.top = (buttonRect.bottom + window.scrollY) + 'px';
            colorGrid.style.left = (buttonRect.left + window.scrollX) + 'px';
            document.body.appendChild(colorGrid);
            
            // Close when clicking outside
            document.addEventListener('click', function closeColorGrid(e) {
                if (!colorGrid.contains(e.target) && e.target !== textColorBtn) {
                    colorGrid.remove();
                    document.removeEventListener('click', closeColorGrid);
                }
            });
            
            // Helper function to apply background color to selected text
            function applyBgColor(color) {
                // Make sure we have selection or focus in the editor
                const selection = window.getSelection();
                
                if (selection.rangeCount === 0 && descriptionEditor) {
                    // If no selection, focus the editor
                    descriptionEditor.focus();
                }
                
                // Apply the background color
                document.execCommand('hiliteColor', false, color);
                
                // Update hidden input with new content
                if (descriptionEditor && hiddenInput) {
                    const html = DOMPurify ? DOMPurify.sanitize(descriptionEditor.innerHTML) : descriptionEditor.innerHTML;
                    hiddenInput.value = JSON.stringify({
                        delta: {},
                        html: html
                    });
                    updateTextStats();
                }
            }
            
            // Helper function to update the background color indicator on the button
            function updateBgColorIndicator(color) {
                // Update the visual indicator
                bgColorBtn.setAttribute('data-current-color', color);
                bgColorBtn.style.borderBottom = `3px solid ${color}`;
            }
        });
    }

    /* Simple color picker styles */
    .simple-color-picker {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 5px;
        padding: 10px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        position: absolute;
        z-index: 9999;
        width: 150px;
    }

    .color-swatch {
        width: 20px;
        height: 20px;
        border-radius: 3px;
        cursor: pointer;
        border: 1px solid rgba(0,0,0,0.1);
    }

    .color-swatch:hover {
        transform: scale(1.1);
    }

    /* Color picker styles */
    .custom-editor-toolbar .color-picker {
        position: relative;
    }

    .custom-editor-toolbar .color-picker input[type="color"] {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
        padding: 0;
        border: none;
    }

    .custom-editor-toolbar .color-picker button {
        position: relative;
        border-bottom: 3px solid transparent;
    }

    .custom-editor-toolbar .color-picker button::after {
        content: "";
        position: absolute;
        bottom: -3px;
        left: 0;
        right: 0;
        height: 3px;
    }

    #text-color-btn::after {
        background-color: #000000;
    }

    #bg-color-btn::after {
        background-color: #ffffff;
        border: 1px solid #d1d5db;
    }

    /* Just adding this style to improve visibility */
    .custom-editor-toolbar .color-picker button:active,
    .custom-editor-toolbar .color-picker button:focus {
        outline: 2px solid #3b82f6;
    }

    /* Color swatch styles */
    .simple-color-picker {
        position: absolute;
        z-index: 1000;
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        padding: 8px;
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .color-swatch {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        cursor: pointer;
        border: 1px solid #d1d5db;
    }

    .color-swatch:hover {
        transform: scale(1.1);
    }

    /* Color picker popup styles */
    .simple-color-picker {
        position: absolute;
        z-index: 1000;
        display: grid;
        grid-template-columns: repeat(10, 1fr);
        gap: 5px;
        background-color: white;
        border-radius: 4px;
        padding: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        max-width: 250px;
    }

    .color-swatch {
        width: 20px;
        height: 20px;
        border-radius: 3px;
        cursor: pointer;
        border: 1px solid #ddd;
        transition: transform 0.1s ease;
    }

    .color-swatch:hover {
        transform: scale(1.2);
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
    }

    /* Improved tooltip and color picker styling */
    .tooltip.color-picker button::after {
        content: "";
        display: block;
        width: 14px;
        height: 3px;
        background-color: currentColor;
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        border-radius: 1px;
    }

    .tooltip.color-picker.active button::after {
        background-color: var(--current-color, #000);
    }

    /* Final override for submit button styling - highest specificity */
    html body .content-container form#courseCreateForm div.mt-6 button#course-submit-button[type="submit"][name="direct_submit"] {
        background-color: #1c2260 !important;
        color: white !important;
        border: none !important;
        padding: 0.5rem 1rem !important;
        border-radius: 0.375rem !important;
        font-weight: 500 !important;
        transition: all 0.2s ease !important;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05) !important;
    }
    
    html body .content-container form#courseCreateForm div.mt-6 button#course-submit-button[type="submit"][name="direct_submit"]:hover {
        background-color: #181f56 !important;
        color: white !important;
        transform: translateY(-1px) !important;
        box-shadow: 0 4px 6px rgba(28, 34, 96, 0.2) !important;
    }
</style>
{% endblock %}

{% block extra_js %}
    {{ block.super }}
    <!-- Sortable.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js" integrity="sha512-Eezs+g9Lq4TCCq0wae01s9PuNWzHYoCMkE97e2qdkYthpI0pzC3UGB03lgEHn2XM85hDOUF6qgqqszs+iXU4UA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <!-- Simple Category Handler -->
    <script src="{% static 'categories/js/simple_category.js' %}?v={{ timestamp|default:'20250126_drag_drop_complete_fix' }}"></script>
    
    <!-- Fixed Section Delete Handler -->
    <script src="{% static 'js/courses/section_delete_fixed.js' %}?v={{ timestamp|default:'20250126_drag_drop_complete_fix' }}"></script>
    
    <!-- URL injection for JavaScript -->
    <script>
        // Inject Django URLs for use by static JavaScript files
        window.TOPIC_CREATE_URL_TEMPLATE = "{% url 'courses:topic_create' course_id=0 %}";
        
        // Cache busting for drag and drop fixes - 2025-01-26
        console.log('🎯 Course Edit Template Loaded - Drag & Drop Fixes Applied');
        console.log('🔄 Template Version: 2025-01-26-drag-drop-complete-fix');
        console.log('⏰ Load Time:', new Date().toISOString());
        console.log('🔧 Features: Section Accordion + Cross-Section Topic Drag + Section Reorder');
        
        // Force template reload detection
        window.DRAG_DROP_FIXES_LOADED = true;
        window.TEMPLATE_VERSION = '2025-01-26-complete';
        
    </script>
    
    <!-- Additional scripts for topic management -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            // Check for SCORM upload completion notification
            checkSCORMUploadCompletion();
            
            // Initialize topic status toggling
            initializeTopicStatusToggle();
            
            // Initialize section accordion functionality
            function initializeSectionAccordion() {
                console.log('🔧 Initializing section accordion...');
                
                // Add click handlers to section toggle buttons
                const sectionToggles = document.querySelectorAll('.section-toggle');
                sectionToggles.forEach(toggle => {
                    toggle.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // Find the section container
                        const sectionContainer = this.closest('.section-item');
                        if (!sectionContainer) return;
                        
                        // Find the section topics container
                        const sectionTopics = sectionContainer.querySelector('.section-topics');
                        if (!sectionTopics) return;
                        
                        // Toggle the section
                        const isCollapsed = sectionTopics.style.display === 'none';
                        
                        if (isCollapsed) {
                            // Expand section
                            sectionTopics.style.display = 'block';
                            this.style.transform = 'rotate(0deg)';
                            sectionContainer.classList.remove('section-collapsed');
                            console.log('Section expanded');
                        } else {
                            // Collapse section
                            sectionTopics.style.display = 'none';
                            this.style.transform = 'rotate(-90deg)';
                            sectionContainer.classList.add('section-collapsed');
                            console.log('Section collapsed');
                        }
                    });
                });
                
                console.log('✅ Section accordion initialized');
            }
            
            // Make section accordion function globally available
            window.initializeSectionAccordion = initializeSectionAccordion;
            
            // Initialize sections sortable functionality
            function initializeSectionsSortable() {
                console.log('🔧 Initializing sections sortable...');
                
                // Check if Sortable is available
                if (typeof Sortable === 'undefined') {
                    console.warn('Sortable library not available for sections');
                    return;
                }
                
                // Find sections container
                const sectionsContainer = document.getElementById('sections-container');
                console.log('Sections container found:', sectionsContainer);
                
                if (!sectionsContainer) {
                    console.warn('Sections container not found');
                    return;
                }
                
                // Skip if already initialized
                if (sectionsContainer.hasAttribute('data-sortable-initialized')) {
                    console.log('Sections sortable already initialized');
                    return;
                }
                
                try {
                    new Sortable(sectionsContainer, {
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        chosenClass: 'sortable-chosen',
                        dragClass: 'sortable-drag',
                        handle: '.section-drag-handle',
                        onStart: function(evt) {
                            console.log('Section drag started');
                            document.body.classList.add('section-dragging-active');
                            evt.item.classList.add('is-dragging');
                            evt.item.setAttribute('data-drag-active', 'true');
                        },
                        onEnd: function(evt) {
                            console.log('Section drag ended');
                            document.body.classList.remove('section-dragging-active');
                            evt.item.classList.remove('is-dragging');
                            evt.item.removeAttribute('data-drag-active');
                            
                            // Save new order if needed
                            if (evt.oldIndex !== evt.newIndex) {
                                console.log('Section order changed:', evt.oldIndex, '->', evt.newIndex);
                                saveSectionOrder();
                            }
                        }
                    });
                    
                    sectionsContainer.setAttribute('data-sortable-initialized', 'true');
                    console.log('✅ Sections sortable initialized successfully');
                } catch (error) {
                    console.error('Error initializing sections sortable:', error);
                }
            }
            
            // Initialize topics sortable functionality with cross-section support
            function initializeTopicsSortable() {
                console.log('🔧 Initializing topics sortable with cross-section support...');
                
                // Check if Sortable is available
                if (typeof Sortable === 'undefined') {
                    console.warn('Sortable library not available');
                    return;
                }
                
                // Find all topic containers
                const topicContainers = document.querySelectorAll('.topic-list, .topics-container, [data-sortable="true"]');
                console.log('Found topic containers:', topicContainers.length);
                
                // Create a group for cross-section dragging
                const sortableOptions = {
                    group: 'topics', // Allow dragging between containers
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    dragClass: 'sortable-drag',
                    handle: '.topic-drag-handle, .drag-handle',
                    onStart: function(evt) {
                        console.log('Topic drag started');
                        document.body.classList.add('topic-dragging-active');
                        evt.item.classList.add('is-dragging');
                        evt.item.setAttribute('data-drag-active', 'true');
                        
                        // Store original section info
                        const originalContainer = evt.from;
                        const originalSectionId = originalContainer.getAttribute('data-section-id');
                        evt.item.setAttribute('data-original-section', originalSectionId);
                    },
                    onEnd: function(evt) {
                        console.log('Topic drag ended');
                        document.body.classList.remove('topic-dragging-active');
                        evt.item.classList.remove('is-dragging');
                        evt.item.removeAttribute('data-drag-active');
                        
                        // Check if topic moved to different section
                        const originalSectionId = evt.item.getAttribute('data-original-section');
                        const newContainer = evt.to;
                        const newSectionId = newContainer.getAttribute('data-section-id');
                        
                        console.log('Topic moved from section', originalSectionId, 'to section', newSectionId);
                        
                        // Save the new order and section
                        if (originalSectionId !== newSectionId || evt.oldIndex !== evt.newIndex) {
                            console.log('Topic order/section changed:', evt.oldIndex, '->', evt.newIndex);
                            saveTopicOrderWithSectionChange(evt.item, newContainer, originalSectionId, newSectionId);
                        }
                        
                        // Clean up
                        evt.item.removeAttribute('data-original-section');
                    }
                };
                
                topicContainers.forEach(container => {
                    // Skip if already initialized
                    if (container.hasAttribute('data-sortable-initialized')) {
                        return;
                    }
                    
                    try {
                        new Sortable(container, sortableOptions);
                        container.setAttribute('data-sortable-initialized', 'true');
                        console.log('✅ Sortable initialized for container:', container.getAttribute('data-section-id'));
                    } catch (error) {
                        console.error('Error initializing sortable for container:', container, error);
                    }
                });
                
                console.log('✅ Topics sortable with cross-section support initialized');
            }
            
            // Function to save section order
            async function saveSectionOrder() {
                try {
                    console.log('💾 Saving section order...');
                    const sectionsContainer = document.getElementById('sections-container');
                    const sectionItems = sectionsContainer.querySelectorAll('.section-item[data-id]');
                    const sectionOrders = [];
                    
                    console.log('Found section items:', sectionItems.length);
                    
                    sectionItems.forEach((item, index) => {
                        const sectionId = item.getAttribute('data-id');
                        console.log(`Section ${index}: ID=${sectionId}`);
                        if (sectionId && sectionId !== 'standalone') {
                            sectionOrders.push({
                                section_id: parseInt(sectionId),
                                order: index + 1
                            });
                        }
                    });
                    
                    if (sectionOrders.length === 0) {
                        console.log('No sections to reorder');
                        return;
                    }
                    
                    console.log('Saving section order:', sectionOrders);
                    
                    const csrfToken = getCSRFToken();
                    console.log('CSRF token:', csrfToken ? 'Found' : 'Not found');
                    
                    const response = await fetch('/courses/api/sections/reorder/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({
                            course_id: {{ course.id }},
                            section_orders: sectionOrders
                        })
                    });
                    
                    console.log('Section reorder response status:', response.status);
                    const data = await response.json();
                    console.log('Section reorder response data:', data);
                    
                    if (data.success) {
                        console.log('✅ Section order saved successfully');
                        showNotification('Section order updated successfully', 'success');
                    } else {
                        console.error('❌ Failed to save section order:', data.error);
                        showNotification('Failed to update section order: ' + data.error, 'error');
                    }
                } catch (error) {
                    console.error('❌ Error saving section order:', error);
                    showNotification('Error updating section order: ' + error.message, 'error');
                }
            }
            
            // Function to save topic order with section change
            async function saveTopicOrderWithSectionChange(topicItem, newContainer, originalSectionId, newSectionId) {
                try {
                    console.log('💾 Saving topic order with section change...');
                    console.log('Topic:', topicItem.dataset.topicId, 'from section:', originalSectionId, 'to section:', newSectionId);
                    
                    const topicId = topicItem.getAttribute('data-topic-id');
                    if (!topicId) {
                        console.error('Topic ID not found');
                        return;
                    }
                    
                    // Get all topics in the new section to determine order
                    const topicItems = newContainer.querySelectorAll('.topic-item[data-topic-id]');
                    const newOrder = Array.from(topicItems).indexOf(topicItem) + 1;
                    
                    console.log('New order for topic:', newOrder);
                    
                    const csrfToken = getCSRFToken();
                    if (!csrfToken) {
                        console.error('CSRF token not found');
                        showNotification('Security token not found. Please refresh the page.', 'error');
                        return;
                    }
                    
                    // Call the topic move API
                    const response = await fetch('/courses/api/topics/move/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({
                            course_id: {{ course.id }},
                            topic_id: parseInt(topicId),
                            section_id: newSectionId === 'standalone' ? null : parseInt(newSectionId),
                            new_order: newOrder
                        })
                    });
                    
                    console.log('Topic move response status:', response.status);
                    const data = await response.json();
                    console.log('Topic move response data:', data);
                    
                    if (data.success) {
                        console.log('✅ Topic moved successfully');
                        showNotification('Topic moved successfully', 'success');
                        
                        // Update the topic's data attributes
                        topicItem.setAttribute('data-section-id', newSectionId);
                    } else {
                        console.error('❌ Failed to move topic:', data.error);
                        showNotification('Failed to move topic: ' + data.error, 'error');
                        
                        // Revert the move by moving the topic back
                        const originalContainer = document.querySelector(`[data-section-id="${originalSectionId}"] .topic-list`);
                        if (originalContainer) {
                            originalContainer.appendChild(topicItem);
                        }
                    }
                } catch (error) {
                    console.error('❌ Error moving topic:', error);
                    showNotification('Error moving topic: ' + error.message, 'error');
                }
            }
            
            // Function to save topic order
            async function saveTopicOrder(container) {
                try {
                    console.log('💾 Saving topic order...');
                    const sectionId = container.getAttribute('data-section-id');
                    const topicItems = container.querySelectorAll('.topic-item[data-topic-id]');
                    const topicOrders = [];
                    
                    console.log('Found topic items:', topicItems.length, 'in section:', sectionId);
                    
                    topicItems.forEach((item, index) => {
                        const topicId = item.getAttribute('data-topic-id');
                        console.log(`Topic ${index}: ID=${topicId}`);
                        if (topicId) {
                            topicOrders.push({
                                topic_id: parseInt(topicId),
                                order: index + 1
                            });
                        }
                    });
                    
                    if (topicOrders.length === 0) {
                        console.log('No topics to reorder');
                        return;
                    }
                    
                    console.log('Saving topic order for section:', sectionId, topicOrders);
                    
                    const csrfToken = getCSRFToken();
                    console.log('CSRF token:', csrfToken ? 'Found' : 'Not found');
                    
                    const response = await fetch('/courses/api/topics/reorder/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({
                            course_id: {{ course.id }},
                            section_id: sectionId === 'standalone' ? null : parseInt(sectionId),
                            topic_orders: topicOrders
                        })
                    });
                    
                    console.log('Topic reorder response status:', response.status);
                    const data = await response.json();
                    console.log('Topic reorder response data:', data);
                    
                    if (data.success) {
                        console.log('✅ Topic order saved successfully');
                        showNotification('Topic order updated successfully', 'success');
                    } else {
                        console.error('❌ Failed to save topic order:', data.error);
                        showNotification('Failed to update topic order: ' + data.error, 'error');
                    }
                } catch (error) {
                    console.error('❌ Error saving topic order:', error);
                    showNotification('Error updating topic order: ' + error.message, 'error');
                }
            }
            
            // Function to show notifications
            function showNotification(message, type = 'info', duration = 3000) {
                // Remove existing notifications
                const existingNotifications = document.querySelectorAll('.drag-drop-notification');
                existingNotifications.forEach(notification => notification.remove());
                
                const notification = document.createElement('div');
                notification.className = `drag-drop-notification fixed bottom-4 right-4 px-6 py-3 rounded shadow-lg z-50 transition-all duration-300`;
                
                // Set colors based on type
                switch(type) {
                    case 'success': 
                        notification.classList.add('bg-green-500', 'text-white');
                        break;
                    case 'error': 
                        notification.classList.add('bg-red-500', 'text-white');
                        break;
                    case 'warning': 
                        notification.classList.add('bg-yellow-500', 'text-white');
                        break;
                    default: 
                        notification.classList.add('bg-blue-500', 'text-white');
                }
                
                notification.innerHTML = message;
                document.body.appendChild(notification);
                
                // Auto-remove after duration
                setTimeout(() => {
                    notification.classList.add('opacity-0');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, duration);
            }
            
            // Ensure the sortable initialization happens after the page is fully loaded
            // Also wait for sections and topics to be properly rendered
            function initializeSortableWhenReady() {
                // Check if sections and topics containers exist
                const sectionsContainer = document.getElementById('sections-container');
                const topicContainers = document.querySelectorAll('.topic-list, .topics-container, [data-sortable="true"]');
                
                if (sectionsContainer && topicContainers.length > 0) {
                    // Initialize sections sortable
                    initializeSectionsSortable();
                    // Initialize topics sortable
                    initializeTopicsSortable();
                    console.log('✅ Sortable initialization completed');
                } else {
                    // Retry after a short delay
                    console.log('🔄 Containers not ready, retrying in 200ms...');
                    setTimeout(initializeSortableWhenReady, 200);
                }
            }
            
            setTimeout(initializeSortableWhenReady, 300);
            
            // Add a failsafe to detect and fix any stuck drag operations
            document.addEventListener('mouseup', function() {
                if (document.body.classList.contains('topic-dragging-active')) {
                    document.body.classList.remove('topic-dragging-active');
                }
                
                if (document.body.classList.contains('section-dragging-active')) {
                    document.body.classList.remove('section-dragging-active');
                }
                
                document.querySelectorAll('.is-dragging').forEach(el => {
                    el.classList.remove('is-dragging');
                });
                
                document.querySelectorAll('[data-drag-active="true"]').forEach(el => {
                    el.removeAttribute('data-drag-active');
                });
            });
            
            // Function to handle topic status toggling
            function initializeTopicStatusToggle() {
                const toggleButtons = document.querySelectorAll('.toggle-status-btn');
                toggleButtons.forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        const topicId = this.dataset.topicId;
                        const currentStatus = this.dataset.status;
                        const newStatus = currentStatus === 'draft' ? 'active' : 'draft';
                        
                        // Get CSRF token
                        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                        
                        // Show loading state on the button
                        const originalInnerHTML = this.innerHTML;
                        this.innerHTML = `<svg class="animate-spin h-3.5 w-3.5 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>`;
                        
                        // Send AJAX request to update status
                        fetch('/courses/topic/' + topicId + '/toggle-status/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest',
                                'X-CSRFToken': csrfToken
                            },
                            body: JSON.stringify({ status: newStatus })
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.success) {
                                // Update button state with the status returned from the server
                                const serverStatus = data.new_status;
                                this.dataset.status = serverStatus;
                                
                                // Update button icon based on the returned status
                                if (serverStatus === 'draft') {
                                    this.innerHTML = `<svg class="h-3.5 w-3.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
                                    </svg>`;
                                } else {
                                    this.innerHTML = `<svg class="h-3.5 w-3.5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                    </svg>`;
                                }
                                
                                // Show notification with the message from the server
                                showTopicNotification(data.message || `Topic status updated to ${serverStatus}`, 'success');
                            } else if (data.error) {
                                // Show error message from server
                                showTopicNotification(data.error, 'error');
                                this.innerHTML = originalInnerHTML; // Restore original button
                            } else {
                                // Restore original button state
                                this.innerHTML = originalInnerHTML;
                                showTopicNotification('Failed to update topic status', 'error');
                            }
                        })
                        .catch(error => {
                            // Handle network errors or other exceptions
                            console.error('Error updating topic status:', error);
                            showTopicNotification('Error updating topic status: ' + error.message, 'error');
                            this.innerHTML = originalInnerHTML; // Restore original button
                        });
                    });
                });
            }

            // Re-initialize sortable on window resize to handle responsive layout changes
            let resizeTimer;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(function() {
                    initializeSectionsSortable();
                    initializeTopicsSortable();
                }, 500);
            });
        });

        // Robust section rename functionality with comprehensive error handling
        function renameSection(sectionId, currentName) {
            const newName = prompt('Enter new section name:', currentName);
            
            if (!newName || newName.trim() === '' || newName.trim() === currentName) {
                return; // User cancelled or no change
            }
            
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            if (!csrfToken) {
                alert('Error: CSRF token not found. Please refresh the page.');
                return;
            }
            
            // Renaming section
            
            // Show loading indicator
            const loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'fixed top-0 left-0 right-0 bg-blue-500 text-white text-center py-2 z-50';
            loadingIndicator.id = 'section-rename-loading';
            loadingIndicator.innerHTML = 'Renaming section...';
            document.body.appendChild(loadingIndicator);
            
            // Create an AbortController for timeout handling
            const controller = new AbortController();
            const timeoutId = setTimeout(() => {
                console.log('Request timeout - aborting...');
                controller.abort();
            }, 15000); // 15 second timeout
            
            const requestUrl = `/courses/api/sections/${sectionId}/rename/`;
            const requestBody = JSON.stringify({ name: newName.trim() });
            
            // Making fetch request
            
            // Use robustFetch if available, otherwise use fetchWithTimeout or standard fetch
            const fetchFunction = typeof robustFetch === 'function' ? robustFetch : 
                                 (typeof fetchWithTimeout === 'function' ? fetchWithTimeout : fetch);
            const fetchOptions = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken.value,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: requestBody,
                signal: controller.signal
            };
            
            // Add timeout if using standard fetch
            if (typeof robustFetch !== 'function' && typeof fetchWithTimeout !== 'function') {
                fetchOptions.timeout = 15000;
            }
            
            fetchFunction(requestUrl, fetchOptions)
            .then(response => {
                clearTimeout(timeoutId); // Clear the timeout
                removeLoadingIndicator();
                
                // Simplified response validation and logging
                // Processing response
                
                // If robustFetch was used, it already validated the response object
                // Just check if the response is ok
                if (response && !response.ok) {
                    const status = response.status || 'Unknown';
                    const statusText = response.statusText || 'Unknown Error';
                    throw new Error(`HTTP ${status}: ${statusText}`);
                }
                
                // Parse response text as JSON
                return response.text().then(text => {
                    if (text.trim().startsWith('<!DOCTYPE') || text.trim().startsWith('<html')) {
                        throw new Error('Server returned HTML page instead of JSON - possible server error');
                    }
                    
                    try {
                        return JSON.parse(text);
                    } catch (jsonError) {
                        console.error('JSON parsing error:', jsonError);
                        console.error('Response text:', text.substring(0, 200) + '...');
                        throw new Error('Invalid JSON response from server');
                    }
                });
            })
            .then(data => {
                console.log('Response data:', data);
                
                if (data && data.success) {
                    // Update the section name in the DOM
                    const nameElement = document.querySelector(`[data-section-id="${sectionId}"].section-name`);
                    if (nameElement) {
                        nameElement.textContent = data.name;
                        nameElement.title = data.name;
                    }
                    
                    // Show success message
                    showTopicNotification(data.message || 'Section renamed successfully', 'success');
                } else {
                    // Show error message with more context
                    let errorMessage = data?.error || 'Unknown error occurred';
                    if (data?.error === 'Permission denied') {
                        errorMessage = 'Permission denied: You do not have permission to rename sections in this course. Please ensure you are the course instructor or have been granted edit permissions.';
                    }
                    
                    console.error('Section rename failed:', data);
                    
                    showTopicNotification(errorMessage, 'error');
                }
            })
            .catch(error => {
                removeLoadingIndicator();
                
                console.error('=== SECTION RENAME ERROR ===');
                console.error('Full error details:', error);
                console.error('Error name:', error.name);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                console.error('============================');
                
                let errorMessage = 'Error renaming section: ';
                
                if (error.name === 'AbortError') {
                    errorMessage += 'Request timed out. Please try again.';
                } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMessage += 'Cannot connect to server. Please check if the Django server is running.';
                } else if (error.message && error.message.includes('HTTP')) {
                    errorMessage += error.message;
                } else if (error.message) {
                    errorMessage += error.message;
                } else {
                    errorMessage += 'Unknown error occurred. Please try again.';
                }
                
                console.error('Final error message:', errorMessage);
                
                showTopicNotification(errorMessage, 'error');
            });
            
            // Helper function to remove loading indicator
            function removeLoadingIndicator() {
                const indicator = document.getElementById('section-rename-loading');
                if (indicator && indicator.parentNode) {
                    indicator.parentNode.removeChild(indicator);
                }
            }
        }

        
        // Global error handler for section operations
        window.addEventListener('error', function(event) {
            if (event.error && event.error.message && event.error.message.includes('section')) {
                console.error('Section-related error caught:', event.error);
                showTopicNotification('A section operation error occurred. Please refresh the page and try again.', 'error');
            }
        });
        
        // Safe section rename handler
        window.handleRenameSection = function(button) {
            const sectionId = button.getAttribute('data-section-id');
            const sectionName = button.getAttribute('data-section-name');
            
            if (typeof renameSection === 'function') {
                renameSection(sectionId, sectionName);
            } else if (typeof renameSectionGlobal === 'function') {
                renameSectionGlobal(sectionId, sectionName);
            } else {
                console.error('Rename section function not available');
            }
        };
        
        // Safe section delete handler
        window.handleDeleteSection = function(button) {
            const sectionId = button.getAttribute('data-section-id');
            
            if (typeof window.deleteSection === 'function') {
                window.deleteSection(sectionId);
            } else {
                console.error('Delete section function not available');
            }
        };
        
        // Add global section rename function with fallback
        window.renameSectionGlobal = function(sectionId, currentName) {
            try {
                renameSection(sectionId, currentName);
            } catch (error) {
                console.error('Error in global renameSection:', error);
                showTopicNotification('Error renaming section. Please try again.', 'error');
            }
        };
        
        

        
        

        // Unified notification function for topic operations
        function showTopicNotification(message, type = 'info') {
            // Always show notifications - user feedback is important in all environments
            console.log(`🔔 Showing notification: ${message} (${type})`);
            
            // Check if we're in development/localhost
            const isDevelopment = false || 
                                 false ||
                                 window.location.hostname.includes('192.168.') ||
                                 window.location.hostname.includes('.local');
            
            if (isDevelopment) {
                // In development, use alert as fallback to ensure user sees the message
                console.log(`[DEV] Using alert for notification: ${message} (${type})`);
                alert(`${type.toUpperCase()}: ${message}`);
                return;
            }
            
            // Prevent showing notifications too frequently (debounce)
            if (showTopicNotification._lastNotificationTime && 
                Date.now() - showTopicNotification._lastNotificationTime < 1000) {
                return;
            }
            showTopicNotification._lastNotificationTime = Date.now();
            
            // Remove any existing notifications to prevent duplicates
            const existingNotifications = document.querySelectorAll('.topic-notification, .toast-notification');
            existingNotifications.forEach(notification => {
                if (notification.parentNode) {
                    try {
                        notification.remove();
                    } catch (e) {
                        console.warn('Error removing existing notification:', e);
                    }
                }
            });
            
            // Use the unified notification system with error handling
            if (typeof window.showNotification === 'function') {
                try {
                    window.showNotification(message, type, 4000);
                    console.log(`Showing unified notification: ${message} (${type})`);
                    return;
                } catch (error) {
                    console.warn('Unified notification system failed, using fallback:', error);
                }
            }
            
            // Fallback to creating our own notification
            console.log(`Showing fallback notification: ${message} (${type})`);
            const notification = document.createElement('div');
            notification.className = `topic-notification fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 max-w-md transition-all duration-300 ${
                type === 'success' ? 'bg-green-500' :
                type === 'error' ? 'bg-red-500' :
                type === 'warning' ? 'bg-yellow-500' :
                'bg-blue-500'
            } text-white`;
            
            notification.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200 transition-colors">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Fade in effect
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateY(0)';
            }, 10);
            
            // Remove notification after 4 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateY(-20px)';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, 4000);
        }

        // Enhanced SCORM upload completion notification
        function showSCORMUploadNotification(topicTitle, packageTitle) {
            const message = `🎉 SCORM upload completed successfully!<br>
                <strong>Topic:</strong> ${topicTitle}<br>
                <strong>Package:</strong> ${packageTitle || 'SCORM Content'}<br>
                <small class="text-green-100">Your SCORM package is now ready for use.</small>`;
            
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 max-w-md bg-green-500 text-white';
            
            notification.innerHTML = `
                <div class="flex items-start justify-between">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <svg class="h-6 w-6 text-green-100" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-green-100">Upload Complete!</h3>
                            <div class="mt-1 text-sm text-white">${message}</div>
                        </div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-green-100 hover:text-white">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Remove notification after 8 seconds (longer for SCORM success)
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 8000);
        }

        // Check for SCORM upload completion on page load
        function checkSCORMUploadCompletion() {
            const urlParams = new URLSearchParams(window.location.search);
            const scormSuccess = urlParams.get('scorm_success');
            const topicTitle = urlParams.get('topic_title');
            const packageTitle = urlParams.get('package_title');
            
            // Only show notification if we have SCORM success AND it hasn't been shown before
            if (scormSuccess === 'true') {
                // Check if we've already shown this notification (prevent duplicate notifications)
                const notificationKey = `scorm_notif_${Date.now()}`;
                const hasShownNotification = sessionStorage.getItem('scorm_notification_shown');
                
                // Only show notification if it hasn't been shown in this session
                if (!hasShownNotification) {
                    console.log('Showing SCORM upload success notification...');
                    showSCORMUploadNotification(
                        topicTitle || 'SCORM Topic',
                        packageTitle || 'SCORM Package'
                    );
                    
                    // Mark notification as shown for this session
                    sessionStorage.setItem('scorm_notification_shown', notificationKey);
                } else {
                    console.log('SCORM notification already shown in this session, skipping...');
                }
                
                // Always clean up URL parameters regardless
                const newUrl = new URL(window.location);
                newUrl.searchParams.delete('scorm_success');
                newUrl.searchParams.delete('topic_title');
                newUrl.searchParams.delete('package_title');
                window.history.replaceState({}, '', newUrl);
            }
        }

        // Utility function to get cookie value
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }


        
        
        
        
        
</script>
{% endblock extra_js %}

{% block global_breadcrumbs %}
    {% include 'components/breadcrumb.html' with breadcrumbs=breadcrumbs %}
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Toast notification container will be created by notifications.js if needed -->
    
    <!-- Main form container -->
    <div class="bg-white rounded-lg shadow-md">
        <div class="w-full course-create-form px-8 py-6">

            <!-- Main Content Area -->
            <form method="POST" enctype="multipart/form-data" id="courseCreateForm" action="{% url 'courses:course_edit' course.id %}" onsubmit="return handleFormSubmit(event)">
                {% csrf_token %}
                
                <!-- Hidden inputs -->
                <input type="hidden" id="course_id" name="course_id" value="{{ course.id }}">
                
                <!-- Display validation errors if any -->
                {% if form.errors %}
                <div class="p-4 bg-red-100 border border-red-200 rounded-md mb-4">
                    <h3 class="text-red-700 font-semibold mb-2">Please correct the errors below:</h3>
                    <ul class="list-disc pl-5 text-red-600">
                        {% for field, errors in form.errors.items %}
                        <li>
                            <strong>{{ field|title }}:</strong> 
                            {% for error in errors %}
                            {{ error }}{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                
                <!-- Two Column Layout -->
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                    <!-- Left Column -->
                    <div class="lg:col-span-7">
                        <!-- Course Name and Image Section -->
                        <div class="space-y-4 border rounded-lg p-4 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Course Title</label>
                                <input type="text" name="title" id="title" required class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Enter course title" value="{{ course.title|default:'' }}">
                                <div class="mt-2">
                                    <label for="course_code" class="block text-sm font-medium text-gray-700 mb-1">Course Code</label>
                                    <input type="text" id="course_code" name="course_code" 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" 
                                        placeholder="Enter course code" 
                                        value="{{ course.course_code|default:'' }}">
                                    <p class="mt-1 text-sm text-gray-500">Optional: Enter a course code</p>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Course Image</label>
                                <div class="file-upload-container bg-gray-50 rounded-lg p-4 border-2 border-dashed border-gray-300 hover:border-blue-500 transition-colors duration-200">
                                    <div class="flex flex-col items-center justify-center space-y-4">
                                        <div class="upload-controls flex flex-col sm:flex-row items-center justify-between w-full gap-3 sm:gap-0">
                                            <div class="flex items-center space-x-2 mb-3 sm:mb-0">
                                                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                                </svg>
                                                <p class="text-sm text-gray-500" id="image-file-info">JPG, PNG, JPEG only • Max 10MB</p>
                                            </div>
                                            <label for="course_image" class="file-upload-label cursor-pointer px-4 py-2 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition text-sm font-medium text-blue-600 shadow-sm">
                                                <span>Upload image</span>
                                                <input type="file" id="course_image" name="course_image" accept="image/jpeg,image/jpg,image/png" class="hidden" onchange="handleImageUpload(event)">
                                            </label>
                                        </div>

                                        <!-- Image Upload Help Section -->
                                        <div class="bg-blue-50 border border-blue-200 rounded-md p-3 text-sm">
                                            <div class="flex items-start space-x-2">
                                                <div class="text-blue-800">
                                                    <p class="font-medium mb-1">Image Upload Guidelines</p>
                                                    <ul class="text-blue-700 space-y-1">
                                                        <li>• <strong>Image formats:</strong> JPG, PNG, JPEG only • <strong>Max size:</strong> 10MB</li>
                                                        <li>• <strong>Any filename allowed</strong> - no character restrictions</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="w-full course-image-container {% if not course.course_image %}hidden{% endif %}">
                                            <div class="relative group">
                                                <img id="course-image-preview" src="{% if course.course_image %}{{ course.course_image.url }}{% endif %}" alt="Course image preview" class="w-full h-48 object-cover rounded-lg shadow-sm" data-existing-image="true" data-container-id="course-image-container">
                                                <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-opacity duration-200 rounded-lg flex items-center justify-center">
                                                    <button type="button" id="remove-image-btn" onclick="removeImage(); return false;" class="opacity-30 group-hover:opacity-100 bg-red-500 text-white px-3 py-1 rounded-md text-sm transition-opacity duration-200 hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2" style="pointer-events: auto;" title="Click to remove image">
                                                        Clear
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Intro Video</label>
                                <div class="file-upload-container bg-gray-50 rounded-lg p-4 border-2 border-dashed border-gray-300 hover:border-blue-500 transition-colors duration-200">
                                    <div class="flex flex-col items-center justify-center space-y-4">
                                        <div class="upload-controls flex flex-col sm:flex-row items-center justify-between w-full gap-3 sm:gap-0">
                                            <div class="flex items-center space-x-2 mb-3 sm:mb-0">
                                                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2z"></path>
                                                </svg>
                                                <p class="text-sm text-gray-500" id="video-file-info">MP4, WEBM only • Max 500MB</p>
                                            </div>
                                            <label for="course_video" class="file-upload-label cursor-pointer px-4 py-2 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition text-sm font-medium text-blue-600 shadow-sm">
                                                <span>Upload video</span>
                                                <input type="file" id="course_video" name="course_video" accept="video/mp4,video/webm" class="hidden" onchange="handleVideoUpload(event)">
                                            </label>
                                        </div>

                                        <!-- Video Upload Help Section -->
                                        <div class="bg-blue-50 border border-blue-200 rounded-md p-3 text-sm">
                                            <div class="flex items-start space-x-2">
                                                <div class="text-blue-800">
                                                    <p class="font-medium mb-1">Video Upload Guidelines</p>
                                                    <ul class="text-blue-700 space-y-1">
                                                        <li>• <strong>Video formats:</strong> MP4, WEBM only • <strong>Max size:</strong> 500MB</li>
                                                        <li>• <strong>Any filename allowed</strong> - no character restrictions</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>

                                        {% if course.course_video %}
                                        <div class="w-full course-video-container">
                                            <div id="video-filename-display" class="selected-filename text-sm font-medium text-blue-600 mb-2">Selected: {{ course.course_video.name|default:"" }}</div>
                                            <div class="relative group">
                                                <video id="course-video-preview" controls class="w-full h-48 object-cover rounded-lg shadow-sm">
                                                    <source src="{{ course.course_video.url }}" type="video/mp4">
                                                    Your browser does not support the video tag.
                                                </video>
                                                <div class="absolute top-0 right-0 m-2">
                                                    <button type="button" id="remove-video-btn-existing" onclick="removeVideo(); return false;" class="opacity-30 group-hover:opacity-100 bg-red-500 text-white px-3 py-1 rounded-md text-sm transition-opacity duration-200 hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2" style="pointer-events: auto;" title="Click to remove video">
                                                        Clear
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        {% else %}
                                        <div id="video-filename-display" class="selected-filename text-sm font-medium text-blue-600 hidden"></div>
                                        <div id="course-video-preview" class="hidden w-full course-video-container">
                                            <div class="relative group">
                                                <video controls class="w-full h-48 object-cover rounded-lg shadow-sm">
                                                    <source src="" type="video/mp4">
                                                    Your browser does not support the video tag.
                                                </video>
                                                <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-opacity duration-200 rounded-lg flex items-center justify-center">
                                                    <button type="button" id="remove-video-btn-new" onclick="removeVideo(); return false;" class="opacity-30 group-hover:opacity-100 bg-red-500 text-white px-3 py-1 rounded-md text-sm transition-opacity duration-200 hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2" style="pointer-events: auto;" title="Click to remove video">
                                                        Clear
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bottom Tabs Section -->
                        <div class="bg-white rounded-lg border">
                            <!-- Desktop Tab Headers -->
                            <div class="tab-headers-desktop flex border-b border-gray-200">
                                <button type="button" class="tab-btn active text-xs font-medium border-b-2 border-blue-600" style="padding: 13px;" data-tab-target="#description-tab">
                                    Description
                                </button>
                                <button type="button" class="tab-btn text-xs font-medium text-gray-500 hover:text-gray-700" style="padding: 13px;" data-tab-target="#discussions-tab">
                                    Discussions
                                </button>
                                <button type="button" class="tab-btn text-xs font-medium text-gray-500 hover:text-gray-700" style="padding: 13px;" data-tab-target="#files-tab">
                                    Files
                                </button>
                                <button type="button" class="tab-btn text-xs font-medium text-gray-500 hover:text-gray-700" style="padding: 13px;" data-tab-target="#outcomes-tab">
                                    Outcomes
                                </button>
                                <button type="button" class="tab-btn text-xs font-medium text-gray-500 hover:text-gray-700" style="padding: 13px;" data-tab-target="#rubrics-tab">
                                    Rubrics
                                </button>
                                <button type="button" class="tab-btn text-xs font-medium text-gray-500 hover:text-gray-700" style="padding: 13px;" data-tab-target="#certificate-tab">
                                    Certificate
                                </button>
                                <button type="button" class="tab-btn text-xs font-medium text-gray-500 hover:text-gray-700" style="padding: 13px;" data-tab-target="#gradebook-tab">
                                    Gradebook
                                </button>
                            </div>

                            <!-- Mobile Accordion -->
                            <div class="tab-accordion-container">
                                <!-- Description Accordion Item -->
                                <div class="tab-accordion-item">
                                    <button type="button" class="tab-accordion-header active" data-accordion-target="#description-tab-accordion">
                                        <span>Description</span>
                                        <svg class="tab-accordion-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    <div id="description-tab-accordion" class="tab-accordion-content active">
                                        <!-- Content will be populated by JavaScript -->
                                    </div>
                                </div>

                                <!-- Discussions Accordion Item -->
                                <div class="tab-accordion-item">
                                    <button type="button" class="tab-accordion-header" data-accordion-target="#discussions-tab-accordion">
                                        <span>Discussions</span>
                                        <svg class="tab-accordion-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    <div id="discussions-tab-accordion" class="tab-accordion-content">
                                        <!-- Content will be populated by JavaScript -->
                                    </div>
                                </div>

                                <!-- Files Accordion Item -->
                                <div class="tab-accordion-item">
                                    <button type="button" class="tab-accordion-header" data-accordion-target="#files-tab-accordion">
                                        <span>Files</span>
                                        <svg class="tab-accordion-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    <div id="files-tab-accordion" class="tab-accordion-content">
                                        <!-- Content will be populated by JavaScript -->
                                    </div>
                                </div>

                                <!-- Outcomes Accordion Item -->
                                <div class="tab-accordion-item">
                                    <button type="button" class="tab-accordion-header" data-accordion-target="#outcomes-tab-accordion">
                                        <span>Outcomes</span>
                                        <svg class="tab-accordion-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    <div id="outcomes-tab-accordion" class="tab-accordion-content">
                                        <!-- Content will be populated by JavaScript -->
                                    </div>
                                </div>

                                <!-- Rubrics Accordion Item -->
                                <div class="tab-accordion-item">
                                    <button type="button" class="tab-accordion-header" data-accordion-target="#rubrics-tab-accordion">
                                        <span>Rubrics</span>
                                        <svg class="tab-accordion-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    <div id="rubrics-tab-accordion" class="tab-accordion-content">
                                        <!-- Content will be populated by JavaScript -->
                                    </div>
                                </div>

                                <!-- Certificate Accordion Item -->
                                <div class="tab-accordion-item">
                                    <button type="button" class="tab-accordion-header" data-accordion-target="#certificate-tab-accordion">
                                        <span>Certificate</span>
                                        <svg class="tab-accordion-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    <div id="certificate-tab-accordion" class="tab-accordion-content">
                                        <!-- Content will be populated by JavaScript -->
                                    </div>
                                </div>

                                <!-- Gradebook Accordion Item -->
                                <div class="tab-accordion-item">
                                    <button type="button" class="tab-accordion-header" data-accordion-target="#gradebook-tab-accordion">
                                        <span>Gradebook</span>
                                        <svg class="tab-accordion-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    <div id="gradebook-tab-accordion" class="tab-accordion-content">
                                        <!-- Content will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Enhanced script for tabs and accordion -->
                            <script>
                                function initializeTabsAndAccordion() {
                                    // Desktop tab functionality
                                    document.querySelectorAll('.tab-btn').forEach(button => {
                                        button.addEventListener('click', function(e) {
                                            e.preventDefault();
                                            
                                            // Remove active class from all buttons
                                            document.querySelectorAll('.tab-btn').forEach(btn => {
                                                btn.classList.remove('active');
                                                btn.classList.remove('border-blue-600');
                                                btn.classList.add('text-gray-500');
                                            });
                                            
                                            // Hide all tab contents
                                            document.querySelectorAll('.tab-content').forEach(content => {
                                                content.classList.remove('active');
                                                content.style.display = 'none';
                                            });
                                            
                                            // Add active class to clicked button
                                            this.classList.add('active');
                                            this.classList.add('border-blue-600');
                                            this.classList.remove('text-gray-500');
                                            
                                            // Show corresponding content
                                            const target = this.getAttribute('data-tab-target');
                                            const targetContent = document.querySelector(target);
                                            if (targetContent) {
                                                targetContent.classList.add('active');
                                                targetContent.style.display = 'block';
                                            }
                                        });
                                    });

                                    // Mobile accordion functionality
                                    document.querySelectorAll('.tab-accordion-header').forEach(header => {
                                        header.addEventListener('click', function(e) {
                                            e.preventDefault();
                                            
                                            const target = this.getAttribute('data-accordion-target');
                                            const targetContent = document.querySelector(target);
                                            const isActive = this.classList.contains('active');
                                            
                                            if (isActive) {
                                                // Close if already open
                                                this.classList.remove('active');
                                                if (targetContent) {
                                                    targetContent.classList.remove('active');
                                                }
                                            } else {
                                                // Close all other accordion items
                                                document.querySelectorAll('.tab-accordion-header').forEach(h => {
                                                    h.classList.remove('active');
                                                });
                                                document.querySelectorAll('.tab-accordion-content').forEach(c => {
                                                    c.classList.remove('active');
                                                });
                                                
                                                // Open clicked item
                                                this.classList.add('active');
                                                if (targetContent) {
                                                    targetContent.classList.add('active');
                                                    // Copy content from tab to accordion
                                                    copyTabContentToAccordion(target);
                                                }
                                            }
                                        });
                                    });

                                    // Initialize content copying
                                    copyInitialContent();
                                }

                                function copyTabContentToAccordion(accordionTarget) {
                                    // Map accordion targets to tab targets
                                    const mapping = {
                                        '#description-tab-accordion': '#description-tab',
                                        '#discussions-tab-accordion': '#discussions-tab',
                                        '#files-tab-accordion': '#files-tab',
                                        '#outcomes-tab-accordion': '#outcomes-tab',
                                        '#rubrics-tab-accordion': '#rubrics-tab',
                                        '#certificate-tab-accordion': '#certificate-tab',
                                        '#gradebook-tab-accordion': '#gradebook-tab'
                                    };

                                    const tabTarget = mapping[accordionTarget];
                                    if (tabTarget) {
                                        const tabContent = document.querySelector(tabTarget);
                                        const accordionContent = document.querySelector(accordionTarget);
                                        
                                        if (tabContent && accordionContent) {
                                            accordionContent.innerHTML = tabContent.innerHTML;
                                        }
                                    }
                                }

                                function copyInitialContent() {
                                    // Copy all tab content to accordion containers on page load
                                    const mapping = {
                                        '#description-tab-accordion': '#description-tab',
                                        '#discussions-tab-accordion': '#discussions-tab',
                                        '#files-tab-accordion': '#files-tab',
                                        '#outcomes-tab-accordion': '#outcomes-tab',
                                        '#rubrics-tab-accordion': '#rubrics-tab',
                                        '#certificate-tab-accordion': '#certificate-tab',
                                        '#gradebook-tab-accordion': '#gradebook-tab'
                                    };

                                    Object.entries(mapping).forEach(([accordionTarget, tabTarget]) => {
                                        const tabContent = document.querySelector(tabTarget);
                                        const accordionContent = document.querySelector(accordionTarget);
                                        
                                        if (tabContent && accordionContent) {
                                            accordionContent.innerHTML = tabContent.innerHTML;
                                        }
                                    });
                                }

                                // Initialize when DOM is ready
                                if (document.readyState === 'loading') {
                                    document.addEventListener('DOMContentLoaded', initializeTabsAndAccordion);
                                } else {
                                    initializeTabsAndAccordion();
                                }
                            </script>

                            <!-- Tab Contents -->
                            <div class="p-4 desktop-tab-content-container">
                                                                <!-- Description Tab -->
                                <div id="description-tab" class="tab-content active">
                                    <!-- Short Description -->
                                    <div class="mb-6">
                                        <label for="{{ form.short_description.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                            Short Description
                                        </label>
                                        {{ form.short_description }}
                                        {% if form.short_description.help_text %}
                                            <p class="mt-1 text-sm text-gray-500">{{ form.short_description.help_text }}</p>
                                        {% endif %}
                                        <p class="mt-1 text-sm text-gray-500">Brief description displayed on course cards in the dashboard and course catalog.</p>
                                        {% if form.short_description.errors %}
                                            <div class="mt-1 text-sm text-red-600">
                                                {{ form.short_description.errors }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Full Description -->
                                    <div class="mb-4">
                                        <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                            Course Description
                                        </label>
                                        {{ form.description }}
                                        {% if form.description.help_text %}
                                            <p class="mt-1 text-sm text-gray-500">{{ form.description.help_text }}</p>
                                        {% endif %}
                                        {% if form.description.errors %}
                                            <div class="mt-1 text-sm text-red-600">
                                                {{ form.description.errors }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Discussions Tab -->
                                <div id="discussions-tab" class="tab-content">
                                    <div class="p-4 bg-white rounded-lg border border-gray-200">
                                        <h3 class="tab-section-title">Course Discussions</h3>
                                        <div class="space-y-4">
                                            {% if course.discussions.all %}
                                                <table class="min-w-full divide-y divide-gray-200">
                                                    <thead class="bg-gray-50">
                                                        <tr>
                                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
                                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Topic</th>
                                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody class="bg-white divide-y divide-gray-200">
                                                        {% for discussion in course.discussions.all %}
                                                        <tr>
                                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ discussion.title }}</td>
                                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                                {% for topic in discussion.topics.all %}
                                                                    {{ topic.title }}{% if not forloop.last %}, {% endif %}
                                                                {% endfor %}
                                                            </td>
                                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ discussion.created_at|date:"M d, Y" }}</td>
                                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                                <a href="{% url 'discussions:discussion_detail' discussion_id=discussion.id %}" class="text-blue-600 hover:text-blue-900">View</a>
                                                            </td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            {% else %}
                                                <p class="text-gray-600">No discussions have been added to this course yet.</p>
                                            {% endif %}
                                        
                                                                                        <div class="mt-4">
                                                <a href="{% url 'discussions:new_discussion_with_course' %}?course_id={{ course.id }}" class="px-4 py-2 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 inline-flex items-center" style="background-color: #1c2260;" onmouseover="this.style.backgroundColor='#181f56'" onmouseout="this.style.backgroundColor='#1c2260'">
                                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                                    </svg>
                                                    Add Discussion
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Files Tab -->
                                <div id="files-tab" class="tab-content">
                                    <div class="p-4 bg-white rounded-lg border border-gray-200">
                                        <h3 class="tab-section-title">Course Files</h3>
                                        
                                        <div class="space-y-4">
                                            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                                <h4 class="text-md font-medium text-gray-700 mb-2">PDF & Document Files</h4>
                                                
                                                {% with pdf_docs=course.topics.all|filter_topics_with_documents %}
                                                    {% if pdf_docs %}
                                                        <table class="min-w-full divide-y divide-gray-200">
                                                            <thead class="bg-gray-50">
                                                                <tr>
                                                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">File Name</th>
                                                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Topic</th>
                                                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody class="bg-white divide-y divide-gray-200">
                                                                {% for topic in pdf_docs %}
                                                                    <tr>
                                                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ topic.content_file.name|filename }}</td>
                                                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ topic.title }}</td>
                                                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                                            {% if topic.content_file.name|file_extension == 'pdf' %}PDF
                                                                            {% elif topic.content_file.name|file_extension == 'doc' or topic.content_file.name|file_extension == 'docx' %}Word
                                                                            {% else %}{{ topic.content_file.name|file_extension|upper }}{% endif %}
                                                                        </td>
                                                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                                            <a href="{{ topic.content_file.url }}" class="text-blue-600 hover:text-blue-900" target="_blank">View</a>
                                                                        </td>
                                                                    </tr>
                                                                {% endfor %}
                                                            </tbody>
                                                        </table>
                                                    {% else %}
                                                        <p class="text-gray-600">No document files have been added to this course yet.</p>
                                                    {% endif %}
                                                {% endwith %}
                                            </div>
                                            
                                        <div class="mt-4">
                                                <a href="{% url 'courses:topic_create' course.id %}" class="px-4 py-2 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 inline-flex items-center" style="background-color: #1c2260;" onmouseover="this.style.backgroundColor='#181f56'" onmouseout="this.style.backgroundColor='#1c2260'">
                                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                                    </svg>
                                                    Add Topic
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Outcomes Tab -->
                                <div id="outcomes-tab" class="tab-content">
                                    <div class="p-4 bg-white rounded-lg border border-gray-200">
                                        <h3 class="tab-section-title">Learning Outcomes</h3>
                                        
                                        <div class="space-y-4">
                                            {% load course_tags %}
                                            {% get_outcomes_for_course course as all_course_outcomes %}
                                            {% if all_course_outcomes %}
                                                <table class="min-w-full divide-y divide-gray-200">
                                                    <thead class="bg-gray-50">
                                                        <tr>
                                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
                                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Source</th>
                                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody class="bg-white divide-y divide-gray-200">
                                                        {% for outcome in all_course_outcomes %}
                                        <tr>
                                            <td class="px-6 py-4 text-sm text-gray-900">
                                                <div class="font-medium">{{ outcome.title }}</div>
                                                {% if outcome.friendly_name %}
                                                <div class="text-xs text-gray-500 mt-1">Friendly: {{ outcome.friendly_name }}</div>
                                                {% endif %}
                                            </td>
                                            <td class="px-6 py-4 text-sm text-gray-600">
                                                {{ outcome.description|default:"" }}
                                                {% if outcome.friendly_description %}
                                                <div class="text-xs text-gray-500 mt-2 italic">Learner description: {{ outcome.friendly_description }}</div>
                                                {% endif %}
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                {% if outcome.course == course %}
                                                    <span class="inline-block bg-green-100 text-green-800 px-2 py-1 rounded-md text-xs mr-1 mb-1">
                                                        Direct Course Link
                                                    </span>
                                                {% endif %}
                                                
                                                <!-- Check if outcome is linked via rubric criteria -->
                                                {% for connection in outcome.criterion_connections.all %}
                                                    {% if connection.criterion.rubric.assignments.all %}
                                                        {% for assignment in connection.criterion.rubric.assignments.all %}
                                                            {% if assignment in course.assignments.all or assignment in course.course_assignments.all %}
                                                                {% get_topic_for_assignment assignment.id as topic %}
                                                                {% if topic %}
                                                                    <span class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded-md text-xs mr-1 mb-1">
                                                                        {{ topic.title }} (Via Rubric)
                                                                    </span>
                                                                {% else %}
                                                                    <span class="inline-block bg-purple-100 text-purple-800 px-2 py-1 rounded-md text-xs mr-1 mb-1">
                                                                        Assignment Rubric
                                                                    </span>
                                                                {% endif %}
                                                            {% endif %}
                                                        {% endfor %}
                                                    {% endif %}
                                                {% endfor %}
                                                
                                                <!-- Legacy alignment check -->
                                                {% for alignment in outcome.alignments.all %}
                                                    {% if alignment.content_type == 'assignment' %}
                                                        {% get_topic_for_assignment alignment.object_id as topic %}
                                                        {% if topic %}
                                                            <span class="inline-block bg-orange-100 text-orange-800 px-2 py-1 rounded-md text-xs mr-1 mb-1">
                                                                {{ topic.title }} (Assignment)
                                                            </span>
                                                        {% else %}
                                                            <span class="inline-block bg-gray-100 text-gray-600 px-2 py-1 rounded-md text-xs mr-1 mb-1">Assignment</span>
                                                        {% endif %}
                                                    {% elif alignment.content_type == 'quiz' %}
                                                        {% load course_tags %}
                                                        {% get_topic_for_quiz alignment.object_id as topic %}
                                                        {% if topic %}
                                                            <span class="inline-block bg-green-100 text-green-800 px-2 py-1 rounded-md text-xs mr-1 mb-1">
                                                                {{ topic.title }} (Quiz)
                                                            </span>
                                                        {% else %}
                                                            <span class="inline-block bg-gray-100 text-gray-600 px-2 py-1 rounded-md text-xs mr-1 mb-1">Quiz</span>
                                                        {% endif %}
                                                    {% elif alignment.content_type == 'discussion' %}
                                                        {% load course_tags %}
                                                        {% get_topic_for_discussion alignment.object_id as topic %}
                                                        {% if topic %}
                                                            <span class="inline-block bg-purple-100 text-purple-800 px-2 py-1 rounded-md text-xs mr-1 mb-1">
                                                                {{ topic.title }} (Discussion)
                                                            </span>
                                                        {% else %}
                                                            <span class="inline-block bg-gray-100 text-gray-600 px-2 py-1 rounded-md text-xs mr-1 mb-1">Discussion</span>
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="inline-block bg-gray-100 text-gray-600 px-2 py-1 rounded-md text-xs mr-1 mb-1">{{ alignment.content_type }}</span>
                                                    {% endif %}
                                                {% empty %}
                                                {% endfor %}
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                <a href="{% url 'lms_outcomes:edit_outcome' outcome.id %}" class="text-blue-600 hover:text-blue-900 mr-3">Edit</a>
                                                <a href="{% url 'lms_outcomes:edit_outcome' outcome.id %}" class="text-blue-600 hover:text-blue-900">View</a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            {% else %}
                                                <p class="text-gray-600">No learning outcomes have been linked to this course yet.</p>
                                            {% endif %}
                                        
                                        <div class="mt-4">
                                                <a href="{% url 'lms_outcomes:create_outcome' %}?course_id={{ course.id }}" class="px-4 py-2 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 inline-flex items-center" style="background-color: #1c2260;" onmouseover="this.style.backgroundColor='#181f56'" onmouseout="this.style.backgroundColor='#1c2260'">
                                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                                    </svg>
                                                    Add Outcome
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Rubrics Tab -->
                                <div id="rubrics-tab" class="tab-content">
                                    <div class="p-4 bg-white rounded-lg border border-gray-200">
                                        <h3 class="tab-section-title">Assessment Rubrics</h3>
                                        
                                        <div class="space-y-4">
                                            {% load course_tags %}
                                            {% get_rubrics_for_course course as all_course_rubrics %}
                                            {% if all_course_rubrics %}
                                                <table class="min-w-full divide-y divide-gray-200">
                                                    <thead class="bg-gray-50">
                                                        <tr>
                                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
                                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Points</th>
                                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Source</th>
                                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody class="bg-white divide-y divide-gray-200">
                                                        {% for rubric in all_course_rubrics %}
                                                        <tr>
                                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ rubric.title }}</td>
                                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ rubric.total_points }}</td>
                                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                                {% if rubric.course == course %}
                                                                    <span class="inline-block bg-green-100 text-green-800 px-2 py-1 rounded-md text-xs mr-1 mb-1">
                                                                        Direct Course Link
                                                                    </span>
                                                                {% endif %}
                                                                
                                                                {% get_topics_for_rubric rubric as rubric_topics %}
                                                                {% if rubric_topics %}
                                                                    {% for topic in rubric_topics %}
                                                                        <span class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded-md text-xs mr-1 mb-1">
                                                                            {{ topic.title }} (Assignment)
                                                                        </span>
                                                                    {% endfor %}
                                                                {% else %}
                                                                    {% if rubric.course != course %}
                                                                        <span class="inline-block bg-purple-100 text-purple-800 px-2 py-1 rounded-md text-xs mr-1 mb-1">
                                                                            Assignment Rubric
                                                                        </span>
                                                                    {% endif %}
                                                                {% endif %}
                                                            </td>
                                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                                <a href="{% url 'lms_rubrics:edit' rubric.id %}" class="text-blue-600 hover:text-blue-900 mr-3">Edit</a>
                                                                <a href="{% url 'lms_rubrics:detail' rubric.id %}" class="text-blue-600 hover:text-blue-900">View</a>
                                                            </td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            {% else %}
                                                <p class="text-gray-600">No rubrics have been linked to this course yet.</p>
                                            {% endif %}
                                        
                                        <div class="mt-4">
                                                <a href="{% url 'lms_rubrics:create' %}?course_id={{ course.id }}" class="px-4 py-2 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 inline-flex items-center" style="background-color: #1c2260;" onmouseover="this.style.backgroundColor='#181f56'" onmouseout="this.style.backgroundColor='#1c2260'">
                                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                                    </svg>
                                                    Add Rubric
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Certificate Tab -->
                                <div id="certificate-tab" class="tab-content">
                                    <div class="p-4 bg-white rounded-lg border border-gray-200">
                                        <h3 class="tab-section-title">Course Certificate</h3>
                                        
                                        <div class="space-y-4">
                                            {% if course.certificate_template %}
                                                <div class="bg-gray-50 p-4 rounded-lg">
                                                    <div class="flex items-start">
                                                        <div class="ml-0">
                                                            <h4 class="text-md font-medium text-gray-900">{{ course.certificate_template.title }}</h4>
                                                            <p class="text-sm text-gray-600 mt-1">{{ course.certificate_template.description|truncatechars:150 }}</p>
                                                            
                                        <div class="mt-4">
                                                                <div class="flex items-center text-sm text-gray-600">
                                                                    <span class="mr-2 font-medium">Issue Certificate:</span>
                                                                    <span class="bg-{{ course.issue_certificate|yesno:"green-100,red-100" }} text-{{ course.issue_certificate|yesno:"green-800,red-800" }} px-2 py-1 rounded-md">
                                                                        {{ course.issue_certificate|yesno:"Yes,No" }}
                                                                    </span>
                                        </div>
                                                                
                                                                <div class="flex items-center text-sm text-gray-600 mt-2">
                                                                    <span class="mr-2 font-medium">Certificate Type:</span>
                                                                    <span class="capitalize">{{ course.certificate_type }}</span>
                                    </div>
                                </div>
                                                            
                                                            <div class="mt-4">
                                                                <a href="{% url 'certificates:certificates' %}?template_id={{ course.certificate_template.id }}" class="px-4 py-2 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 inline-block text-sm" style="background-color: #1c2260;" onmouseover="this.style.backgroundColor='#181f56'" onmouseout="this.style.backgroundColor='#1c2260'">
                                                                    View Certificate Template
                                                                </a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% else %}
                                                <p class="text-gray-600">No certificate has been linked to this course yet.</p>
                                            {% endif %}
                                        
                                            <div class="mt-4">
                                                <a href="{% url 'certificates:certificates' %}?course_id={{ course.id }}" class="px-4 py-2 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 inline-flex items-center" style="background-color: #1c2260;" onmouseover="this.style.backgroundColor='#181f56'" onmouseout="this.style.backgroundColor='#1c2260'">
                                                    {% if course.certificate_template %}
                                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                                        </svg>
                                                        Change Certificate
                                                    {% else %}
                                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                                        </svg>
                                                        Add Certificate
                                                    {% endif %}
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Gradebook Tab -->
                                <div id="gradebook-tab" class="tab-content">
                                    <div class="p-4 bg-white rounded-lg border border-gray-200">
                                        <h3 class="tab-section-title">Course Gradebook</h3>
                                        
                                        <div class="space-y-4">
                                            <p class="text-gray-600 mb-2">View and manage grades for all students enrolled in this course.</p>
                                            
                                            <div class="mt-4">
                                                <a href="{% url 'gradebook:index' %}?course_id={{ course.id }}" class="inline-flex items-center justify-center w-10 h-10 text-white rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-200 hover:transform hover:-translate-y-0.5 hover:shadow-lg" title="View course gradebook" style="background-color: #1c2260;" onmouseover="this.style.backgroundColor='#181f56'" onmouseout="this.style.backgroundColor='#1c2260'">
                                                    <i class="fas fa-eye text-lg"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div class="lg:col-span-5">
                        <!-- Right Section Buttons -->
                        <div class="border rounded-lg p-4 mb-6">
                                    <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                <div class="flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-4">
                                    {% for radio in form.course_status %}
                                    <label class="inline-flex items-center">
                                        {{ radio.tag }}
                                        <span class="ml-2 text-sm text-gray-700">{{ radio.choice_label }}</span>
                                        </label>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="mb-4">
                                <div class="mb-1">
                                    <label for="{{ form.category.id_for_label }}" class="block text-sm font-medium text-gray-700">Categories</label>
                                </div>
                                <div class="flex items-center gap-2">
                                    {{ form.category }}
                                </div>
                                {% if form.category.errors %}
                                    <div class="mt-1 text-sm text-red-600">
                                        {{ form.category.errors }}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Course Pricing Section - Only show if Order Management is enabled -->
                            {% if order_management_enabled %}
                            <!-- Course Price -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Course Price</label>
                                <div class="flex items-center">
                                    <span class="mr-2 text-gray-500">$</span>
                                    <input type="number" name="price" id="course_price" step="0.01" min="0" value="{{ form.instance.price|default:0 }}" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="0.00">
                                </div>
                            </div>
                            
                            <!-- Discount Coupon Code -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Discount Coupon Code</label>
                                <input type="text" name="coupon_code" id="coupon_code" value="{{ form.instance.coupon_code|default:'' }}" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Enter coupon code">
                                <div class="mt-2 flex items-center">
                                    <label class="block text-sm font-medium text-gray-700 mr-2">Discount %:</label>
                                    <input type="number" name="discount_percentage" id="discount_percentage" min="0" max="100" value="{{ form.instance.discount_percentage|default:0 }}" class="w-24 px-2 py-1 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="0">
                                    <span class="ml-1 text-gray-500">%</span>
                                </div>
                            </div>
                            {% else %}
                            <!-- Hidden pricing fields when order management is disabled -->
                            <input type="hidden" name="price" value="0.00">
                            <input type="hidden" name="coupon_code" value="">
                            <input type="hidden" name="discount_percentage" value="0">
                            {% endif %}
                            
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <!-- Course Actions -->
                                <a href="{% url 'courses:topic_create' course.id %}" class="btn-action flex items-center justify-center p-2 border rounded-lg bg-[#1c2261] text-white">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                    </svg>
                                    <span>Add Topic</span>
                                </a>
                                <a href="{% url 'courses:course_users' course.id %}" class="btn-action flex items-center justify-center p-2 border rounded-lg bg-[#1c2261] text-white" data-bypass-warning>
                                    <span class="text-sm">Users +</span>
                                </a>
                                <a href="{% url 'lms_outcomes:create_outcome' %}" class="btn-action flex items-center justify-center p-2 border rounded-lg bg-[#1c2261] text-white">
                                    <span class="text-sm">Outcome</span>
                                </a>
                                <a href="{% url 'lms_rubrics:create' %}" class="btn-action flex items-center justify-center p-2 border rounded-lg bg-[#1c2261] text-white">
                                    <span class="text-sm">Rubrics</span>
                                </a>
                                <a href="{% url 'groups:group_list' %}?tab=course-groups" class="btn-action flex items-center justify-center p-2 border rounded-lg bg-[#1c2261] text-white" data-bypass-warning>
                                    <span class="text-sm">Groups +</span>
                                </a>
                                <a href="{% url 'courses:course_settings' course.id %}" class="btn-action flex items-center justify-center p-2 border rounded-lg bg-[#1c2261] text-white" data-bypass-warning>
                                    <span class="text-sm">Settings</span>
                                </a>
                            </div>

                            
                        </div>

                        <!-- Right Column - Topics -->
                        <div class="bg-white rounded-lg border">
                            <div class="flex items-center justify-between p-3 border-b">
                                <h3 class="text-base font-medium">Topic Section</h3>
                                <button type="button" onclick="showSectionModal()" class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none">
                                    <svg class="-ml-0.5 mr-1 h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                    </svg>
                                    Add Section
                                </button>
                            </div>
                            <div class="p-4">
                               
                                
                                <!-- Sections -->
                                <div class="sections-list" id="sections-container">
                                    {% for section in sections %}
                                    <div class="section-item section-container mb-3" id="section-{{ section.id }}" data-id="{{ section.id }}" data-section-id="{{ section.id }}">
                                        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between p-2 bg-gray-100 rounded-t-md border border-gray-200 gap-2 sm:gap-0">
                                            <div class="flex items-center">
                                                <span class="section-drag-handle mr-2 cursor-grab opacity-70 hover:opacity-100">
                                                    <svg class="h-4 w-4 text-gray-500" fill="currentColor" viewBox="0 0 24 24">
                                                        <path d="M8 6a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm0 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm0 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm8-16a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm0 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm0 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"></path>
                                                    </svg>
                                                </span>
                                                <svg class="section-toggle h-4 w-4 mr-1 cursor-pointer" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                </svg>
                                                <span class="font-semibold text-sm section-name max-w-[150px] sm:max-w-[200px] inline-block" title="{{ section.name }}" data-section-id="{{ section.id }}">{{ section.name|default:"Section" }}</span>
                                            </div>
                                            <div class="flex items-center space-x-1">
                                                <button type="button" data-section-id="{{ section.id }}" data-section-name="{{ section.name|escapejs }}" onclick="handleRenameSection(this)" class="text-xs px-2 py-1 bg-white border border-gray-300 rounded-md hover:bg-gray-50" title="Rename section">
                                                    <svg class="h-3.5 w-3.5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                                                    </svg>
                                                </button>
                                                <button type="button" data-section-id="{{ section.id }}" onclick="handleDeleteSection(this)" class="text-xs px-2 py-1 bg-white border border-gray-300 rounded-md hover:bg-gray-50" title="Delete section">
                                                    <svg class="h-3.5 w-3.5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="section-topics px-3 py-2 bg-gray-50">
                                            <div class="topic-list" data-section-id="{{ section.id }}">
                                                {% for topic in section.topics.all %}
                                                <div class="topic-item mb-1 p-2 bg-white rounded-md border border-gray-200 relative group" 
                                                     id="topic-{{ topic.id }}" 
                                                     data-topic-id="{{ topic.id }}" 
                                                     data-section-id="{{ section.id }}">
                                                    <div class="flex items-center justify-between">
                                                        <div class="flex items-center">
                                                            <span class="drag-handle mr-2 cursor-grab opacity-30 group-hover:opacity-100 topic-drag-handle">
                                                                <svg class="h-4 w-4 text-gray-500" fill="currentColor" viewBox="0 0 24 24">
                                                                    <path d="M8 6a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm0 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm0 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm8-16a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm0 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm0 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"></path>
                                                                </svg>
                                                            </span>
                                                            <!-- Topic type icon -->
                                                            <span class="content-type-icon content-type-{{ topic.content_type|lower }} mr-2 h-5 w-5 flex-shrink-0">
                                                                {% if topic.content_type == 'SCORM' %}
                                                                    <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                                                                        <path d="M4 6h16v12H4V6zm2 2v8h12V8H6zm5 2h2v4h-2v-4z"/>
                                                                    </svg>
                                                                {% elif topic.content_type == 'Video' %}
                                                                    <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                                                                        <path d="M8 5v14l11-7z"/>
                                                                    </svg>
                                                                {% elif topic.content_type == 'Document' %}
                                                                    <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                                                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 1v5h5v10H6V4h7zm-2 8H8v-1h3v1zm0 2H8v-1h3v1zm0 2H8v-1h3v1zm5-4h-3v-1h3v1zm0 2h-3v-1h3v1zm0 2h-3v-1h3v1z"/>
                                                                    </svg>
                                                                {% elif topic.content_type == 'Text' %}
                                                                    <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                                                                        <path d="M19 5v14H5V5h14m0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-2 14H7v-2h10v2zm0-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                                                                    </svg>
                                                                {% elif topic.content_type == 'Audio' %}
                                                                    <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                                                                        <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                                                                    </svg>
                                                                {% elif topic.content_type == 'Web' %}
                                                                    <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                                                                        <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zm6.93 6h-2.95a15.65 15.65 0 0 0-1.38-3.56A8.03 8.03 0 0 1 18.92 8zM12 4.04c.83 1.2 1.48 2.53 1.91 3.96h-3.82c.43-1.43 1.08-2.76 1.91-3.96zM4.26 14C4.1 13.36 4 12.69 4 12s.1-1.36.26-2h3.38c-.08.66-.14 1.32-.14 2s.06 1.34.14 2H4.26zm.82 2h2.95c.32 1.25.78 2.45 1.38 3.56A7.99 7.99 0 0 1 5.08 16zM5.08 8h2.95c.32-1.25.78-2.45 1.38-3.56A8.03 8.03 0 0 0 5.08 8zm1.77 6h10.3c.1-.66.16-1.32.16-2s-.06-1.34-.16-2H6.85c-.1.66-.16 1.32-.16 2s.06 1.34.16 2h3.38c.16.64.26 1.31.26 2s-.1 1.36-.26 2h-3.38z"/>
                                                                    </svg>
                                                                {% elif topic.content_type == 'Quiz' %}
                                                                    <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                                                                        <path d="M4 6h16v12H4V6zm2 2v8h12V8H6zm8 6H8v-1h6v1zm0-3H8v-1h6v1zm0-2H8v-1h6v1z"/>
                                                                    </svg>
                                                                {% elif topic.content_type == 'Assignment' %}
                                                                    <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                                                                        <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm-2 14l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/>
                                                                    </svg>
                                                                {% elif topic.content_type == 'EmbedVideo' %}
                                                                    <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                                                                        <path d="M10 8v8l6-4zm11-5v18H3V3h18zm-2 2H5v14h14V5z"/>
                                                                    </svg>
                                                                {% elif topic.content_type == 'Conference' %}
                                                                    <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                                                                        <path d="M16 10c1.66 0 2.99-1.34 2.99-3S17.66 4 16 4c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 4 8 4C6.34 4 5 5.34 5 7s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V20h14v-4.5c0-2.33-4.67-3.5-7-3.5z"/>
                                                                    </svg>
                                                                {% elif topic.content_type == 'Discussion' %}
                                                                    <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                                                                        <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
                                                                    </svg>
                                                                {% else %}
                                                                    <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                                                                        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14h-2V9h-2V7h4v10z"/>
                                                                    </svg>
                                        {% endif %}
                                                            </span>
                                                            <span class="text-sm truncate max-w-[150px] inline-block" title="{{ topic.title }}">{{ topic.title }}</span>
                                                            <!-- Dot indicator -->
                                                            <span class="text-gray-400 mx-1">•</span>
                                            </div>
                                                        <div class="flex items-center space-x-1 transition-opacity">
                                                            <!-- Status toggle (eye) button -->
                                                            <button type="button" 
                                                                    class="toggle-status-btn text-xs px-2 py-1 bg-white border border-gray-300 rounded-md hover:bg-gray-50" 
                                                                    data-topic-id="{{ topic.id }}" 
                                                                    data-status="{{ topic.status }}"
                                                                    title="{{ topic.status|title }} - Click to toggle status">
                                                                {% if topic.status == 'draft' %}
                                                                <svg class="h-3.5 w-3.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
                                                                </svg>
                                                                {% else %}
                                                                <svg class="h-3.5 w-3.5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                                                </svg>
                                        {% endif %}
                                                            </button>
                                                            <!-- Preview button -->
                                                            <a href="{% url 'courses:topic_view' topic.id %}" target="_blank" class="text-xs px-2 py-1 bg-white border border-gray-300 rounded-md hover:bg-gray-50" title="Preview Topic">
                                                                <svg class="h-3.5 w-3.5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                                                </svg>
                                                            </a>
                                                            <a href="{% if topic.section %}{% url 'courses:topic_section_edit' topic.id topic.section.id %}{% else %}{% url 'courses:topic_edit' topic.id %}{% endif %}" class="text-xs px-2 py-1 bg-white border border-gray-300 rounded-md hover:bg-gray-50" title="Edit Topic">
                                                                <svg class="h-3.5 w-3.5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                                                                </svg>
                                                            </a>
                                                            <!-- Delete button -->
                                                            <button type="button" 
                                                                    class="delete-topic-btn text-xs px-2 py-1 bg-white border border-gray-300 rounded-md hover:bg-red-50 hover:border-red-300" 
                                                                    data-topic-id="{{ topic.id }}" 
                                                                    data-topic-title="{{ topic.title }}"
                                                                    title="Delete Topic">
                                                                <svg class="h-3.5 w-3.5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                                </svg>
                                                            </button>
                                    </div>
                                </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                    
                                    <!-- Standalone Topics as a section -->
                                    {% if topics_without_section %}
                                    <div class="section-item section-container mb-3" id="section-standalone" data-id="standalone" data-section-id="standalone">
                                        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between p-2 bg-gray-100 rounded-t-md border border-gray-200 gap-2 sm:gap-0">
                                            <div class="flex items-center">
                                                <span class="section-drag-handle mr-2 cursor-grab opacity-70 hover:opacity-100">
                                                    <svg class="h-4 w-4 text-gray-500" fill="currentColor" viewBox="0 0 24 24">
                                                        <path d="M8 6a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm0 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm0 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm8-16a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm0 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm0 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"></path>
                                                    </svg>
                                                </span>
                                                <svg class="section-toggle h-4 w-4 mr-1 cursor-pointer" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                </svg>
                                                <span class="font-semibold text-sm section-name max-w-[150px] sm:max-w-[200px] inline-block" title="Standalone Topics" data-section-id="standalone">Standalone Topics</span>
                                            </div>
                                        </div>
                                        <div class="section-topics px-3 py-2 bg-gray-50">
                                            <div class="topic-list" data-section-id="standalone">
                                                {% for topic in topics_without_section %}
                                                <div class="topic-item mb-1 p-2 bg-white rounded-md border border-gray-200 relative group" 
                                                     id="topic-{{ topic.id }}" 
                                                     data-topic-id="{{ topic.id }}" 
                                                     data-section-id="null">
                                                    <div class="flex items-center justify-between">
                                                        <div class="flex items-center">
                                                            <span class="drag-handle mr-2 cursor-grab opacity-30 group-hover:opacity-100 topic-drag-handle">
                                                                <svg class="h-4 w-4 text-gray-500" fill="currentColor" viewBox="0 0 24 24">
                                                                    <path d="M8 6a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm0 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm0 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm8-16a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm0 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm0 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"></path>
                                                                </svg>
                                                            </span>
                                                            <!-- Topic type icon -->
                                                            <span class="content-type-icon content-type-{{ topic.content_type|lower }} mr-2 h-5 w-5 flex-shrink-0">
                                                                {% if topic.content_type == 'SCORM' %}
                                                                    <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                                                                        <path d="M4 6h16v12H4V6zm2 2v8h12V8H6zm5 2h2v4h-2v-4z"/>
                                                                    </svg>
                                                                {% elif topic.content_type == 'Video' %}
                                                                    <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                                                                        <path d="M8 5v14l11-7z"/>
                                                                    </svg>
                                                                {% elif topic.content_type == 'Document' %}
                                                                    <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                                                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 1v5h5v10H6V4h7zm-2 8H8v-1h3v1zm0 2H8v-1h3v1zm0 2H8v-1h3v1zm5-4h-3v-1h3v1zm0 2h-3v-1h3v1zm0 2h-3v-1h3v1z"/>
                                                                    </svg>
                                                                {% elif topic.content_type == 'Text' %}
                                                                    <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                                                                        <path d="M19 5v14H5V5h14m0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-2 14H7v-2h10v2zm0-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                                                                    </svg>
                                                                {% elif topic.content_type == 'Audio' %}
                                                                    <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                                                                        <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                                                                    </svg>
                                                                {% elif topic.content_type == 'Web' %}
                                                                    <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                                                                        <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zm6.93 6h-2.95a15.65 15.65 0 0 0-1.38-3.56A8.03 8.03 0 0 1 18.92 8zM12 4.04c.83 1.2 1.48 2.53 1.91 3.96h-3.82c.43-1.43 1.08-2.76 1.91-3.96zM4.26 14C4.1 13.36 4 12.69 4 12s.1-1.36.26-2h3.38c-.08.66-.14 1.32-.14 2s.06 1.34.14 2H4.26zm.82 2h2.95c.32 1.25.78 2.45 1.38 3.56A7.99 7.99 0 0 1 5.08 16zM5.08 8h2.95c.32-1.25.78-2.45 1.38-3.56A8.03 8.03 0 0 0 5.08 8zm1.77 6h10.3c.1-.66.16-1.32.16-2s-.06-1.34-.16-2H6.85c-.1.66-.16 1.32-.16 2s.06 1.34.16 2h3.38c.16.64.26 1.31.26 2s-.1 1.36-.26 2h-3.38z"/>
                                                                    </svg>
                                                                {% elif topic.content_type == 'Quiz' %}
                                                                    <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                                                                        <path d="M4 6h16v12H4V6zm2 2v8h12V8H6zm8 6H8v-1h6v1zm0-3H8v-1h6v1zm0-2H8v-1h6v1z"/>
                                                                    </svg>
                                                                {% elif topic.content_type == 'Assignment' %}
                                                                    <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                                                                        <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm-2 14l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/>
                                                                    </svg>
                                                                {% elif topic.content_type == 'EmbedVideo' %}
                                                                    <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                                                                        <path d="M10 8v8l6-4zm11-5v18H3V3h18zm-2 2H5v14h14V5z"/>
                                                                    </svg>
                                                                {% elif topic.content_type == 'Conference' %}
                                                                    <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                                                                        <path d="M16 10c1.66 0 2.99-1.34 2.99-3S17.66 4 16 4c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 4 8 4C6.34 4 5 5.34 5 7s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V20h14v-4.5c0-2.33-4.67-3.5-7-3.5z"/>
                                                                    </svg>
                                                                {% elif topic.content_type == 'Discussion' %}
                                                                    <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                                                                        <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
                                                                    </svg>
                                                                {% else %}
                                                                    <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                                                                        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14h-2V9h-2V7h4v10z"/>
                                                                    </svg>
                                                                {% endif %}
                                                            </span>
                                                            <span class="text-sm truncate max-w-[150px] inline-block" title="{{ topic.title }}">{{ topic.title }}</span>
                                                            <!-- Dot indicator -->
                                                            <span class="text-gray-400 mx-1">•</span>
                                                        </div>
                                                        <div class="flex items-center space-x-1 transition-opacity">
                                                            <!-- Status toggle (eye) button -->
                                                            <button type="button" 
                                                                    class="toggle-status-btn text-xs px-2 py-1 bg-white border border-gray-300 rounded-md hover:bg-gray-50" 
                                                                    data-topic-id="{{ topic.id }}" 
                                                                    data-status="{{ topic.status }}"
                                                                    title="{{ topic.status|title }} - Click to toggle status">
                                                                {% if topic.status == 'draft' %}
                                                                <svg class="h-3.5 w-3.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
                                                                </svg>
                                                                {% else %}
                                                                <svg class="h-3.5 w-3.5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                                                </svg>
                                                                {% endif %}
                                                            </button>
                                                            <!-- Preview button -->
                                                            <a href="{% url 'courses:topic_view' topic.id %}" target="_blank" class="text-xs px-2 py-1 bg-white border border-gray-300 rounded-md hover:bg-gray-50" title="Preview Topic">
                                                                <svg class="h-3.5 w-3.5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                                                </svg>
                                                            </a>
                                                            <a href="{% if topic.section %}{% url 'courses:topic_section_edit' topic.id topic.section.id %}{% else %}{% url 'courses:topic_edit' topic.id %}{% endif %}" class="text-xs px-2 py-1 bg-white border border-gray-300 rounded-md hover:bg-gray-50" title="Edit Topic">
                                                                <svg class="h-3.5 w-3.5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                                                                </svg>
                                                            </a>
                                                            <!-- Delete button -->
                                                            <button type="button" 
                                                                    class="delete-topic-btn text-xs px-2 py-1 bg-white border border-gray-300 rounded-md hover:bg-red-50 hover:border-red-300" 
                                                                    data-topic-id="{{ topic.id }}" 
                                                                    data-topic-title="{{ topic.title }}"
                                                                    title="Delete Topic">
                                                                <svg class="h-3.5 w-3.5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                                </svg>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                            <div class="mt-2 flex justify-end">
                                                <a href="{% url 'courses:topic_create' course.id %}?section=standalone" class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none">
                                                    <svg class="-ml-0.5 mr-1 h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                                    </svg>
                                                    Add Topic
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Form actions -->
<div class="mt-6 flex items-center justify-end gap-x-6 px-6 py-4 bg-gray-50 border-t rounded-b-lg">
    <a href="{% url 'courses:course_details' course.id %}" id="cancel-edit-button" class="text-sm font-medium text-gray-600 hover:text-gray-500">
            Cancel
    </a>
    <button type="submit" name="direct_submit" id="course-submit-button" class="px-4 py-2 text-white font-medium rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-600" style="background-color: #1c2260;" onmouseover="this.style.backgroundColor='#181f56'" onmouseout="this.style.backgroundColor='#1c2260'">
        Update Course
    </button>
    
    <!-- Fallback submit button in case JavaScript fails -->
    <noscript>
        <button type="submit" name="direct_submit" class="px-4 py-2 text-white font-medium rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-600" style="background-color: #1c2260; margin-left: 10px;">
            Update Course (No JS)
        </button>
    </noscript>
    </div>
</form>
</div>

<!-- Add Section Modal -->
<div id="add-section-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 hidden overflow-y-auto h-full w-full z-50 flex items-center justify-center">
    <div class="relative mx-auto p-4 border border-gray-300 w-full max-w-md shadow-2xl rounded-lg bg-white">
        <div class="flex justify-between items-center mb-3 border-b pb-2">
            <h3 class="text-lg font-semibold text-gray-800">Add New Section</h3>
            <button type="button" class="text-gray-500 hover:text-gray-700 transition focus:outline-none" onclick="hideSectionModal()">
                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        
        <form id="newSectionForm" class="space-y-4" method="POST" action="{% url 'courses:section_create' course.id %}">
            {% csrf_token %}
            
            <div>
                <label for="section_name" class="block text-sm font-medium text-gray-700 mb-1">Section Title (Optional)</label>
                <input type="text" id="section_name" name="name" 
                    class="w-full px-3 py-2 text-sm rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                    placeholder="Section title is optional">
            </div>
            
            
            <div class="flex justify-end space-x-3 pt-4 border-t">
                <button type="button" onclick="hideSectionModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none">
                    Cancel
                </button>
                <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 border border-transparent rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none">
                    Save Section
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Move Topic to Section Modal -->
<div id="move-topic-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 hidden overflow-y-auto h-full w-full z-50 flex items-center justify-center">
    <div class="relative mx-auto p-4 border border-gray-300 w-full max-w-md shadow-2xl rounded-lg bg-white">
        <div class="flex justify-between items-center mb-3 border-b pb-2">
            <h3 class="text-lg font-semibold text-gray-800">Move Topic to Section</h3>
            <button type="button" class="text-gray-500 hover:text-gray-700 transition focus:outline-none" onclick="hideMoveTopicModal()">
                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        
        <form id="moveTopicForm" class="space-y-4" method="POST" action="{% url 'courses:move_topic_to_section' %}">
            {% csrf_token %}
            <input type="hidden" id="topic_id_to_move" name="topic_id">
            
                <div>
                <label for="target_section" class="block text-sm font-medium text-gray-700 mb-1">Select Section</label>
                <select id="target_section" name="section_id" class="w-full px-3 py-2 text-sm rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    {% for section in course.sections.all %}
                    <option value="{{ section.id }}">{{ section.name }}</option>
                    {% endfor %}
                    <option value="">Remove from section</option>
                </select>
                        </div>
                        
            <div class="flex justify-end space-x-3 pt-4 border-t">
                <button type="button" onclick="hideMoveTopicModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none">
                    Cancel
                </button>
                <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 border border-transparent rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none">
                    Move Topic
                </button>
            </div>
        </form>
    </div>
</div>


<!-- Include at the end of the file, before the closing </body> tag -->
<script src="{% static 'core/js/safe-fetch-utils.js' %}"></script>
<!-- Removed notifications.js to prevent conflicts with unified notification system -->

<script>
// Declare global variables for editor elements so they can be accessed from all scripts
let descriptionEditor;
let hiddenInput;





// Initialize debugging for drag and drop operations
document.addEventListener('DOMContentLoaded', function() {
    
    // Initialize global variables
    descriptionEditor = document.getElementById('custom-description-editor');
    hiddenInput = document.getElementById('description-input');
    
    // Initialize the custom text editor
    const characterCountElement = document.getElementById('character-count');
    const wordCountElement = document.getElementById('word-count');
    
    // Check for and fix "single bracket" issue
    if (descriptionEditor) {
        if (descriptionEditor.textContent === '{' || 
            descriptionEditor.innerHTML === '{' || 
            descriptionEditor.innerHTML === '<p>{</p>') {
            console.log('Fixing single bracket issue');
            descriptionEditor.innerHTML = '<br>';
            
            // Also fix the hidden input if it just contains a bracket
            if (hiddenInput && (hiddenInput.value === '{' || hiddenInput.value === '{}')) {
                hiddenInput.value = JSON.stringify({
                    delta: {},
                    html: '<br>'
                });
            }
        }
    }
    
    // Function to update character and word counts
    function updateTextStats() {
        if (!descriptionEditor || !characterCountElement || !wordCountElement) {
            console.warn('updateTextStats: One or more required elements not found');
            return;
        }
        
        try {
            // Get text content without HTML tags - use innerText instead of textContent
            // innerText respects display styling and returns text as it appears in the browser
            const text = descriptionEditor.innerText || '';
            
            // Update character count
            const charCount = text.length;
            characterCountElement.textContent = charCount;
            
            // Update word count - improved word counting logic
            const words = text.trim().match(/\S+/g) || [];
            const wordCount = words.length;
            wordCountElement.textContent = wordCount;
            
            // Debug log for text stats
            console.log(`Text stats updated: ${charCount} chars, ${wordCount} words`);
        } catch (error) {
            console.error('Error updating text stats:', error);
        }
    }
    
    if (descriptionEditor && hiddenInput) {
        // Set initial content from hidden input if in JSON format
        try {
            let contentObj;
            // Handle empty or invalid JSON values
            if (hiddenInput.value && hiddenInput.value.trim() !== '' && hiddenInput.value.trim() !== '{') {
                try {
                    contentObj = JSON.parse(hiddenInput.value);
                } catch (parseError) {
                    console.warn('Failed to parse description JSON, using fallback:', parseError);
                    // Try to extract HTML from a string that looks like a JSON but isn't valid
                    const htmlMatch = hiddenInput.value.match(/"html":"(.*?)"/s);
                    if (htmlMatch && htmlMatch[1]) {
                        const extractedHtml = htmlMatch[1]
                            .replace(/\\"/g, '"')
                            .replace(/\\n/g, '\n')
                            .replace(/\\\\/g, '\\');
                        contentObj = { html: extractedHtml };
                    } else {
                        // Use the value directly if it doesn't look like JSON
                        contentObj = { 
                            html: hiddenInput.value.startsWith('{') && hiddenInput.value.endsWith('}') 
                                ? '<br>' 
                                : hiddenInput.value 
                        };
                    }
                }
            } else {
                contentObj = { html: '<br>' };
            }
            
            if (contentObj && contentObj.html) {
                // Ensure content always ends with a BR tag for better cursor handling
                let html = contentObj.html;
                if (html.trim() === '' || html === '{') {
                    html = '<br>';
                }
                
                // Set the editor content and force a redraw
                descriptionEditor.innerHTML = html;
                
                // Force trigger input event to ensure stats update
                const inputEvent = new Event('input', {
                    bubbles: true,
                    cancelable: true,
                });
                descriptionEditor.dispatchEvent(inputEvent);
                
                // Also update the stats directly
                updateTextStats();
                
                console.log('Editor initialized with content:', 
                    html.substring(0, 50) + (html.length > 50 ? '...' : ''));
            }
        } catch (e) {
            console.error('Error setting initial editor content:', e);
            // Provide a fallback when JSON parsing fails
            descriptionEditor.innerHTML = '<br>';
            hiddenInput.value = JSON.stringify({
                delta: {},
                html: '<br>'
            });
            updateTextStats();
        }
        
        // Update hidden input and text stats when content changes
        descriptionEditor.addEventListener('input', function() {
            let html = descriptionEditor.innerHTML;
            
            // Make sure empty content has a BR tag for cursor placement
            if (html.trim() === '') {
                html = '<br>';
                // Only update innerHTML if it's actually empty to avoid cursor jumping
                if (descriptionEditor.innerHTML === '') {
                    descriptionEditor.innerHTML = html;
                }
            }
            
            // Store in hidden input
            hiddenInput.value = JSON.stringify({
                delta: {},
                html: html
            });
            
            // Ensure text stats are updated
            updateTextStats();
            updateActiveFormatButton();
            
            console.log('Editor content updated:', html.substring(0, 50) + (html.length > 50 ? '...' : ''));
        });
        
        // Force an initial update of text stats
        setTimeout(function() {
            updateTextStats();
            console.log('Initial text stats update triggered');
        }, 500);
        
        // Enhanced editor event handling
        if (descriptionEditor) {
            // Make sure the editor is initialized with contenteditable
            descriptionEditor.setAttribute('contenteditable', 'true');
            
            // Fix cursor issues with empty editor
            if (descriptionEditor.innerHTML === '' || descriptionEditor.innerHTML === '{') {
                descriptionEditor.innerHTML = '<p><br></p>';
            }
            
            // Update buttons when cursor position changes
            const editorEvents = ['click', 'keyup', 'mouseup', 'touchend', 'focus', 'input'];
            editorEvents.forEach(eventType => {
                descriptionEditor.addEventListener(eventType, function(e) {
                    // Don't process for modifier keys alone
                    if (eventType === 'keyup' && (e.ctrlKey || e.metaKey || e.altKey)) {
                        return;
                    }
                    
                    // Delay slightly to let browser finish rendering
                    setTimeout(updateActiveFormatButton, 10);
                    
                    // Also update character and word counts
                    if (['input', 'keyup'].includes(eventType)) {
                        setTimeout(updateTextStats, 10);
                    }
                });
            });
            
            // Fix issues with losing focus
            descriptionEditor.addEventListener('blur', function() {
                // Store for possible later use
                if (window.getSelection().rangeCount > 0) {
                    const range = window.getSelection().getRangeAt(0);
                    if (range.commonAncestorContainer === descriptionEditor || 
                        descriptionEditor.contains(range.commonAncestorContainer)) {
                        window._savedEditorRange = range.cloneRange();
                    }
                }
            });
            
            // Listen for selection changes across the document
            document.addEventListener('selectionchange', function() {
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    const container = range.commonAncestorContainer;
                    
                    // Check if the selection is within our editor
                    let isInEditor = false;
                    let currentNode = container;
                    
                    while (currentNode && !isInEditor) {
                        if (currentNode === descriptionEditor) {
                            isInEditor = true;
                        }
                        currentNode = currentNode.parentNode;
                    }
                    
                    if (isInEditor) {
                        // Save this range for future reference
                        window._savedEditorRange = range.cloneRange();
                        updateActiveFormatButton();
                    }
                }
            });
        }
        
        // Enhanced function to update active formatting buttons based on cursor position
        function updateActiveFormatButton() {
            // Safety check - don't proceed if editor is not found
            if (!descriptionEditor) {
                console.warn('Cannot update format buttons: editor not found');
                return;
            }
            
            // Get current selection
            const selection = window.getSelection();
            
            // No need to proceed if there's no selection or it's not in the editor
            if (selection.rangeCount === 0) {
                return;
            }
            
            try {
                const range = selection.getRangeAt(0);
                
                // Check if selection is in our editor
                let isInEditor = false;
                let node = range.commonAncestorContainer;
                while (node && !isInEditor) {
                    if (node === descriptionEditor) {
                        isInEditor = true;
                    }
                    node = node.parentNode;
                }
                
                if (!isInEditor) {
                    return;
                }
                
                // Get the parent element of the selection
                const parentElement = range.commonAncestorContainer.nodeType === 1 ? 
                    range.commonAncestorContainer : 
                    range.commonAncestorContainer.parentElement;
                
                if (!parentElement) {
                    return;
                }
                
                // Reset all format buttons
                const formatButtons = document.querySelectorAll('.format-btn');
                formatButtons.forEach(btn => btn.classList.remove('active'));
                
                // Also update inline formatting buttons (bold, italic, etc.)
                const commandButtons = {
                    'bold': document.querySelector('button[data-command="bold"]'),
                    'italic': document.querySelector('button[data-command="italic"]'),
                    'underline': document.querySelector('button[data-command="underline"]'),
                    'strikeThrough': document.querySelector('button[data-command="strikeThrough"]'),
                    'justifyLeft': document.querySelector('button[data-command="justifyLeft"]'),
                    'justifyCenter': document.querySelector('button[data-command="justifyCenter"]'),
                    'justifyRight': document.querySelector('button[data-command="justifyRight"]'),
                    'justifyFull': document.querySelector('button[data-command="justifyFull"]')
                };
                
                // Update state for each command button
                for (const [command, button] of Object.entries(commandButtons)) {
                    if (button) {
                        try {
                            const isActive = document.queryCommandState(command);
                            button.classList.toggle('active', isActive);
                        } catch (e) {
                            console.warn(`Error checking state for ${command}:`, e);
                        }
                    }
                }
                
                // Check for block formats (headings, blockquote, etc.)
                if (parentElement) {
                    let currentNode = parentElement;
                    while (currentNode && currentNode !== descriptionEditor) {
                        const nodeName = currentNode.nodeName.toLowerCase();
                        // Check for heading or other format elements
                        if (['h1', 'h2', 'h3', 'h4', 'blockquote', 'pre'].includes(nodeName)) {
                            // Find and activate the corresponding button
                            const formatButton = document.querySelector(`.format-btn[data-format="${nodeName}"]`);
                            if (formatButton) {
                                formatButton.classList.add('active');
                            }
                            break;
                        }
                        currentNode = currentNode.parentElement;
                    }
                }
                
                // Extra check for specific commands that might not be properly detected
                const computedStyle = window.getComputedStyle(parentElement);
                
                // Check for text alignment
                const textAlign = computedStyle.textAlign;
                if (textAlign && commandButtons[`justify${textAlign.charAt(0).toUpperCase() + textAlign.slice(1)}`]) {
                    const alignButton = commandButtons[`justify${textAlign.charAt(0).toUpperCase() + textAlign.slice(1)}`];
                    if (alignButton) {
                        alignButton.classList.add('active');
                    }
                }
            } catch (error) {
                console.error('Error updating format buttons:', error);
            }
        }
        
        // Call once on init to set initial state
        updateActiveFormatButton();
        
        // Handle form submission to ensure hidden input is updated
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function(e) {
                let html;
                // Check if we're in HTML view mode or WYSIWYG mode
                if (descriptionEditor.getAttribute('data-showing-html') === 'true') {
                    // If in HTML view, use the text content
                    try {
                        // Parse and clean the HTML
                        html = descriptionEditor.textContent.trim();
                        if (html === '' || html === '{') {
                            html = '<br>';
                        }
                    } catch (error) {
                        console.error('Error parsing HTML on submit:', error);
                        html = '<br>';
                    }
                } else {
                    // If in WYSIWYG view, use innerHTML
                    html = descriptionEditor.innerHTML;
                    // Ensure empty content has a BR tag
                    if (html.trim() === '' || html.trim() === '{') {
                        html = '<br>';
                    }
                }

                try {
                    // Sanitize the HTML to remove any problematic elements
                    html = sanitizeHtml(html);
                    
                    // Create a proper JSON object
                    const jsonData = {
                        delta: {},
                        html: html
                    };
                    hiddenInput.value = JSON.stringify(jsonData);
                    
                    // Double-check the value was set correctly
                    console.log('Form submission - description value:', hiddenInput.value);
                } catch (error) {
                    console.error('Error creating JSON data:', error);
                    // Fallback to simple JSON with just HTML
                    hiddenInput.value = JSON.stringify({
                        delta: {},
                        html: '<br>'
                    });
                }
            });
        }
        
        // Helper function to sanitize HTML and fix common issues
        function sanitizeHtml(html) {
            if (!html || html.trim() === '' || html === '{') {
                return '<br>';
            }
            
            try {
                // Create a DOMParser to safely parse the HTML
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // Remove any script tags or on* event attributes
                const scripts = doc.querySelectorAll('script');
                scripts.forEach(script => script.remove());
                
                // Remove on* attributes from all elements (event handlers)
                const allElements = doc.querySelectorAll('*');
                allElements.forEach(el => {
                    const attributes = el.attributes;
                    const attributesToRemove = [];
                    
                    for (let i = 0; i < attributes.length; i++) {
                        const attr = attributes[i];
                        if (attr.name.startsWith('on') || 
                            attr.name === 'href' && attr.value.startsWith('javascript:')) {
                            attributesToRemove.push(attr.name);
                        }
                    }
                    
                    attributesToRemove.forEach(attr => el.removeAttribute(attr));
                });
                
                // Fix common TinyMCE issues
                const emptyParagraphs = doc.querySelectorAll('p:empty');
                emptyParagraphs.forEach(p => p.innerHTML = '<br>');
                
                // Get the sanitized HTML from the body
                let sanitized = doc.body.innerHTML;
                
                // Fix additional string-level issues
                return sanitized
                    .replace(/(\r\n|\n|\r)/gm, '') // Remove newlines
                    .replace(/\\(["'])/g, '$1')    // Fix escaped quotes
                    .replace(/<p><\/p>/g, '<p><br></p>') // Empty paragraphs should have br
                    .replace(/<([a-z][a-z0-9]*)[^>]*?\/>/gi, '<$1></$1>'); // Fix self-closing tags
            } catch (error) {
                console.error('Error in sanitizeHtml:', error);
                // Return a safe fallback if parsing fails
                return '<p>' + html.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</p>';
            }
        }
        
        // Set up format buttons with enhanced functionality
        const formatButtons = document.querySelectorAll('.format-btn');
        formatButtons.forEach(button => {
            button.addEventListener('click', function() {
                const format = this.getAttribute('data-format');
                
                // Focus on editor first to ensure we have a selection point
                descriptionEditor.focus();
                
                // Try to restore saved selection if no current selection
                const sel = window.getSelection();
                if (sel.rangeCount === 0 && window._savedEditorRange) {
                    try {
                        sel.removeAllRanges();
                        sel.addRange(window._savedEditorRange);
                    } catch (e) {
                        console.warn('Could not restore saved selection:', e);
                    }
                }
                
                // If still no selection and in editor, create one at end or cursor position
                if (sel.rangeCount === 0) {
                    const range = document.createRange();
                    // Find the last text node or create a cursor position
                    if (descriptionEditor.lastChild) {
                        range.selectNodeContents(descriptionEditor.lastChild);
                        range.collapse(false); // collapse to end
                    } else {
                        descriptionEditor.innerHTML = '<p><br></p>';
                        range.selectNodeContents(descriptionEditor.firstChild);
                    }
                    sel.removeAllRanges();
                    sel.addRange(range);
                }
                
                // Now save this selection
                let savedRange = null;
                if (sel.rangeCount > 0) {
                    savedRange = sel.getRangeAt(0).cloneRange();
                }
                
                // Check if this button is already active (format already applied)
                try {
                    if (this.classList.contains('active')) {
                        // If already active, remove active class and revert to paragraph format
                        this.classList.remove('active');
                        document.execCommand('formatBlock', false, '<p>');
                    } else {
                        // Remove active class from all format buttons
                        formatButtons.forEach(btn => btn.classList.remove('active'));
                        
                        // Add active class to clicked button
                        this.classList.add('active');
                        
                        // Apply the format
                        document.execCommand('formatBlock', false, '<' + format + '>');
                    }
                } catch (e) {
                    console.error('Error applying format:', e);
                }
                
                // Restore selection if it was lost
                if (savedRange) {
                    try {
                        const newSel = window.getSelection();
                        newSel.removeAllRanges();
                        newSel.addRange(savedRange);
                    } catch (e) {
                        console.error('Error restoring selection:', e);
                    }
                }
                
                // Update hidden input
                const html = DOMPurify ? DOMPurify.sanitize(descriptionEditor.innerHTML) : descriptionEditor.innerHTML;
                hiddenInput.value = JSON.stringify({
                    delta: {},
                    html: html
                });
                
                // Force update statistics and button states after formatting
                setTimeout(() => {
                    updateTextStats();
                    updateActiveFormatButton();
                }, 10);
                
                // Focus back on editor
                descriptionEditor.focus();
            });
        });
        
        // Set up editor toolbar buttons with enhanced functionality
        const buttons = document.querySelectorAll('.custom-editor-toolbar button:not(.format-btn)');
        buttons.forEach(button => {
            button.addEventListener('click', function() {
                const command = this.dataset.command;
                
                // Focus the editor first
                descriptionEditor.focus();
                
                // Try to restore saved selection if no current selection exists
                const sel = window.getSelection();
                if (sel.rangeCount === 0 && window._savedEditorRange) {
                    try {
                        sel.removeAllRanges();
                        sel.addRange(window._savedEditorRange);
                    } catch (e) {
                        console.warn('Could not restore saved selection:', e);
                    }
                }
                
                // If still no selection, create one at end or current position
                if (sel.rangeCount === 0) {
                    const range = document.createRange();
                    if (descriptionEditor.lastChild) {
                        range.selectNodeContents(descriptionEditor.lastChild);
                        range.collapse(false); // collapse to end
                    } else {
                        descriptionEditor.innerHTML = '<p><br></p>';
                        range.selectNodeContents(descriptionEditor.firstChild);
                    }
                    sel.removeAllRanges();
                    sel.addRange(range);
                }
                
                // Now save this selection
                let savedRange = null;
                if (sel.rangeCount > 0) {
                    savedRange = sel.getRangeAt(0).cloneRange();
                    // Also store globally for potential later use
                    window._savedEditorRange = savedRange.cloneRange();
                }
                
                if (command === 'createLink') {
                    const url = prompt('Enter the link URL:');
                    if (url) {
                        document.execCommand('createLink', false, url);
                        
                        // Get the newly created link and add target="_blank"
                        const selection = window.getSelection();
                        if (selection.rangeCount > 0) {
                            const range = selection.getRangeAt(0);
                            const linkNode = range.commonAncestorContainer;
                            
                            if (linkNode.nodeName === 'A') {
                                linkNode.setAttribute('target', '_blank');
                                linkNode.setAttribute('rel', 'noopener noreferrer');
                            } else if (linkNode.parentNode && linkNode.parentNode.nodeName === 'A') {
                                linkNode.parentNode.setAttribute('target', '_blank');
                                linkNode.parentNode.setAttribute('rel', 'noopener noreferrer');
                            }
                        }
                    }
                } else if (command === 'showCode') {
                    // Toggle between HTML view and WYSIWYG view
                    const isShowingHTML = descriptionEditor.getAttribute('data-showing-html') === 'true';
                    
                    if (isShowingHTML) {
                        // Switch back to WYSIWYG view
                        try {
                            // Store the content before switching views
                            const htmlContent = descriptionEditor.textContent.trim();
                            
                            // Make sure there's a BR tag for empty content
                            let cleanHtml = htmlContent;
                            if (cleanHtml === '' || cleanHtml === '{') {
                                cleanHtml = '<br>';
                            }
                            
                            // Set the formatted content back to editor
                            descriptionEditor.innerHTML = cleanHtml;
                            
                            // Re-enable formatting buttons
                            const formattingButtons = document.querySelectorAll('.custom-editor-toolbar button');
                            formattingButtons.forEach(btn => {
                                if (btn.dataset.command !== 'showCode') {
                                    btn.disabled = false;
                                }
                            });
                            
                            // Update visual style for editor
                            descriptionEditor.style.fontFamily = ""; // Reset to default formatting
                            descriptionEditor.style.whiteSpace = "";
                        } catch (error) {
                            console.error('Error parsing HTML:', error);
                            descriptionEditor.innerHTML = '<br>';
                        }
                        descriptionEditor.setAttribute('data-showing-html', 'false');
                        this.classList.remove('active');
                    } else {
                        // Switch to HTML view
                        try {
                            // Get current HTML content
                            const formattedHtml = descriptionEditor.innerHTML;
                            
                            // Format the HTML with proper indentation for readability
                            const prettyHtml = formattedHtml
                                .replace(/<div/g, '\n<div')
                                .replace(/<p/g, '\n<p')
                                .replace(/<\/div>/g, '</div>\n')
                                .replace(/<\/p>/g, '</p>\n')
                                .replace(/<br>/g, '<br>\n');
                                
                            // Set the HTML view content
                            descriptionEditor.textContent = prettyHtml;
                            
                            // Disable formatting buttons while in HTML view
                            const formattingButtons = document.querySelectorAll('.custom-editor-toolbar button');
                            formattingButtons.forEach(btn => {
                                if (btn.dataset.command !== 'showCode') {
                                    btn.disabled = true;
                                }
                            });
                            
                            // Change visual style for code editing
                            descriptionEditor.style.fontFamily = "monospace";
                            descriptionEditor.style.whiteSpace = "pre-wrap";
                        } catch (error) {
                            console.error('Error switching to HTML view:', error);
                            descriptionEditor.textContent = descriptionEditor.innerHTML;
                        }
                        
                        descriptionEditor.setAttribute('data-showing-html', 'true');
                        this.classList.add('active');
                    }
                    
                    // Update hidden input even when toggling view mode
                    try {
                        const contentToSave = isShowingHTML ? 
                            descriptionEditor.innerHTML : 
                            descriptionEditor.innerHTML; // We always save innerHTML to keep formatting
                            
                        hiddenInput.value = JSON.stringify({
                            delta: {},
                            html: contentToSave
                        });
                        updateTextStats();
                    } catch (error) {
                        console.error('Error updating hidden input during view toggle:', error);
                    }
                } else {
                    document.execCommand(command, false, null);
                }
                
                // Update hidden input after executing command
                if (command !== 'showCode') {
                    const html = DOMPurify ? DOMPurify.sanitize(descriptionEditor.innerHTML) : descriptionEditor.innerHTML;
                    hiddenInput.value = JSON.stringify({
                        delta: {},
                        html: html
                    });
                    
                    // Force update text stats after command execution
                    setTimeout(updateTextStats, 10);
                    
                    // Restore selection if it was lost
                    if (savedRange) {
                        try {
                            sel = window.getSelection();
                            sel.removeAllRanges();
                            sel.addRange(savedRange);
                        } catch (e) {
                            console.error('Error restoring selection:', e);
                        }
                    }
                }
                
                // Focus back on editor
                descriptionEditor.focus();
            });
        });
        
        // Force update text stats when editor changes
        descriptionEditor.addEventListener('input', function() {
            // Ensure the update happens after the DOM is updated
            setTimeout(updateTextStats, 0);
        });
        
        // Add keyboard shortcuts for common commands
        descriptionEditor.addEventListener('keydown', function(e) {
            // Bold: Ctrl+B
            if (e.ctrlKey && e.key === 'b') {
                e.preventDefault();
                document.execCommand('bold', false, null);
            }
            
            // Italic: Ctrl+I
            if (e.ctrlKey && e.key === 'i') {
                e.preventDefault();
                document.execCommand('italic', false, null);
            }
            
            // Underline: Ctrl+U
            if (e.ctrlKey && e.key === 'u') {
                e.preventDefault();
                document.execCommand('underline', false, null);
            }
            
            // Update stats on keyboard input
            updateTextStats();
        });
        
        // Initialize text stats on load
        updateTextStats();
    }
    
    
    
    // Check if Sortable is available
    if (typeof Sortable === 'undefined') {
        console.error('Sortable library not loaded! Drag and drop will not work.');
    } else {
        console.log('Sortable library available (version ' + Sortable.version + ')');
    }
    
    // Log information about topic elements to help debugging
    const topicItems = document.querySelectorAll('.topic-item');
    console.log(`Found ${topicItems.length} topic items on page load`);
    
    // Additional debugging for topic loading
    const sectionTopics = document.querySelectorAll('.section-topics');
    console.log(`Found ${sectionTopics.length} section topic containers`);
    
    sectionTopics.forEach((container, index) => {
        const topicsInSection = container.querySelectorAll('.topic-item');
        console.log(`Section ${index}: ${topicsInSection.length} topics`);
        
        // Check if topics are being rendered
        if (topicsInSection.length === 0) {
            console.warn(`Section ${index} has no topics - checking template rendering`);
            const sectionItem = container.closest('.section-item');
            const sectionId = sectionItem ? sectionItem.dataset.id : 'unknown';
            console.log(`Section ID: ${sectionId}`);
        }
    });
    
    topicItems.forEach((item, index) => {
        const topicId = item.dataset.id || item.dataset.topicId;
        const dragHandle = item.querySelector('.drag-handle, .topic-drag-handle');
        
        if (!topicId) {
            console.warn(`Topic item #${index} is missing ID attributes`);
        }
        
        if (!dragHandle) {
            console.warn(`Topic item #${index} (ID: ${topicId}) is missing drag handle`);
        }
    });
    
    // Check section containers
    console.log(`Found ${sectionTopics.length} section topic containers`);
    
    sectionTopics.forEach((container, index) => {
        const sectionItem = container.closest('.section-item');
        const sectionId = sectionItem ? sectionItem.dataset.id : null;
        
        if (!sectionId) {
            console.warn(`Section container #${index} is missing section ID`);
        }
    });
});
</script>

<!-- TinyMCE is already included via global components above -->
<script src="{% static 'core/js/courses/tinymce-simple-init.js' %}"></script>
<script>
// Additional course-specific TinyMCE handling
(function() {
    'use strict';
    
    console.log('Course Edit Page: Additional TinyMCE handling');
    
    // Wait for TinyMCE to load
    function waitForTinyMCE(callback, maxAttempts = 30) {
        let attempts = 0;
        
        function checkTinyMCE() {
            attempts++;
            
            if (typeof tinymce !== 'undefined' && tinymce.init) {
                console.log('TinyMCE available, proceeding with initialization');
                callback();
            } else if (attempts < maxAttempts) {
                setTimeout(checkTinyMCE, 100);
            } else {
                console.error('TinyMCE failed to load after', maxAttempts, 'attempts');
                // Try to load dynamically as fallback
                loadTinyMCEDynamically(callback);
            }
        }
        
        checkTinyMCE();
    }
    
    // Dynamic TinyMCE loading fallback
    function loadTinyMCEDynamically(callback) {
        if (document.querySelector('script[src*="tinymce.min.js"]')) {
            console.log('TinyMCE script already exists, waiting for it to load');
            setTimeout(() => waitForTinyMCE(callback, 10), 500);
            return;
        }
        
        console.log('Loading TinyMCE dynamically');
        const script = document.createElement('script');
        script.src = '{% static "tinymce_editor/tinymce/tinymce.min.js" %}';
        script.async = true;
        script.onload = function() {
            console.log('TinyMCE loaded dynamically');
            setTimeout(() => callback(), 100);
        };
        script.onerror = function() {
            console.error('Failed to load TinyMCE dynamically');
        };
        document.head.appendChild(script);
    }
    
    // Declare TinyMCE initialization flag
    let tinymceInitialized = false;
    
    // Declare form change detection flag
    let formChangeDetectionActive = false;
    
    // Initialize TinyMCE editors
    function initializeTinyMCEEditors() {
        if (tinymceInitialized) {
            console.log('TinyMCE already initialized, skipping');
            return;
        }
        
        console.log('Initializing TinyMCE editors');
        
        // Use TinyMCE widget system for course description field
        if (typeof window.TinyMCEWidget !== 'undefined' && window.TinyMCEWidget.initializeAll) {
            console.log('Initializing TinyMCE widgets');
            window.TinyMCEWidget.initializeAll();
        }
        
        const textareas = document.querySelectorAll('textarea.tinymce-editor:not([data-tinymce-config])');
        console.log('Found textareas for manual TinyMCE init:', textareas.length);
        
        if (textareas.length === 0) {
            console.log('No textareas found for manual TinyMCE initialization');
            tinymceInitialized = true;
            initializeFormChangeDetection();
            return;
        }
        
        textareas.forEach(function(textarea) {
            // Skip if already initialized
            if (textarea.classList.contains('tinymce-initialized')) {
                console.log('Textarea already initialized:', textarea.id);
                return;
            }
            
            // Ensure textarea has an ID
            if (!textarea.id) {
                textarea.id = 'tinymce-' + Math.random().toString(36).substr(2, 9);
            }
            
            console.log('Initializing TinyMCE for:', textarea.id);
            
            // Mark as being initialized
            textarea.classList.add('tinymce-initialized');
            
            const config = {
                selector: '#' + textarea.id,
                height: 400,
                menubar: false,
                plugins: 'link image lists code fullscreen wordcount aiwriter',
                toolbar: 'undo redo | formatselect | bold italic | bullist numlist | link image code fullscreen | aiwriter',
                content_style: 'body { font-family:Helvetica,Arial,sans-serif; font-size:14px }',
                branding: false,
                promotion: false,
                license_key: 'gpl',
                external_plugins: {
                    'aiwriter': '/static/tinymce_editor/js/plugins/aiwriter/plugin.js'
                },
                setup: function(editor) {
                    editor.on('init', function() {
                        console.log('TinyMCE editor initialized:', editor.id);
                        
                        // Initialize form change detection once editors are ready
                        if (!formChangeDetectionActive) {
                            initializeFormChangeDetection();
                        }
                        
                        // Set up change handlers for this editor with content comparison
                        let initialContent = '';
                        
                        // Store initial content when editor is ready
                        editor.on('LoadContent', function() {
                            initialContent = editor.getContent();
                        });
                        
                        // Add a debounced change handler with content comparison
                        let changeTimeout;
                        const handleEditorChange = function() {
                            clearTimeout(changeTimeout);
                            changeTimeout = setTimeout(() => {
                                // Only trigger if content actually changed
                                if (typeof editor.getContent === 'function') {
                                    const currentContent = editor.getContent();
                                    
                                    if (currentContent !== initialContent) {
                                        console.log('TinyMCE editor content actually changed:', editor.id);
                                        if (typeof window.formHasUnsavedChanges !== 'undefined') {
                                            window.formHasUnsavedChanges = true;
                                        }
                                        if (typeof window.markFormAsChanged === 'function') {
                                            window.markFormAsChanged();
                                        }
                                    } else {
                                        console.log('TinyMCE editor event but no content change:', editor.id);
                                    }
                                }
                            }, 100);
                        };
                        
                        editor.on('change paste Undo Redo SetContent', handleEditorChange);
                    });
                }
            };
            
            // Initialize TinyMCE
            try {
                tinymce.init(config).then(function(editors) {
                    if (editors && editors.length > 0) {
                        console.log('TinyMCE initialized successfully for:', textarea.id);
                    }
                }).catch(function(error) {
                    console.error('Failed to initialize TinyMCE for:', textarea.id, error);
                    // Remove the initialization flag so it can be retried
                    textarea.classList.remove('tinymce-initialized');
                });
            } catch (error) {
                console.error('Error calling tinymce.init for:', textarea.id, error);
                textarea.classList.remove('tinymce-initialized');
            }
        });
        
        tinymceInitialized = true;
    }
    
    // Initialize form change detection
    function initializeFormChangeDetection() {
        if (formChangeDetectionActive) {
            return;
        }
        
        console.log('Initializing form change detection');
        formChangeDetectionActive = true;
        
        // This will be handled by the main course_edit.js file
        // We just need to make sure TinyMCE editors are available
        setTimeout(function() {
            if (typeof window.initFormChangeDetection === 'function') {
                window.initFormChangeDetection();
            }
        }, 100);
    }
    
    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, waiting for TinyMCE');
        waitForTinyMCE(initializeTinyMCEEditors);
    });
    
    // Expose function globally for reinitializing if needed
    window.reinitializeTinyMCE = function() {
        tinymceInitialized = false;
        formChangeDetectionActive = false;
        
        // Remove existing editors
        if (typeof tinymce !== 'undefined' && tinymce.editors) {
            tinymce.editors.forEach(function(editor) {
                try {
                    editor.destroy();
                } catch (e) {
                    console.warn('Error destroying editor:', e);
                }
            });
        }
        
        // Remove initialization flags
        document.querySelectorAll('textarea.tinymce-initialized').forEach(function(textarea) {
            textarea.classList.remove('tinymce-initialized');
        });
        
        // Reinitialize
        waitForTinyMCE(initializeTinyMCEEditors);
    };
    
})();
</script>

<!-- Load comprehensive file upload validator -->


<!-- Load course edit JS for topic title truncation -->
<script src="{% static "js/courses/course_edit.js" %}"></script>


<!-- Topic Status Toggle Functionality -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add event listeners for toggle status buttons
    document.addEventListener('click', function(e) {
        if (e.target.closest('.toggle-status-btn')) {
            e.preventDefault();
            
            const button = e.target.closest('.toggle-status-btn');
            const topicId = button.getAttribute('data-topic-id');
            const currentStatus = button.getAttribute('data-status');
            
            if (!topicId) {
                console.error('No topic ID found for toggle button');
                return;
            }
            
            // Show loading state
            button.disabled = true;
            button.classList.add('opacity-50');
            
            // Make AJAX request to toggle status
            fetch(`/courses/topic/${topicId}/toggle-status/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
            .then(data => {
                if (data.success) {
                    // Update button status and icon
                    button.setAttribute('data-status', data.new_status);
                    button.title = `${data.new_status.charAt(0).toUpperCase() + data.new_status.slice(1)} - Click to toggle status`;
                    
                    // Update the icon based on new status
                    const svg = button.querySelector('svg');
                    if (data.new_status === 'draft') {
                        // Closed eye (draft)
                        svg.className = 'h-3.5 w-3.5 text-gray-400';
                        svg.innerHTML = `
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
                        `;
                    } else {
                        // Open eye (active/published)
                        svg.className = 'h-3.5 w-3.5 text-blue-500';
                        svg.innerHTML = `
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        `;
                    }
                    
                    // Show success message
                    console.log(`Topic status updated: ${data.message}`);
                    
                    // Optional: Show a temporary success indicator
                    const originalBg = button.style.backgroundColor;
                    button.style.backgroundColor = '#10B981'; // Green (keep for success feedback)
                    setTimeout(() => {
                        button.style.backgroundColor = originalBg;
                    }, 1000);
                    
                } else {
                    console.error('Failed to toggle status:', data.error);
                    alert('Failed to update topic status: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error toggling topic status:', error);
                alert('Error updating topic status. Please try again.');
            })
            .finally(() => {
                // Remove loading state
                button.disabled = false;
                button.classList.remove('opacity-50');
            });
        }
    });
    
    // Add event listeners for delete topic buttons
    document.addEventListener('click', function(e) {
        if (e.target.closest('.delete-topic-btn')) {
            e.preventDefault();
            
            const button = e.target.closest('.delete-topic-btn');
            const topicId = button.getAttribute('data-topic-id');
            const topicTitle = button.getAttribute('data-topic-title');
            
            if (!topicId) {
                console.error('No topic ID found for delete button');
                return;
            }
            
            // Show confirmation dialog
            if (confirm(`Are you sure you want to delete the topic "${topicTitle}"? This action cannot be undone.`)) {
                // Check if CSRF token is available
                const csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
                let csrfToken;
                
                if (csrfTokenElement) {
                    csrfToken = csrfTokenElement.value;
                } else {
                    // Fallback: Try to get CSRF token from cookies
                    csrfToken = getCookie('csrftoken');
                }
                
                if (!csrfToken) {
                    alert('Error: CSRF token not found. Please refresh the page and try again.');
                    return;
                }
                
                // Show loading state
                button.disabled = true;
                button.classList.add('opacity-50');
                
                // Make AJAX request to delete topic
                fetch(`/courses/topic/${topicId}/delete/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin'
                })
                .then(response => {
                    if (response.ok) {
                        // Remove the topic item from the DOM
                        const topicItem = button.closest('.topic-item');
                        if (topicItem) {
                            topicItem.remove();
                        }
                        
                        // Show success message to user
                        alert(`Topic "${topicTitle}" has been deleted successfully.`);
                        console.log(`Topic "${topicTitle}" deleted successfully`);
                        
                    } else if (response.status === 403) {
                        throw new Error('Permission denied. You do not have permission to delete this topic.');
                    } else if (response.status === 404) {
                        throw new Error('Topic not found. It may have already been deleted.');
                    } else {
                        throw new Error(`Server error (${response.status}). Please try again.`);
                    }
                })
                .catch(error => {
                    console.error('Error deleting topic:', error);
                    alert('Error deleting topic: ' + error.message);
                    
                    // Remove loading state
                    button.disabled = false;
                    button.classList.remove('opacity-50');
                });
            }
        }
    });
    
    // Image and Video Management Functions
    function removeImage() {
        const imageContainer = document.getElementById('course-image-container');
        const imageInput = document.getElementById('id_course_image');
        const imagePreview = document.getElementById('course-image-preview');
        
        if (imageContainer && imageInput) {
            // Clear the file input
            imageInput.value = '';
            
            // Hide the image container
            imageContainer.classList.add('hidden');
            
            // Clear the preview
            if (imagePreview) {
                imagePreview.src = '';
            }
            
            // Show the file input again
            const fileInputContainer = document.querySelector('.course-image-upload');
            if (fileInputContainer) {
                fileInputContainer.classList.remove('hidden');
            }
        }
    }
    
    function removeVideo() {
        const videoContainer = document.getElementById('course-video-container');
        const videoInput = document.getElementById('id_course_video');
        const videoPreview = document.getElementById('course-video-preview');
        
        if (videoContainer && videoInput) {
            // Clear the file input
            videoInput.value = '';
            
            // Hide the video container
            videoContainer.classList.add('hidden');
            
            // Clear the preview
            if (videoPreview) {
                videoPreview.src = '';
            }
            
            // Show the file input again
            const fileInputContainer = document.querySelector('.course-video-upload');
            if (fileInputContainer) {
                fileInputContainer.classList.remove('hidden');
            }
        }
    }
    
    // Modal Management Functions
    function showSectionModal() {
        const modal = document.getElementById('sectionModal');
        if (modal) {
            modal.classList.remove('hidden');
        }
    }
    
    function hideSectionModal() {
        const modal = document.getElementById('sectionModal');
        if (modal) {
            modal.classList.add('hidden');
        }
    }
    
    function hideMoveTopicModal() {
        const modal = document.getElementById('moveTopicModal');
        if (modal) {
            modal.classList.add('hidden');
        }
    }
});
</script>

<!-- Form submission handler -->
<script>
function handleFormSubmit(event) {
    try {
        // Set form submitting flag to prevent beforeunload confirmation
        if (typeof isFormSubmitting !== 'undefined') {
            isFormSubmitting = true;
        }
        
        // If we have TinyMCE instances, sync them
        if (typeof tinymce !== 'undefined') {
            tinymce.triggerSave();
        }
        
        // Show loading state for submit button
        const submitButton = event.target.querySelector('button[type="submit"]');
        if (submitButton) {
            submitButton.disabled = true;
            submitButton.innerHTML = 'Updating Course...';
        }
        
        // Validate required fields
        const title = document.getElementById('id_title');
        if (title && !title.value.trim()) {
            alert('Course title is required');
            if (submitButton) {
                submitButton.disabled = false;
                submitButton.innerHTML = 'Update Course';
            }
            return false;
        }
        
        return true; // Allow the form to submit
    } catch (error) {
        // Reset button state on error but still allow form submission
        const submitButton = event.target.querySelector('button[type="submit"]');
        if (submitButton) {
            submitButton.disabled = false;
            submitButton.innerHTML = 'Update Course';
        }
        // Don't prevent form submission on JS errors - let it submit anyway
        return true; // Allow form to submit even with JS errors
    }
}

// Add backup click handler for submit button
document.addEventListener('DOMContentLoaded', function() {
    const submitButton = document.getElementById('course-submit-button');
    const form = document.getElementById('courseCreateForm');
    
    if (submitButton) {
        // Remove any existing event listeners and add fresh ones
        const newButton = submitButton.cloneNode(true);
        submitButton.parentNode.replaceChild(newButton, submitButton);
        
        // Add click handler
        newButton.addEventListener('click', function(e) {
            const form = document.getElementById('courseCreateForm');
            if (!form) {
                return;
            }
            
            // Basic validation
            const title = document.getElementById('id_title');
            if (title && !title.value.trim()) {
                e.preventDefault();
                alert('Course title is required');
                return false;
            }
            
            // Set form submitting flag to prevent beforeunload confirmation
            if (typeof isFormSubmitting !== 'undefined') {
                isFormSubmitting = true;
            }
            
            // Sync TinyMCE if available
            if (typeof tinymce !== 'undefined') {
                try {
                    tinymce.triggerSave();
                } catch (err) {
                    // Ignore TinyMCE sync errors
                }
            }
            
            // Show loading state
            this.disabled = true;
            this.innerHTML = 'Updating Course...';
            
            // Force form submission if needed
            setTimeout(() => {
                if (form && !form.submitted) {
                    form.submit();
                    form.submitted = true;
                }
            }, 100);
            
            return true;
        });
    }
    
    if (form) {
        // Add form submit handler
        form.addEventListener('submit', function(e) {
            // Set form submitting flag to prevent beforeunload confirmation
            if (typeof isFormSubmitting !== 'undefined') {
                isFormSubmitting = true;
            }
            return true;
        });
    }
});

<!-- Category functionality removed as requested -->
<script>
console.log('✅ Add Category button has been removed - Template updated successfully');
</script>

{% endblock %}
