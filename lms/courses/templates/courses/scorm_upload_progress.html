{% extends 'base.html' %}
{% load static %}

{% block title %}SCORM Upload Progress - {{ topic.title }}{% endblock %}

{% block extra_css %}
<style>
    .upload-progress-container {
        max-width: 800px;
        margin: 2rem auto;
        padding: 2rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .progress-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .progress-icon {
        font-size: 4rem;
        color: #007bff;
        margin-bottom: 1rem;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }

    .progress-bar-container {
        margin: 2rem 0;
    }

    .progress {
        height: 30px;
        border-radius: 15px;
        overflow: hidden;
        background-color: #e9ecef;
    }

    .progress-bar {
        height: 100%;
        background: linear-gradient(45deg, #007bff, #0056b3);
        border-radius: 15px;
        transition: width 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .progress-bar::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        background-image: linear-gradient(
            -45deg,
            rgba(255, 255, 255, .2) 25%,
            transparent 25%,
            transparent 50%,
            rgba(255, 255, 255, .2) 50%,
            rgba(255, 255, 255, .2) 75%,
            transparent 75%,
            transparent
        );
        background-size: 50px 50px;
        animation: move 2s linear infinite;
    }

    @keyframes move {
        0% { background-position: 0 0; }
        100% { background-position: 50px 50px; }
    }

    .status-message {
        font-size: 1.2rem;
        margin: 1rem 0;
        text-align: center;
        min-height: 1.5rem;
    }

    .file-info {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 6px;
        margin: 1rem 0;
    }

    .recommendations {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 6px;
        padding: 1rem;
        margin: 1rem 0;
    }

    .btn-secondary {
        margin-top: 1rem;
    }

    .alert {
        margin-top: 1rem;
    }

    .spinner-border {
        margin-right: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="upload-progress-container">
    <div class="progress-header">
        <div class="progress-icon">
            <i class="fas fa-cloud-upload-alt"></i>
        </div>
        <h2>SCORM Upload in Progress</h2>
        <p class="text-muted">{{ topic.title }}</p>
    </div>

    <div class="file-info">
        <h5><i class="fas fa-file-archive"></i> File Information</h5>
        <p><strong>Topic:</strong> {{ topic.title }}</p>
        <p><strong>Course:</strong> {{ course.title }}</p>
        <p><strong>Content Type:</strong> SCORM Package</p>
        {% if filename %}
        <p><strong>File:</strong> {{ filename }}</p>
        {% endif %}
    </div>

    <div class="progress-bar-container">
        <div class="progress">
            <div class="progress-bar" id="uploadProgress" style="width: 10%"></div>
        </div>
    </div>

    <div class="status-message" id="statusMessage">
        <span class="spinner-border spinner-border-sm"></span>
        Initializing upload...
    </div>

    <div class="recommendations">
        <h6><i class="fas fa-lightbulb"></i> Please wait while your SCORM package uploads</h6>
        <ul class="mb-0">
            <li>Keep this browser tab open during the upload</li>
            <li>Large files may take several minutes to upload and process</li>
            <li>You'll be automatically redirected when upload completes</li>
            <li>Don't refresh this page or navigate away</li>
        </ul>
    </div>

    <div class="text-center">
        <button type="button" class="btn btn-secondary" onclick="window.location.href='{{ course_edit_url }}'">
            <i class="fas fa-arrow-left"></i> Return to Course (Cancel Upload)
        </button>
    </div>

    <!-- Success/Error alerts will be shown here -->
    <div id="alertContainer"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const statusUrl = '{{ upload_status_url|escapejs }}';
    const courseEditUrl = '{{ course_edit_url|escapejs }}';
    const progressBar = document.getElementById('uploadProgress');
    const statusMessage = document.getElementById('statusMessage');
    const alertContainer = document.getElementById('alertContainer');
    
    let pollCount = 0;
    const maxPolls = 300; // 5 minutes at 1 second intervals
    let progressValue = 10;
    
    function showAlert(message, type = 'info') {
        alertContainer.innerHTML = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
    }
    
    function updateProgress(percentage, message) {
        progressBar.style.width = percentage + '%';
        statusMessage.innerHTML = message;
    }
    
    function checkUploadStatus() {
        fetch(statusUrl)
            .then(response => {
            if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
            .then(data => {
                pollCount++;
                
                if (data.status === 'completed') {
                    // Upload successful
                    updateProgress(100, '<i class="fas fa-check-circle text-success"></i> Upload completed successfully!');
                    showAlert(`
                        <strong>Success!</strong> Your SCORM package has been uploaded successfully.
                        <br><strong>Package:</strong> ${data.package_title || 'SCORM Content'}
                        <br>Redirecting to course page in 3 seconds...
                    `, 'success');
                    
                    // Add success parameters to redirect URL
                    const redirectUrlObj = new URL(courseEditUrl);
                    redirectUrlObj.searchParams.set('scorm_success', 'true');
                    redirectUrlObj.searchParams.set('topic_title', data.topic_title || 'SCORM Topic');
                    redirectUrlObj.searchParams.set('package_title', data.package_title || 'SCORM Package');
                    
                    setTimeout(() => {
                        window.location.href = redirectUrlObj.toString();
                    }, 3000);
                    
                } else if (data.status === 'error') {
                    // Upload failed
                    updateProgress(progressValue, '<i class="fas fa-exclamation-triangle text-danger"></i> Upload failed');
                    showAlert(`
                        <strong>Upload Failed:</strong> ${data.message}
                        <br>Please try again with a smaller file or contact support.
                    `, 'danger');
                    
                } else if (data.status === 'processing') {
                    // Still processing
                    progressValue = Math.min(90, 10 + (pollCount * 2)); // Gradually increase to 90%
                    let message = data.message || 'Processing SCORM package...';
                    
                    if (data.file_size_mb) {
                        const estimatedMinutes = Math.ceil(data.file_size_mb / 10); // Rough estimate
                        message += ` (Est. ${estimatedMinutes} min)`;
                    }
                    
                    updateProgress(progressValue, `<span class="spinner-border spinner-border-sm"></span> ${message}`);
                    
                    // Continue polling
                    if (pollCount < maxPolls) {
                        setTimeout(checkUploadStatus, 2000); // Check every 2 seconds
                    } else {
                        updateProgress(progressValue, '<i class="fas fa-clock text-warning"></i> Upload taking longer than expected');
                        showAlert(`
                            <strong>Upload Timeout:</strong> The upload is taking longer than expected.
                            <br>Large files may take up to 30 minutes. You can safely close this page and check back later.
                        `, 'warning');
                    }
                } else {
                    // Unknown status
                    setTimeout(checkUploadStatus, 2000);
                }
            })
            .catch(error => {
                console.error('Error checking upload status:', error);
                updateProgress(progressValue, '<i class="fas fa-exclamation-triangle text-warning"></i> Connection error');
                
                // Retry after a delay
                if (pollCount < maxPolls) {
                    setTimeout(checkUploadStatus, 5000); // Wait longer on error
                }
            });
    }
    
    // Start checking status
    updateProgress(10, '<span class="spinner-border spinner-border-sm"></span> Starting upload...');
    setTimeout(checkUploadStatus, 2000); // Initial delay to let upload start
});
</script>
{% endblock %} 