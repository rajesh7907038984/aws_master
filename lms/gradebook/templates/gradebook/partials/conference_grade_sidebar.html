{% load gradebook_tags %}
{% load static %}

<!-- Conference Grade Sidebar Content -->
<div class="conference-grade-sidebar">

<!-- Conference Details -->
<div class="mb-6">
    <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-bold text-gray-800">{{ conference.title }}</h3>
        <a href="{% url 'conferences:conference_detail' conference.id %}#rubric-history" class="text-blue-600 hover:text-blue-800 text-sm font-medium" target="_blank">
            <i class="fas fa-external-link-alt mr-1"></i>
            Detailed View
        </a>
    </div>
    
    <div class="bg-gray-50 p-4 rounded-lg mb-4">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
            <div>
                <span class="text-gray-600">Student:</span>
                <span class="font-medium">{{ student.get_full_name }}</span>
            </div>
            {% if conference.rubric %}
            <div>
                <span class="text-gray-600">Max Score:</span>
                <span class="font-medium">{{ conference.rubric.total_points }} pts</span>
            </div>
            {% endif %}
            <div>
                <span class="text-gray-600">Date:</span>
                <span class="font-medium">{{ conference.date|date:"M d, Y" }}</span>
            </div>
            <div>
                <span class="text-gray-600">Attendance:</span>
                {% if attendance_data.has_attended %}
                    <span class="px-2 py-1 rounded-full text-xs bg-green-100 text-green-800">Attended</span>
                {% else %}
                    <span class="px-2 py-1 rounded-full text-xs bg-red-100 text-red-800">Not Attended</span>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Student Attendance Summary -->
<div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
    <h4 class="text-lg font-bold mb-4 text-blue-800">
        <i class="fas fa-user-clock mr-2 text-blue-500"></i>
        Attendance Summary
    </h4>
    
    {% if attendance_data.has_attended %}
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
        <div>
            <span class="text-blue-700 font-medium">Join Time:</span>
            <div class="text-blue-600">{{ attendance_data.join_time|date:"M d, Y g:i A" }}</div>
        </div>
        {% if attendance_data.leave_time %}
        <div>
            <span class="text-blue-700 font-medium">Leave Time:</span>
            <div class="text-blue-600">{{ attendance_data.leave_time|date:"M d, Y g:i A" }}</div>
        </div>
        {% endif %}
        <div>
            <span class="text-blue-700 font-medium">Duration:</span>
            <div class="text-blue-600">{{ attendance_data.duration_minutes }} minutes</div>
        </div>
        <div>
            <span class="text-blue-700 font-medium">Status:</span>
            <div class="px-2 py-1 rounded-full text-xs bg-green-100 text-green-800 inline-block">Participated</div>
        </div>
    </div>
    {% else %}
    <div class="text-center py-4">
        <i class="fas fa-times-circle text-red-400 text-3xl mb-2"></i>
        <p class="text-red-700 font-medium">Student did not attend this conference</p>
        <p class="text-red-600 text-sm">No attendance record found</p>
    </div>
    {% endif %}
</div>

<!-- Rubric Evaluation -->
{% if rubric_data %}
<div class="bg-white border border-gray-200 rounded-lg p-4 mb-6">
    <h4 class="text-lg font-bold mb-4 text-gray-800">
        <i class="fas fa-clipboard-list mr-2 text-purple-500"></i>
        Rubric Evaluation
    </h4>
    
    <form method="POST" action="{% url 'gradebook:ajax_save_grade' %}" class="space-y-4" id="gradingForm" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="activity_type" value="conference">
        <input type="hidden" name="activity_id" value="{{ conference.id }}">
        <input type="hidden" name="student_id" value="{{ student.id }}">
        
        <div class="space-y-4">
            <div class="bg-purple-50 p-3 rounded-lg">
                <h5 class="font-medium text-purple-900">{{ rubric_data.rubric.title }}</h5>
                <p class="text-sm text-purple-700">{{ rubric_data.rubric.total_points }} points possible</p>
            </div>
            
            {% for criterion in rubric_data.criteria %}
            <div class="border border-gray-200 rounded-lg p-3">
                <div class="mb-2">
                    <h6 class="font-medium text-gray-800">{{ criterion.description }}</h6>
                    <p class="text-sm text-gray-600">Maximum: {{ criterion.points }} points</p>
                </div>
                
                <!-- Rating Selection -->
                {% if criterion.ratings.all %}
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Rating</label>
                    <select data-rating-select 
                            data-criterion="{{ criterion.id }}"
                            class="w-full px-3 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="">Select a rating...</option>
                        {% for rating in criterion.ratings.all %}
                        <option value="{{ rating.id }}" 
                                data-points="{{ rating.points }}"
                                {% with evaluation=rubric_data.evaluations|get_item:criterion.id %}
                                {% if evaluation and evaluation.rating and evaluation.rating.id == rating.id %}selected{% endif %}
                                {% endwith %}>
                            {{ rating.title }} ({{ rating.points }} pts)
                        </option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
                
                <!-- Points Input -->
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Points</label>
                    <input type="number" 
                           data-criterion="{{ criterion.id }}"
                           data-points-input
                           min="0" 
                           max="{{ criterion.points }}" 
                           step="0.1"
                           value="{% with evaluation=rubric_data.evaluations|get_item:criterion.id %}{% if evaluation %}{{ evaluation.points }}{% endif %}{% endwith %}"
                           class="w-full px-3 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                           placeholder="0">
                </div>
                
                <!-- Comments -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Comments (Optional)</label>
                    <textarea data-criterion="{{ criterion.id }}"
                              data-comments-input
                              rows="2"
                              class="w-full px-3 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                              placeholder="Add comments about this criterion...">{% with evaluation=rubric_data.evaluations|get_item:criterion.id %}{% if evaluation %}{{ evaluation.comments }}{% endif %}{% endwith %}</textarea>
                </div>
            </div>
            {% endfor %}
            
            <!-- Total Points Display -->
            <div class="bg-gray-50 p-3 rounded-lg">
                <div class="flex justify-between items-center">
                    <span class="font-medium text-gray-800">Total Points:</span>
                    <span class="font-bold text-lg text-purple-600" id="totalPoints">0</span>
                </div>
            </div>
        </div>
        
        <!-- Overall Feedback Section -->
        <div class="mb-6">
            <h4 class="text-lg font-bold mb-4 text-gray-800">
                <i class="fas fa-comment-alt mr-2 text-blue-500"></i>
                Overall Feedback
            </h4>
            
            <!-- Show existing feedback if any -->
            {% if overall_feedback %}
            <div class="mb-4">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                    <h5 class="font-medium text-blue-900 mb-2">
                        <i class="fas fa-history mr-2"></i>
                        Previous Feedback
                    </h5>
                    
                    {% if overall_feedback.feedback %}
                    <div class="mb-3">
                        <div class="flex items-center mb-1">
                            <i class="fas fa-keyboard text-blue-600 mr-2 text-sm"></i>
                            <span class="font-medium text-blue-800 text-sm">Written Feedback</span>
                        </div>
                        <div class="prose prose-sm max-w-none text-gray-700 bg-white p-3 rounded border">
                            {{ overall_feedback.feedback|safe }}
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if overall_feedback.audio_feedback %}
                    <div class="mb-3">
                        <div class="flex items-center mb-1">
                            <i class="fas fa-microphone text-green-600 mr-2 text-sm"></i>
                            <span class="font-medium text-green-800 text-sm">Audio Feedback</span>
                        </div>
                        <div class="bg-green-50 p-2 rounded border">
                            <audio controls class="w-full h-8" controlsList="nodownload">
                                <source src="{{ overall_feedback.audio_feedback.url }}" type="audio/mpeg">
                                <source src="{{ overall_feedback.audio_feedback.url }}" type="audio/wav">
                                <source src="{{ overall_feedback.audio_feedback.url }}" type="audio/mp4">
                                Your browser does not support the audio element.
                            </audio>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if overall_feedback.video_feedback %}
                    <div class="mb-3">
                        <div class="flex items-center mb-1">
                            <i class="fas fa-video text-purple-600 mr-2 text-sm"></i>
                            <span class="font-medium text-purple-800 text-sm">Video Feedback</span>
                        </div>
                        <div class="bg-purple-50 p-2 rounded border">
                            <video controls class="w-full max-w-sm rounded" controlsList="nodownload">
                                <source src="{{ overall_feedback.video_feedback.url }}" type="video/mp4">
                                <source src="{{ overall_feedback.video_feedback.url }}" type="video/mov">
                                <source src="{{ overall_feedback.video_feedback.url }}" type="video/avi">
                                Your browser does not support the video element.
                            </video>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="text-xs text-gray-500 mt-2">
                        <i class="fas fa-clock mr-1"></i>
                        {{ overall_feedback.created_at|date:"M d, Y g:i A" }}
                        {% if overall_feedback.created_by %}
                        by {{ overall_feedback.created_by.get_full_name }}
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Feedback Type Tabs -->
            <div class="mb-4">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8" aria-label="Feedback Types">
                        <button type="button" 
                                class="feedback-tab-btn py-2 px-1 border-b-2 font-medium text-sm whitespace-nowrap border-blue-500 text-blue-600 active"
                                data-tab="text"
                                data-active-class="border-blue-500 text-blue-600"
                                data-inactive-class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                            <i class="fas fa-keyboard mr-2"></i>Text Feedback
                        </button>
                        <button type="button" 
                                class="feedback-tab-btn py-2 px-1 border-b-2 font-medium text-sm whitespace-nowrap border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
                                data-tab="audio"
                                data-active-class="border-blue-500 text-blue-600"
                                data-inactive-class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                            <i class="fas fa-microphone mr-2"></i>Audio Feedback
                        </button>
                        <button type="button" 
                                class="feedback-tab-btn py-2 px-1 border-b-2 font-medium text-sm whitespace-nowrap border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
                                data-tab="video"
                                data-active-class="border-blue-500 text-blue-600"
                                data-inactive-class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                            <i class="fas fa-video mr-2"></i>Video Feedback
                        </button>
                    </nav>
                </div>
            </div>
            
            <!-- Text Feedback Tab -->
            <div id="text-feedback-tab" class="feedback-tab-content">
                <div class="relative">
                    {% if feedback_form %}
                        {{ feedback_form.feedback }}
                    {% else %}
                        <textarea name="overall_feedback" 
                                  id="conference-feedback-textarea"
                                  rows="4"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 tinymce-editor"
                                  placeholder="Provide overall feedback about the student's conference participation and rubric performance...">{% if overall_feedback %}{{ overall_feedback.feedback }}{% endif %}</textarea>
                    {% endif %}
                </div>
            </div>
            
            <!-- Audio Feedback Tab -->
            <div id="audio-feedback-tab" class="feedback-tab-content hidden">
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6">
                    <div class="text-center">
                        <i class="fas fa-microphone text-4xl text-gray-400 mb-4"></i>
                        <div class="mb-4">
                            <label for="{% if feedback_form %}{{ feedback_form.audio_feedback.id_for_label }}{% else %}audio_feedback{% endif %}" class="block text-sm font-medium text-gray-700 mb-2">Upload Audio Feedback</label>
                            {% if feedback_form %}
                                {{ feedback_form.audio_feedback }}
                            {% else %}
                                <input type="file" 
                                       name="audio_feedback" 
                                       id="audio_feedback"
                                       accept="audio/*,.mp3,.wav,.m4a,.aac,.ogg"
                                       class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                            {% endif %}
                            <p class="text-xs text-gray-500 mt-1">Supported formats: MP3, WAV, M4A, AAC, OGG (Max: 50MB)</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Video Feedback Tab -->
            <div id="video-feedback-tab" class="feedback-tab-content hidden">
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6">
                    <div class="text-center">
                        <i class="fas fa-video text-4xl text-gray-400 mb-4"></i>
                        <div class="mb-4">
                            <label for="{% if feedback_form %}{{ feedback_form.video_feedback.id_for_label }}{% else %}video_feedback{% endif %}" class="block text-sm font-medium text-gray-700 mb-2">Upload Video Feedback</label>
                            {% if feedback_form %}
                                {{ feedback_form.video_feedback }}
                            {% else %}
                                <input type="file" 
                                       name="video_feedback" 
                                       id="video_feedback"
                                       accept="video/*,.mp4,.mov,.avi,.wmv,.mkv"
                                       class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                            {% endif %}
                            <p class="text-xs text-gray-500 mt-1">Supported formats: MP4, MOV, AVI, WMV, MKV (Max: 100MB)</p>
                        </div>
                    </div>
                </div>
            </div>
            

        </div>
        
        <!-- Submit Button -->
        <button type="submit" class="w-full bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 transition">
            <i class="fas fa-save mr-2"></i>
            Save Evaluation
        </button>
    </form>
</div>
{% elif not attendance_data.has_attended %}
<div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
    <div class="flex items-center">
        <i class="fas fa-exclamation-circle text-red-600 mr-3"></i>
        <div>
            <h4 class="font-medium text-red-800">Cannot Evaluate</h4>
            <p class="text-sm text-red-700">Student did not attend this conference and cannot be evaluated.</p>
        </div>
    </div>
</div>
{% else %}
<div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
    <div class="flex items-center">
        <i class="fas fa-exclamation-triangle text-yellow-600 mr-3"></i>
        <div>
            <h4 class="font-medium text-yellow-800">No Rubric Available</h4>
            <p class="text-sm text-yellow-700">This conference does not have a rubric for evaluation.</p>
        </div>
    </div>
</div>
{% endif %}

<!-- Include Form Media for TinyMCE -->
{% if feedback_form %}
{{ feedback_form.media.css }}
{{ feedback_form.media.js }}
{% else %}
<!-- Include TinyMCE CSS and JS for fallback textarea -->
<link rel="stylesheet" href="{% static 'tinymce_editor/css/tinymce-widget.css' %}">
<script src="{% static 'tinymce_editor/js/tinymce/tinymce.min.js' %}"></script>
{% endif %}

<!-- JavaScript for Rubric Evaluation -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log(' Conference grading sidebar JavaScript initializing...');
    
    // Rubric Rating Selection Handling
    function initializeRubricRatingHandlers() {
        console.log(' Initializing rubric rating handlers...');
        
        // Handle rating selection changes
        document.querySelectorAll('[data-rating-select]').forEach(select => {
            select.addEventListener('change', function() {
                const criterionId = this.dataset.criterion;
                const selectedOption = this.options[this.selectedIndex];
                
                if (selectedOption && selectedOption.value) {
                    const points = selectedOption.dataset.points;
                    const pointsInput = document.querySelector(`[data-criterion="${criterionId}"][data-points-input]`);
                    
                    if (pointsInput && points) {
                        const currentPoints = parseFloat(pointsInput.value) || 0;
                        const ratingPoints = parseFloat(points);
                        
                        // Only auto-fill if points field is empty or contains 0
                        if (currentPoints === 0 || pointsInput.value.trim() === '') {
                            pointsInput.style.transition = 'all 0.3s ease';
                            pointsInput.style.backgroundColor = '#e8eafd';
                            pointsInput.value = ratingPoints;
                            
                            setTimeout(() => {
                                pointsInput.style.backgroundColor = '';
                            }, 1000);
                            console.log(` Auto-populated points for criterion ${criterionId}: ${points}`);
                        } else {
                            // If instructor has entered custom points, show a subtle indicator
                            pointsInput.style.transition = 'all 0.3s ease';
                            pointsInput.style.borderColor = '#3b82f6';
                            pointsInput.title = `Rating suggests ${ratingPoints} points, but your custom value (${currentPoints}) is preserved.`;
                            
                            setTimeout(() => {
                                pointsInput.style.borderColor = '';
                            }, 2000);
                            console.log(` Custom points preserved for criterion ${criterionId}: ${currentPoints} (rating suggests ${points})`);
                        }
                    }
                } else {
                    // Clear points if no rating selected
                    const pointsInput = document.querySelector(`[data-criterion="${criterionId}"][data-points-input]`);
                    if (pointsInput) {
                        pointsInput.value = '';
                    }
                }
                updateTotalPoints();
            });
        });
        
        // Handle points input changes
        document.querySelectorAll('[data-points-input]').forEach(input => {
            input.addEventListener('input', function() {
                updateTotalPoints();
            });
        });
    }
    
    function updateTotalPoints() {
        let total = 0;
        document.querySelectorAll('[data-points-input]').forEach(input => {
            const value = parseFloat(input.value) || 0;
            total += value;
        });
        
        const totalDisplay = document.getElementById('totalPoints');
        if (totalDisplay) {
            totalDisplay.textContent = total.toFixed(1);
        }
    }
    
    // Collect rubric data
    function collectRubricData() {
        const rubricData = {};
        
        document.querySelectorAll('[data-rating-select]').forEach(select => {
            const criterionId = select.dataset.criterion;
            const ratingId = select.value;
            const pointsInput = document.querySelector(`[data-criterion="${criterionId}"][data-points-input]`);
            const commentsInput = document.querySelector(`[data-criterion="${criterionId}"][data-comments-input]`);
            
            const points = pointsInput ? parseFloat(pointsInput.value) : null;
            const comments = commentsInput ? commentsInput.value.trim() : '';
            
            if (!isNaN(points) || ratingId || comments) {
                rubricData[criterionId] = {
                    points: isNaN(points) ? 0 : points,
                    comments: comments,
                    rating_id: ratingId || null
                };
            }
        });
        
        console.log('ðŸ“Š Collected rubric data:', rubricData);
        return rubricData;
    }
    
    // Form submission handling
    const gradingForm = document.getElementById('gradingForm');
    if (gradingForm) {
        gradingForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Save TinyMCE content before form submission
            if (typeof tinymce !== 'undefined') {
                tinymce.triggerSave();
            }
            
            const formData = new FormData(this);
            
            // Add rubric data if present
            const rubricData = collectRubricData();
            if (Object.keys(rubricData).length > 0) {
                formData.append('rubric_data', JSON.stringify(rubricData));
            }
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            // Show loading state
            submitBtn.textContent = 'Saving...';
            submitBtn.disabled = true;
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
            .then(data => {
                if (data.success) {
                    alert('Conference evaluation saved successfully!');
                    // Reload parent page
                    setTimeout(() => {
                        if (window.parent && window.parent.location) {
                            window.parent.location.reload();
                        } else {
                            location.reload();
                        }
                    }, 1500);
                } else {
                    alert(data.error || 'Error saving evaluation');
                }
            })
            .catch(error => {
                console.error(' Form submission error:', error);
                alert('Error saving evaluation');
            })
            .finally(() => {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            });
        });
    }
    
    // Initialize handlers
    initializeRubricRatingHandlers();
    updateTotalPoints();
    
    // Get the container for this sidebar
    const container = document.querySelector('.conference-grade-sidebar') || document.body;
    
    // Initialize TinyMCE using the unified sidebar approach
    if (typeof window.initializeSidebarTinyMCE === 'function') {
        window.initializeSidebarTinyMCE(container);
    } else {
        // Fallback to widget system
        if (typeof window.TinyMCEWidget !== 'undefined' && window.TinyMCEWidget.initializeAll) {
            console.log(' Initializing TinyMCE using widget system');
            window.TinyMCEWidget.initializeAll();
        } else {
            console.log(' TinyMCE widget system not available yet, retrying...');
            setTimeout(initializeTinyMCE, 100);
        }
        
        // Also initialize TinyMCE for any textarea with tinymce-editor class
        const textareas = document.querySelectorAll('textarea.tinymce-editor');
        textareas.forEach(textarea => {
            if (textarea.id && typeof tinymce !== 'undefined') {
                // Remove existing editor if any
                if (tinymce.get(textarea.id)) {
                    tinymce.get(textarea.id).remove();
                }
                
                // Initialize TinyMCE
                tinymce.init({
                    selector: `#${textarea.id}`,
                    height: 350,  // Increased height for better content editing
                    menubar: 'edit view insert format tools',
                    plugins: ['lists', 'link', 'autolink', 'paste', 'searchreplace', 'image', 'media', 'table', 'wordcount'],
                    toolbar: 'undo redo | blocks | bold italic underline | bullist numlist | link | image media | removeformat',
                    content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; font-size: 14px }',
                    paste_as_text: false,
                    paste_data_images: true,
                    // TinyMCE 7.0 compatible paste options
                    paste_preprocess: function(plugin, args) {
                        // Custom paste preprocessing logic can be added here
                        return args;
                    },
                    branding: false,
                    promotion: false,
                    license_key: 'gpl',
                    setup: function(editor) {
                        editor.on('change', function() {
                            tinymce.triggerSave();
                        });
                    }
                });
                console.log(' TinyMCE initialized for textarea:', textarea.id);
            }
        });
    }

    // Feedback Tab Handling
    function initializeFeedbackTabs() {
        console.log(' Initializing feedback tabs...');
        
        // Handle feedback tab switching
        document.querySelectorAll('.feedback-tab-btn').forEach(button => {
            button.addEventListener('click', function() {
                const tabName = this.dataset.tab;
                const activeClass = this.dataset.activeClass;
                const inactiveClass = this.dataset.inactiveClass;
                
                // Update button states
                document.querySelectorAll('.feedback-tab-btn').forEach(btn => {
                    btn.className = `feedback-tab-btn py-2 px-1 border-b-2 font-medium text-sm whitespace-nowrap ${btn.dataset.inactiveClass}`;
                });
                
                // Set active button
                this.className = `feedback-tab-btn py-2 px-1 border-b-2 font-medium text-sm whitespace-nowrap ${activeClass}`;
                
                // Show/hide content
                document.querySelectorAll('.feedback-tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                
                const targetTab = document.getElementById(`${tabName}-feedback-tab`);
                if (targetTab) {
                    targetTab.classList.remove('hidden');
                }
            });
        });
        
        // File validation
        const audioInput = document.querySelector('input[name="audio_feedback"]');
        const videoInput = document.querySelector('input[name="video_feedback"]');
        
        if (audioInput) {
            audioInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Validate file size (50MB limit)
                    if (file.size > 50 * 1024 * 1024) {
                        alert('Audio file size cannot exceed 50MB');
                        this.value = '';
                        return;
                    }
                    
                    // Validate file type
                    const allowedTypes = ['audio/'];
                    if (!allowedTypes.some(type => file.type.includes(type))) {
                        alert('Please select a valid audio file');
                        this.value = '';
                        return;
                    }
                }
            });
        }
        
        if (videoInput) {
            videoInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Validate file size (100MB limit)
                    if (file.size > 100 * 1024 * 1024) {
                        alert('Video file size cannot exceed 100MB');
                        this.value = '';
                        return;
                    }
                    
                    // Validate file type
                    const allowedTypes = ['video/'];
                    if (!allowedTypes.some(type => file.type.includes(type))) {
                        alert('Please select a valid video file');
                        this.value = '';
                        return;
                    }
                }
            });
        }
    }
    
    // Initialize feedback tabs using the unified approach
    if (typeof window.initializeFeedbackTabsInContent === 'function') {
        setTimeout(() => {
            window.initializeFeedbackTabsInContent(container);
        }, 150);
    } else {
        // Fallback to local implementation
        initializeFeedbackTabs();
    }
    
    console.log(' Conference grading sidebar JavaScript initialized');
});
</script>

</div> <!-- End conference-grade-sidebar --> 