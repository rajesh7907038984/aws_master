<!DOCTYPE html>
<html>
<head>
    <title>SCORM Content Player</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background-color: #f5f5f5;
        }
        .player-container { 
            background: white;
            border: 1px solid #ddd; 
            border-radius: 8px;
            padding: 30px; 
            margin: 20px auto; 
            max-width: 800px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .scorm-content {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 20px;
            margin: 20px 0;
            min-height: 400px;
        }
        .quiz-container {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 20px;
            margin: 20px 0;
        }
        .question {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .question h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .options {
            margin: 10px 0;
        }
        .option {
            margin: 8px 0;
            padding: 8px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .option:hover {
            background: #e9ecef;
        }
        .option.selected {
            background: #007cba;
            color: white;
            border-color: #007cba;
        }
        .submit-button { 
            background: #28a745; 
            color: white; 
            padding: 12px 24px; 
            border: none; 
            border-radius: 4px;
            cursor: pointer; 
            margin: 20px 0;
            font-size: 16px;
            transition: background-color 0.2s;
        }
        .submit-button:hover { 
            background: #218838; 
        }
        .submit-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .result-container {
            display: none;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            padding: 20px;
            margin: 20px 0;
        }
        .result-container.show {
            display: block;
        }
        .result-pass {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .result-fail {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .completion-message {
            text-align: center;
            padding: 20px;
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 4px;
            margin: 20px 0;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-fill {
            height: 100%;
            background: #007cba;
            transition: width 0.3s ease;
            width: 0%;
        }
    </style>
</head>
<body>
    <div class="player-container">
        <h1>SCORM Content Player</h1>
        <h2>{{ topic.title }}</h2>
        <p>{{ topic.description }}</p>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>
        
        <div id="scorm-content" class="scorm-content">
            <h3>Interactive SCORM Content</h3>
            <p>This simulates a real SCORM learning module. Complete the quiz below to automatically mark the topic as complete.</p>
            
            <div class="quiz-container">
                <h4>Knowledge Check</h4>
                <div class="question" data-question="1">
                    <h4>Question 1: What is SCORM?</h4>
                    <div class="options">
                        <div class="option" data-answer="a">A) A type of video format</div>
                        <div class="option" data-answer="b">B) A learning management system</div>
                        <div class="option" data-answer="c">C) A standard for e-learning content</div>
                        <div class="option" data-answer="d">D) A programming language</div>
                    </div>
                </div>
                
                <div class="question" data-question="2">
                    <h4>Question 2: What does SCORM stand for?</h4>
                    <div class="options">
                        <div class="option" data-answer="a">A) Standard Content Object Reference Model</div>
                        <div class="option" data-answer="b">B) Sharable Content Object Reference Model</div>
                        <div class="option" data-answer="c">C) Simple Content Object Reference Model</div>
                        <div class="option" data-answer="d">D) Structured Content Object Reference Model</div>
                    </div>
                </div>
                
                <div class="question" data-question="3">
                    <h4>Question 3: Which of the following is a SCORM benefit?</h4>
                    <div class="options">
                        <div class="option" data-answer="a">A) Content reusability</div>
                        <div class="option" data-answer="b">B) Interoperability</div>
                        <div class="option" data-answer="c">C) Durability</div>
                        <div class="option" data-answer="d">D) All of the above</div>
                    </div>
                </div>
                
                <button class="submit-button" id="submit-quiz" onclick="submitQuiz()">
                    Submit Quiz
                </button>
            </div>
        </div>
        
        <div id="result-container" class="result-container">
            <h4 id="result-title">Quiz Results</h4>
            <p id="result-message"></p>
            <p id="result-score"></p>
        </div>
        
        <div id="completion-message" class="completion-message" style="display: none;">
            <h4>✅ Topic Completed Successfully!</h4>
            <p>Your progress has been automatically saved. You can now proceed to the next topic.</p>
            <button class="submit-button" onclick="returnToTopic()">
                Return to Topic
            </button>
        </div>
    </div>
    
    <script>
        let userAnswers = {};
        let quizSubmitted = false;
        
        // Initialize quiz
        document.addEventListener('DOMContentLoaded', function() {
            // Add click handlers to options
            document.querySelectorAll('.option').forEach(option => {
                option.addEventListener('click', function() {
                    if (quizSubmitted) return;
                    
                    const question = this.closest('.question');
                    const questionNum = question.dataset.question;
                    
                    // Remove previous selection for this question
                    question.querySelectorAll('.option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // Select this option
                    this.classList.add('selected');
                    userAnswers[questionNum] = this.dataset.answer;
                    
                    // Update progress
                    updateProgress();
                });
            });
        });
        
        function updateProgress() {
            const totalQuestions = 3;
            const answeredQuestions = Object.keys(userAnswers).length;
            const progress = (answeredQuestions / totalQuestions) * 100;
            
            document.getElementById('progress-fill').style.width = progress + '%';
        }
        
        function submitQuiz() {
            if (quizSubmitted) return;
            
            const totalQuestions = 3;
            const answeredQuestions = Object.keys(userAnswers).length;
            
            if (answeredQuestions < totalQuestions) {
                alert('Please answer all questions before submitting.');
                return;
            }
            
            quizSubmitted = true;
            document.getElementById('submit-quiz').disabled = true;
            document.getElementById('submit-quiz').textContent = 'Submitting...';
            
            // Calculate score
            const correctAnswers = {
                '1': 'c', // SCORM is a standard for e-learning content
                '2': 'b', // Sharable Content Object Reference Model
                '3': 'd'  // All of the above
            };
            
            let correctCount = 0;
            for (let question in userAnswers) {
                if (userAnswers[question] === correctAnswers[question]) {
                    correctCount++;
                }
            }
            
            const score = Math.round((correctCount / totalQuestions) * 100);
            const passed = score >= 70; // 70% passing grade
            
            // Show results
            setTimeout(() => {
                showResults(score, passed, correctCount, totalQuestions);
            }, 1000);
        }
        
        function showResults(score, passed, correct, total) {
            const resultContainer = document.getElementById('result-container');
            const resultTitle = document.getElementById('result-title');
            const resultMessage = document.getElementById('result-message');
            const resultScore = document.getElementById('result-score');
            
            resultContainer.classList.add('show');
            
            if (passed) {
                resultContainer.classList.add('result-pass');
                resultTitle.textContent = '✅ Quiz Passed!';
                resultMessage.textContent = 'Congratulations! You have successfully completed this SCORM module.';
            } else {
                resultContainer.classList.add('result-fail');
                resultTitle.textContent = '❌ Quiz Failed';
                resultMessage.textContent = 'You need to score at least 70% to pass. Please review the content and try again.';
            }
            
            resultScore.textContent = `Score: ${correct}/${total} (${score}%)`;
            
            // Auto-complete if passed
            if (passed) {
                setTimeout(() => {
                    autoCompleteTopic(score);
                }, 2000);
            } else {
                // Allow retry
                setTimeout(() => {
                    document.getElementById('submit-quiz').disabled = false;
                    document.getElementById('submit-quiz').textContent = 'Retry Quiz';
                    quizSubmitted = false;
                    userAnswers = {};
                    document.querySelectorAll('.option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    document.getElementById('progress-fill').style.width = '0%';
                }, 3000);
            }
        }
        
        function autoCompleteTopic(score) {
            // Automatically complete the topic when learner passes
            fetch('/scorm/topic/{{ topic.id }}/local-completion/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    'completed': true,
                    'completion_status': 'completed',
                    'success_status': 'passed',
                    'score': score,
                    'auto_completion': true
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show completion message
                    document.getElementById('completion-message').style.display = 'block';
                    document.getElementById('scorm-content').style.display = 'none';
                    document.getElementById('result-container').style.display = 'none';
                } else {
                    console.error('Error:', data.error);
                    alert('Error completing topic: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while completing the topic.');
            });
        }
        
        function returnToTopic() {
            window.location.href = '/courses/topic/{{ topic.id }}/view/';
        }
    </script>
</body>
</html>