<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>{{ scorm_package.title }} - SCORM Player</title>
    {% load static %}
<style>
    body {
        margin: 0;
        padding: 0;
        overflow: hidden;
    }
    
    .scorm-player-container {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        flex-direction: column;
        background: #1f2937;
    }
    
    .scorm-header {
        background: #111827;
        padding: 12px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        z-index: 1000;
    }
    
    .scorm-title {
        font-size: 16px;
        font-weight: 600;
        margin: 0;
    }
    
    .scorm-status {
        display: flex;
        gap: 20px;
        align-items: center;
        font-size: 14px;
    }
    
    .status-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #6b7280;
    }
    
    .status-dot.active {
        background: #10b981;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    .scorm-actions {
        display: flex;
        gap: 10px;
    }
    
    .btn-exit {
        background: #ef4444;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.2s;
    }
    
    .btn-exit:hover {
        background: #dc2626;
    }
    
    .scorm-content {
        flex: 1;
        position: relative;
        background: white;
    }
    
    #scorm-frame {
        width: 100%;
        height: 100%;
        min-height: 600px;
        border: none;
        display: block;
        background: white;
    }
    
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #1f2937;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
    }
    
    .loading-overlay.hidden {
        display: none;
    }
    
    .loading-spinner {
        width: 48px;
        height: 48px;
        border: 4px solid #374151;
        border-top-color: #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>
</head>
<body>
<div class="scorm-player-container">
    {% csrf_token %}
    <div class="scorm-header">
        <h1 class="scorm-title">{{ scorm_package.title }}</h1>
        
        <div class="scorm-status">
            <div class="status-indicator">
                <div class="status-dot" id="connection-status"></div>
                <span id="status-text">Loading...</span>
            </div>
            <div class="status-indicator">
                <span>Time: <span id="time-display">00:00:00</span></span>
            </div>
        </div>
        
        <div class="scorm-actions">
            <button class="btn-exit" onclick="exitPlayer()">Exit</button>
        </div>
    </div>
    
    <div class="scorm-content">
        <div class="loading-overlay" id="loading-overlay">
            <div class="loading-spinner"></div>
            <div style="color: white; margin-top: 20px; font-size: 14px;">Loading assessment content...</div>
        </div>
        <iframe id="scorm-frame" 
                src="{{ launch_url }}" 
                allow="autoplay; fullscreen; camera; microphone; encrypted-media"
                loading="eager"
                importance="high"
                sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-downloads allow-modals"
                referrerpolicy="no-referrer-when-downgrade"></iframe>
    </div>
</div>

<script>
// SCORM Real API - Connects to Django SCORM API endpoint
(function() {
    let sessionStartTime = Date.now();
    let timeInterval = null;
    let apiEndpoint = '{{ api_endpoint }}';
    let csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    
    // Get CSRF token from cookies if not in form
    if (!csrfToken) {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'csrftoken') {
                csrfToken = value;
                break;
            }
        }
    }
    
    // Function to make API calls to Django backend
    function callSCORMAPI(method, parameters = []) {
        try {
            const xhr = new XMLHttpRequest();
            xhr.open('POST', apiEndpoint, false); // Synchronous for SCORM compliance
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.setRequestHeader('X-CSRFToken', csrfToken);
            
            const data = JSON.stringify({
                method: method,
                parameters: parameters
            });
            
            xhr.send(data);
            
            if (xhr.status === 200) {
                const response = JSON.parse(xhr.responseText);
                if (response.success) {
                    return response.result;
                } else {
                    console.error('SCORM API Error:', response.error);
                    return 'false';
                }
            } else {
                console.error('SCORM API HTTP Error:', xhr.status);
                return 'false';
            }
        } catch (error) {
            console.error('SCORM API Exception:', error);
            return 'false';
        }
    }
    
    // Create the real SCORM API that communicates with Django
    const realAPI = {
        // SCORM 1.2 API
        LMSInitialize: function(param) { 
            console.log('SCORM API: LMSInitialize called');
            updateStatus('Initializing...', true);
            startTimer();
            const result = callSCORMAPI('Initialize', [param]);
            if (result === 'true') {
                updateStatus('Content Initialized', true);
            }
            return result;
        },
        LMSFinish: function(param) { 
            console.log('🏁 SCORM API: LMSFinish called');
            const result = callSCORMAPI('Terminate', [param]);
            if (result === 'true') {
                updateStatus('Content Finished', false);
                stopTimer();
            }
            return result;
        },
        LMSGetValue: function(element) { 
            console.log('📖 SCORM API: LMSGetValue(' + element + ')');
            return callSCORMAPI('GetValue', [element]);
        },
        LMSSetValue: function(element, value) { 
            console.log('💾 SCORM API: LMSSetValue(' + element + ', ' + value + ')');
            return callSCORMAPI('SetValue', [element, value]);
        },
        LMSCommit: function(param) { 
            console.log('SCORM API: LMSCommit called');
            return callSCORMAPI('Commit', [param]);
        },
        LMSGetLastError: function() { 
            return callSCORMAPI('GetLastError', []);
        },
        LMSGetErrorString: function(errorCode) { 
            return callSCORMAPI('GetErrorString', [errorCode]);
        },
        LMSGetDiagnostic: function(errorCode) { 
            return callSCORMAPI('GetDiagnostic', [errorCode]);
        },
        
        // SCORM 2004 API (aliases)
        Initialize: function(param) { return this.LMSInitialize(param); },
        Terminate: function(param) { return this.LMSFinish(param); },
        GetValue: function(element) { return this.LMSGetValue(element); },
        SetValue: function(element, value) { return this.LMSSetValue(element, value); },
        Commit: function(param) { return this.LMSCommit(param); },
        GetLastError: function() { return this.LMSGetLastError(); },
        GetErrorString: function(errorCode) { return this.LMSGetErrorString(errorCode); },
        GetDiagnostic: function(errorCode) { return this.LMSGetDiagnostic(errorCode); }
    };
    
    // Expose the real API globally for SCORM content to find
    window.API = realAPI;
    window.API_1484_11 = realAPI;
    
    console.log('🔗 SCORM Real API created and connected to Django backend');
    
    // Update status display
    function updateStatus(text, active) {
        const statusText = document.getElementById('status-text');
        const statusDot = document.getElementById('connection-status');
        
        if (statusText) statusText.textContent = text;
        if (statusDot) {
            if (active) {
                statusDot.classList.add('active');
            } else {
                statusDot.classList.remove('active');
            }
        }
    }
    
    // Timer functions
    function startTimer() {
        if (timeInterval) return;
        
        timeInterval = setInterval(() => {
            const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
            const hours = Math.floor(elapsed / 3600);
            const minutes = Math.floor((elapsed % 3600) / 60);
            const seconds = elapsed % 60;
            
            const display = document.getElementById('time-display');
            if (display) {
                display.textContent = 
                    `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }
        }, 1000);
    }
    
    function stopTimer() {
        if (timeInterval) {
            clearInterval(timeInterval);
            timeInterval = null;
        }
    }
    
    // Exit player
    window.exitPlayer = function() {
        if (confirm('Are you sure you want to exit? Your progress will be saved.')) {
            console.log('🚪 EXIT: User initiated exit');
            
            // Force the SCORM content to finish and save data
            try {
                // Try to get the SCORM API from the iframe
                const iframe = document.getElementById('scorm-frame');
                if (iframe && iframe.contentWindow && iframe.contentWindow.API) {
                    const API = iframe.contentWindow.API;
                    console.log('📝 EXIT: Calling LMSCommit to save pending data');
                    API.LMSCommit('');
                    console.log('🏁 EXIT: Calling LMSFinish to terminate session');
                    API.LMSFinish('');
                } else {
                    // Call our API stub
                    console.log('📝 EXIT: Using parent API to save data');
                    if (window.API_1484_11 && window.API_1484_11.Commit) {
                        window.API_1484_11.Commit('');
                        window.API_1484_11.Terminate('');
                    } else if (window.API && window.API.LMSCommit) {
                        window.API.LMSCommit('');
                        window.API.LMSFinish('');
                    }
                }
            } catch (e) {
                console.error('❌ EXIT: Error saving SCORM data:', e);
            }
            
            stopTimer();
            
            // Small delay to ensure API calls complete
            setTimeout(() => {
                window.location.href = '{% url "courses:topic_view" topic.id %}';
            }, 500);
        }
    };
    
    // Auto-save when page is about to unload (user closes tab, navigates away, etc)
    window.addEventListener('beforeunload', function(e) {
        console.log('⚠️ UNLOAD: Page is closing, attempting to save SCORM data');
        
        try {
            // Try to commit any pending data
            const iframe = document.getElementById('scorm-frame');
            if (iframe && iframe.contentWindow && iframe.contentWindow.API) {
                const API = iframe.contentWindow.API;
                console.log('📝 UNLOAD: Calling LMSCommit');
                API.LMSCommit('');
            } else if (window.API_1484_11 && window.API_1484_11.Commit) {
                window.API_1484_11.Commit('');
            } else if (window.API && window.API.LMSCommit) {
                window.API.LMSCommit('');
            }
        } catch (err) {
            console.error('❌ UNLOAD: Error saving data:', err);
        }
    });
    
    // Handle iframe load
    const scormFrame = document.getElementById('scorm-frame');
    let loadTimeout;
    
    scormFrame.addEventListener('load', function() {
        clearTimeout(loadTimeout);
        const loadingOverlay = document.getElementById('loading-overlay');
        if (loadingOverlay) {
            loadingOverlay.classList.add('hidden');
        }
        
        updateStatus('Ready', true);
        
        console.log('SCORM content loaded with stub API available');
    });
    
    // Add timeout for loading - increased for complex SCORM packages
    loadTimeout = setTimeout(() => {
        console.info('SCORM content is still loading - large course packages may take longer');
        updateStatus('Loading course content (this may take a moment for large courses)...', true);
    }, 15000);
    
    // Add additional status update for very large packages
    setTimeout(() => {
        if (loadTimeout) {
            updateStatus('Loading assessment questions and resources...', true);
        }
    }, 5000);
    
    // Handle iframe errors
    scormFrame.addEventListener('error', function(e) {
        console.error('SCORM frame error:', e);
        updateStatus('Error loading content', false);
        const loadingOverlay = document.getElementById('loading-overlay');
        if (loadingOverlay) {
            loadingOverlay.innerHTML = '<div style="color: white; text-align: center;"><h3>Error Loading SCORM Content</h3><p>Please refresh the page or contact support.</p></div>';
        }
    });
    
    // Initial status
    updateStatus('Loading content...', true);
    
    // Auto-save mechanism: periodically commit SCORM data
    // This ensures scores are saved even if SCORM content doesn't call Commit properly
    let autoSaveInterval = setInterval(() => {
        try {
            // Try to commit any pending data from the iframe
            const iframe = document.getElementById('scorm-frame');
            if (iframe && iframe.contentWindow && iframe.contentWindow.API) {
                const API = iframe.contentWindow.API;
                // Check if there's an active session
                if (API.initialized || (API.LMSGetValue && API.LMSGetValue('cmi.core.lesson_status'))) {
                    console.log('💾 AUTO-SAVE: Committing SCORM data');
                    API.LMSCommit('');
                }
            } else if (window.API && window.API.LMSCommit) {
                console.log('💾 AUTO-SAVE: Committing via parent API');
                window.API.LMSCommit('');
            } else if (window.API_1484_11 && window.API_1484_11.Commit) {
                console.log('💾 AUTO-SAVE: Committing via SCORM 2004 API');
                window.API_1484_11.Commit('');
            }
        } catch (err) {
            console.debug('AUTO-SAVE: No active session or error:', err.message);
        }
    }, 30000); // Auto-save every 30 seconds
    
    // Clear auto-save on unload
    window.addEventListener('beforeunload', function() {
        if (autoSaveInterval) {
            clearInterval(autoSaveInterval);
        }
    });
    
})();
</script>
</body>
</html>