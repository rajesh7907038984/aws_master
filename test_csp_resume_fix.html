<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCORM CSP Resume Fix Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .csp-test {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>SCORM CSP Resume Fix Test</h1>
        <p>This test verifies that the CSP fixes allow SCORM resume functionality to work properly.</p>
        
        <div class="csp-test">
            <strong>CSP Test Status:</strong>
            <div id="csp-status">Testing CSP permissions...</div>
        </div>
        
        <div class="status" id="test-status">
            Ready to test CSP fixes for SCORM resume functionality...
        </div>
        
        <h3>Test Functions</h3>
        <button class="test-button" id="test-csp">Test CSP Permissions</button>
        <button class="test-button" id="test-resume">Test Resume Functionality</button>
        <button class="test-button" id="test-script-injection">Test Script Injection</button>
        <button class="test-button" id="test-direct-calls">Test Direct Function Calls</button>
        
        <h3>Test Log</h3>
        <div class="log" id="test-log"></div>
        
        <h3>CSP Headers Test</h3>
        <div id="csp-headers">Loading CSP headers...</div>
    </div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function updateStatus(message, type = 'success') {
            const statusDiv = document.getElementById('test-status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        function updateCSPStatus(message) {
            document.getElementById('csp-status').textContent = message;
        }

        // Test CSP permissions
        function testCSPPermissions() {
            log('üß™ Testing CSP permissions...');
            
            try {
                // Test 1: Script execution
                const testScript = 'console.log("CSP script test successful")';
                eval(testScript);
                log('‚úÖ Script execution: ALLOWED');
                
                // Test 2: Function creation
                const testFunction = new Function('return "CSP function test successful"');
                const result = testFunction();
                log(`‚úÖ Function creation: ALLOWED (${result})`);
                
                // Test 3: String evaluation
                const testString = '1 + 1';
                const evalResult = eval(testString);
                log(`‚úÖ String evaluation: ALLOWED (${evalResult})`);
                
                updateCSPStatus('‚úÖ CSP permissions: ALLOWED');
                updateStatus('CSP permissions test passed!', 'success');
                
            } catch (error) {
                log(`‚ùå CSP permissions: BLOCKED (${error.message})`);
                updateCSPStatus('‚ùå CSP permissions: BLOCKED');
                updateStatus('CSP permissions test failed!', 'error');
            }
        }

        // Test resume functionality
        function testResumeFunctionality() {
            log('üéØ Testing resume functionality...');
            
            try {
                // Mock SCORM resume data
                const resumeData = {
                    suspendData: '2U6230ged10010115010110000...',
                    lessonLocation: 'resume_point_1',
                    entry: 'resume',
                    completionStatus: 'incomplete'
                };
                
                // Test direct function injection (CSP-safe method)
                window.scormResumeData = resumeData;
                window.handleResumeTrigger = function() {
                    log('üéØ Resume trigger function called successfully');
                    return true;
                };
                
                // Test function call
                if (window.handleResumeTrigger) {
                    window.handleResumeTrigger();
                    log('‚úÖ Resume functionality: WORKING');
                    updateStatus('Resume functionality test passed!', 'success');
                } else {
                    throw new Error('Resume function not available');
                }
                
            } catch (error) {
                log(`‚ùå Resume functionality: FAILED (${error.message})`);
                updateStatus('Resume functionality test failed!', 'error');
            }
        }

        // Test script injection (should be blocked by CSP)
        function testScriptInjection() {
            log('üö´ Testing script injection (should be blocked by CSP)...');
            
            try {
                // This should be blocked by CSP
                const script = document.createElement('script');
                script.textContent = 'console.log("Script injection test")';
                document.head.appendChild(script);
                
                log('‚ö†Ô∏è Script injection: ALLOWED (CSP may be too permissive)');
                updateStatus('Script injection test: ALLOWED (check CSP settings)', 'error');
                
            } catch (error) {
                log(`‚úÖ Script injection: BLOCKED (${error.message})`);
                updateStatus('Script injection test: BLOCKED (good for security)', 'success');
            }
        }

        // Test direct function calls (CSP-safe method)
        function testDirectCalls() {
            log('üîß Testing direct function calls (CSP-safe method)...');
            
            try {
                // Mock iframe window
                const mockIframeWindow = {
                    scormResumeData: {
                        suspendData: 'test_data',
                        entry: 'resume'
                    },
                    API: {
                        LMSInitialize: function() { return 'true'; }
                    }
                };
                
                // Test direct function injection
                mockIframeWindow.handleResumeTrigger = function() {
                    log('üéØ Direct function call successful');
                    return true;
                };
                
                // Test function execution
                if (mockIframeWindow.handleResumeTrigger) {
                    mockIframeWindow.handleResumeTrigger();
                    log('‚úÖ Direct function calls: WORKING');
                    updateStatus('Direct function calls test passed!', 'success');
                } else {
                    throw new Error('Direct function not available');
                }
                
            } catch (error) {
                log(`‚ùå Direct function calls: FAILED (${error.message})`);
                updateStatus('Direct function calls test failed!', 'error');
            }
        }

        // Test CSP headers
        function testCSPHeaders() {
            log('üìã Testing CSP headers...');
            
            // Check if we can access response headers (limited in browser)
            const cspHeader = document.querySelector('meta[http-equiv="Content-Security-Policy"]');
            if (cspHeader) {
                log(`‚úÖ CSP meta tag found: ${cspHeader.content}`);
            } else {
                log('‚ÑπÔ∏è No CSP meta tag found (headers may be set server-side)');
            }
            
            // Test if our CSP fixes would work
            const cspTest = {
                'script-src': "'self' 'unsafe-inline' 'unsafe-eval'",
                'style-src': "'self' 'unsafe-inline' data:",
                'font-src': "'self' data: https:",
                'img-src': "'self' data: https:"
            };
            
            let cspStatus = 'CSP Configuration Test:\n';
            for (const [directive, value] of Object.entries(cspTest)) {
                cspStatus += `‚úÖ ${directive}: ${value}\n`;
            }
            
            document.getElementById('csp-headers').innerHTML = `<pre>${cspStatus}</pre>`;
            log('‚úÖ CSP headers configuration: READY');
        }

        // Add event listeners
        document.getElementById('test-csp').addEventListener('click', testCSPPermissions);
        document.getElementById('test-resume').addEventListener('click', testResumeFunctionality);
        document.getElementById('test-script-injection').addEventListener('click', testScriptInjection);
        document.getElementById('test-direct-calls').addEventListener('click', testDirectCalls);

        // Initialize
        log('SCORM CSP Resume Fix Test initialized');
        testCSPHeaders();
        
        // Auto-run CSP test
        setTimeout(() => {
            testCSPPermissions();
        }, 1000);
    </script>
</body>
</html>
