<!-- Personal Information Tab Content -->
{% if not is_edit_mode or is_edit_mode and profile_user.role == 'learner' %}
<div id="personal-tab" class="tab-content">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Profile Image Field -->
        <div class="form-group">
            <label for="{{ form.profile_image.id_for_label }}" class="form-label">Profile Picture</label>
            <div class="profile-image-upload">
                {% if is_edit_mode and profile_user.profile_image %}
                    <div class="current-image mb-3">
                        <img src="{{ profile_user.profile_image.url }}" alt="Current profile picture" class="profile-preview-img" style="width: 100px; height: 100px; object-fit: cover; border-radius: 50%; border: 3px solid #e5e7eb;">
                        <p class="text-sm text-gray-600 mt-2">Current profile picture</p>
                    </div>
                {% endif %}
                <div class="file-input-container">
                    <label class="file-input-button">
                        Choose File
                        {{ form.profile_image }}
                    </label>
                    <span class="file-name" id="profile-image-name">
                        {% if is_edit_mode and profile_user.profile_image %}{{ profile_user.profile_image.name }}{% else %}No file chosen{% endif %}
                    </span>
                </div>
                {% if form.profile_image.errors %}
                <div class="error-message">{{ form.profile_image.errors.0 }}</div>
                {% endif %}
                <div class="form-help-text">{{ form.profile_image.help_text }}</div>
            </div>
        </div>

        <div class="form-group">
            <label for="{{ form.cv_file.id_for_label }}" class="form-label">CV File</label>
            <div class="file-input-container">
                <label class="file-input-button">
                    Choose File
                    {{ form.cv_file }}
                </label>
                <span class="file-name" id="cv-file-name">
                    {% if is_edit_mode and profile_user.cv_file %}{{ profile_user.cv_file.name }}{% else %}No file chosen{% endif %}
                </span>
            </div>
            <div id="cv-extraction-status" class="mt-2 hidden">
                <div class="flex items-center">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-500 mr-2"></div>
                    <span>Extracting data from CV...</span>
                </div>
            </div>
            {% if form.cv_file.errors %}
            <div class="error-message">{{ form.cv_file.errors.0 }}</div>
            {% endif %}
            <div class="form-help-text">{{ form.cv_file.help_text }}{% if not is_edit_mode %} (PDF files will be automatically analyzed to extract personal, education, and employment data){% endif %}</div>
            {% if is_edit_mode and profile_user.cv_file %}
            <div class="mt-2 text-sm text-gray-600">
                Current file: <a href="{{ profile_user.cv_file.url }}" target="_blank" class="text-blue-600 hover:underline">{{ profile_user.cv_file.name }}</a>
            </div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="{{ form.unique_learner_number.id_for_label }}" class="form-label">Unique Learner Number (ULN)</label>
            {{ form.unique_learner_number }}
            {% if form.unique_learner_number.errors %}
            <div class="error-message">{{ form.unique_learner_number.errors.0 }}</div>
            {% endif %}
            <div class="form-help-text">{{ form.unique_learner_number.help_text }}</div>
        </div>

        <div class="form-group">
            <label for="{{ form.date_of_birth.id_for_label }}" class="form-label">Date of Birth</label>
            {{ form.date_of_birth }}
            {% if form.date_of_birth.errors %}
            <div class="error-message">{{ form.date_of_birth.errors.0 }}</div>
            {% endif %}
            <div class="form-help-text">{{ form.date_of_birth.help_text }}</div>
        </div>

        <div class="form-group">
            <label for="{{ form.sex.id_for_label }}" class="form-label">Sex</label>
            {{ form.sex }}
            {% if form.sex.errors %}
            <div class="error-message">{{ form.sex.errors.0 }}</div>
            {% endif %}
            <div class="form-help-text">{{ form.sex.help_text }}</div>
        </div>

        <div class="form-group sex-other-container" style="display: none;">
            <label for="{{ form.sex_other.id_for_label }}" class="form-label">Other Sex/Gender</label>
            {{ form.sex_other }}
            {% if form.sex_other.errors %}
            <div class="error-message">{{ form.sex_other.errors.0 }}</div>
            {% endif %}
            <div class="form-help-text">{{ form.sex_other.help_text }}</div>
        </div>

        <div class="form-group">
            <label for="{{ form.sexual_orientation.id_for_label }}" class="form-label">Sexual Orientation</label>
            {{ form.sexual_orientation }}
            {% if form.sexual_orientation.errors %}
            <div class="error-message">{{ form.sexual_orientation.errors.0 }}</div>
            {% endif %}
            <div class="form-help-text">{{ form.sexual_orientation.help_text }}</div>
        </div>

        <div class="form-group sexual-orientation-other-container" style="display: none;">
            <label for="{{ form.sexual_orientation_other.id_for_label }}" class="form-label">Other Sexual Orientation</label>
            {{ form.sexual_orientation_other }}
            {% if form.sexual_orientation_other.errors %}
            <div class="error-message">{{ form.sexual_orientation_other.errors.0 }}</div>
            {% endif %}
            <div class="form-help-text">{{ form.sexual_orientation_other.help_text }}</div>
        </div>

        <div class="form-group">
            <label for="{{ form.ethnicity.id_for_label }}" class="form-label">Ethnicity</label>
            {{ form.ethnicity }}
            {% if form.ethnicity.errors %}
            <div class="error-message">{{ form.ethnicity.errors.0 }}</div>
            {% endif %}
            <div class="form-help-text">{{ form.ethnicity.help_text }}</div>
        </div>

        <div class="form-group ethnicity-other-container" style="display: none;">
            <label for="{{ form.ethnicity_other.id_for_label }}" class="form-label">Other Ethnicity</label>
            {{ form.ethnicity_other }}
            {% if form.ethnicity_other.errors %}
            <div class="error-message">{{ form.ethnicity_other.errors.0 }}</div>
            {% endif %}
            <div class="form-help-text">{{ form.ethnicity_other.help_text }}</div>
        </div>

        <div class="form-group">
            <label for="{{ form.current_postcode.id_for_label }}" class="form-label">Postcode</label>
            {{ form.current_postcode }}
            <div id="postcode-lookup-status" class="mt-2 hidden">
                <div class="flex items-center">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-500 mr-2"></div>
                    <span>Looking up address...</span>
                </div>
            </div>
            {% if form.current_postcode.errors %}
            <div class="error-message">{{ form.current_postcode.errors.0 }}</div>
            {% endif %}
            <div class="form-help-text">{{ form.current_postcode.help_text }} (Powered by Ideal Postcodes API)</div>
        </div>

        <!-- Address Selector Dropdown -->
        <div id="address-selector-container" class="form-group hidden">
            <label for="address-selector" class="form-label">Select Address</label>
            <select id="address-selector" class="form-select">
                <option value="">Please select an address...</option>
            </select>
            <div class="form-help-text">Choose your address from the list or type manually in the fields below</div>
        </div>

        <div class="form-group">
            <label for="{{ form.is_non_uk_address.id_for_label }}" class="form-label">Non-UK Address</label>
            {{ form.is_non_uk_address }}
            <span class="ml-2">Manual address entry (for non-UK addresses)</span>
            {% if form.is_non_uk_address.errors %}
            <div class="error-message">{{ form.is_non_uk_address.errors.0 }}</div>
            {% endif %}
            <div class="form-help-text">{{ form.is_non_uk_address.help_text }}</div>
        </div>

        <div class="form-group">
            <label for="{{ form.address_line1.id_for_label }}" class="form-label">Address Line 1</label>
            {{ form.address_line1 }}
            {% if form.address_line1.errors %}
            <div class="error-message">{{ form.address_line1.errors.0 }}</div>
            {% endif %}
            <div class="form-help-text">{{ form.address_line1.help_text }}</div>
        </div>

        <div class="form-group">
            <label for="{{ form.address_line2.id_for_label }}" class="form-label">Address Line 2</label>
            {{ form.address_line2 }}
            {% if form.address_line2.errors %}
            <div class="error-message">{{ form.address_line2.errors.0 }}</div>
            {% endif %}
            <div class="form-help-text">{{ form.address_line2.help_text }}</div>
        </div>

        <div class="form-group">
            <label for="{{ form.city.id_for_label }}" class="form-label">City/Town</label>
            {{ form.city }}
            {% if form.city.errors %}
            <div class="error-message">{{ form.city.errors.0 }}</div>
            {% endif %}
            <div class="form-help-text">{{ form.city.help_text }}</div>
        </div>

        <div class="form-group">
            <label for="{{ form.county.id_for_label }}" class="form-label">County/State/Province</label>
            {{ form.county }}
            {% if form.county.errors %}
            <div class="error-message">{{ form.county.errors.0 }}</div>
            {% endif %}
            <div class="form-help-text">{{ form.county.help_text }}</div>
        </div>

        <div class="form-group">
            <label for="{{ form.country.id_for_label }}" class="form-label">Country</label>
            {{ form.country }}
            {% if form.country.errors %}
            <div class="error-message">{{ form.country.errors.0 }}</div>
            {% endif %}
            <div class="form-help-text">{{ form.country.help_text }}</div>
        </div>
    </div>
</div>

<script>
// Ensure tab state is preserved when making updates in this tab
document.addEventListener('DOMContentLoaded', function() {
    // Set tab state for form submission
    function updateTabState() {
        // Update global tab state explicitly for this tab
        if (typeof currentTabState !== 'undefined') {
            currentTabState.mainTab = 'personal-tab';
            
            console.log('Personal tab: Setting tab state to:', currentTabState);
            
            // Update hidden form fields directly
            var activeTabField = document.getElementById('activeTabField');
            if (activeTabField) activeTabField.value = currentTabState.mainTab;
        }
    }
    
    // Update tab state when the tab becomes visible
    var tabElement = document.getElementById('personal-tab');
    if (tabElement) {
        // Create a mutation observer to detect when the tab becomes visible
        var observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && 
                    mutation.attributeName === 'style' &&
                    tabElement.style.display !== 'none') {
                    updateTabState();
                }
                
                if (mutation.type === 'attributes' && 
                    mutation.attributeName === 'class' &&
                    tabElement.classList.contains('active')) {
                    updateTabState();
                }
            });
        });
        
        observer.observe(tabElement, { attributes: true });
        
        // Also check if it's already visible
        if (tabElement.style.display !== 'none' || tabElement.classList.contains('active')) {
            updateTabState();
        }
    }
    
    // Add input listeners to all form elements in this tab
    var formElements = document.querySelectorAll('#personal-tab input, #personal-tab textarea, #personal-tab select');
    formElements.forEach(function(element) {
        element.addEventListener('focus', updateTabState);
        element.addEventListener('change', updateTabState);
    });
});
</script>
{% endif %} 