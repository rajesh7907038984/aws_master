<!-- Health & Safety Tab Content -->
<div id="health-safety-tab" class="ilp-tab-content" style="display: none;">
    <div class="bg-white border border-gray-200 rounded-xl p-6 shadow-sm">
        <div class="flex items-center justify-between mb-6">
            <h4 class="text-lg font-semibold text-gray-900">Health & Safety Questionnaire</h4>
            {% if user.role == 'admin' or user.role == 'instructor' or user.role == 'superadmin' or user.role == 'globaladmin' %}
            <button type="button" onclick="addHealthSafetyItem()" class="inline-flex items-center px-4 py-2 text-white text-sm font-medium rounded-lg transition-colors duration-200" style="background-color: #1c2260;" onmouseover="this.style.backgroundColor='#181f56'" onmouseout="this.style.backgroundColor='#1c2260'">
                <i class="fas fa-plus mr-2"></i>
                Add Question
            </button>
            {% endif %}
        </div>
        
        <!-- Health & Safety Items Container -->
        <div id="health-safety-items-container">
            {% if existing_health_safety_items %}
                {% for item in existing_health_safety_items %}
                <div class="health-safety-item border border-gray-200 rounded-lg p-4 mb-4" data-item-id="{{ item.id }}">
                    <div class="flex items-start justify-between mb-3">
                        <h5 class="text-md font-medium text-gray-800">Question {{ forloop.counter }}</h5>
                        <div class="flex items-center space-x-2">
                            <!-- Status indicator -->
                            {% if item.student_confirmed == 'yes' %}
                                <span class="px-2 py-1 bg-green-100 text-green-800 text-xs font-medium rounded-full">
                                    <i class="fas fa-check-circle mr-1"></i>Confirmed
                                </span>
                            {% elif item.student_confirmed == 'no' %}
                                <span class="px-2 py-1 bg-red-100 text-red-800 text-xs font-medium rounded-full">
                                    <i class="fas fa-times-circle mr-1"></i>Not Confirmed
                                </span>
                            {% else %}
                                <span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs font-medium rounded-full">
                                    <i class="fas fa-hourglass-half mr-1"></i>Pending
                                </span>
                            {% endif %}
                            
                            {% if user.role == 'admin' or user.role == 'instructor' or user.role == 'superadmin' or user.role == 'globaladmin' %}
                            <button type="button" onclick="deleteHealthSafetyItem({{ item.id }})" class="text-red-600 hover:text-red-800 text-sm">
                                <i class="fas fa-trash"></i>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Question Text (Instructor/Admin View) -->
                    {% if user.role == 'admin' or user.role == 'instructor' or user.role == 'superadmin' or user.role == 'globaladmin' %}
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Question Text</label>
                        <textarea name="existing_health_safety_item_{{ item.id }}_question_text" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                  rows="2" placeholder="Enter health & safety question">{{ item.question_text }}</textarea>
                    </div>
                    {% else %}
                    <!-- Question Display (Learner View) -->
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Question</label>
                        <div class="p-3 bg-gray-50 rounded-md">
                            {{ item.question_text }}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Learner Response Section (for learners only) -->
                    {% if user.role == 'learner' %}
                    <div class="border-t border-gray-200 pt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-3">Do you agree with this health & safety requirement?</label>
                        <div class="space-y-3">
                            <div class="flex items-center">
                                <input 
                                    id="health_safety_agree_{{ item.id }}" 
                                    name="health_safety_item_{{ item.id }}_student_confirmed" 
                                    type="radio" 
                                    value="yes" 
                                    class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300"
                                    {% if item.student_confirmed == 'yes' %}checked{% endif %}
                                >
                                <label for="health_safety_agree_{{ item.id }}" class="ml-3 text-sm text-gray-700">
                                    <i class="fas fa-thumbs-up text-green-600 mr-1"></i>
                                    Yes, I confirm
                                </label>
                            </div>
                            <div class="flex items-center">
                                <input 
                                    id="health_safety_disagree_{{ item.id }}" 
                                    name="health_safety_item_{{ item.id }}_student_confirmed" 
                                    type="radio" 
                                    value="no" 
                                    class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300"
                                    {% if item.student_confirmed == 'no' %}checked{% endif %}
                                >
                                <label for="health_safety_disagree_{{ item.id }}" class="ml-3 text-sm text-gray-700">
                                    <i class="fas fa-thumbs-down text-red-600 mr-1"></i>
                                    No, I disagree
                                </label>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <label for="health_safety_answer_{{ item.id }}" class="block text-sm font-medium text-gray-700 mb-2">
                                Your Answer (Optional):
                            </label>
                            <textarea 
                                id="health_safety_answer_{{ item.id }}" 
                                name="health_safety_item_{{ item.id }}_answer_text" 
                                rows="2" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                placeholder="Provide additional information or explanation..."
                            >{{ item.answer_text|default:"" }}</textarea>
                        </div>
                        
                        <div class="mt-4">
                            <label for="health_safety_comment_{{ item.id }}" class="block text-sm font-medium text-gray-700 mb-2">
                                Your Comments:
                            </label>
                            <textarea 
                                id="health_safety_comment_{{ item.id }}" 
                                name="health_safety_item_{{ item.id }}_student_comment" 
                                rows="3" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                placeholder="Add your comments about this health & safety requirement..."
                            >{{ item.student_comment|default:"" }}</textarea>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Show learner response and instructor reply section for instructors -->
                    {% if user.role == 'admin' or user.role == 'instructor' or user.role == 'superadmin' or user.role == 'globaladmin' %}
                        {% if item.student_confirmed and item.student_confirmed != '' %}
                        <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-md">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-user text-blue-600 mr-2"></i>
                                <span class="text-sm font-medium text-gray-700">Learner Response:</span>
                                <span class="ml-2 px-2 py-1 text-xs rounded-full {% if item.student_confirmed == 'yes' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                    {% if item.student_confirmed == 'yes' %}Confirmed{% else %}Not Confirmed{% endif %}
                                </span>
                            </div>
                            {% if item.student_comment %}
                            <p class="text-gray-700 mb-3">{{ item.student_comment }}</p>
                            {% endif %}
                            {% if item.answer_text %}
                            <div class="mb-3">
                                <span class="text-sm font-medium text-gray-600">Answer:</span>
                                <p class="text-gray-700 mt-1">{{ item.answer_text }}</p>
                            </div>
                            {% endif %}
                            
                            <div>
                                <label class="block text-sm font-medium text-blue-700 mb-2">Your Reply:</label>
                                <textarea name="existing_health_safety_item_{{ item.id }}_instructor_reply" 
                                          class="w-full px-3 py-2 border border-blue-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                          rows="3" placeholder="Reply to learner's feedback...">{{ item.instructor_reply|default:"" }}</textarea>
                            </div>
                        </div>
                        {% else %}
                        <!-- Show instructor reply field for questions without learner responses -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Instructor Reply</label>
                            <textarea name="existing_health_safety_item_{{ item.id }}_instructor_reply" 
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                      rows="2" placeholder="Add any additional information or instructions">{{ item.instructor_reply|default:"" }}</textarea>
                        </div>
                        {% endif %}
                    {% endif %}
                    
                    <!-- Show instructor reply to learners (outside of instructor-only section) -->
                    <!-- Debug: instructor_reply value = "{{ item.instructor_reply }}" -->
                    {% if item.instructor_reply %}
                    <div class="mt-4 p-4 bg-green-50 border border-green-200 rounded-md">
                        <p class="text-sm text-green-600 mb-1">
                            <i class="fas fa-reply mr-1"></i>
                            Instructor Reply:
                        </p>
                        <!-- SECURITY FIX: Removed |safe filter to prevent XSS attacks -->
                        <div class="text-gray-800 prose prose-sm max-w-none">{{ item.instructor_reply|linebreaks }}</div>
                    </div>
                    {% endif %}
                    </div>
                    
                    <!-- File attachments from section documents -->
                    {% if item.section_documents %}
                    <div class="mt-4 pt-3 border-t border-gray-200">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Related Documents</label>
                        <div class="space-y-2">
                            {% for doc in item.section_documents %}
                            <div class="flex items-center justify-between p-2 bg-gray-50 rounded-md">
                                <div class="flex items-center">
                                    <i class="fas fa-file text-gray-500 mr-2"></i>
                                    <span class="text-sm text-gray-700">{{ doc.title }}</span>
                                </div>
                                <a href="{{ doc.document_file.url }}" target="_blank" 
                                   class="text-blue-600 hover:text-blue-800 text-sm">
                                    <i class="fas fa-download mr-1"></i>Download
                                </a>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <div class="text-center py-8">
                    <div class="text-gray-400 mb-4">
                        <i class="fas fa-shield-alt text-4xl"></i>
                    </div>
                    <p class="text-gray-600 mb-4">No health & safety questions have been added yet.</p>
                    {% if user.role == 'admin' or user.role == 'instructor' or user.role == 'superadmin' or user.role == 'globaladmin' %}
                    <button type="button" onclick="addHealthSafetyItem()" 
                            class="inline-flex items-center px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white text-sm font-medium rounded-lg">
                        <i class="fas fa-plus mr-2"></i>
                        Add First Question
                    </button>
                    {% endif %}
            </div>
            {% endif %}
        </div>
        
        <!-- Hidden container for new items (instructor/admin only) -->
        {% if user.role == 'admin' or user.role == 'instructor' or user.role == 'superadmin' or user.role == 'globaladmin' %}
        <div id="new-health-safety-items-container"></div>
        {% endif %}
    </div>
</div>

<script>
// Health & Safety Item Management
(function() {
    let healthSafetyItemCounter = 0;

    window.addHealthSafetyItem = function() {
    healthSafetyItemCounter++;
    const container = document.getElementById('new-health-safety-items-container');
    
    // Calculate the total question number (existing + new)
    const existingQuestions = document.querySelectorAll('.health-safety-item[data-item-id]').length;
    const totalQuestionNumber = existingQuestions + healthSafetyItemCounter;
    
    const itemHtml = `
        <div class="health-safety-item border border-green-200 rounded-lg p-4 mb-4 bg-green-50" data-item-index="${healthSafetyItemCounter}">
            <div class="flex items-start justify-between mb-3">
                <h5 class="text-md font-medium text-gray-800">
                    <i class="fas fa-plus-circle text-green-600 mr-2"></i>
                    New Question ${totalQuestionNumber}
                    <span class="text-xs text-green-600 ml-2">(Unsaved)</span>
                </h5>
                <button type="button" onclick="removeNewHealthSafetyItem(${healthSafetyItemCounter})" class="text-red-600 hover:text-red-800 text-sm">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            
            <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-2">Question Text *</label>
                <textarea name="new_health_safety_item_${healthSafetyItemCounter}_question_text" 
                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                          rows="2" placeholder="Enter health & safety question" required></textarea>
            </div>
            
            <div class="text-xs text-gray-500 italic">
                <i class="fas fa-info-circle mr-1"></i>
                This question will be saved when you submit the form.
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', itemHtml);
    
    // Hide the "no questions" message if it exists
    const noQuestionsMessage = document.querySelector('.text-center.py-8');
    if (noQuestionsMessage) {
        noQuestionsMessage.style.display = 'none';
    }
    
    // Scroll to the new item and focus on textarea
    setTimeout(() => {
        const newItem = container.lastElementChild;
        if (newItem) {
            newItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
            // Focus on the textarea
            const textarea = newItem.querySelector('textarea');
            if (textarea) {
                textarea.focus();
            }
        }
    }, 100);
    
}

    window.removeNewHealthSafetyItem = function(index) {
    const item = document.querySelector(`[data-item-index="${index}"]`);
    if (item) {
        item.remove();
    }
}

    window.deleteHealthSafetyItem = function(itemId) {
    if (confirm('Are you sure you want to delete this health & safety question?')) {
        // Create hidden input to mark for deletion
        const deleteInput = document.createElement('input');
        deleteInput.type = 'hidden';
        deleteInput.name = 'delete_health_safety_item_' + itemId;
        deleteInput.value = 'true';
        
        const form = document.querySelector('form');
        if (form) {
            form.appendChild(deleteInput);
        } else {
            // Could not find form to add deletion input
        }
        
        // Hide the item visually
        const item = document.querySelector(`[data-item-id="${itemId}"]`);
        if (item) {
            item.style.display = 'none';
        } else {
            // Could not find item to hide
        }
        
    }
}

    // Auto-save functionality for health & safety items
    function setupHealthSafetyAutoSave() {
        const form = document.querySelector('form');
        if (!form) return;
        
        // Add auto-save for existing items
        const existingInputs = form.querySelectorAll('textarea[name*="health_safety_item_"], select[name*="health_safety_item_"]');
        existingInputs.forEach(input => {
            input.addEventListener('change', function() {
                console.log('Health safety item changed:', this.name, this.value);
                // Could implement AJAX auto-save here if needed
            });
        });
        
        // Add auto-save for new items (delegated event handling)
        form.addEventListener('change', function(e) {
            if (e.target.name && e.target.name.includes('new_health_safety_item_')) {
                console.log('New health safety item changed:', e.target.name, e.target.value);
                // Could implement AJAX auto-save here if needed
            }
        });
    }

    // Form submission feedback
    function setupFormSubmissionFeedback() {
        const form = document.querySelector('form');
        if (!form) return;
        
        form.addEventListener('submit', function(e) {
            // Debug: Log all deletion inputs being submitted
            const deletionInputs = form.querySelectorAll('input[name^="delete_health_safety_item_"]');
            
            const newQuestions = document.querySelectorAll('[data-item-index]');
            if (newQuestions.length > 0) {
                // Show feedback that questions are being saved
                newQuestions.forEach(question => {
                    const header = question.querySelector('h5');
                    if (header) {
                        header.innerHTML = header.innerHTML.replace('(Unsaved)', '<span class="text-blue-600">(Saving...)</span>');
                    }
                    question.classList.remove('bg-green-50', 'border-green-200');
                    question.classList.add('bg-blue-50', 'border-blue-200');
                });
                
            }
        });
    }

    // Initialize when the tab is opened
    document.addEventListener('DOMContentLoaded', function() {
        setupHealthSafetyAutoSave();
        setupFormSubmissionFeedback();
    });
})();

// Ensure tab state is preserved when making updates in this tab
document.addEventListener('DOMContentLoaded', function() {
    // Set tab state for form submission
    function updateTabState() {
        // Update global tab state explicitly for this tab
        if (typeof currentTabState !== 'undefined') {
            currentTabState.mainTab = 'ilp-tab';
            currentTabState.subTab = 'health-safety-tab';
            
            console.log('Health & Safety tab: Setting tab state to:', currentTabState);
            
            // Update hidden form fields directly
            var activeTabField = document.getElementById('activeTabField');
            var activeSubTabField = document.getElementById('activeSubTabField');
            
            if (activeTabField) activeTabField.value = currentTabState.mainTab;
            if (activeSubTabField) activeSubTabField.value = currentTabState.subTab;
        }
    }
    
    // Update tab state when the tab becomes visible
    var tabElement = document.getElementById('health-safety-tab');
    if (tabElement) {
        // Create a mutation observer to detect when the tab becomes visible
        var observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && 
                    mutation.attributeName === 'style' &&
                    tabElement.style.display !== 'none') {
                    updateTabState();
                }
                
                if (mutation.type === 'attributes' && 
                    mutation.attributeName === 'class' &&
                    tabElement.classList.contains('active')) {
                    updateTabState();
                }
            });
        });
        
        observer.observe(tabElement, { attributes: true });
        
        // Also check if it's already visible
        if (tabElement.style.display !== 'none' || tabElement.classList.contains('active')) {
            updateTabState();
        }
    }
    
    // Add input listeners to all form elements in this tab
    var formElements = document.querySelectorAll('#health-safety-tab input, #health-safety-tab textarea, #health-safety-tab select');
    formElements.forEach(function(element) {
        element.addEventListener('focus', updateTabState);
        element.addEventListener('change', updateTabState);
    });
});
</script> 