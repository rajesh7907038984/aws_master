{% extends 'base.html' %}
{% load static %}

{% block title %}Two-Factor Authentication - {{ site_name|default:"Nexsy LMS" }}{% endblock %}

{% block extra_css %}
<style>
    .otp-container {
        min-height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }
    
    .otp-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        padding: 40px;
        width: 100%;
        max-width: 500px;
        text-align: center;
    }
    
    .otp-header {
        margin-bottom: 30px;
    }
    
    .otp-header h1 {
        color: #2c3e50;
        font-size: 28px;
        margin-bottom: 10px;
        font-weight: 600;
    }
    
    .otp-header p {
        color: #6c757d;
        font-size: 16px;
        margin: 0;
    }
    
    .security-icon {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
        color: white;
        font-size: 36px;
    }
    
    .otp-form {
        margin: 30px 0;
    }
    
    .otp-input-container {
        margin: 20px 0;
    }
    
    .otp-input {
        width: 100%;
        padding: 15px 20px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 24px;
        text-align: center;
        font-weight: bold;
        letter-spacing: 8px;
        transition: border-color 0.3s ease;
        margin-bottom: 10px;
    }
    
    .otp-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .otp-input::placeholder {
        color: #adb5bd;
        font-weight: normal;
        letter-spacing: normal;
    }
    
    .email-info {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin: 20px 0;
        font-size: 14px;
        color: #495057;
    }
    
    .email-info strong {
        color: #2c3e50;
    }
    
    .submit-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 15px 40px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        width: 100%;
        margin-bottom: 20px;
    }
    
    .submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }
    
    .submit-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    .back-link {
        display: inline-block;
        color: #6c757d;
        text-decoration: none;
        font-size: 14px;
        margin-top: 20px;
        transition: color 0.3s ease;
    }
    
    .back-link:hover {
        color: #495057;
        text-decoration: underline;
    }
    
    .timer-info {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 5px;
        padding: 10px;
        margin: 15px 0;
        color: #856404;
        font-size: 14px;
    }
    
    .security-tips {
        text-align: left;
        background-color: #e7f3ff;
        border-left: 4px solid #007bff;
        padding: 15px;
        margin: 20px 0;
        border-radius: 0 8px 8px 0;
    }
    
    .security-tips h4 {
        margin-top: 0;
        color: #0056b3;
        font-size: 14px;
        font-weight: 600;
    }
    
    .security-tips ul {
        margin: 10px 0 0 0;
        padding-left: 20px;
    }
    
    .security-tips li {
        margin: 5px 0;
        font-size: 12px;
        color: #495057;
    }
    
    @media (max-width: 576px) {
        .otp-card {
            padding: 30px 20px;
        }
        
        .otp-header h1 {
            font-size: 24px;
        }
        
        .security-icon {
            width: 60px;
            height: 60px;
            font-size: 28px;
        }
        
        .otp-input {
            font-size: 20px;
            letter-spacing: 6px;
            padding: 12px 15px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="otp-container">
    <div class="otp-card">
        <div class="security-icon">
            <i class="fas fa-shield-alt"></i>
        </div>
        
        <div class="otp-header">
            <h1>Two-Factor Authentication</h1>
            <p>
                {% if branch %}
                Secure login to {{ branch.name }}
                {% elif user.username %}
                Secure login verification for {{ user.get_full_name|default:user.username }}
                {% else %}
                Secure login verification
                {% endif %}
            </p>
        </div>
        
        <div class="email-info">
            <i class="fas fa-envelope text-primary"></i>
            <strong>Verification Code Sent</strong><br>
            We've sent a 6-digit verification code to <strong>{{ email_masked }}</strong>
        </div>
        
        <div class="timer-info">
            <i class="fas fa-clock"></i>
            <strong>Important:</strong> This code will expire in 10 minutes. If you don't see the email, check your spam folder.
        </div>
        
        <form method="post" class="otp-form" id="otpForm">
            {% csrf_token %}
            
            <div class="otp-input-container">
                <input 
                    type="text" 
                    name="otp_code" 
                    class="otp-input" 
                    placeholder="000000"
                    maxlength="8"
                    autocomplete="one-time-code"
                    autofocus
                    id="otpInput"
                    required
                >
                <small class="text-muted">Enter the code from your email, authenticator app, or backup code</small>
            </div>
            
            <button type="submit" class="submit-btn" id="submitBtn">
                <i class="fas fa-check-circle"></i> Verify & Continue
            </button>
        </form>
        
                    <div class="security-tips">
                <h4><i class="fas fa-info-circle"></i> Verification Options</h4>
                <ul>
                    <li><strong>Email Code:</strong> 6-digit code sent to your email (expires in 10 minutes)</li>
                    <li><strong>Authenticator App:</strong> 6-digit code from Google Authenticator, Authy, etc.</li>
                    <li><strong>Backup Code:</strong> 8-character recovery code (use if you lost your device)</li>
                    <li><strong>Security:</strong> Never share codes with anyone</li>
                </ul>
            </div>
        
        <a href="{% if branch_slug %}{% url 'users:branch_login' branch_slug %}{% else %}{% url 'login' %}{% endif %}" class="back-link">
            <i class="fas fa-arrow-left"></i> Back to Login
        </a>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const otpInput = document.getElementById('otpInput');
    const submitBtn = document.getElementById('submitBtn');
    const form = document.getElementById('otpForm');
    
    // Format OTP input for different code types
    otpInput.addEventListener('input', function(e) {
        let value = e.target.value.toUpperCase();
        
        // For backup codes, allow alphanumeric up to 8 chars
        if (/^[A-Z0-9]*$/.test(value)) {
            if (value.length > 8) {
                value = value.slice(0, 8);
            }
        } else {
            // For numeric codes, remove non-digits and limit to 6
            value = value.replace(/\D/g, '');
            if (value.length > 6) {
                value = value.slice(0, 6);
            }
        }
        
        e.target.value = value;
        
        // Enable submit for various code lengths
        if (value.length === 6 || value.length === 8) {
            submitBtn.disabled = false;
            // Auto-submit for 6-digit codes (TOTP/email OTP)
            if (value.length === 6) {
                setTimeout(() => {
                    form.submit();
                }, 500);
            }
        } else {
            submitBtn.disabled = value.length < 6;
        }
    });
    
    // Allow alphanumeric input for backup codes
    otpInput.addEventListener('keydown', function(e) {
        // Allow: backspace, delete, tab, escape, enter
        if ([8, 9, 27, 13, 46].indexOf(e.keyCode) !== -1 ||
            // Allow: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
            (e.keyCode === 65 && e.ctrlKey === true) ||
            (e.keyCode === 67 && e.ctrlKey === true) ||
            (e.keyCode === 86 && e.ctrlKey === true) ||
            (e.keyCode === 88 && e.ctrlKey === true)) {
            return;
        }
        // Allow numbers and letters for backup codes
        if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && 
            (e.keyCode < 96 || e.keyCode > 105) && 
            (e.keyCode < 65 || e.keyCode > 90)) {
            e.preventDefault();
        }
    });
    
    // Paste handling for various code types
    otpInput.addEventListener('paste', function(e) {
        e.preventDefault();
        const paste = (e.clipboardData || window.clipboardData).getData('text').trim();
        
        // Handle backup codes (alphanumeric) or numeric codes
        let cleanValue;
        if (/^[A-Z0-9]{8}$/.test(paste.toUpperCase())) {
            // Backup code - keep as is but uppercase
            cleanValue = paste.toUpperCase().slice(0, 8);
        } else {
            // Numeric code - extract digits only
            cleanValue = paste.replace(/\D/g, '').slice(0, 6);
        }
        
        otpInput.value = cleanValue;
        
        if (cleanValue.length === 6 || cleanValue.length === 8) {
            submitBtn.disabled = false;
            if (cleanValue.length === 6) {
                setTimeout(() => {
                    form.submit();
                }, 500);
            }
        }
    });
    
    // Initial state
    submitBtn.disabled = otpInput.value.length < 6;
});
</script>
{% endblock %}
