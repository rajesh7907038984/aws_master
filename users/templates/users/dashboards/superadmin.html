{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - Nexsy LMS{% endblock %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="{% static 'css/dashboard-shared.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'css/dashboard-roles-unified.css' %}">
<style>
    /* Superadmin-specific overrides only */
    .dashboard-main {
        background-color: var(--superadmin-background) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-main">
        <!-- Breadcrumbs -->
        {% include 'components/breadcrumb.html' with breadcrumbs=breadcrumbs %}
        
        <!-- Main Content Grid -->
        <div class="dashboard-grid dashboard-grid-main">
            <!-- First Column (60%) -->
            <div class="dashboard-flex dashboard-flex-col">
                <!-- First Row: Overview and Quick Actions -->
                <div class="dashboard-grid dashboard-grid-two-col">
                    <!-- Overview Section -->
                    <div class="dashboard-section">
                        <h2 class="dashboard-section-header">Overview</h2>
                        <div class="dashboard-grid dashboard-grid-overview">
                            <div class="dashboard-overview-card">
                                <div class="dashboard-overview-icon">
                                    <i class="fas fa-building"></i>
                                </div>
                                <div class="dashboard-overview-content">
                                    <div class="dashboard-overview-value" id="total-branches-display">{{ total_branches|default:"0" }}</div>
                                    <div class="dashboard-overview-label">Branches</div>
                                </div>
                            </div>
                            
                            <div class="dashboard-overview-card">
                                <div class="dashboard-overview-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="dashboard-overview-content">
                                    <div class="dashboard-overview-value" id="active-users-display">{{ active_users|default:"0" }}</div>
                                    <div class="dashboard-overview-label">Active Users</div>
                                </div>
                            </div>
                            
                            <div class="dashboard-overview-card">
                                <div class="dashboard-overview-icon">
                                    <i class="fas fa-book"></i>
                                </div>
                                <div class="dashboard-overview-content">
                                    <div class="dashboard-overview-value" id="total-courses-display">{{ total_courses|default:"0" }}</div>
                                    <div class="dashboard-overview-label">Courses</div>
                                </div>
                            </div>
                            
                            <div class="dashboard-overview-card">
                                <div class="dashboard-overview-icon">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <div class="dashboard-overview-content">
                                    <div class="dashboard-overview-value" id="completion-rate-display">{{ completion_rate|default:"0" }}%</div>
                                    <div class="dashboard-overview-label">Completion Rate</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions Section -->
                    <div class="dashboard-section">
                        <h2 class="dashboard-section-header">Quick Actions</h2>
                        <div class="dashboard-quick-actions">
                            <a href="{% url 'courses:course_manage' %}" class="dashboard-quick-action">
                                <div class="dashboard-quick-action-icon">
                                    <i class="fas fa-book"></i>
                                </div>
                                <div class="dashboard-quick-action-text">Create Course</div>
                            </a>
                            
                            <a href="{% url 'groups:group_create' %}" class="dashboard-quick-action">
                                <div class="dashboard-quick-action-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="dashboard-quick-action-text">Create Group</div>
                            </a>
                            
                            <a href="{% url 'users:user_create' %}" class="dashboard-quick-action">
                                <div class="dashboard-quick-action-icon">
                                    <i class="fas fa-user-plus"></i>
                                </div>
                                <div class="dashboard-quick-action-text">Create User</div>
                            </a>
                            
                            <a href="{% url 'categories:category_create' %}" class="dashboard-quick-action">
                                <div class="dashboard-quick-action-icon">
                                    <i class="fas fa-tags"></i>
                                </div>
                                <div class="dashboard-quick-action-text">Create Category</div>
                            </a>
                        </div>
                    </div>
                </div>


                <!-- Third Row: In Progress and Instructors -->
                <div class="dashboard-grid dashboard-grid-two-col">
                    <!-- In Progress Section -->
                    <div class="dashboard-section">
                        <div class="dashboard-flex dashboard-flex-between dashboard-mb-sm">
                            <h2 class="dashboard-section-header dashboard-mb-0">In Progress</h2>
                        </div>
                        <div class="dashboard-section-description">Branch Courses</div>
                        
                        <div class="dashboard-activity-list">
                            {% for course in branch_courses %}
                            <div class="dashboard-flex dashboard-flex-between" style="padding: 0.75rem 0; border-bottom: 1px solid #f3f4f6;">
                                <div class="dashboard-flex" style="align-items: center; min-width: 0; flex-grow: 1;">
                                    <div class="w-10 h-10 rounded-full bg-gray-200 mr-3 overflow-hidden" style="flex-shrink: 0; display: flex; align-items: center; justify-content: center;">
                                        <i class="far fa-file-alt" style="color: #6b7280;"></i>
                                    </div>
                                    <div style="min-width: 0; flex-grow: 1; display: flex; align-items: center; justify-content: space-between;">
                                        <div class="dashboard-text-small font-medium">{{ course.title }}</div>
                                        <div class="dashboard-text-xs text-gray-500" style="margin-left: 1rem; white-space: nowrap;">{{ course.total_enrollments }} enrollment{{ course.total_enrollments|pluralize }}</div>
                                    </div>
                                </div>
                                {% if course.id and course.id != '' %}
                                <a href="{% url 'courses:course_view' course.id %}" class="text-gray-400 hover:text-gray-600" style="flex-shrink: 0;">
                                    <i class="fas fa-arrow-right"></i>
                                </a>
                                {% endif %}
                            </div>
                            {% empty %}
                            <div class="dashboard-text-center dashboard-text-small" style="padding: 1.5rem 1rem; color: #6b7280;">
                                <i class="fas fa-book-open text-3xl mb-3 text-gray-300"></i>
                                <p>No courses in progress</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Instructors Section -->
                    <div class="dashboard-section">
                        <div class="dashboard-flex dashboard-flex-between dashboard-mb-lg">
                            <h2 class="dashboard-section-header dashboard-mb-0">Instructors</h2>
                        </div>
                        <div class="dashboard-section-description">Recently Active</div>
                        
                        <div class="dashboard-activity-list">
                            {% for instructor in recent_instructors %}
                            <div class="dashboard-flex dashboard-flex-between" style="padding: 0.75rem 0; border-bottom: 1px solid #f3f4f6;">
                                <div class="dashboard-flex" style="align-items: center; min-width: 0; flex-grow: 1;">
                                    <div class="w-10 h-10 rounded-full bg-gray-200 mr-3 overflow-hidden" style="flex-shrink: 0;">
                                        {% if instructor.profile_image %}
                                            <img src="{{ instructor.profile_image.url }}" alt="Avatar" class="w-full h-full object-cover">
                                        {% else %}
                                            <img src="{% static 'img/default-avatar.svg' %}" alt="Avatar" class="w-full h-full object-cover">
                                        {% endif %}
                                    </div>
                                    <div style="min-width: 0; flex-grow: 1; display: flex; align-items: center; justify-content: space-between;">
                                        <div class="dashboard-text-small font-medium">{{ instructor.get_full_name|default:instructor.username|truncatechars:25 }}</div>
                                        <div class="dashboard-text-xs text-gray-500" style="margin-left: 1rem; white-space: nowrap;">Last active: {{ instructor.last_login|timesince }} ago</div>
                                    </div>
                                </div>
                                <a href="{% url 'users:user_profile' instructor.id %}" class="text-gray-400 hover:text-gray-600" style="flex-shrink: 0;">
                                    <i class="fas fa-arrow-right"></i>
                                </a>
                            </div>
                            {% empty %}
                            <div class="dashboard-text-center dashboard-text-small" style="padding: 1.5rem 1rem; color: #6b7280;">
                                <i class="fas fa-chalkboard-teacher text-3xl mb-3 text-gray-300"></i>
                                <p>No active instructors found</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Second Column (40%) -->
            <div class="dashboard-flex dashboard-flex-col">
                <!-- To-Do List -->
                <div class="dashboard-section">
                    <div class="dashboard-flex dashboard-flex-between dashboard-mb-lg">
                        <h2 class="dashboard-section-header dashboard-mb-0">To-Do List</h2>
                        <div class="dashboard-text-small dashboard-text-muted">
                            <span id="todo-count">{{ total_todo_count|default:0 }} active tasks</span>
                        </div>
                    </div>
                    
                    <!-- Enhanced Todo List Container -->
                    <div class="todo-content-wrapper" style="max-height: 400px; overflow-y: auto;">
                        <div id="todo-list" class="dashboard-activity-list">
                            <!-- Enhanced Todo Items -->
                            {% include 'users/components/enhanced_todo_item.html' %}
                            
                            {% if not todo_items %}
                            <div class="dashboard-text-center dashboard-text-small" style="padding: 1.5rem 1rem; color: #6b7280;">
                                <i class="fas fa-tasks text-3xl mb-3 text-gray-300"></i>
                                <p>No active tasks</p>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Load More Button -->
                        {% if has_more_todos %}
                        <div class="text-center pt-3" id="load-more-container">
                            <button id="load-more-todos" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-plus-circle mr-1"></i>
                                Load More Tasks
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Responsive Calendar Component -->
                <div class="dashboard-section">
                    {% include 'components/dashboard_calendar.html' %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}

<!-- Chart functionality handled by global unified chart system -->
<script>
let currentTodoStart = {{ todo_items|length }};

// Load more todos functionality
function loadMoreTodos() {
    const loadButton = document.getElementById('load-more-todos');
    const todoList = document.getElementById('todo-list');
    
    if (!loadButton || !todoList) return;
    
    // Show loading state
    const originalText = loadButton.innerHTML;
    loadButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Loading...';
    loadButton.disabled = true;
    
    // Make AJAX request
    fetch(`${window.location.pathname}?load_more_todos=1&start=${currentTodoStart}&limit=5`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Cache-Control': 'no-cache'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.html) {
            // Append new items to the todo list
            todoList.insertAdjacentHTML('beforeend', data.html);
            
            // Update the start position for next load
            currentTodoStart += 5;
            
            // Update task count
            const countElement = document.getElementById('todo-count');
            if (countElement) {
                const currentCount = todoList.querySelectorAll('.todo-item').length;
                countElement.textContent = `${data.total_count} active tasks`;
            }
            
            // Hide load more button if no more items
            if (!data.has_more) {
                const loadMoreContainer = document.getElementById('load-more-container');
                if (loadMoreContainer) {
                    loadMoreContainer.style.display = 'none';
                }
            }
        }
        
        // Restore button state
        loadButton.innerHTML = originalText;
        loadButton.disabled = false;
    })
    .catch(error => {
        console.error('Error loading more todos:', error);
        
        // Restore button state on error
        loadButton.innerHTML = originalText;
        loadButton.disabled = false;
        
        // Show error message
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger text-center mt-2';
        errorDiv.style.fontSize = '12px';
        errorDiv.innerHTML = '<i class="fas fa-exclamation-triangle mr-1"></i>Failed to load more tasks. Please try again.';
        
        const loadMoreContainer = document.getElementById('load-more-container');
        if (loadMoreContainer) {
            loadMoreContainer.appendChild(errorDiv);
            
            // Remove error message after 3 seconds
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 3000);
        }
    });
}

// Attach event listener when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    const loadMoreButton = document.getElementById('load-more-todos');
    if (loadMoreButton) {
        loadMoreButton.addEventListener('click', loadMoreTodos);
    }
});
</script>
{% endblock %}
