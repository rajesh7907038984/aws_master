{% extends 'base.html' %}
{% load static %}

{% block title %}Groups Management - LMS{% endblock %}

{% block extra_css %}
<style>
    body {
        background-color: #ffffff !important;
    }

    /* Table styles */
    .group-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }
    
    .group-table th {
        color: #374151;
        font-weight: 500;
        text-align: left;
        padding: 0.75rem 1rem;
        background-color: #F9FAFB;
        font-size: 0.875rem;
        border-bottom: 1px solid #E5E7EB;
    }
    
    .group-table td {
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        border-bottom: 1px solid #E5E7EB;
        text-align: left;
    }

    .group-table tr:nth-child(odd) td {
        background-color: #F9FAFB;
    }

    .group-table tr:nth-child(even) td {
        background-color: #FFFFFF;
    }
    
    .group-table tr:hover td {
        background-color: #F3F4F6;
    }

    /* Action buttons */
    .action-btn {
        padding: 0.375rem;
        border-radius: 0.375rem;
        transition: all 0.2s;
        color: #6B7280;
    }
    
    .action-btn:hover {
        background-color: #F3F4F6;
        color: #374151;
    }

    /* Group info styles */
    .group-name {
        color: #111827;
        font-weight: 500;
        font-size: 0.875rem;
    }

    .group-info {
        color: #6B7280;
        font-size: 0.875rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="flex-1 overflow-x-hidden overflow-y-auto bg-white">
    <div class="p-6 space-y-6 bg-white">
        <!-- Breadcrumb -->
        {% include 'components/breadcrumb.html' with items=breadcrumbs %}

        <!-- Main Content -->
        <div class="container mx-auto">
            <!-- Main grid with 70-30 split -->
            <div class="grid grid-cols-12 gap-4 md:gap-6">
                <!-- Left Column (70%) -->
                <div class="col-span-12 lg:col-span-8 transition-all duration-300">
                    <!-- Tabs -->
                    <div x-data="{ 
                        activeTab: '{{ request.GET.tab|default:default_tab }}',
                        setActiveTab(tab) {
                            this.activeTab = tab;
                            const url = new URL(window.location);
                            url.searchParams.set('tab', tab);
                            history.pushState({}, '', url);
                        }
                    }" class="mt-6">
                        <!-- Tab Navigation -->
                        <div class="border-b border-gray-200">
                            <nav class="flex -mb-px space-x-8" aria-label="Tabs">
                                {% if request.user.role != 'learner' %}
                                <button @click="setActiveTab('user-groups')"
                                        :class="{ 'border-blue-500 text-blue-600': activeTab === 'user-groups',
                                                'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'user-groups' }"
                                        class="py-4 px-1 border-b-2 font-medium text-sm">
                                    User Groups
                                </button>
                                {% endif %}
                                <button @click="setActiveTab('course-groups')"
                                        :class="{ 'border-blue-500 text-blue-600': activeTab === 'course-groups',
                                                'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'course-groups' }"
                                        class="py-4 px-1 border-b-2 font-medium text-sm">
                                    Course Groups
                                </button>
                                {% if request.user.role != 'learner' %}
                                <button @click="setActiveTab('access-control')"
                                        :class="{ 'border-blue-500 text-blue-600': activeTab === 'access-control',
                                                'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'access-control' }"
                                        class="py-4 px-1 border-b-2 font-medium text-sm">
                                    Access Control
                                </button>
                                {% endif %}
                            </nav>
                        </div>

                        <!-- Tab Content -->
                        <div class="mt-6">
                            <!-- User Groups Tab -->
                            <div x-show="activeTab === 'user-groups'" id="user-groups" class="space-y-6">
                                <div class="flex justify-between items-center">
                                    <h2 class="text-2xl font-bold text-gray-900">User Groups</h2>
                                    <div class="flex space-x-4">
                                        <button id="bulkDeleteUserGroups" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors hidden" onclick="bulkDeleteGroups('user-groups')">
                                            Delete Selected
                                        </button>
                                        {% if request.user.role == 'admin' or request.user.role == 'superadmin' or request.user.role == 'globaladmin' %}
                                            {% if request.user.branch and request.user.branch.teams_integration_enabled %}
                                            <button id="azureSyncBtn" onclick="syncAzureGroups()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors flex items-center">
                                                <i class="fas fa-sync-alt mr-2"></i> Sync Azure Groups
                                            </button>
                                            <button id="azureImportBtn" onclick="openAzureImportModal()" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors flex items-center">
                                                <i class="fab fa-microsoft mr-2"></i> Import from Azure
                                            </button>
                                            {% endif %}
                                        {% endif %}
                                        {% if can_create %}
                                        <a href="{% url 'groups:group_create' %}?type=user&tab=user-groups" 
                                           class="px-4 py-2 text-white rounded-md transition-colors" style="background-color: #1c2260;" onmouseover="this.style.backgroundColor='#181f56'" onmouseout="this.style.backgroundColor='#1c2260'">
                                            Create User Group
                                        </a>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="bg-white shadow-sm rounded-lg overflow-hidden border border-gray-200">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    <input type="checkbox" id="selectAllUserGroups" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                                </th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Group Name</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Members</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            {% for group in user_groups %}
                                            <tr>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <input type="checkbox" name="selected_groups" value="{{ group.id }}" class="group-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="flex items-center">
                                                        <i class="fas fa-users text-gray-400 mr-3"></i>
                                                        <span class="group-name">{{ group.name }}</span>
                                                    </div>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <span class="group-info">
                                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                                            {{ group.memberships.count }} members
                                                        </span>
                                                    </span>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="flex justify-start space-x-2">
                                                        <a href="{% url 'groups:group_edit' group.id %}?type=user&tab=user-groups" class="action-btn" title="Edit">
                                                            <i class="fas fa-edit"></i>
                                                        </a>
                                                        <form method="post" action="{% url 'groups:group_delete' group.id %}" class="inline" onsubmit="return confirm('Are you sure you want to delete this group?');">
                                                            {% csrf_token %}
                                                            <input type="hidden" name="tab" value="user-groups">
                                                            <button type="submit" class="action-btn" title="Delete">
                                                                <i class="fas fa-trash-alt"></i>
                                                            </button>
                                                        </form>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="5" class="text-center py-8">
                                                    <div class="flex flex-col items-center justify-center">
                                                        <div class="w-16 h-16 mb-4 text-gray-300">
                                                            <i class="fas fa-users text-4xl"></i>
                                                        </div>
                                                        <h3 class="text-lg font-medium text-gray-900 mb-2">No User Groups Found</h3>
                                                        <p class="text-sm text-gray-500">Create your first user group to get started.</p>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Course Groups Tab -->
                            <div x-show="activeTab === 'course-groups'" id="course-groups" class="space-y-6">
                                <div class="flex justify-between items-center">
                                    <h2 class="text-2xl font-bold text-gray-900">Course Groups</h2>
                                    <div class="flex space-x-4">
                                        <button id="bulkDeleteCourseGroups" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors hidden" onclick="bulkDeleteGroups('course-groups')">
                                            Delete Selected
                                        </button>
                                        {% if can_create and request.user.role != 'learner' %}
                                        <a href="{% url 'groups:group_create' %}?type=course&tab=course-groups" 
                                           class="px-4 py-2 text-white rounded-md transition-colors" style="background-color: #1c2260;" onmouseover="this.style.backgroundColor='#181f56'" onmouseout="this.style.backgroundColor='#1c2260'">
                                            Create Course Group
                                        </a>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="bg-white shadow-sm rounded-lg overflow-hidden border border-gray-200">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                {% if request.user.role != 'learner' %}
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    <input type="checkbox" id="selectAllCourseGroups" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                                </th>
                                                {% endif %}
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Group Name</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Courses</th>
                                                {% if request.user.role != 'learner' %}
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                                {% endif %}
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            {% for group in course_groups %}
                                            <tr>
                                                {% if request.user.role != 'learner' %}
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <input type="checkbox" name="selected_groups" value="{{ group.id }}" class="group-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                                </td>
                                                {% endif %}
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="flex items-center">
                                                        <i class="fas fa-graduation-cap text-gray-400 mr-3"></i>
                                                        <span class="group-name">{{ group.name }}</span>
                                                    </div>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <span class="group-info">
                                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                                                            {{ group.course_access.count }} courses
                                                        </span>
                                                    </span>
                                                </td>
                                                {% if request.user.role != 'learner' %}
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="flex justify-start space-x-2">
                                                        <a href="{% url 'groups:group_edit' group.id %}?type=course&tab=course-groups" class="action-btn" title="Edit">
                                                            <i class="fas fa-edit"></i>
                                                        </a>
                                                        <form method="post" action="{% url 'groups:group_delete' group.id %}" class="inline" onsubmit="return confirm('Are you sure you want to delete this group?');">
                                                            {% csrf_token %}
                                                            <input type="hidden" name="tab" value="course-groups">
                                                            <button type="submit" class="action-btn" title="Delete">
                                                                <i class="fas fa-trash-alt"></i>
                                                            </button>
                                                        </form>
                                                    </div>
                                                </td>
                                                {% endif %}
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="{% if request.user.role == 'learner' %}2{% else %}4{% endif %}" class="text-center py-8">
                                                    <div class="flex flex-col items-center justify-center">
                                                        <div class="w-16 h-16 mb-4 text-gray-300">
                                                            <i class="fas fa-graduation-cap text-4xl"></i>
                                                        </div>
                                                        <h3 class="text-lg font-medium text-gray-900 mb-2">
                                                            {% if request.user.role == 'learner' %}
                                                            No Course Groups Available
                                                            {% else %}
                                                            No Course Groups Found
                                                            {% endif %}
                                                        </h3>
                                                        <p class="text-sm text-gray-500">
                                                            {% if request.user.role == 'learner' %}
                                                            You are not currently a member of any course groups.
                                                            {% else %}
                                                            Create your first course group to get started.
                                                            {% endif %}
                                                        </p>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Access Control Tab -->
                            <div x-show="activeTab === 'access-control'" id="access-control" class="space-y-6">
                                <div class="flex justify-between items-center">
                                    <h2 class="text-2xl font-bold text-gray-900">Access Control</h2>
                                    <div class="flex space-x-4">
                                        <button id="bulkDeleteAccessControl" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors hidden" onclick="bulkDeleteGroups('access-control')">
                                            Delete Selected
                                        </button>
                                        {% if can_create %}
                                        <a href="{% url 'groups:role_create' %}?tab=access-control" 
                                           class="px-4 py-2 text-white rounded-md transition-colors" style="background-color: #1c2260;" onmouseover="this.style.backgroundColor='#181f56'" onmouseout="this.style.backgroundColor='#1c2260'">
                                            Create Access Control
                                        </a>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="bg-white shadow-sm rounded-lg overflow-hidden border border-gray-200">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    <input type="checkbox" id="selectAllAccessControl" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                                </th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role Name</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Group</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Permissions</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            {% for group_data in grouped_access_control %}
                                            <tr>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <input type="checkbox" name="selected_groups" value="{{ group_data.first_role_id }}" class="group-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <span class="group-name">{{ group_data.combined_role_name }}</span>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <span class="group-info">{{ group_data.group_name }}</span>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="flex flex-wrap gap-1">
                                                        {% if group_data.permissions.can_view %}
                                                        <span class="px-2.5 py-0.5 inline-flex text-sm leading-5 font-semibold rounded-full bg-green-100 text-green-800">View</span>
                                                        {% endif %}
                                                        {% if group_data.permissions.can_edit %}
                                                        <span class="px-2.5 py-0.5 inline-flex text-sm leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">Edit</span>
                                                        {% endif %}
                                                        {% if group_data.permissions.can_manage_members %}
                                                        <span class="px-2.5 py-0.5 inline-flex text-sm leading-5 font-semibold rounded-full bg-purple-100 text-purple-800">Manage Members</span>
                                                        {% endif %}
                                                        {% if group_data.permissions.can_manage_content %}
                                                        <span class="px-2.5 py-0.5 inline-flex text-sm leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Manage Content</span>
                                                        {% endif %}
                                                    </div>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="flex justify-start space-x-2">
                                                        <a href="{% url 'groups:role_edit' group_data.first_role_id %}?tab=access-control" class="action-btn" title="Edit Group Roles">
                                                            <i class="fas fa-edit"></i>
                                                        </a>
                                                        <form method="post" action="{% url 'groups:role_delete' group_data.first_role_id %}" class="inline" onsubmit="return confirm('Are you sure you want to delete this role? This action might affect multiple roles if grouped.');">
                                                            {% csrf_token %}
                                                            <input type="hidden" name="tab" value="access-control">
                                                            <button type="submit" class="action-btn" title="Delete Group Roles">
                                                                <i class="fas fa-trash-alt"></i>
                                                            </button>
                                                        </form>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="5" class="text-center py-8">
                                                    <div class="flex flex-col items-center justify-center">
                                                        <div class="w-16 h-16 mb-4 text-gray-300">
                                                            <i class="fas fa-key text-4xl"></i>
                                                        </div>
                                                        <h3 class="text-lg font-medium text-gray-900 mb-2">No Roles Found</h3>
                                                        <p class="text-sm text-gray-500">Create your first role to manage access control.</p>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column (30%) -->
                <div class="col-span-12 lg:col-span-4 transition-all duration-300">
                    {% include 'components/right_sidebar.html' %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Function to handle select all checkboxes
    function setupSelectAll(selectAllId, tabName) {
        const selectAll = document.getElementById(selectAllId);
        const checkboxes = document.querySelectorAll(`#${tabName} .group-checkbox`);
        const bulkDeleteBtn = document.getElementById(`bulkDelete${tabName.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join('')}`);

        if (!selectAll || !bulkDeleteBtn) return;

        selectAll.addEventListener('change', function() {
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateBulkDeleteButton(tabName);
        });

        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                updateBulkDeleteButton(tabName);
                // Update select all checkbox state
                const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                selectAll.checked = allChecked;
            });
        });

        // Initial update of bulk delete button
        updateBulkDeleteButton(tabName);
    }

    // Function to update bulk delete button visibility
    function updateBulkDeleteButton(tabName) {
        const checkboxes = document.querySelectorAll(`#${tabName} .group-checkbox`);
        const bulkDeleteBtn = document.getElementById(`bulkDelete${tabName.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join('')}`);
        
        if (!bulkDeleteBtn) return;
        
        const hasChecked = Array.from(checkboxes).some(checkbox => checkbox.checked);
        bulkDeleteBtn.classList.toggle('hidden', !hasChecked);
    }

    // Function to handle bulk deletion
    function bulkDeleteGroups(tabName) {
        const checkboxes = document.querySelectorAll(`#${tabName} .group-checkbox:checked`);
        const groupIds = Array.from(checkboxes).map(checkbox => checkbox.value);
        
        if (groupIds.length === 0) {
            alert('Please select at least one group to delete.');
            return;
        }

        if (!confirm(`Are you sure you want to delete ${groupIds.length} selected group(s)?`)) {
            return;
        }

        // Create a form and submit it
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url "groups:group_bulk_delete" %}';
        
        // Add CSRF token
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
        form.appendChild(csrfInput);

        // Add group IDs
        groupIds.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'group_ids[]';
            input.value = id;
            form.appendChild(input);
        });

        // Add tab information
        const tabInput = document.createElement('input');
        tabInput.type = 'hidden';
        tabInput.name = 'tab';
        tabInput.value = tabName;
        form.appendChild(tabInput);

        document.body.appendChild(form);
        form.submit();
    }

    // Initialize select all functionality for each tab
    document.addEventListener('DOMContentLoaded', function() {
        setupSelectAll('selectAllUserGroups', 'user-groups');
        setupSelectAll('selectAllCourseGroups', 'course-groups');
        setupSelectAll('selectAllAccessControl', 'access-control');
    });

    // ============ Azure AD Group Import Functions ============
    
    let azureGroups = [];
    let selectedGroups = [];
    
    function openAzureImportModal() {
        // Show loading state
        document.getElementById('azureImportBtn').disabled = true;
        document.getElementById('azureImportBtn').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Loading...';
        
        // Fetch Azure AD groups
        fetch("{% url 'groups:azure_groups_list' %}")
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    azureGroups = data.groups;
                    displayAzureGroups(data.groups);
                    document.getElementById('azureImportModal').classList.remove('hidden');
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                alert('Error fetching Azure AD groups: ' + error);
            })
            .finally(() => {
                document.getElementById('azureImportBtn').disabled = false;
                document.getElementById('azureImportBtn').innerHTML = '<i class="fab fa-microsoft mr-2"></i> Import from Azure';
            });
    }
    
    function displayAzureGroups(groups) {
        const container = document.getElementById('azureGroupsContainer');
        container.innerHTML = '';
        
        // Display groups by category
        const categories = [
            { key: 'security', label: 'Security Groups', icon: 'fa-shield-alt' },
            { key: 'microsoft365', label: 'Microsoft 365 Groups', icon: 'fa-users' },
            { key: 'distribution', label: 'Distribution Lists', icon: 'fa-envelope' },
            { key: 'other', label: 'Other Groups', icon: 'fa-folder' }
        ];
        
        let totalGroups = 0;
        
        categories.forEach(category => {
            const categoryGroups = groups[category.key] || [];
            if (categoryGroups.length === 0) return;
            
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'mb-6 azure-category';
            categoryDiv.setAttribute('data-category', category.key);
            categoryDiv.innerHTML = `
                <h4 class="text-lg font-semibold mb-3 text-gray-700 flex items-center">
                    <i class="fas ${category.icon} mr-2"></i> ${category.label}
                </h4>
                <div class="space-y-2" id="${category.key}-groups"></div>
            `;
            container.appendChild(categoryDiv);
            
            const groupsContainer = document.getElementById(`${category.key}-groups`);
            categoryGroups.forEach(group => {
                totalGroups++;
                const groupDiv = document.createElement('div');
                groupDiv.className = 'border rounded-lg p-4 hover:bg-gray-50 transition-colors azure-group-item';
                groupDiv.setAttribute('data-group-name', group.displayName.toLowerCase());
                groupDiv.setAttribute('data-group-desc', (group.description || '').toLowerCase());
                groupDiv.setAttribute('data-group-id', group.id);
                groupDiv.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center flex-1">
                            <input type="checkbox" 
                                   id="group-${group.id}" 
                                   ${group.already_imported ? 'disabled checked' : ''}
                                   class="rounded border-gray-300 text-blue-600 mr-3"
                                   onchange="toggleGroupSelection('${group.id}', '${group.displayName}', this.checked)">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <label for="group-${group.id}" class="font-medium text-gray-900 cursor-pointer">
                                        ${group.displayName}
                                    </label>
                                    <span id="member-badge-${group.id}" class="px-2 py-0.5 text-xs font-semibold rounded-full bg-gray-100 text-gray-400">
                                        <i class="fas fa-spinner fa-spin text-xs mr-1"></i>...
                                    </span>
                                </div>
                                ${group.description ? `<p class="text-sm text-gray-500 mt-1">${group.description}</p>` : ''}
                                ${group.already_imported ? '<span class="text-xs text-blue-600 font-semibold mt-1 block">Already Imported</span>' : ''}
                            </div>
                        </div>
                        <div id="role-selector-${group.id}" class="ml-4 ${group.already_imported ? 'hidden' : ''}" style="min-width: 150px;">
                            <select class="form-select rounded-md border-gray-300 text-sm" 
                                    onchange="updateGroupRole('${group.id}', this.value)">
                                <option value="learner">Learner</option>
                                <option value="instructor">Instructor</option>
                            </select>
                        </div>
                    </div>
                `;
                groupsContainer.appendChild(groupDiv);
            });
        });
        
        // Update total count
        updateSearchCount(totalGroups, totalGroups);
        
        // Fetch member counts for initial visible groups (limited to 100)
        // If there are too many groups, user can search to narrow down and see counts
        setTimeout(() => {
            fetchMemberCounts();
        }, 100);
    }
    
    let memberCountTimeout = null;
    async function fetchMemberCounts() {
        // Get all visible group IDs (not hidden by filter)
        const visibleGroups = Array.from(document.querySelectorAll('.azure-group-item'))
            .filter(el => el.style.display !== 'none');
        const groupIds = visibleGroups.map(el => el.getAttribute('data-group-id'));
        
        if (groupIds.length === 0) return;
        
        // Limit to 100 groups max to avoid long API calls
        if (groupIds.length > 100) {
            console.warn(`Too many groups (${groupIds.length}) to fetch counts for. Please refine your search.`);
            // Update all badges to show a message instead of loading spinner
            visibleGroups.forEach(group => {
                const groupId = group.getAttribute('data-group-id');
                const badge = document.getElementById(`member-badge-${groupId}`);
                if (badge) {
                    badge.className = 'px-2 py-0.5 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800';
                    badge.innerHTML = '<i class="fas fa-search text-xs mr-1"></i>Search to view';
                    badge.title = 'Too many groups to load member counts. Use the search box to filter groups and view member counts.';
                }
            });
            return;
        }
        
        try {
            const response = await fetch('/groups/azure/member-counts/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ group_ids: groupIds })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Update badges with member counts
                Object.entries(data.counts).forEach(([groupId, count]) => {
                    const badge = document.getElementById(`member-badge-${groupId}`);
                    if (badge) {
                        const memberBadgeColor = count > 0 ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-600';
                        badge.className = `px-2 py-0.5 text-xs font-semibold rounded-full ${memberBadgeColor}`;
                        badge.innerHTML = `<i class="fas fa-users text-xs mr-1"></i>${count} member${count !== 1 ? 's' : ''}`;
                    }
                });
            } else {
                console.error('Failed to fetch member counts:', data.error);
                // Set all badges to error state
                groupIds.forEach(groupId => {
                    const badge = document.getElementById(`member-badge-${groupId}`);
                    if (badge) {
                        badge.className = 'px-2 py-0.5 text-xs font-semibold rounded-full bg-gray-100 text-gray-500';
                        badge.innerHTML = '<i class="fas fa-question text-xs mr-1"></i>?';
                    }
                });
            }
        } catch (error) {
            console.error('Error fetching member counts:', error);
            // Set all badges to error state
            groupIds.forEach(groupId => {
                const badge = document.getElementById(`member-badge-${groupId}`);
                if (badge) {
                    badge.className = 'px-2 py-0.5 text-xs font-semibold rounded-full bg-gray-100 text-gray-500';
                    badge.innerHTML = '<i class="fas fa-question text-xs mr-1"></i>?';
                }
            });
        }
    }
    
    function filterAzureGroups(searchTerm) {
        const term = searchTerm.toLowerCase().trim();
        const allGroups = document.querySelectorAll('.azure-group-item');
        const allCategories = document.querySelectorAll('.azure-category');
        const noResults = document.getElementById('noResultsMessage');
        const container = document.getElementById('azureGroupsContainer');
        
        let visibleCount = 0;
        let totalCount = allGroups.length;
        
        if (term === '') {
            // Show all groups
            allGroups.forEach(group => {
                group.style.display = '';
                visibleCount++;
            });
            allCategories.forEach(cat => cat.style.display = '');
            container.style.display = '';
            noResults.classList.add('hidden');
            updateSearchCount(visibleCount, totalCount);
            return;
        }
        
        // Filter groups
        allGroups.forEach(group => {
            const name = group.getAttribute('data-group-name');
            const desc = group.getAttribute('data-group-desc');
            
            if (name.includes(term) || desc.includes(term)) {
                group.style.display = '';
                visibleCount++;
            } else {
                group.style.display = 'none';
            }
        });
        
        // Hide empty categories
        allCategories.forEach(category => {
            const categoryKey = category.getAttribute('data-category');
            const categoryGroups = category.querySelectorAll('.azure-group-item');
            const visibleInCategory = Array.from(categoryGroups).filter(g => g.style.display !== 'none').length;
            
            if (visibleInCategory === 0) {
                category.style.display = 'none';
            } else {
                category.style.display = '';
            }
        });
        
        // Show/hide no results message
        if (visibleCount === 0) {
            container.style.display = 'none';
            noResults.classList.remove('hidden');
        } else {
            container.style.display = '';
            noResults.classList.add('hidden');
        }
        
        updateSearchCount(visibleCount, totalCount);
        
        // Fetch member counts for filtered groups (with debouncing)
        if (memberCountTimeout) {
            clearTimeout(memberCountTimeout);
        }
        memberCountTimeout = setTimeout(() => {
            fetchMemberCounts();
        }, 500); // Wait 500ms after user stops typing
    }
    
    function updateSearchCount(visible, total) {
        const countElement = document.getElementById('searchResultCount');
        if (visible === total) {
            countElement.textContent = `${total} group${total !== 1 ? 's' : ''}`;
        } else {
            countElement.textContent = `${visible} of ${total} group${total !== 1 ? 's' : ''}`;
        }
    }
    
    function toggleGroupSelection(groupId, groupName, isChecked) {
        if (isChecked) {
            const roleSelector = document.querySelector(`#role-selector-${groupId} select`);
            const role = roleSelector ? roleSelector.value : 'learner';
            selectedGroups.push({
                azure_group_id: groupId,
                azure_group_name: groupName,
                assigned_role: role
            });
        } else {
            selectedGroups = selectedGroups.filter(g => g.azure_group_id !== groupId);
        }
        
        // Update import button state
        const importBtn = document.getElementById('executeImportBtn');
        importBtn.disabled = selectedGroups.length === 0;
        importBtn.textContent = selectedGroups.length > 0 
            ? `Import ${selectedGroups.length} Group(s)` 
            : 'Select Groups to Import';
    }
    
    function updateGroupRole(groupId, role) {
        const group = selectedGroups.find(g => g.azure_group_id === groupId);
        if (group) {
            group.assigned_role = role;
        }
    }
    
    function closeAzureImportModal() {
        document.getElementById('azureImportModal').classList.add('hidden');
        selectedGroups = [];
        // Reset search
        document.getElementById('azureGroupSearch').value = '';
        filterAzureGroups('');
    }
    
    function executeImport() {
        if (selectedGroups.length === 0) {
            alert('Please select at least one group to import');
            return;
        }
        
        const importBtn = document.getElementById('executeImportBtn');
        importBtn.disabled = true;
        importBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Importing...';
        
        fetch("{% url 'groups:azure_group_import' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                group_mappings: selectedGroups
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let message = `Successfully imported ${data.imported_groups.length} group(s) with ${data.imported_users_count} user(s).\n\n`;
                data.imported_groups.forEach(g => {
                    let detailMsg = `- ${g.azure_name} → ${g.lms_name}\n`;
                    detailMsg += `  • Found: ${g.members_count} members\n`;
                    detailMsg += `  • Imported: ${g.imported_count || 0} users\n`;
                    if (g.skipped_count && g.skipped_count > 0) {
                        detailMsg += `  • Skipped: ${g.skipped_count} (no email or errors)\n`;
                    }
                    detailMsg += `  • Role: ${g.role}\n`;
                    message += detailMsg;
                });
                
                if (data.errors && data.errors.length > 0) {
                    message += '\n\nWarnings:\n';
                    data.errors.forEach(err => {
                        message += `- ${err}\n`;
                    });
                }
                
                alert(message);
                closeAzureImportModal();
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error importing groups: ' + error);
        })
        .finally(() => {
            importBtn.disabled = false;
            importBtn.innerHTML = '<i class="fas fa-download mr-2"></i> Import Selected Groups';
        });
    }
    
    function syncAzureGroups() {
        if (!confirm('This will sync all previously imported Azure AD groups and add any new members. Continue?')) {
            return;
        }
        
        const syncBtn = document.getElementById('azureSyncBtn');
        syncBtn.disabled = true;
        syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Syncing...';
        
        fetch("{% url 'groups:azure_group_sync' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let message = `Successfully synced ${data.synced_groups.length} group(s) with ${data.new_users_count} new user(s).\n\n`;
                data.synced_groups.forEach(g => {
                    if (g.new_members > 0) {
                        message += `- ${g.azure_name} → ${g.lms_name} (+${g.new_members} new members)\n`;
                    }
                });
                
                if (data.new_users_count === 0) {
                    message = 'All groups are up to date. No new members found.';
                }
                
                alert(message);
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error syncing groups: ' + error);
        })
        .finally(() => {
            syncBtn.disabled = false;
            syncBtn.innerHTML = '<i class="fas fa-sync-alt mr-2"></i> Sync Azure Groups';
        });
    }
</script>

<!-- Azure Import Modal -->
<div id="azureImportModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-6xl shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-2xl font-bold text-gray-900">Import Azure AD Groups</h3>
            <button onclick="closeAzureImportModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>
        
        <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <p class="text-sm text-blue-800">
                <i class="fas fa-info-circle mr-2"></i>
                Select Azure AD groups to import. Users from selected groups will be automatically registered in the LMS 
                with the role you assign. You can assign either "Learner" or "Instructor" role to each group.
            </p>
        </div>
        
        <!-- Search Box -->
        <div class="mb-4">
            <div class="relative">
                <input type="text" 
                       id="azureGroupSearch" 
                       placeholder="Search groups by name or description..." 
                       class="w-full px-4 py-3 pl-10 pr-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                       onkeyup="filterAzureGroups(this.value)">
                <i class="fas fa-search absolute left-3 top-4 text-gray-400"></i>
                <span id="searchResultCount" class="absolute right-3 top-4 text-sm text-gray-500"></span>
            </div>
        </div>
        
        <div id="azureGroupsContainer" class="max-h-96 overflow-y-auto mb-6 border rounded-lg p-4 bg-gray-50">
            <!-- Groups will be populated here -->
        </div>
        
        <div id="noResultsMessage" class="hidden text-center py-8 text-gray-500">
            <i class="fas fa-search text-4xl mb-3"></i>
            <p class="text-lg">No groups found matching your search</p>
        </div>
        
        <div class="flex justify-end space-x-4">
            <button onclick="closeAzureImportModal()" 
                    class="px-6 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors">
                Cancel
            </button>
            <button id="executeImportBtn" 
                    onclick="executeImport()" 
                    disabled
                    class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed">
                <i class="fas fa-download mr-2"></i> Select Groups to Import
            </button>
        </div>
    </div>
</div>

{% endblock %}
