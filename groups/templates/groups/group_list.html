{% extends 'base.html' %}
{% load static %}

{% block title %}Groups Management - LMS{% endblock %}

{% block extra_css %}
<style>
    body {
        background-color: #ffffff !important;
    }

    /* Table styles */
    .group-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }
    
    .group-table th {
        color: #374151;
        font-weight: 500;
        text-align: left;
        padding: 0.75rem 1rem;
        background-color: #F9FAFB;
        font-size: 0.875rem;
        border-bottom: 1px solid #E5E7EB;
    }
    
    .group-table td {
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        border-bottom: 1px solid #E5E7EB;
        text-align: left;
    }

    .group-table tr:nth-child(odd) td {
        background-color: #F9FAFB;
    }

    .group-table tr:nth-child(even) td {
        background-color: #FFFFFF;
    }
    
    .group-table tr:hover td {
        background-color: #F3F4F6;
    }

    /* Action buttons */
    .action-btn {
        padding: 0.375rem;
        border-radius: 0.375rem;
        transition: all 0.2s;
        color: #6B7280;
    }
    
    .action-btn:hover {
        background-color: #F3F4F6;
        color: #374151;
    }

    /* Group info styles */
    .group-name {
        color: #111827;
        font-weight: 500;
        font-size: 0.875rem;
    }

    .group-info {
        color: #6B7280;
        font-size: 0.875rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="flex-1 overflow-x-hidden overflow-y-auto bg-white">
    <div class="p-6 space-y-6 bg-white">
        <!-- Breadcrumb -->
        {% include 'components/breadcrumb.html' with items=breadcrumbs %}

        <!-- Main Content -->
        <div class="container mx-auto">
            <!-- Main grid with 70-30 split -->
            <div class="grid grid-cols-12 gap-4 md:gap-6">
                <!-- Left Column (70%) -->
                <div class="col-span-12 lg:col-span-8 transition-all duration-300">
                    <!-- Tabs -->
                    <div x-data="{ 
                        activeTab: '{{ request.GET.tab|default:default_tab }}',
                        setActiveTab(tab) {
                            this.activeTab = tab;
                            const url = new URL(window.location);
                            url.searchParams.set('tab', tab);
                            history.pushState({}, '', url);
                        }
                    }" class="mt-6">
                        <!-- Tab Navigation -->
                        <div class="border-b border-gray-200">
                            <nav class="flex -mb-px space-x-8" aria-label="Tabs">
                                {% if request.user.role != 'learner' %}
                                <button @click="setActiveTab('user-groups')"
                                        :class="{ 'border-blue-500 text-blue-600': activeTab === 'user-groups',
                                                'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'user-groups' }"
                                        class="py-4 px-1 border-b-2 font-medium text-sm">
                                    User Groups
                                </button>
                                {% endif %}
                                <button @click="setActiveTab('course-groups')"
                                        :class="{ 'border-blue-500 text-blue-600': activeTab === 'course-groups',
                                                'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'course-groups' }"
                                        class="py-4 px-1 border-b-2 font-medium text-sm">
                                    Course Groups
                                </button>
                                {% if request.user.role != 'learner' %}
                                <button @click="setActiveTab('access-control')"
                                        :class="{ 'border-blue-500 text-blue-600': activeTab === 'access-control',
                                                'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'access-control' }"
                                        class="py-4 px-1 border-b-2 font-medium text-sm">
                                    Access Control
                                </button>
                                {% endif %}
                            </nav>
                        </div>

                        <!-- Tab Content -->
                        <div class="mt-6">
                            <!-- User Groups Tab -->
                            <div x-show="activeTab === 'user-groups'" id="user-groups" class="space-y-6">
                                <div class="flex justify-between items-center">
                                    <h2 class="text-2xl font-bold text-gray-900">User Groups</h2>
                                    <div class="flex space-x-4">
                                        <button id="bulkDeleteUserGroups" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors hidden" onclick="bulkDeleteGroups('user-groups')">
                                            Delete Selected
                                        </button>
                                        {% if can_create %}
                                        <a href="{% url 'groups:group_create' %}?type=user&tab=user-groups" 
                                           class="px-4 py-2 text-white rounded-md transition-colors" style="background-color: #1c2260;" onmouseover="this.style.backgroundColor='#181f56'" onmouseout="this.style.backgroundColor='#1c2260'">
                                            Create User Group
                                        </a>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="bg-white shadow-sm rounded-lg overflow-hidden border border-gray-200">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    <input type="checkbox" id="selectAllUserGroups" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                                </th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Group Name</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Members</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            {% for group in user_groups %}
                                            <tr>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <input type="checkbox" name="selected_groups" value="{{ group.id }}" class="group-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="flex items-center">
                                                        <i class="fas fa-users text-gray-400 mr-3"></i>
                                                        <span class="group-name">{{ group.name }}</span>
                                                    </div>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <span class="group-info">
                                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                                            {{ group.memberships.count }} members
                                                        </span>
                                                    </span>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="flex justify-start space-x-2">
                                                        <a href="{% url 'groups:group_edit' group.id %}?type=user&tab=user-groups" class="action-btn" title="Edit">
                                                            <i class="fas fa-edit"></i>
                                                        </a>
                                                        <form method="post" action="{% url 'groups:group_delete' group.id %}" class="inline" onsubmit="return confirm('Are you sure you want to delete this group?');">
                                                            {% csrf_token %}
                                                            <input type="hidden" name="tab" value="user-groups">
                                                            <button type="submit" class="action-btn" title="Delete">
                                                                <i class="fas fa-trash-alt"></i>
                                                            </button>
                                                        </form>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="5" class="text-center py-8">
                                                    <div class="flex flex-col items-center justify-center">
                                                        <div class="w-16 h-16 mb-4 text-gray-300">
                                                            <i class="fas fa-users text-4xl"></i>
                                                        </div>
                                                        <h3 class="text-lg font-medium text-gray-900 mb-2">No User Groups Found</h3>
                                                        <p class="text-sm text-gray-500">Create your first user group to get started.</p>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Course Groups Tab -->
                            <div x-show="activeTab === 'course-groups'" id="course-groups" class="space-y-6">
                                <div class="flex justify-between items-center">
                                    <h2 class="text-2xl font-bold text-gray-900">Course Groups</h2>
                                    <div class="flex space-x-4">
                                        <button id="bulkDeleteCourseGroups" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors hidden" onclick="bulkDeleteGroups('course-groups')">
                                            Delete Selected
                                        </button>
                                        {% if can_create and request.user.role != 'learner' %}
                                        <a href="{% url 'groups:group_create' %}?type=course&tab=course-groups" 
                                           class="px-4 py-2 text-white rounded-md transition-colors" style="background-color: #1c2260;" onmouseover="this.style.backgroundColor='#181f56'" onmouseout="this.style.backgroundColor='#1c2260'">
                                            Create Course Group
                                        </a>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="bg-white shadow-sm rounded-lg overflow-hidden border border-gray-200">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                {% if request.user.role != 'learner' %}
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    <input type="checkbox" id="selectAllCourseGroups" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                                </th>
                                                {% endif %}
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Group Name</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Courses</th>
                                                {% if request.user.role != 'learner' %}
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                                {% endif %}
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            {% for group in course_groups %}
                                            <tr>
                                                {% if request.user.role != 'learner' %}
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <input type="checkbox" name="selected_groups" value="{{ group.id }}" class="group-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                                </td>
                                                {% endif %}
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="flex items-center">
                                                        <i class="fas fa-graduation-cap text-gray-400 mr-3"></i>
                                                        <span class="group-name">{{ group.name }}</span>
                                                    </div>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <span class="group-info">
                                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                                                            {{ group.course_access.count }} courses
                                                        </span>
                                                    </span>
                                                </td>
                                                {% if request.user.role != 'learner' %}
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="flex justify-start space-x-2">
                                                        <a href="{% url 'groups:group_edit' group.id %}?type=course&tab=course-groups" class="action-btn" title="Edit">
                                                            <i class="fas fa-edit"></i>
                                                        </a>
                                                        <form method="post" action="{% url 'groups:group_delete' group.id %}" class="inline" onsubmit="return confirm('Are you sure you want to delete this group?');">
                                                            {% csrf_token %}
                                                            <input type="hidden" name="tab" value="course-groups">
                                                            <button type="submit" class="action-btn" title="Delete">
                                                                <i class="fas fa-trash-alt"></i>
                                                            </button>
                                                        </form>
                                                    </div>
                                                </td>
                                                {% endif %}
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="{% if request.user.role == 'learner' %}2{% else %}4{% endif %}" class="text-center py-8">
                                                    <div class="flex flex-col items-center justify-center">
                                                        <div class="w-16 h-16 mb-4 text-gray-300">
                                                            <i class="fas fa-graduation-cap text-4xl"></i>
                                                        </div>
                                                        <h3 class="text-lg font-medium text-gray-900 mb-2">
                                                            {% if request.user.role == 'learner' %}
                                                            No Course Groups Available
                                                            {% else %}
                                                            No Course Groups Found
                                                            {% endif %}
                                                        </h3>
                                                        <p class="text-sm text-gray-500">
                                                            {% if request.user.role == 'learner' %}
                                                            You are not currently a member of any course groups.
                                                            {% else %}
                                                            Create your first course group to get started.
                                                            {% endif %}
                                                        </p>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Access Control Tab -->
                            <div x-show="activeTab === 'access-control'" id="access-control" class="space-y-6">
                                <div class="flex justify-between items-center">
                                    <h2 class="text-2xl font-bold text-gray-900">Access Control</h2>
                                    <div class="flex space-x-4">
                                        <button id="bulkDeleteAccessControl" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors hidden" onclick="bulkDeleteGroups('access-control')">
                                            Delete Selected
                                        </button>
                                        {% if can_create %}
                                        <a href="{% url 'groups:role_create' %}?tab=access-control" 
                                           class="px-4 py-2 text-white rounded-md transition-colors" style="background-color: #1c2260;" onmouseover="this.style.backgroundColor='#181f56'" onmouseout="this.style.backgroundColor='#1c2260'">
                                            Create Access Control
                                        </a>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="bg-white shadow-sm rounded-lg overflow-hidden border border-gray-200">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    <input type="checkbox" id="selectAllAccessControl" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                                </th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role Name</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Group</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Permissions</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            {% for group_data in grouped_access_control %}
                                            <tr>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <input type="checkbox" name="selected_groups" value="{{ group_data.first_role_id }}" class="group-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <span class="group-name">{{ group_data.combined_role_name }}</span>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <span class="group-info">{{ group_data.group_name }}</span>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="flex flex-wrap gap-1">
                                                        {% if group_data.permissions.can_view %}
                                                        <span class="px-2.5 py-0.5 inline-flex text-sm leading-5 font-semibold rounded-full bg-green-100 text-green-800">View</span>
                                                        {% endif %}
                                                        {% if group_data.permissions.can_edit %}
                                                        <span class="px-2.5 py-0.5 inline-flex text-sm leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">Edit</span>
                                                        {% endif %}
                                                        {% if group_data.permissions.can_manage_members %}
                                                        <span class="px-2.5 py-0.5 inline-flex text-sm leading-5 font-semibold rounded-full bg-purple-100 text-purple-800">Manage Members</span>
                                                        {% endif %}
                                                        {% if group_data.permissions.can_manage_content %}
                                                        <span class="px-2.5 py-0.5 inline-flex text-sm leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Manage Content</span>
                                                        {% endif %}
                                                    </div>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="flex justify-start space-x-2">
                                                        <a href="{% url 'groups:role_edit' group_data.first_role_id %}?tab=access-control" class="action-btn" title="Edit Group Roles">
                                                            <i class="fas fa-edit"></i>
                                                        </a>
                                                        <form method="post" action="{% url 'groups:role_delete' group_data.first_role_id %}" class="inline" onsubmit="return confirm('Are you sure you want to delete this role? This action might affect multiple roles if grouped.');">
                                                            {% csrf_token %}
                                                            <input type="hidden" name="tab" value="access-control">
                                                            <button type="submit" class="action-btn" title="Delete Group Roles">
                                                                <i class="fas fa-trash-alt"></i>
                                                            </button>
                                                        </form>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="5" class="text-center py-8">
                                                    <div class="flex flex-col items-center justify-center">
                                                        <div class="w-16 h-16 mb-4 text-gray-300">
                                                            <i class="fas fa-key text-4xl"></i>
                                                        </div>
                                                        <h3 class="text-lg font-medium text-gray-900 mb-2">No Roles Found</h3>
                                                        <p class="text-sm text-gray-500">Create your first role to manage access control.</p>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column (30%) -->
                <div class="col-span-12 lg:col-span-4 transition-all duration-300">
                    {% include 'components/right_sidebar.html' %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Function to handle select all checkboxes
    function setupSelectAll(selectAllId, tabName) {
        const selectAll = document.getElementById(selectAllId);
        const checkboxes = document.querySelectorAll(`#${tabName} .group-checkbox`);
        const bulkDeleteBtn = document.getElementById(`bulkDelete${tabName.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join('')}`);

        if (!selectAll || !bulkDeleteBtn) return;

        selectAll.addEventListener('change', function() {
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateBulkDeleteButton(tabName);
        });

        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                updateBulkDeleteButton(tabName);
                // Update select all checkbox state
                const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                selectAll.checked = allChecked;
            });
        });

        // Initial update of bulk delete button
        updateBulkDeleteButton(tabName);
    }

    // Function to update bulk delete button visibility
    function updateBulkDeleteButton(tabName) {
        const checkboxes = document.querySelectorAll(`#${tabName} .group-checkbox`);
        const bulkDeleteBtn = document.getElementById(`bulkDelete${tabName.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join('')}`);
        
        if (!bulkDeleteBtn) return;
        
        const hasChecked = Array.from(checkboxes).some(checkbox => checkbox.checked);
        bulkDeleteBtn.classList.toggle('hidden', !hasChecked);
    }

    // Function to handle bulk deletion
    function bulkDeleteGroups(tabName) {
        const checkboxes = document.querySelectorAll(`#${tabName} .group-checkbox:checked`);
        const groupIds = Array.from(checkboxes).map(checkbox => checkbox.value);
        
        if (groupIds.length === 0) {
            alert('Please select at least one group to delete.');
            return;
        }

        if (!confirm(`Are you sure you want to delete ${groupIds.length} selected group(s)?`)) {
            return;
        }

        // Create a form and submit it
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url "groups:group_bulk_delete" %}';
        
        // Add CSRF token
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
        form.appendChild(csrfInput);

        // Add group IDs
        groupIds.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'group_ids[]';
            input.value = id;
            form.appendChild(input);
        });

        // Add tab information
        const tabInput = document.createElement('input');
        tabInput.type = 'hidden';
        tabInput.name = 'tab';
        tabInput.value = tabName;
        form.appendChild(tabInput);

        document.body.appendChild(form);
        form.submit();
    }

    // Initialize select all functionality for each tab
    document.addEventListener('DOMContentLoaded', function() {
        setupSelectAll('selectAllUserGroups', 'user-groups');
        setupSelectAll('selectAllCourseGroups', 'course-groups');
        setupSelectAll('selectAllAccessControl', 'access-control');
    });
</script>
{% endblock %}
