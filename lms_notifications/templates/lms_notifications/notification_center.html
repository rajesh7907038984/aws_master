{% extends "base.html" %}
{% load static %}

{% block title %}Notification Center - {{ block.super }}{% endblock %}

{% block global_breadcrumbs %}
<!-- Breadcrumb -->
{% include 'components/breadcrumb.html' with breadcrumbs=breadcrumbs %}
{% endblock %}

{% block extra_css %}
<style>
.section-box {
    border-radius: 8px;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    background-color: white;
    transition: all 0.2s ease-in-out;
    padding: 1.25rem;
    margin-bottom: 1rem;
}

.section-box:hover {
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-semibold text-gray-900">Notification Center</h1>
            <p class="text-gray-600 mt-1">Manage your notifications and preferences</p>
        </div>
        <div class="flex gap-3">
            <!-- User notification settings for non-learner users -->
            {% if request.user.role != 'learner' %}
            <a href="{% url 'lms_notifications:settings' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                <i class="fas fa-cog mr-2"></i> Settings
            </a>
            {% endif %}
            
            {% if request.user.role == 'globaladmin' %}
            <a href="{% url 'lms_notifications:admin_settings' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                <i class="fas fa-cogs mr-2"></i> Admin Settings
            </a>
            {% endif %}
            
            {% if request.user.role in 'admin,superadmin,instructor' %}
            <a href="{% url 'lms_notifications:bulk_notification_list' %}" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white" style="background-color: #191f56;" onmouseover="this.style.backgroundColor='#141a4a'" onmouseout="this.style.backgroundColor='#191f56'">
                <i class="fas fa-bullhorn mr-2"></i> Send Bulk Notification
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-6">
        <!-- Unread Notifications -->
        <div class="section-box text-white border-0 shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-200" style="background-color: #191f56;">
            <div class="flex justify-between items-center">
                <div class="flex-1">
                    <h4 class="text-2xl md:text-3xl font-bold mb-1">{{ unread_count|default:"0" }}</h4>
                    <p class="text-gray-200 text-sm font-medium">Unread</p>
                </div>
                <div class="flex-shrink-0 ml-4">
                    <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                        <i class="fas fa-bell text-xl text-white"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Total Notifications -->
        <div class="section-box text-white border-0 shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-200" style="background-color: #191f56;">
            <div class="flex justify-between items-center">
                <div class="flex-1">
                    <h4 class="text-2xl md:text-3xl font-bold mb-1">{{ total_count|default:"0" }}</h4>
                    <p class="text-gray-200 text-sm font-medium">Total</p>
                </div>
                <div class="flex-shrink-0 ml-4">
                    <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                        <i class="fas fa-envelope text-xl text-white"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Read Notifications -->
        <div class="section-box text-white border-0 shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-200" style="background-color: #191f56;">
            <div class="flex justify-between items-center">
                <div class="flex-1">
                    <h4 class="text-2xl md:text-3xl font-bold mb-1">{{ read_count|default:"0" }}</h4>
                    <p class="text-gray-200 text-sm font-medium">Read</p>
                </div>
                <div class="flex-shrink-0 ml-4">
                    <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                        <i class="fas fa-check text-xl text-white"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Urgent Notifications -->
        <div class="section-box text-white border-0 shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-200" style="background-color: #191f56;">
            <div class="flex justify-between items-center">
                <div class="flex-1">
                    <h4 class="text-2xl md:text-3xl font-bold mb-1">{{ urgent_count|default:"0" }}</h4>
                    <p class="text-gray-200 text-sm font-medium">Urgent</p>
                </div>
                <div class="flex-shrink-0 ml-4">
                    <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                        <i class="fas fa-exclamation-triangle text-xl text-white"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="section-box">
        <form method="GET" class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
            <div class="md:col-span-3">
                <label for="type" class="block text-sm font-medium text-gray-700 mb-2">Filter</label>
                <select name="type" id="type" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="all" {% if filter_type == 'all' %}selected{% endif %}>All Notifications</option>
                    <option value="unread" {% if filter_type == 'unread' %}selected{% endif %}>Unread Only</option>
                    <option value="read" {% if filter_type == 'read' %}selected{% endif %}>Read Only</option>
                </select>
            </div>
            <div class="md:col-span-2">
                <label for="priority" class="block text-sm font-medium text-gray-700 mb-2">Priority</label>
                <select name="priority" id="priority" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Priorities</option>
                    {% for value, label in priority_choices %}
                    <option value="{{ value }}" {% if priority == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="md:col-span-4">
                <label for="search" class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                <input type="text" name="search" id="search" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Search notifications..." value="{{ search }}">
            </div>
            <div class="md:col-span-3">
                <div class="flex gap-2">
                    <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white" style="background-color: #1c2260;" onmouseover="this.style.backgroundColor='#181f56'" onmouseout="this.style.backgroundColor='#1c2260'">
                        <i class="fas fa-search mr-2"></i> Filter
                    </button>
                    <a href="{% url 'lms_notifications:notification_center' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                        <i class="fas fa-times mr-2"></i> Clear
                    </a>
                </div>
            </div>
        </form>
    </div>

    <!-- Bulk Actions -->
    {% if notifications.object_list %}
    <div class="section-box">
        <div class="flex gap-3">
            <form method="POST" action="{% url 'lms_notifications:mark_all_read' %}" class="inline">
                {% csrf_token %}
                <button type="submit" class="inline-flex items-center px-3 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700">
                    <i class="fas fa-check-double mr-2"></i> Mark All as Read
                </button>
            </form>
            <form method="POST" action="{% url 'lms_notifications:delete_all_read' %}" class="inline">
                {% csrf_token %}
                <button type="submit" class="inline-flex items-center px-3 py-2 border border-red-300 rounded-md shadow-sm text-sm font-medium text-red-700 bg-white hover:bg-red-50" onclick="return confirm('Are you sure you want to delete all read notifications?')">
                    <i class="fas fa-trash mr-2"></i> Delete All Read
                </button>
            </form>
        </div>
    </div>
    {% endif %}

    <!-- Notifications List -->
    <div class="space-y-4">
        {% for notification in notifications %}
        <div class="section-box {% if not notification.is_read %}border-l-4 border-blue-500 bg-blue-50{% endif %} hover:shadow-lg transition-shadow duration-200" data-notification-id="{{ notification.id }}">
            <div class="flex items-start space-x-4">
                <div class="flex-shrink-0">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center text-white {% if notification.priority == 'urgent' %}bg-red-500{% elif notification.priority == 'high' %}bg-orange-500{% elif notification.priority == 'low' %}bg-gray-500{% else %}bg-blue-500{% endif %}">
                        {% if notification.priority == 'urgent' %}
                            <i class="fas fa-exclamation-triangle"></i>
                        {% elif notification.priority == 'high' %}
                            <i class="fas fa-exclamation"></i>
                        {% elif notification.priority == 'low' %}
                            <i class="fas fa-info"></i>
                        {% else %}
                            <i class="fas fa-bell"></i>
                        {% endif %}
                    </div>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h5 class="text-lg font-medium text-gray-900 {% if not notification.is_read %}font-bold{% endif %}">
                                {{ notification.title }}
                            </h5>
                            <p class="text-gray-600 text-sm mt-1">
                                {{ notification.short_message }}
                            </p>
                            <div class="flex items-center space-x-4 mt-2">
                                <span class="text-xs text-gray-500">
                                    <i class="fas fa-clock mr-1"></i> {{ notification.created_at|timesince }} ago
                                </span>
                                {% if notification.sender %}
                                <span class="text-xs text-gray-500">
                                    <i class="fas fa-user mr-1"></i> {{ notification.sender.get_full_name|default:notification.sender.username }}
                                </span>
                                {% endif %}
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium {% if notification.priority == 'urgent' %}bg-red-100 text-red-800{% elif notification.priority == 'high' %}bg-orange-100 text-orange-800{% elif notification.priority == 'low' %}bg-gray-100 text-gray-800{% else %}bg-blue-100 text-blue-800{% endif %}">
                                    {{ notification.get_priority_display }}
                                </span>
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                    {{ notification.notification_type.display_name }}
                                </span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2 ml-4">
                            {% if not notification.is_read %}
                            <button type="button" class="inline-flex items-center px-2 py-1 border border-transparent rounded text-xs font-medium text-green-700 bg-green-100 hover:bg-green-200 mark-read" 
                                    data-notification-id="{{ notification.id }}" title="Mark as read">
                                <i class="fas fa-check"></i>
                            </button>
                            {% endif %}
                            {% if notification.action_url %}
                            <a href="{{ notification.action_url }}" class="inline-flex items-center px-2 py-1 border border-transparent rounded text-xs font-medium text-blue-700 bg-blue-100 hover:bg-blue-200" title="{{ notification.action_text|default:'View' }}">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                            {% endif %}
                            <button type="button" class="inline-flex items-center px-2 py-1 border border-transparent rounded text-xs font-medium text-red-700 bg-red-100 hover:bg-red-200 delete-notification" 
                                    data-notification-id="{{ notification.id }}" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="section-box text-center py-12">
            <i class="fas fa-bell text-6xl text-gray-400 mb-4"></i>
            <h4 class="text-xl font-medium text-gray-900 mb-2">No notifications found</h4>
            <p class="text-gray-600">You don't have any notifications matching your criteria.</p>
            {% if filter_type != 'all' or search or priority %}
            <a href="{% url 'lms_notifications:notification_center' %}" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white mt-4" style="background-color: #1c2260;" onmouseover="this.style.backgroundColor='#181f56'" onmouseout="this.style.backgroundColor='#1c2260'">
                View All Notifications
            </a>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if notifications.has_other_pages %}
    <div class="flex justify-center mt-6">
        <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
            {% if notifications.has_previous %}
            <a href="?page={{ notifications.previous_page_number }}{% if filter_type %}&type={{ filter_type }}{% endif %}{% if priority %}&priority={{ priority }}{% endif %}{% if search %}&search={{ search }}{% endif %}" 
               class="relative inline-flex items-center px-3 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                <i class="fas fa-chevron-left mr-1"></i> Previous
            </a>
            {% endif %}
            
            {% for num in notifications.paginator.page_range %}
            {% if num == notifications.number %}
            <span class="relative inline-flex items-center px-4 py-2 border border-blue-500 bg-blue-50 text-sm font-medium text-blue-600">
                {{ num }}
            </span>
            {% elif num > notifications.number|add:'-3' and num < notifications.number|add:'3' %}
            <a href="?page={{ num }}{% if filter_type %}&type={{ filter_type }}{% endif %}{% if priority %}&priority={{ priority }}{% endif %}{% if search %}&search={{ search }}{% endif %}" 
               class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                {{ num }}
            </a>
            {% endif %}
            {% endfor %}
            
            {% if notifications.has_next %}
            <a href="?page={{ notifications.next_page_number }}{% if filter_type %}&type={{ filter_type }}{% endif %}{% if priority %}&priority={{ priority }}{% endif %}{% if search %}&search={{ search }}{% endif %}" 
               class="relative inline-flex items-center px-3 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                Next <i class="fas fa-chevron-right ml-1"></i>
            </a>
            {% endif %}
        </nav>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Mark notification as read
    document.querySelectorAll('.mark-read').forEach(button => {
        button.addEventListener('click', function() {
            const notificationId = this.dataset.notificationId;
            markAsRead(notificationId, this);
        });
    });

    // Delete notification
    document.querySelectorAll('.delete-notification').forEach(button => {
        button.addEventListener('click', function() {
            if (confirm('Are you sure you want to delete this notification?')) {
                const notificationId = this.dataset.notificationId;
                deleteNotification(notificationId);
            }
        });
    });

    function markAsRead(notificationId, button) {
        fetch(`/notifications/${notificationId}/read/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
        .then(data => {
            if (data.success) {
                const card = button.closest('.notification-card');
                card.classList.remove('unread');
                button.remove();
                
                // Update unread count if present
                const unreadElement = document.querySelector('.bg-primary .card-title');
                if (unreadElement) {
                    let count = parseInt(unreadElement.textContent);
                    unreadElement.textContent = Math.max(0, count - 1);
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to mark notification as read. Please try again.');
        });
    }

    function deleteNotification(notificationId) {
        fetch(`/notifications/${notificationId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
        .then(data => {
            if (data.success) {
                const card = document.querySelector(`[data-notification-id="${notificationId}"]`);
                card.style.transition = 'all 0.3s ease';
                card.style.opacity = '0';
                card.style.transform = 'translateX(100%)';
                
                setTimeout(() => {
                    card.remove();
                    
                    // Check if no notifications left
                    if (document.querySelectorAll('.notification-card').length === 0) {
                        location.reload();
                    }
                }, 300);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete notification. Please try again.');
        });
    }

    // Disabled auto-refresh to prevent unwanted notifications
    // Auto-refresh was causing notification spam and performance issues
    // Users can manually refresh the page if needed
});
</script>
{% endblock %} 