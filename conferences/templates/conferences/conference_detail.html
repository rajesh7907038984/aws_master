{% extends 'base.html' %}
{% load static %}
{% load conference_tags %}

{% block title %}{{ conference.title }}{% endblock %}

{% block extra_css %}
<style>
    body {
        background-color: #f5f7fa !important;
    }
    
    .conference-card {
        background-color: white;
        border-radius: 12px;
        box-shadow: 0px 0px 20px -8px rgba(0,0,0,0.15);
        padding: 2rem;
        max-width: 800px;
        margin: 0 auto;
    }
    
    .info-row {
        display: flex;
        justify-content: space-between;
        padding: 1rem 0;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .info-row:last-child {
        border-bottom: none;
    }
    
    .info-label {
        color: #6b7280;
        font-weight: 500;
    }
    
    .info-value {
        color: #1f2937;
        font-weight: 600;
    }
    
    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .status-upcoming {
        background-color: #fef3c7;
        color: #d97706;
    }
    
    .status-live {
        background-color: #dcfce7;
        color: #16a34a;
    }
    
    .status-ended {
        background-color: #f3f4f6;
        color: #6b7280;
    }
</style>
{% endblock %}

{% block content %}
<!-- Breadcrumb Navigation -->
<div class="container mx-auto px-4 py-4">
    {% with breadcrumbs=breadcrumbs %}
        {% include 'components/breadcrumb.html' %}
    {% endwith %}
</div>

<div class="container mx-auto px-4">
    <div class="conference-card">
        <h1 class="h2 mb-4">{{ conference.title }}</h1>
        
        {% if conference.description %}
        <div class="mb-4">
            <h5>Description</h5>
            <div class="text-muted">{{ conference.description|decode_html }}</div>
        </div>
        {% endif %}
        
        <div class="conference-details">
            {% if conference.course %}
            <div class="info-row">
                <span class="info-label">Course:</span>
                <span class="info-value">{{ conference.course.title }}</span>
            </div>
            {% endif %}
            
            <div class="info-row">
                <span class="info-label">Created by:</span>
                <span class="info-value">{{ conference.created_by.get_full_name|default:conference.created_by.username }}</span>
            </div>
            
            {% if conference.scheduled_time %}
            <div class="info-row">
                <span class="info-label">Scheduled Time:</span>
                <span class="info-value">{{ conference.scheduled_time|date:"M d, Y - g:i A" }}</span>
            </div>
            {% endif %}
            
            <div class="info-row">
                <span class="info-label">Status:</span>
                <span class="info-value">
                    {% if conference.is_live %}
                        <span class="status-badge status-live">Live</span>
                    {% elif conference.scheduled_time and conference.scheduled_time > now %}
                        <span class="status-badge status-upcoming">Upcoming</span>
                    {% else %}
                        <span class="status-badge status-ended">Ended</span>
                    {% endif %}
                </span>
            </div>
            
            {% if conference.duration %}
            <div class="info-row">
                <span class="info-label">Duration:</span>
                <span class="info-value">{{ conference.duration }} minutes</span>
            </div>
            {% endif %}
            
            {% if conference.platform %}
            <div class="info-row">
                <span class="info-label">Platform:</span>
                <span class="info-value">{{ conference.platform|title }}</span>
            </div>
            {% endif %}
            
            <div class="info-row">
                <span class="info-label">Created:</span>
                <span class="info-value">{{ conference.created_at|date:"M d, Y - g:i A" }}</span>
            </div>
        </div>
        
        <!-- Time Slot Selection Section -->
        {% if conference.use_time_slots %}
        <div class="mt-4 pt-4" style="border-top: 1px solid #e5e7eb;">
            <h3 class="text-lg font-semibold text-gray-900 mb-3">
                <i class="fas fa-clock mr-2"></i>Select Your Time Slot
            </h3>
            
            {% with user_selection=conference.time_slot_selections.all|filter_by_user:request.user %}
                {% if user_selection %}
                    <div class="alert alert-success" style="position: relative;">
                        <div style="margin-bottom: 10px;">
                            <i class="fas fa-check-circle mr-2"></i>
                            <strong>You have selected:</strong> 
                            {{ user_selection.time_slot.date|date:"F d, Y" }} 
                            {{ user_selection.time_slot.start_time|time:"H:i" }} - {{ user_selection.time_slot.end_time|time:"H:i" }}
                            ({{ user_selection.time_slot.timezone }})
                            {% if user_selection.calendar_added %}
                                <span class="badge badge-success ml-2">
                                    <i class="fas fa-calendar-check"></i> Added to Outlook
                                </span>
                            {% endif %}
                            {% if user_selection.time_slot.meeting_link %}
                                <div class="mt-2">
                                    <button type="button" onclick="autoRegisterAndJoin()" class="btn btn-sm btn-primary">
                                        <i class="fas fa-video mr-1"></i> Join Selected Slot
                                    </button>
                                </div>
                            {% endif %}
                        </div>
                        
                        <form method="POST" action="{% url 'conferences:unselect_time_slot' conference.id %}" style="display: block; margin-top: 10px;" onsubmit="return confirm('Are you sure you want to cancel your time slot selection?');">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-danger">
                                <i class="fas fa-times mr-1"></i>
                                Cancel Selection
                            </button>
                        </form>
                    </div>
                {% endif %}
            {% endwith %}
            
            <div class="mt-3">
                {% for time_slot in conference.time_slots.all %}
                    {% if time_slot.is_available %}
                        <div class="info-row" style="align-items: center;">
                            <div>
                                <div class="info-value">
                                    {{ time_slot.date|date:"F d, Y" }}
                                </div>
                                <div class="text-sm text-gray-600">
                                    {{ time_slot.start_time|time:"H:i" }} - {{ time_slot.end_time|time:"H:i" }}
                                    ({{ time_slot.timezone }})
                                </div>
                                <div class="text-xs text-gray-500 mt-1">
                                    {% if time_slot.max_participants > 0 %}
                                        {{ time_slot.current_participants }}/{{ time_slot.max_participants }} participants
                                        {% if time_slot.get_available_spots %}
                                            ({{ time_slot.get_available_spots }} spots remaining)
                                        {% endif %}
                                    {% else %}
                                        {{ time_slot.current_participants }} participants (Unlimited)
                                    {% endif %}
                                </div>
                            </div>
                            <div>
                                {% if time_slot.is_full %}
                                    <span class="badge badge-secondary">Full</span>
                                {% else %}
                                    <a href="{% url 'conferences:select_time_slot' conference.id time_slot.id %}" 
                                       class="btn btn-sm btn-primary">
                                        <i class="fas fa-check mr-1"></i>
                                        {% with user_selection=conference.time_slot_selections.all|filter_by_user:request.user %}
                                            {% if user_selection and user_selection.time_slot.id == time_slot.id %}
                                                Selected
                                            {% else %}
                                                Select
                                            {% endif %}
                                        {% endwith %}
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
            
            {% if conference.meeting_platform == 'teams' %}
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle mr-2"></i>
                    <small>After selecting a time slot, it will be automatically added to your Outlook calendar with the meeting link.</small>
                </div>
            {% endif %}
        </div>
        {% else %}
        <div class="mt-4">
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>Access Information:</strong> Your current role does not have specific permissions for this conference. Contact your administrator if you need access.
            </div>
        </div>
        {% endif %}
        
        <div class="mt-4">
            <a href="{% url 'conferences:conference_list' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Conferences
            </a>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
function autoRegisterAndJoin() {
    // Get CSRF token
    let csrfToken = null;
    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    if (csrfMeta) {
        csrfToken = csrfMeta.getAttribute('content');
    }
    if (!csrfToken) {
        const csrfCookie = document.cookie.split(';').find(c => c.trim().startsWith('csrftoken='));
        if (csrfCookie) {
            csrfToken = csrfCookie.split('=')[1];
        }
    }
    
    if (!csrfToken) {
        alert('Unable to process join request. Please refresh the page and try again.');
        return;
    }
    
    // Make AJAX request to auto-register and get join link
    fetch("{% url 'conferences:auto_register_and_join' conference_id=conference.id %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Open the meeting in a new tab
            window.open(data.join_url, '_blank');
        } else {
            alert(data.error || 'Failed to join conference. Please try again.');
        }
    })
    .catch(error => {
        console.error('Error joining conference:', error);
        alert('An error occurred while trying to join the conference. Please try again.');
    });
}
</script>
{% endblock %}
{% endblock %} 