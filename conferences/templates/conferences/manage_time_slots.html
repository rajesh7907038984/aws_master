{% extends 'base.html' %}
{% load static %}

{% block title %}Manage Time Slots - {{ conference.title }}{% endblock %}

{% block extra_css %}
<style>
    .time-slot-card {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .slot-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    .slot-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }
    .info-item {
        padding: 0.5rem;
        background: #f9fafb;
        border-radius: 4px;
    }
    .info-label {
        font-size: 0.875rem;
        color: #6b7280;
        margin-bottom: 0.25rem;
    }
    .info-value {
        font-weight: 600;
        color: #1f2937;
    }
    .participants-list {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #e5e7eb;
    }
    .participant-item {
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        background: #f3f4f6;
        border-radius: 4px;
    }
    .btn-create-slot {
        background: #3b82f6;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        text-decoration: none;
        display: inline-block;
        margin-bottom: 2rem;
    }
    .btn-create-slot:hover {
        background: #2563eb;
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 2rem;
        border-radius: 8px;
        max-width: 600px;
    }
    .form-group {
        margin-bottom: 1rem;
    }
    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }
    .form-control {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-4">
    {% include 'partials/breadcrumb.html' %}
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-clock mr-2"></i> Manage Time Slots</h2>
        <button class="btn-create-slot" onclick="openCreateModal()">
            <i class="fas fa-plus mr-2"></i> Create Time Slot
        </button>
    </div>

    <div class="alert alert-info">
        <strong>Info:</strong> Time slots allow learners to choose a convenient meeting time. 
        {% if conference.meeting_platform == 'teams' %}
        When learners select a slot, it will be automatically added to their Outlook calendar.
        {% endif %}
    </div>

    {% if slots_with_selections %}
        {% for item in slots_with_selections %}
            <div class="time-slot-card">
                <div class="slot-header">
                    <h4>
                        <i class="fas fa-calendar-day mr-2"></i>
                        {{ item.slot.date }} {{ item.slot.start_time|time:"H:i" }} - {{ item.slot.end_time|time:"H:i" }}
                    </h4>
                    <div>
                        {% if item.slot.is_available %}
                            <span class="badge badge-success">Available</span>
                        {% else %}
                            <span class="badge badge-secondary">Unavailable</span>
                        {% endif %}
                    </div>
                </div>

                <div class="slot-info">
                    <div class="info-item">
                        <div class="info-label">Timezone</div>
                        <div class="info-value">{{ item.slot.timezone }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Participants</div>
                        <div class="info-value">
                            {{ item.slot.current_participants }}
                            {% if item.slot.max_participants > 0 %} / {{ item.slot.max_participants }}{% else %} (Unlimited){% endif %}
                        </div>
                    </div>
                    {% if item.available_spots %}
                        <div class="info-item">
                            <div class="info-label">Available Spots</div>
                            <div class="info-value">{{ item.available_spots }}</div>
                        </div>
                    {% endif %}
                </div>

                {% if item.slot.meeting_link %}
                    <div class="info-item">
                        <div class="info-label">Meeting Link</div>
                        <div class="info-value">
                            <a href="{{ item.slot.meeting_link }}" target="_blank">
                                <i class="fas fa-external-link-alt mr-1"></i> Join Meeting
                            </a>
                        </div>
                    </div>
                {% endif %}

                {% if item.selections %}
                    <div class="participants-list">
                        <h5>Selected Participants ({{ item.selections|length }})</h5>
                        {% for selection in item.selections %}
                            <div class="participant-item">
                                <i class="fas fa-user mr-2"></i>
                                {{ selection.user.get_full_name }}
                                {% if selection.calendar_added %}
                                    <span class="badge badge-success ml-2">
                                        <i class="fas fa-calendar-check"></i> Calendar Added
                                    </span>
                                {% endif %}
                                <small class="text-muted ml-2">Selected: {{ selection.selected_at|date:"M d, Y H:i" }}</small>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}

                <div class="mt-3">
                    <form method="post" style="display: inline;">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="toggle">
                        <input type="hidden" name="slot_id" value="{{ item.slot.id }}">
                        <button type="submit" class="btn btn-sm btn-secondary">
                            {% if item.slot.is_available %}
                                <i class="fas fa-eye-slash"></i> Mark Unavailable
                            {% else %}
                                <i class="fas fa-eye"></i> Mark Available
                            {% endif %}
                        </button>
                    </form>
                    
                    {% if not item.selections %}
                        <form method="post" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this time slot?');">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="delete">
                            <input type="hidden" name="slot_id" value="{{ item.slot.id }}">
                            <button type="submit" class="btn btn-sm btn-danger">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </form>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    {% else %}
        <div class="alert alert-warning">
            <i class="fas fa-info-circle mr-2"></i>
            No time slots created yet. Click "Create Time Slot" to add one.
        </div>
    {% endif %}

    <div class="mt-4">
        <a href="{% url 'conferences:conference_detail' conference.id %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left mr-2"></i> Back to Conference
        </a>
    </div>
</div>

<!-- Create Time Slot Modal -->
<div id="createSlotModal" class="modal">
    <div class="modal-content">
        <h3>Create Time Slot</h3>
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="create">
            
            <div class="form-group">
                <label class="form-label">Date</label>
                <input type="date" name="date" class="form-control" required>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">Start Time</label>
                        <input type="time" name="start_time" class="form-control" required>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">End Time</label>
                        <input type="time" name="end_time" class="form-control" required>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Timezone</label>
                <input type="text" name="timezone" class="form-control" value="{{ conference.timezone }}" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Max Participants (0 for unlimited)</label>
                <input type="number" name="max_participants" class="form-control" value="0" min="0">
            </div>
            
            {% if conference.meeting_platform == 'teams' %}
                <div class="form-group">
                    <label>
                        <input type="checkbox" name="create_teams_meeting" value="true" checked>
                        Automatically create Teams meeting for this slot
                    </label>
                </div>
            {% else %}
                <div class="form-group">
                    <label class="form-label">Meeting Link (Optional)</label>
                    <input type="url" name="meeting_link" class="form-control">
                </div>
            {% endif %}
            
            <div class="d-flex justify-content-between mt-4">
                <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Time Slot</button>
            </div>
        </form>
    </div>
</div>

<script>
function openCreateModal() {
    document.getElementById('createSlotModal').style.display = 'block';
}

function closeCreateModal() {
    document.getElementById('createSlotModal').style.display = 'none';
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('createSlotModal');
    if (event.target == modal) {
        closeCreateModal();
    }
}
</script>
{% endblock %}

