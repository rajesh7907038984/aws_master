{% extends 'base.html' %}
{% load static %}

{% block title %}Manage Time Slots - {{ conference.title }}{% endblock %}

{% block extra_css %}
<style>
    .time-slot-card {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .slot-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    .slot-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }
    .info-item {
        padding: 0.5rem;
        background: #f9fafb;
        border-radius: 4px;
    }
    .info-label {
        font-size: 0.875rem;
        color: #6b7280;
        margin-bottom: 0.25rem;
    }
    .info-value {
        font-weight: 600;
        color: #1f2937;
    }
    .participants-list {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #e5e7eb;
    }
    .participant-item {
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        background: #f3f4f6;
        border-radius: 4px;
    }
    .btn-create-slot {
        background: #3b82f6;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        text-decoration: none;
        display: inline-block;
        margin-bottom: 2rem;
    }
    .btn-create-slot:hover {
        background: #2563eb;
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
        background-color: white;
        margin: 2% auto;
        padding: 2rem;
        border-radius: 8px;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
    }
    .form-group {
        margin-bottom: 1.5rem;
    }
    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #1f2937;
    }
    .form-control {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        font-size: 0.95rem;
    }
    .form-text {
        display: block;
        margin-top: 0.25rem;
        font-size: 0.875rem;
        color: #6b7280;
    }
    .modal-content h3 {
        margin-bottom: 1.5rem;
        color: #1f2937;
    }
    .form-group label {
        cursor: pointer;
    }
    .form-group input[type="checkbox"] {
        margin-right: 0.5rem;
        cursor: pointer;
    }
    .modal-form-container {
        max-height: calc(90vh - 150px);
        overflow-y: auto;
        padding-right: 0.5rem;
    }
    .modal-footer {
        position: sticky;
        bottom: 0;
        background: white;
        padding-top: 1rem;
        margin-top: 1rem;
        border-top: 1px solid #e5e7eb;
    }
    /* Smooth scrollbar styling */
    .modal-form-container::-webkit-scrollbar {
        width: 8px;
    }
    .modal-form-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }
    .modal-form-container::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }
    .modal-form-container::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-4">
    {% include 'components/breadcrumb.html' %}
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-clock mr-2"></i> Manage Time Slots</h2>
        <button class="btn-create-slot" onclick="openCreateModal()">
            <i class="fas fa-plus mr-2"></i> Create Time Slot
        </button>
    </div>

    <div class="alert alert-info">
        <strong>Info:</strong> Time slots allow learners to choose a convenient meeting time. 
        {% if conference.meeting_platform == 'teams' %}
        When learners select a slot, it will be automatically added to their Outlook calendar.
        {% endif %}
    </div>

    {% if slots_with_selections %}
        {% for item in slots_with_selections %}
            <div class="time-slot-card">
                <div class="slot-header">
                    <h4>
                        <i class="fas fa-calendar-day mr-2"></i>
                        {{ item.slot.date }} {{ item.slot.start_time|time:"H:i" }} - {{ item.slot.end_time|time:"H:i" }}
                    </h4>
                    <div>
                        {% if item.slot.is_available %}
                            <span class="badge badge-success">Available</span>
                        {% else %}
                            <span class="badge badge-secondary">Unavailable</span>
                        {% endif %}
                    </div>
                </div>

                <div class="slot-info">
                    <div class="info-item">
                        <div class="info-label">Timezone</div>
                        <div class="info-value">{{ item.slot.timezone }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Participants</div>
                        <div class="info-value">
                            {{ item.slot.current_participants }}
                        </div>
                    </div>
                    {% if item.available_spots %}
                        <div class="info-item">
                            <div class="info-label">Available Spots</div>
                            <div class="info-value">{{ item.available_spots }}</div>
                        </div>
                    {% endif %}
                </div>

                {% if item.slot.meeting_link %}
                    <div class="info-item">
                        <div class="info-label">Meeting Link</div>
                        <div class="info-value">
                            <a href="{{ item.slot.meeting_link }}" target="_blank">
                                <i class="fas fa-external-link-alt mr-1"></i> Join Meeting
                            </a>
                        </div>
                    </div>
                {% endif %}

                {% if item.selections %}
                    <div class="participants-list">
                        <h5>Selected Participants ({{ item.selections|length }})</h5>
                        {% for selection in item.selections %}
                            <div class="participant-item">
                                <i class="fas fa-user mr-2"></i>
                                {{ selection.user.get_full_name }}
                                {% if selection.calendar_added %}
                                    <span class="badge badge-success ml-2">
                                        <i class="fas fa-calendar-check"></i> Calendar Added
                                    </span>
                                {% endif %}
                                <small class="text-muted ml-2">Selected: {{ selection.selected_at|date:"M d, Y H:i" }}</small>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}

                <div class="mt-3">
                    <form method="post" style="display: inline;">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="toggle">
                        <input type="hidden" name="slot_id" value="{{ item.slot.id }}">
                        <button type="submit" class="btn btn-sm btn-secondary">
                            {% if item.slot.is_available %}
                                <i class="fas fa-eye-slash"></i> Mark Unavailable
                            {% else %}
                                <i class="fas fa-eye"></i> Mark Available
                            {% endif %}
                        </button>
                    </form>
                    
                    {% if not item.selections %}
                        <form method="post" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this time slot?');">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="delete">
                            <input type="hidden" name="slot_id" value="{{ item.slot.id }}">
                            <button type="submit" class="btn btn-sm btn-danger">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </form>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    {% else %}
        <div class="alert alert-warning">
            <i class="fas fa-info-circle mr-2"></i>
            No time slots created yet. Click "Create Time Slot" to add one.
        </div>
    {% endif %}

    <div class="mt-4">
        <a href="{% url 'conferences:conference_detail' conference.id %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left mr-2"></i> Back to Conference
        </a>
    </div>
</div>

<!-- Create Time Slot Modal -->
<div id="createSlotModal" class="modal">
    <div class="modal-content">
        <h3>Create Time Slot</h3>
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="create">
            
            <div class="modal-form-container">
            <div class="form-group">
                <label class="form-label">Date</label>
                <input type="date" name="date" class="form-control" value="{{ conference.date|date:'Y-m-d' }}" required>
                <small class="form-text text-muted">Conference date: {{ conference.date|date:"F d, Y" }}</small>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">Start Time</label>
                        <input type="time" name="start_time" class="form-control" value="{{ conference.start_time|time:'H:i' }}" required>
                        <small class="form-text text-muted">Conference start: {{ conference.start_time|time:"H:i" }}</small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">End Time</label>
                        <input type="time" name="end_time" class="form-control" value="{{ conference.end_time|time:'H:i' }}" required>
                        <small class="form-text text-muted">Conference end: {{ conference.end_time|time:"H:i" }}</small>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Timezone</label>
                <select name="timezone" class="form-control" required>
                    <optgroup label="Popular Timezones">
                        <option value="UTC" {% if request.user.timezone == 'UTC' or conference.timezone == 'UTC' %}selected{% endif %}>UTC (Coordinated Universal Time)</option>
                        <option value="Europe/London" {% if request.user.timezone == 'Europe/London' or conference.timezone == 'Europe/London' %}selected{% endif %}>Europe/London (GMT/BST)</option>
                        <option value="Europe/Paris" {% if request.user.timezone == 'Europe/Paris' or conference.timezone == 'Europe/Paris' %}selected{% endif %}>Europe/Paris (CET/CEST)</option>
                        <option value="America/New_York" {% if request.user.timezone == 'America/New_York' or conference.timezone == 'America/New_York' %}selected{% endif %}>America/New_York (EST/EDT)</option>
                        <option value="America/Chicago" {% if request.user.timezone == 'America/Chicago' or conference.timezone == 'America/Chicago' %}selected{% endif %}>America/Chicago (CST/CDT)</option>
                        <option value="America/Los_Angeles" {% if request.user.timezone == 'America/Los_Angeles' or conference.timezone == 'America/Los_Angeles' %}selected{% endif %}>America/Los_Angeles (PST/PDT)</option>
                        <option value="Asia/Dubai" {% if request.user.timezone == 'Asia/Dubai' or conference.timezone == 'Asia/Dubai' %}selected{% endif %}>Asia/Dubai (GST)</option>
                        <option value="Asia/Tokyo" {% if request.user.timezone == 'Asia/Tokyo' or conference.timezone == 'Asia/Tokyo' %}selected{% endif %}>Asia/Tokyo (JST)</option>
                        <option value="Australia/Sydney" {% if request.user.timezone == 'Australia/Sydney' or conference.timezone == 'Australia/Sydney' %}selected{% endif %}>Australia/Sydney (AEDT/AEST)</option>
                    </optgroup>
                    <optgroup label="Europe">
                        <option value="Europe/Dublin" {% if request.user.timezone == 'Europe/Dublin' or conference.timezone == 'Europe/Dublin' %}selected{% endif %}>Europe/Dublin</option>
                        <option value="Europe/Berlin" {% if request.user.timezone == 'Europe/Berlin' or conference.timezone == 'Europe/Berlin' %}selected{% endif %}>Europe/Berlin</option>
                        <option value="Europe/Madrid" {% if request.user.timezone == 'Europe/Madrid' or conference.timezone == 'Europe/Madrid' %}selected{% endif %}>Europe/Madrid</option>
                        <option value="Europe/Rome" {% if request.user.timezone == 'Europe/Rome' or conference.timezone == 'Europe/Rome' %}selected{% endif %}>Europe/Rome</option>
                        <option value="Europe/Amsterdam" {% if request.user.timezone == 'Europe/Amsterdam' or conference.timezone == 'Europe/Amsterdam' %}selected{% endif %}>Europe/Amsterdam</option>
                        <option value="Europe/Brussels" {% if request.user.timezone == 'Europe/Brussels' or conference.timezone == 'Europe/Brussels' %}selected{% endif %}>Europe/Brussels</option>
                        <option value="Europe/Vienna" {% if request.user.timezone == 'Europe/Vienna' or conference.timezone == 'Europe/Vienna' %}selected{% endif %}>Europe/Vienna</option>
                        <option value="Europe/Athens" {% if request.user.timezone == 'Europe/Athens' or conference.timezone == 'Europe/Athens' %}selected{% endif %}>Europe/Athens</option>
                        <option value="Europe/Istanbul" {% if request.user.timezone == 'Europe/Istanbul' or conference.timezone == 'Europe/Istanbul' %}selected{% endif %}>Europe/Istanbul</option>
                        <option value="Europe/Moscow" {% if request.user.timezone == 'Europe/Moscow' or conference.timezone == 'Europe/Moscow' %}selected{% endif %}>Europe/Moscow</option>
                    </optgroup>
                    <optgroup label="Americas">
                        <option value="America/Toronto" {% if request.user.timezone == 'America/Toronto' or conference.timezone == 'America/Toronto' %}selected{% endif %}>America/Toronto</option>
                        <option value="America/Montreal" {% if request.user.timezone == 'America/Montreal' or conference.timezone == 'America/Montreal' %}selected{% endif %}>America/Montreal</option>
                        <option value="America/Denver" {% if request.user.timezone == 'America/Denver' or conference.timezone == 'America/Denver' %}selected{% endif %}>America/Denver</option>
                        <option value="America/Phoenix" {% if request.user.timezone == 'America/Phoenix' or conference.timezone == 'America/Phoenix' %}selected{% endif %}>America/Phoenix</option>
                        <option value="America/Mexico_City" {% if request.user.timezone == 'America/Mexico_City' or conference.timezone == 'America/Mexico_City' %}selected{% endif %}>America/Mexico_City</option>
                        <option value="America/Sao_Paulo" {% if request.user.timezone == 'America/Sao_Paulo' or conference.timezone == 'America/Sao_Paulo' %}selected{% endif %}>America/Sao_Paulo</option>
                        <option value="America/Buenos_Aires" {% if request.user.timezone == 'America/Buenos_Aires' or conference.timezone == 'America/Buenos_Aires' %}selected{% endif %}>America/Buenos_Aires</option>
                    </optgroup>
                    <optgroup label="Asia & Middle East">
                        <option value="Asia/Riyadh" {% if request.user.timezone == 'Asia/Riyadh' or conference.timezone == 'Asia/Riyadh' %}selected{% endif %}>Asia/Riyadh</option>
                        <option value="Asia/Kuwait" {% if request.user.timezone == 'Asia/Kuwait' or conference.timezone == 'Asia/Kuwait' %}selected{% endif %}>Asia/Kuwait</option>
                        <option value="Asia/Qatar" {% if request.user.timezone == 'Asia/Qatar' or conference.timezone == 'Asia/Qatar' %}selected{% endif %}>Asia/Qatar</option>
                        <option value="Asia/Bahrain" {% if request.user.timezone == 'Asia/Bahrain' or conference.timezone == 'Asia/Bahrain' %}selected{% endif %}>Asia/Bahrain</option>
                        <option value="Asia/Jerusalem" {% if request.user.timezone == 'Asia/Jerusalem' or conference.timezone == 'Asia/Jerusalem' %}selected{% endif %}>Asia/Jerusalem</option>
                        <option value="Asia/Tehran" {% if request.user.timezone == 'Asia/Tehran' or conference.timezone == 'Asia/Tehran' %}selected{% endif %}>Asia/Tehran</option>
                        <option value="Asia/Karachi" {% if request.user.timezone == 'Asia/Karachi' or conference.timezone == 'Asia/Karachi' %}selected{% endif %}>Asia/Karachi</option>
                        <option value="Asia/Kolkata" {% if request.user.timezone == 'Asia/Kolkata' or conference.timezone == 'Asia/Kolkata' %}selected{% endif %}>Asia/Kolkata</option>
                        <option value="Asia/Singapore" {% if request.user.timezone == 'Asia/Singapore' or conference.timezone == 'Asia/Singapore' %}selected{% endif %}>Asia/Singapore</option>
                        <option value="Asia/Hong_Kong" {% if request.user.timezone == 'Asia/Hong_Kong' or conference.timezone == 'Asia/Hong_Kong' %}selected{% endif %}>Asia/Hong_Kong</option>
                        <option value="Asia/Shanghai" {% if request.user.timezone == 'Asia/Shanghai' or conference.timezone == 'Asia/Shanghai' %}selected{% endif %}>Asia/Shanghai</option>
                        <option value="Asia/Seoul" {% if request.user.timezone == 'Asia/Seoul' or conference.timezone == 'Asia/Seoul' %}selected{% endif %}>Asia/Seoul</option>
                    </optgroup>
                    <optgroup label="Africa">
                        <option value="Africa/Cairo" {% if request.user.timezone == 'Africa/Cairo' or conference.timezone == 'Africa/Cairo' %}selected{% endif %}>Africa/Cairo</option>
                        <option value="Africa/Johannesburg" {% if request.user.timezone == 'Africa/Johannesburg' or conference.timezone == 'Africa/Johannesburg' %}selected{% endif %}>Africa/Johannesburg</option>
                        <option value="Africa/Lagos" {% if request.user.timezone == 'Africa/Lagos' or conference.timezone == 'Africa/Lagos' %}selected{% endif %}>Africa/Lagos</option>
                        <option value="Africa/Nairobi" {% if request.user.timezone == 'Africa/Nairobi' or conference.timezone == 'Africa/Nairobi' %}selected{% endif %}>Africa/Nairobi</option>
                    </optgroup>
                    <optgroup label="Pacific & Oceania">
                        <option value="Australia/Melbourne" {% if request.user.timezone == 'Australia/Melbourne' or conference.timezone == 'Australia/Melbourne' %}selected{% endif %}>Australia/Melbourne</option>
                        <option value="Australia/Brisbane" {% if request.user.timezone == 'Australia/Brisbane' or conference.timezone == 'Australia/Brisbane' %}selected{% endif %}>Australia/Brisbane</option>
                        <option value="Australia/Perth" {% if request.user.timezone == 'Australia/Perth' or conference.timezone == 'Australia/Perth' %}selected{% endif %}>Australia/Perth</option>
                        <option value="Pacific/Auckland" {% if request.user.timezone == 'Pacific/Auckland' or conference.timezone == 'Pacific/Auckland' %}selected{% endif %}>Pacific/Auckland</option>
                        <option value="Pacific/Fiji" {% if request.user.timezone == 'Pacific/Fiji' or conference.timezone == 'Pacific/Fiji' %}selected{% endif %}>Pacific/Fiji</option>
                    </optgroup>
                </select>
                <small class="form-text text-muted">
                    {% if request.user.timezone %}
                        Your timezone: {{ request.user.timezone }}
                    {% else %}
                        Conference timezone: {{ conference.timezone }}
                    {% endif %}
                </small>
            </div>
            
            {% if conference.meeting_platform == 'teams' %}
                <div class="form-group">
                    <label>
                        <input type="checkbox" name="create_teams_meeting" value="true" checked>
                        Automatically create Teams meeting for this slot
                    </label>
                </div>
            {% else %}
                <div class="form-group">
                    <label class="form-label">Meeting Link (Optional)</label>
                    <input type="url" name="meeting_link" class="form-control">
                </div>
            {% endif %}
            </div>
            
            <div class="modal-footer">
                <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Time Slot</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
function openCreateModal() {
    document.getElementById('createSlotModal').style.display = 'block';
}

function closeCreateModal() {
    document.getElementById('createSlotModal').style.display = 'none';
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('createSlotModal');
    if (event.target == modal) {
        closeCreateModal();
    }
}
</script>
{% endblock %}

