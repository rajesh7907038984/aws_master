{% extends 'base.html' %}
{% load course_filters %}
{% load static %}
{% load json_filters %}
{% load assignment_filters %}
{% load assignment_tags %}
{% block title %}{{ assignment.title }} - Content{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'core/css/assignments/detail.css' %}">
<link rel="stylesheet" href="{% static 'core/css/assignments/feedback_timeline.css' %}">
<link rel="stylesheet" href="{% static 'core/css/assignments/rubric_timeline.css' %}">
<link rel="stylesheet" href="https://cdn.quilljs.com/1.3.7/quill.snow.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/quill-better-table@1.2.10/dist/quill-better-table.css">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="stylesheet" href="{% static 'tinymce_editor/css/tinymce-fixes.css' %}">
<link rel="stylesheet" href="{% static 'tinymce_editor/css/force-toolbar.css' %}">
<style>
    /* Quill editor container */
    .quill-editor-container {
        background: #ffffff;
        border-radius: 0.375rem;
        overflow: hidden;
        margin-bottom: 1rem;
    }

    /* Quill editor toolbar */
    .ql-toolbar.ql-snow {
        border: 1px solid #e5e7eb;
        background: #f9fafb;
        border-top-left-radius: 0.375rem;
        border-top-right-radius: 0.375rem;
    }

    /* Quill editor content area */
    .ql-container.ql-snow {
        border: 1px solid #e5e7eb;
        border-top: none;
        min-height: 300px;
        font-family: 'Inter', sans-serif;
        font-size: 14px;
        line-height: 1.5;
        border-bottom-left-radius: 0.375rem;
        border-bottom-right-radius: 0.375rem;
    }

    .ql-editor {
        min-height: 300px;
        background: #ffffff;
        color: #1f2937;
    }

    .ql-editor.ql-blank::before {
        color: #9ca3af;
        font-style: normal;
    }

    /* Button styles */
    .ql-formats button {
        color: #4b5563;
        min-height: 28px;
        min-width: 28px;
    }

    .ql-formats button:hover {
        color: #1f2937;
    }

    .ql-formats button.ql-active {
        color: #2563eb;
    }

    /* Dropdown styles */
    .ql-picker {
        color: #4b5563 !important;
    }

    .ql-picker-options {
        background-color: #ffffff !important;
        border-color: #e5e7eb !important;
    }

    /* Mobile-specific responsive styles */
    @media (max-width: 640px) {
        .quill-editor-container {
            margin-bottom: 0.5rem;
        }
        
        .ql-toolbar.ql-snow {
            padding: 8px 4px;
        }
        
        .ql-formats {
            margin-right: 8px !important;
        }
        
        .ql-formats button {
            min-height: 36px !important;
            min-width: 36px !important;
            margin: 1px;
        }
        
        .ql-container.ql-snow {
            min-height: 200px;
            font-size: 16px; /* Prevents zoom on iOS */
        }
        
        .ql-editor {
            min-height: 200px;
            padding: 12px 8px;
        }
    }
    
    /* Editor stats */
    .editor-stats {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: #4b5563;
        padding: 6px 10px;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-top: none;
        border-radius: 0 0 0.375rem 0.375rem;
    }

    /* Custom text editor container */
    .custom-text-editor-container {
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        overflow: hidden;
        position: relative;
        margin-bottom: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .editor-toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        padding: 8px;
        background-color: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
    }
    
    .toolbar-group {
        display: flex;
        align-items: center;
        gap: 2px;
    }
    
    .divider {
        width: 1px;
        height: 24px;
        background-color: #e2e8f0;
        margin: 0 4px;
    }
    
    .custom-text-editor {
        min-height: 300px;
        max-height: 600px;
        overflow-y: auto;
        padding: 12px;
        outline: none;
        background-color: #fff;
        font-size: 1rem;
        line-height: 1.6;
    }
    
    .custom-text-editor:focus {
        outline: none;
    }
    
    .tooltip {
        position: relative;
        display: inline-block;
    }
    
    .tooltip button {
        width: 32px;
        height: 32px;
        border: 1px solid transparent;
        background: transparent;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #4b5563;
        transition: all 0.2s;
    }

    /* Mobile toolbar improvements */
    @media (max-width: 640px) {
        .editor-toolbar {
            padding: 12px 8px;
            gap: 8px;
        }
        
        .toolbar-group {
            gap: 4px;
        }
        
        .tooltip button {
            width: 40px;
            height: 40px;
            border-radius: 6px;
        }
        
        .custom-text-editor {
            min-height: 200px;
            padding: 16px 12px;
            font-size: 16px; /* Prevents zoom on iOS */
        }
        
        .divider {
            height: 32px;
            margin: 0 6px;
        }
    }
    
    .tooltip button:hover {
        background-color: #f1f5f9;
        border-color: #e2e8f0;
    }
    
    .tooltip button.active {
        background-color: #e2e8f0;
        border-color: #cbd5e1;
    }
    
    .tooltip .tooltip-text {
        visibility: hidden;
        width: max-content;
        background-color: #1e293b;
        color: #fff;
        text-align: center;
        border-radius: 4px;
        padding: 4px 8px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        opacity: 0;
        transition: opacity 0.2s;
        font-size: 12px;
        pointer-events: none;
    }
    
    .tooltip:hover .tooltip-text {
        visibility: visible;
        opacity: 0.9;
    }
    
    .format-selector {
        padding: 4px 8px;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        background-color: #fff;
        color: #4b5563;
        font-size: 14px;
    }

    /* Simple Feedback Accordion Styles */
    .feedback-accordion-content {
        display: block;
    }

    .feedback-accordion-content.hidden {
        display: none;
    }

    .feedback-accordion-header {
        cursor: pointer;
    }

    .feedback-accordion-header:hover {
        background-color: #f8fafc;
    }

    /* Simple icon rotation */
    .feedback-accordion-icon {
        transition: transform 0.2s ease;
    }
    
    .feedback-accordion-icon.rotated {
        transform: rotate(180deg);
    }
    
    /* Ensure hover effects work properly */
    .feedback-accordion-header:hover {
        background-color: #f8fafc !important;
    }
    
    /* Ensure submission comments section is properly hidden/shown */
    div[id^="submission-comments-"] {
        transition: all 0.3s ease;
    }
    
    .hidden {
        display: none !important;
    }
    
    .format-selector:focus {
        outline: none;
        border-color: #93c5fd;
    }
    
    /* Custom text editor content styles */
    .custom-text-editor h1,
    .custom-text-editor h2,
    .custom-text-editor h3,
    .custom-text-editor h4 {
        color: #111827;
        margin-top: 1em;
        margin-bottom: 0.5em;
    }
    
    .custom-text-editor h1 {
        font-size: 1.75rem;
        font-weight: 700;
    }
    
    .custom-text-editor h2 {
        font-size: 1.5rem;
        font-weight: 600;
    }
    
    .custom-text-editor h3 {
        font-size: 1.25rem;
        font-weight: 600;
    }
    
    .custom-text-editor h4 {
        font-size: 1.125rem;
        font-weight: 600;
    }
    
    .custom-text-editor p {
        margin-bottom: 1em;
    }
    
    .custom-text-editor ul,
    .custom-text-editor ol {
        margin-left: 1.5em;
        margin-bottom: 1em;
    }
    
    .custom-text-editor table {
        border-collapse: collapse;
        width: 100%;
    }
    
    .custom-text-editor table td,
    .custom-text-editor table th {
        border: 1px solid #e5e7eb;
        padding: 8px;
    }
    
    .custom-text-editor table th {
        background-color: #f9fafb;
        font-weight: 600;
    }
    
    .custom-text-editor a {
        color: #3b82f6;
        text-decoration: underline;
    }
    
    .custom-text-editor blockquote {
        border-left: 3px solid #3b82f6;
        padding-left: 1rem;
        margin: 1em 0;
        color: #4b5563;
    }
    
    .custom-text-editor img {
        max-width: 100%;
        height: auto;
    }
    
    /* Prose content styling - matches TinyMCE editor styling */
    .prose {
        max-width: none !important;
    }
    
    .prose h1,
    .prose h2,
    .prose h3,
    .prose h4 {
        color: #111827;
        margin-top: 1em;
        margin-bottom: 0.5em;
    }
    
    .prose h1 {
        font-size: 1.75rem;
        font-weight: 700;
    }
    
    .prose h2 {
        font-size: 1.5rem;
        font-weight: 600;
    }
    
    .prose h3 {
        font-size: 1.25rem;
        font-weight: 600;
    }
    
    .prose h4 {
        font-size: 1.125rem;
        font-weight: 600;
    }
    
    .prose p {
        margin-bottom: 1em;
        line-height: 1.6;
    }
    
    .prose ul,
    .prose ol {
        margin-left: 1.5em;
        margin-bottom: 1em;
        line-height: 1.6;
    }
    
    .prose li {
        margin-bottom: 0.5em;
    }
    
    /* Enhanced table styling for prose content */
    .prose table {
        border-collapse: collapse;
        width: 100%;
        margin: 1em 0;
        border: 1px solid #e5e7eb;
        border-radius: 0.375rem;
        overflow: hidden;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
    }
    
    .prose table td,
    .prose table th {
        border: 1px solid #e5e7eb;
        padding: 12px 16px;
        text-align: left;
        vertical-align: top;
    }
    
    .prose table th {
        background-color: #f8fafc;
        font-weight: 600;
        color: #374151;
        border-bottom: 2px solid #e5e7eb;
    }
    
    .prose table tr:nth-child(even) {
        background-color: #f9fafb;
    }
    
    .prose table tr:hover {
        background-color: #f3f4f6;
    }
    
    .prose table tbody tr:first-child td {
        border-top: 2px solid #e5e7eb;
    }
    
    .prose a {
        color: #3b82f6;
        text-decoration: underline;
    }
    
    .prose a:hover {
        color: #1d4ed8;
    }
    
    .prose blockquote {
        border-left: 4px solid #3b82f6;
        padding-left: 1rem;
        margin: 1em 0;
        color: #4b5563;
        font-style: italic;
        background-color: #f8fafc;
        padding: 1rem;
        border-radius: 0 0.375rem 0.375rem 0;
    }
    
    .prose img {
        max-width: 100%;
        height: auto;
        border-radius: 0.375rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        margin: 1em 0;
    }
    
    .prose code {
        background-color: #f1f5f9;
        color: #e11d48;
        padding: 2px 6px;
        border-radius: 0.25rem;
        font-size: 0.875em;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    }
    
    .prose pre {
        background-color: #1e293b;
        color: #f1f5f9;
        padding: 1rem;
        border-radius: 0.375rem;
        overflow-x: auto;
        margin: 1em 0;
    }
    
    .prose pre code {
        background-color: transparent;
        color: inherit;
        padding: 0;
    }
    
    .prose strong {
        font-weight: 600;
        color: #111827;
    }
    
    .prose em {
        font-style: italic;
        color: #374151;
    }
    
    /* Hide file inputs in the editor */
    .custom-text-editor input[type="file"],
    .custom-text-editor .file-input-wrapper,
    .custom-text-editor-container input[type="file"],
    .custom-text-editor button[type="button"]:has(+ input[type="file"]),
    .custom-text-editor input[type="file"] + span {
        display: none !important;
    }
    
    /* Hidden inputs should be invisible */
    .custom-text-editor-container input[type="hidden"] {
        display: none !important;
    }
    
    /* Hide any Choose File elements that might appear */
    .custom-text-editor:empty::before {
        content: attr(data-placeholder);
        color: #9ca3af;
        font-style: italic;
        position: absolute;
        pointer-events: none;
    }
    
    /* Math formula styles */
    .custom-text-editor .math-formula {
        font-family: math, serif;
        background-color: #f8f9fa;
        padding: 4px 8px;
        border-radius: 4px;
        display: inline-block;
        margin: 0 2px;
        border: 1px solid #e2e8f0;
    }
    
    /* Code block styles */
    .custom-text-editor pre {
        background-color: #f1f5f9;
        padding: 12px;
        border-radius: 6px;
        font-family: monospace;
        font-size: 0.9em;
        overflow: auto;
        margin-bottom: 1em;
        border: 1px solid #e2e8f0;
    }
    
    .custom-text-editor code {
        font-family: monospace;
        background-color: #f1f5f9;
        padding: 2px 4px;
        border-radius: 3px;
        font-size: 0.9em;
    }
    
    /* Explicitly hide all file controls in editor */
    .custom-text-editor input,
    .custom-text-editor-container button:has(+ input[type="file"]) {
        display: none !important;
    }

    /* Timeline styles for interaction log */
    .timeline-flow {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .timeline-item {
        position: relative;
    }
    
    .timeline-item:not(:last-child)::after {
        content: '';
        position: absolute;
        top: 44px;
        left: 20px;
        bottom: 0;
        width: 2px;
        background-color: #e5e7eb;
        z-index: 1;
    }
    
    .timeline-icon {
        position: relative;
        z-index: 2;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* Custom accordion styles */
    .submission-accordion .submission-toggle-icon i {
        transition: transform 0.2s ease;
    }
    
    .submission-accordion.active .submission-toggle-icon i {
        transform: rotate(90deg);
    }
</style>
{% endblock %}

{% block extra_head %}
<!-- We'll load Quill in the body to ensure correct order -->
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 bg-white text-gray-800">
    <!-- Global Breadcrumb Component -->
    {% include 'components/breadcrumb.html' with breadcrumbs=breadcrumbs %}

    <!-- Main Content Layout -->
    <div class="w-full">
        <!-- Full Width Content -->
        <div class="space-y-6">
            <!-- Assignment Title -->
            <h1 class="text-2xl font-bold text-gray-900">{{ assignment.title }}</h1>

            <!-- Learner's Submission Attempt Section (moved to top) -->
            {% if user.role == 'learner' %}
                {% for submission_data in submissions %}
                    {% if submission_data.submission.user == user %}
                        <div class="bg-gray-100 rounded p-6 mb-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-semibold text-gray-800">
                                    Submission Attempt
                                    {% if submission_data.is_latest_submission %}
                                        <span class="text-sm bg-green-100 text-green-800 px-2 py-1 rounded ml-2">Latest</span>
                                    {% endif %}
                                </h2>
                                <div class="text-sm text-gray-600">
                                    <div class="font-medium">Submitted: {{ submission_data.submission.submitted_at|date:"M d, Y" }}</div>
                                    <div class="text-xs">{{ submission_data.submission.submitted_at|time:"H:i" }} ({{ submission_data.submission.submitted_at|timesince }} ago)</div>
                                    {% if submission_data.submission.last_modified and submission_data.submission.last_modified != submission_data.submission.submitted_at %}
                                        <div class="text-xs text-blue-600 mt-1">Last modified: {{ submission_data.submission.last_modified|date:"M d, Y H:i" }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Submission Details -->
                            <div class="bg-white rounded-lg border border-gray-200 mb-4">
                                <div class="grid grid-cols-5 bg-gray-50 text-gray-700 border-b text-sm font-medium">
                                    <div class="col-span-1 py-3 px-4 border-r">Course</div>
                                    <div class="col-span-1 py-3 px-4 border-r">Instructor</div>
                                    <div class="col-span-1 py-3 px-4 border-r">Grade</div>
                                    <div class="col-span-1 py-3 px-4 border-r">Status</div>
                                    <div class="col-span-1 py-3 px-4">Discussion</div>
                                </div>
                                
                                <div class="grid grid-cols-5 text-gray-700 hover:bg-gray-50 border-b text-sm">
                                    <!-- Course -->
                                    <div class="col-span-1 py-3 px-4 border-r">
                                        <div class="text-sm">
                                            {% if submission_data.course_id %}
                                                <a href="{% url 'courses:course_details' submission_data.course_id %}" 
                                                   class="text-blue-600 hover:text-blue-800">
                                                    {{ submission_data.course_name }}
                                                </a>
                                            {% else %}
                                                <span class="text-gray-500 italic">{{ submission_data.course_name }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <!-- Instructor -->
                                    <div class="col-span-1 py-3 px-4 border-r">
                                        <div class="text-sm text-gray-600">
                                            {{ submission_data.instructor_name }}
                                        </div>
                                    </div>
                                    
                                    <!-- Grade -->
                                    <div class="col-span-1 py-3 px-4 border-r">
                                        <div class="space-y-1">
                                            <!-- Total Points -->
                                            <div class="text-sm">
                                                {% if submission_data.submission.grade %}
                                                    <span class="text-green-600 font-medium">
                                                        {{ submission_data.submission.grade }}/{{ assignment.max_score }}
                                                    </span>
                                                    {% if submission_data.grade_percentage %}
                                                        <span class="text-blue-600 font-medium block">
                                                            ({{ submission_data.grade_percentage|floatformat:1 }}%)
                                                        </span>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="text-gray-400">Not graded yet</span>
                                                {% endif %}
                                            </div>
                                            
                                            <!-- Rubric Score (if available) -->
                                            {% if assignment.rubric and submission_data.rubric_evaluations %}
                                            <div class="text-sm">
                                                <span class="text-purple-600">
                                                    Rubric: {{ submission_data.total_rubric_score }}/{{ submission_data.max_rubric_score }}
                                                </span>
                                            </div>
                                            {% endif %}
                                            
                                            <!-- Graded Date -->
                                            {% if submission_data.submission.graded_at %}
                                            <div class="text-xs text-gray-500">
                                                Graded: {{ submission_data.submission.graded_at|date:"M d, Y H:i" }}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <!-- Status -->
                                    <div class="col-span-1 py-3 px-4 border-r">
                                        <div class="space-y-1">
                                            <div>
                                                <span class="px-2 py-1 rounded-full text-xs font-medium
                                                    {% if submission_data.submission.status == 'submitted' %}bg-blue-100 text-blue-800
                                                    {% elif submission_data.submission.status == 'not_graded' %}bg-orange-100 text-orange-800
                                                    {% elif submission_data.submission.status == 'graded' %}bg-green-100 text-green-800
                                                    {% elif submission_data.submission.status == 'returned' %}bg-yellow-100 text-yellow-800
                                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                                    {{ submission_data.submission.get_status_display }}
                                                </span>
                                            </div>
                                            
                                            <!-- Graded By -->
                                            {% if submission_data.submission.graded_by %}
                                            <div class="text-xs text-gray-500">
                                                Graded by {{ submission_data.submission.graded_by.get_full_name }}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <!-- Discussion -->
                                    <div class="col-span-1 py-3 px-4">
                                        <div class="flex flex-col space-y-1">
                                            <!-- Comments & Discussion Button for Learner -->
                                            <button onclick="toggleSubmissionComments({{ submission_data.submission.id }})" 
                                                    class="inline-flex items-center justify-center px-3 py-2 bg-green-600 text-white rounded text-sm hover:bg-green-700">
                                                <i class="fas fa-comments mr-2"></i>
                                                <span id="comments-btn-text-{{ submission_data.submission.id }}">
                                                    {% if submission_data.submission_comments|length > 0 %}
                                                        View Feedback
                                                    {% else %}
                                                        Discussion
                                                    {% endif %}
                                                </span>
                                                {% if submission_data.submission_comments|length > 0 %}
                                                <span class="ml-2 bg-white text-green-600 rounded-full px-2 py-1 text-xs" id="comments-count-{{ submission_data.submission.id }}">
                                                    {{ submission_data.submission_comments|length }}
                                                </span>
                                                {% endif %}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Individual Comments & Discussion Section for this specific submission attempt -->
                            <div id="submission-comments-{{ submission_data.submission.id }}" class="hidden bg-gray-50 border-t border-gray-300 rounded-b-lg">
                                <div class="p-4">
                                    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                                        <div class="border-b border-gray-200 p-4">
                                            <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                                                <i class="fas fa-comments text-green-500 mr-2"></i>
                                                Feedback & Discussion - Attempt
                                                <span class="ml-2 text-sm bg-green-100 text-green-800 px-2 py-1 rounded">{{ submission_data.submission_comments|length }} comment{{ submission_data.submission_comments|length|pluralize }}</span>
                                            </h3>
                                            <p class="text-sm text-gray-600 mt-1">
                                                Discussion about submission attempt from {{ submission_data.submission.submitted_at|date:"M d, Y H:i" }}
                                            </p>
                                        </div>

                                            <div class="p-4">
                                                <!-- Add New Comment Form for this specific submission attempt -->
                                                <form method="post" action="{% url 'assignments:add_comment' assignment.id %}" class="mb-6">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="submission_id" value="{{ submission_data.submission.id }}">
                                                    <div class="mb-4">
                                                        <label for="comment-content-learner-{{ submission_data.submission.id }}" class="block text-sm font-medium text-gray-700 mb-2">
                                                            Ask a question or respond to instructor feedback for Attempt
                                                        </label>
                                                        <textarea 
                                                            id="comment-content-learner-{{ submission_data.submission.id }}" 
                                                            name="content" 
                                                            rows="3" 
                                                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent resize-vertical"
                                                            placeholder="Ask questions about feedback or provide additional information about this submission attempt..."
                                                            autocomplete="on" autocorrect="off" autocapitalize="off" spellcheck="false"
                                                            required
                                                        ></textarea>
                                                    </div>
                                                    
                                                    <button 
                                                        type="submit" 
                                                        class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200"
                                                    >
                                                        <i class="fas fa-paper-plane mr-2"></i>
                                                        Post Comment
                                                    </button>
                                                </form>

                                                <!-- Comments List for this specific submission attempt -->
                                                {% if submission_data.submission_comments %}
                                                <div class="space-y-4">
                                                    {% for comment in submission_data.submission_comments %}
                                                    <div class="comment-thread border-l-4 border-green-200 pl-4">
                                                        <!-- Main Comment -->
                                                        <div class="bg-gray-50 rounded-lg p-4">
                                                            <div class="flex justify-between items-start mb-3">
                                                                <div class="flex items-center">
                                                                    <div class="w-8 h-8 {% if comment.author.role == 'instructor' %}bg-blue-500{% else %}bg-green-500{% endif %} text-white rounded-full flex items-center justify-center text-sm font-medium mr-3">
                                                                        {% if comment.author.first_name %}
                                                                            {{ comment.author.first_name|first }}{{ comment.author.last_name|first }}
                                                                        {% else %}
                                                                            {{ comment.author.username|first|upper }}
                                                                        {% endif %}
                                                                    </div>
                                                                    <div>
                                                                        <h4 class="font-medium text-gray-900">
                                                                            {{ comment.author.get_full_name }}
                                                                            {% if comment.author.role == 'instructor' %}
                                                                                <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded ml-2">Instructor</span>
                                                                            {% endif %}
                                                                        </h4>
                                                                        <p class="text-sm text-gray-500">
                                                                            {{ comment.created_at|date:"M d, Y H:i" }} ({{ comment.created_at|timesince }} ago)
                                                                            {% if comment.is_private and comment.author != user %}
                                                                                <span class="ml-2 bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-xs">Private Note</span>
                                                                            {% endif %}
                                                                        </p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            
                                                                                                        <!-- Show comments based on visibility rules for learners -->
                                            {% if not comment.is_private or comment.author == user or user.role in 'instructor,admin,superadmin,globaladmin'|split:',' %}
                                            <div class="comment-content" id="comment-content-{{ comment.id }}">
                                                <p class="text-gray-700">{{ comment.content|linebreaks }}</p>
                                                
                                                <!-- Show privacy indicator for learners viewing their own private comments -->
                                                {% if comment.is_private and comment.author == user %}
                                                <div class="mt-2">
                                                    <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">
                                                        <i class="fas fa-lock mr-1"></i>Private Note (Only you can see this)
                                                    </span>
                                                </div>
                                                {% endif %}
                                            </div>
                                            
                                            <!-- Reply Button for learners (only for non-private comments or instructor feedback) -->
                                            {% if not comment.is_private or comment.author.role == 'instructor' %}
                                            <button 
                                                onclick="toggleReplyForm({{ comment.id }})" 
                                                class="mt-3 text-green-600 hover:text-green-800 text-sm font-medium"
                                            >
                                                <i class="fas fa-reply mr-1"></i>
                                                Reply
                                            </button>
                                            
                                            <!-- Reply Form (Hidden by default) -->
                                            <div class="reply-form hidden mt-3" id="reply-form-{{ comment.id }}">
                                                <form method="post" action="{% url 'assignments:add_comment' assignment.id %}">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="parent_id" value="{{ comment.id }}">
                                                    <input type="hidden" name="submission_id" value="{{ submission_data.submission.id }}">
                                                    <textarea 
                                                        name="content" 
                                                        rows="2" 
                                                        class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent mb-3"
                                                        placeholder="Write a reply..."
                                                        autocomplete="on" autocorrect="off" autocapitalize="off" spellcheck="false"
                                                        required
                                                    ></textarea>
                                                    <div class="flex space-x-2">
                                                        <button 
                                                            type="submit" 
                                                            class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700"
                                                        >
                                                            <i class="fas fa-paper-plane mr-1"></i>
                                                            Post Reply
                                                        </button>
                                                        <button 
                                                            type="button" 
                                                            onclick="toggleReplyForm({{ comment.id }})" 
                                                            class="bg-gray-600 text-white px-3 py-1 rounded text-sm hover:bg-gray-700"
                                                        >
                                                            Cancel
                                                        </button>
                                                    </div>
                                                </form>
                                            </div>
                                            {% endif %}
                                            {% else %}
                                            <!-- Show placeholder for hidden private comments -->
                                            <div class="comment-content bg-gray-50 border-l-4 border-gray-300 p-3 rounded">
                                                <p class="text-gray-500 text-sm italic">
                                                    <i class="fas fa-lock mr-2"></i>
                                                    Private instructor note (not visible to students)
                                                </p>
                                            </div>
                                            {% endif %}
                                                        </div>
                                                        
                                                        <!-- Replies -->
                                                        {% for reply in comment.get_visible_replies %}
                                                        {% if not reply.is_private or reply.author == user or user.role in 'instructor,admin,superadmin,globaladmin'|split:',' %}
                                                        <div class="ml-8 mt-3 bg-white rounded-lg p-4 border border-gray-200">
                                                            <div class="flex justify-between items-start mb-3">
                                                                <div class="flex items-center">
                                                                    <div class="w-6 h-6 {% if reply.author.role == 'instructor' %}bg-blue-500{% else %}bg-green-500{% endif %} text-white rounded-full flex items-center justify-center text-xs font-medium mr-3">
                                                                        {% if reply.author.first_name %}
                                                                            {{ reply.author.first_name|first }}{{ reply.author.last_name|first }}
                                                                        {% else %}
                                                                            {{ reply.author.username|first|upper }}
                                                                        {% endif %}
                                                                    </div>
                                                                    <div>
                                                                        <h5 class="font-medium text-gray-900 text-sm">
                                                                            {{ reply.author.get_full_name }}
                                                                            {% if reply.author.role == 'instructor' %}
                                                                                <span class="text-xs bg-blue-100 text-blue-800 px-1 py-0.5 rounded ml-1">Instructor</span>
                                                                            {% endif %}
                                                                        </h5>
                                                                        <p class="text-xs text-gray-500">
                                                                            {{ reply.created_at|date:"M d, Y H:i" }} ({{ reply.created_at|timesince }} ago)
                                                                            {% if reply.is_private and reply.author == user %}
                                                                                <span class="ml-2 bg-yellow-100 text-yellow-800 px-1 py-0.5 rounded text-xs">Your Private Note</span>
                                                                            {% elif reply.is_private %}
                                                                                <span class="ml-2 bg-yellow-100 text-yellow-800 px-1 py-0.5 rounded text-xs">Private Note</span>
                                                                            {% endif %}
                                                                        </p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            
                                                            <div class="comment-content" id="comment-content-{{ reply.id }}">
                                                                <p class="text-gray-700 text-sm">{{ reply.content|linebreaks }}</p>
                                                                
                                                                <!-- Show privacy indicator for learners viewing their own private replies -->
                                                                {% if reply.is_private and reply.author == user %}
                                                                <div class="mt-2">
                                                                    <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">
                                                                        <i class="fas fa-lock mr-1"></i>Private Note (Only you can see this)
                                                                    </span>
                                                                </div>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                        {% elif reply.is_private %}
                                                        <!-- Show placeholder for hidden private replies -->
                                                        <div class="ml-8 mt-3 bg-gray-50 border-l-4 border-gray-300 p-3 rounded">
                                                            <p class="text-gray-500 text-sm italic">
                                                                <i class="fas fa-lock mr-2"></i>
                                                                Private instructor reply (not visible to students)
                                                            </p>
                                                        </div>
                                                        {% endif %}
                                                        {% endfor %}
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                                {% else %}
                                                <div class="text-center py-8 text-gray-500">
                                                    <i class="fas fa-comments text-4xl text-gray-300 mb-3"></i>
                                                    <p>Discussion for this submission attempt. Your instructor will provide comments here.</p>
                                                </div>
                                                {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                    {% endif %}
                {% endfor %}
                
                <!-- No submissions message for learners -->
                {% if not submissions %}
                <div class="bg-gray-100 rounded p-6 mb-6">
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-inbox text-4xl text-gray-300 mb-3"></i>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">No Submissions Yet</h3>
                        <p>You haven't submitted this assignment yet. Use the submission form below to submit your work.</p>
                    </div>
                </div>
                {% endif %}
            {% endif %}

            <!-- Enhanced Submissions Table (moved to top for instructors/admins) -->
            {% if user.role in 'instructor,admin,superadmin,globaladmin'|split:',' %}
                {% include 'assignments/enhanced_submissions_table.html' %}
            {% endif %}

            <!-- General Assignment Comments Section (Only for Instructors/Admins) - moved to top -->
            {% if user.role in 'instructor,admin,superadmin,globaladmin'|split:',' %}
                {% if user.role == 'instructor' or user.role == 'admin' or user.role == 'globaladmin' or user.role == 'superadmin' or user.is_superuser %}
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                    <div class="border-b border-gray-200 p-4">
                        <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                            <i class="fas fa-comments text-blue-500 mr-2"></i>
                            General Assignment Discussion
                            <span class="ml-2 text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded">{{ comments|length }} comment{{ comments|length|pluralize }}</span>
                        </h2>
                        <p class="text-sm text-gray-600 mt-1">General discussion about this assignment (not specific to individual submissions)</p>
                        {% if user.role == 'instructor' or user.role == 'admin' or user.role == 'globaladmin' or user.role == 'superadmin' or user.is_superuser %}
                            <p class="text-xs text-amber-600 mt-1">
                                <i class="fas fa-info-circle mr-1"></i>
                                For submission-specific feedback, use the Comments button in the submissions table below
                            </p>
                        {% endif %}
                    </div>

                    <div class="p-4">
                        <!-- Add New Comment Form -->
                        <form method="post" action="{% url 'assignments:add_comment' assignment.id %}" class="mb-6">
                            {% csrf_token %}
                            <div class="mb-4">
                                <label for="comment-content" class="block text-sm font-medium text-gray-700 mb-2">
                                    Add a general comment about this assignment
                                </label>
                                <textarea 
                                    id="comment-content" 
                                    name="content" 
                                    rows="3" 
                                    class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-vertical"
                                    placeholder="Ask a question or share your thoughts about this assignment in general..."
                                    {% if submission %}autocomplete="on"{% else %}autocomplete="off"{% endif %} autocorrect="off" autocapitalize="off" spellcheck="false"
                                    required
                                ></textarea>
                            </div>
                            
                            <!-- Don't include submission_id for general assignment comments -->
                            
                            {% if user.role == 'instructor' %}
                            <div class="mb-4">
                                <label class="flex items-center">
                                    <input type="checkbox" name="is_private" class="mr-2">
                                    <span class="text-sm text-gray-600">Make this comment private (only instructors can see)</span>
                                </label>
                            </div>
                            {% endif %}
                            
                            <button 
                                type="submit" 
                                class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200"
                            >
                                <i class="fas fa-paper-plane mr-2"></i>
                                Post Comment
                            </button>
                        </form>

                        <!-- Comments List -->
                        {% if comments %}
                        <div class="space-y-4">
                            {% for comment in comments %}
                            <div class="comment-thread border-l-4 border-blue-200 pl-4">
                                <!-- Main Comment -->
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <div class="flex justify-between items-start mb-3">
                                        <div class="flex items-center">
                                            <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-medium mr-3">
                                                {% if comment.author.first_name %}
                                                    {{ comment.author.first_name|first }}{{ comment.author.last_name|first }}
                                                {% else %}
                                                    {{ comment.author.username|first|upper }}
                                                {% endif %}
                                            </div>
                                            <div>
                                                <h4 class="font-medium text-gray-900">{{ comment.author.get_full_name }}</h4>
                                                <p class="text-sm text-gray-500">
                                                    {{ comment.created_at|timesince }} ago
                                                    {% if comment.is_private %}
                                                        <span class="ml-2 bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-xs">Private</span>
                                                    {% endif %}
                                                </p>
                                            </div>
                                        </div>
                                        
                                        {% if comment.can_edit_by_user %}
                                        <div class="flex items-center space-x-2">
                                            <button 
                                                onclick="toggleEditComment({{ comment.id }})" 
                                                class="text-gray-500 hover:text-gray-700 text-sm"
                                                title="Edit comment"
                                            >
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <form method="post" action="{% url 'assignments:delete_comment' comment.id %}" class="inline" 
                                                  onsubmit="return confirm('Are you sure you want to delete this comment?')">
                                                {% csrf_token %}
                                                <button 
                                                    type="submit" 
                                                    class="text-red-500 hover:text-red-700 text-sm"
                                                    title="Delete comment"
                                                >
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="comment-content" id="comment-content-{{ comment.id }}">
                                        <p class="text-gray-700">{{ comment.content|linebreaks }}</p>
                                    </div>
                                    
                                    <!-- Edit Form (Hidden by default) -->
                                    <div class="comment-edit-form hidden" id="edit-form-{{ comment.id }}">
                                        <form method="post" action="{% url 'assignments:edit_comment' comment.id %}">
                                            {% csrf_token %}
                                            <textarea 
                                                name="content" 
                                                rows="3" 
                                                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent mb-3"
                                                autocomplete="on" autocorrect="off" autocapitalize="off" spellcheck="false"
                                                required
                                            >{{ comment.content }}</textarea>
                                            <div class="flex space-x-2">
                                                <button 
                                                    type="submit" 
                                                    class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700"
                                                >
                                                    Save
                                                </button>
                                                <button 
                                                    type="button" 
                                                    onclick="toggleEditComment({{ comment.id }})" 
                                                    class="bg-gray-600 text-white px-3 py-1 rounded text-sm hover:bg-gray-700"
                                                >
                                                    Cancel
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                    
                                    <!-- Reply Button -->
                                    <button 
                                        onclick="toggleReplyForm({{ comment.id }})" 
                                        class="mt-3 text-blue-600 hover:text-blue-800 text-sm font-medium"
                                    >
                                        <i class="fas fa-reply mr-1"></i>
                                        Reply
                                    </button>
                                    
                                    <!-- Reply Form (Hidden by default) -->
                                    <div class="reply-form hidden mt-3" id="reply-form-{{ comment.id }}">
                                        <form method="post" action="{% url 'assignments:add_comment' assignment.id %}">
                                            {% csrf_token %}
                                            <input type="hidden" name="parent_id" value="{{ comment.id }}">
                                            {% if submission %}
                                            <input type="hidden" name="submission_id" value="{{ submission.id }}">
                                            {% endif %}
                                            <textarea 
                                                name="content" 
                                                rows="2" 
                                                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent mb-3"
                                                placeholder="Write a reply..."
                                                {% if submission %}autocomplete="on"{% else %}autocomplete="off"{% endif %} autocorrect="off" autocapitalize="off" spellcheck="false"
                                                required
                                            ></textarea>
                                            <div class="flex space-x-2">
                                                <button 
                                                    type="submit" 
                                                    class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700"
                                                >
                                                    <i class="fas fa-paper-plane mr-1"></i>
                                                    Post Reply
                                                </button>
                                                <button 
                                                    type="button" 
                                                    onclick="toggleReplyForm({{ comment.id }})" 
                                                    class="bg-gray-600 text-white px-3 py-1 rounded text-sm hover:bg-gray-700"
                                                >
                                                    Cancel
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                                
                                <!-- Replies -->
                                {% for reply in comment.get_visible_replies %}
                                <div class="ml-8 mt-3 bg-white rounded-lg p-4 border border-gray-200">
                                    <div class="flex justify-between items-start mb-3">
                                        <div class="flex items-center">
                                            <div class="w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center text-xs font-medium mr-3">
                                                {% if reply.author.first_name %}
                                                    {{ reply.author.first_name|first }}{{ reply.author.last_name|first }}
                                                {% else %}
                                                    {{ reply.author.username|first|upper }}
                                                {% endif %}
                                            </div>
                                            <div>
                                                <h4 class="font-medium text-gray-900 text-sm">{{ reply.author.get_full_name }}</h4>
                                                <p class="text-xs text-gray-500">{{ reply.created_at|timesince }} ago</p>
                                            </div>
                                        </div>
                                        
                                        {% if reply.can_edit_by_user %}
                                        <div class="flex items-center space-x-2">
                                            <button 
                                                onclick="toggleEditComment({{ reply.id }})" 
                                                class="text-gray-500 hover:text-gray-700 text-xs"
                                                title="Edit reply"
                                            >
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <form method="post" action="{% url 'assignments:delete_comment' reply.id %}" class="inline" 
                                                  onsubmit="return confirm('Are you sure you want to delete this reply?')">
                                                {% csrf_token %}
                                                <button 
                                                    type="submit" 
                                                    class="text-red-500 hover:text-red-700 text-xs"
                                                    title="Delete reply"
                                                >
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="comment-content" id="comment-content-{{ reply.id }}">
                                        <p class="text-gray-700 text-sm">{{ reply.content|linebreaks }}</p>
                                    </div>
                                    
                                    <!-- Edit Form for Reply (Hidden by default) -->
                                    <div class="comment-edit-form hidden" id="edit-form-{{ reply.id }}">
                                        <form method="post" action="{% url 'assignments:edit_comment' reply.id %}">
                                            {% csrf_token %}
                                            <textarea 
                                                name="content" 
                                                rows="2" 
                                                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent mb-3 text-sm"
                                                autocomplete="on" autocorrect="off" autocapitalize="off" spellcheck="false"
                                                required
                                            >{{ reply.content }}</textarea>
                                            <div class="flex space-x-2">
                                                <button 
                                                    type="submit" 
                                                    class="bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-700"
                                                >
                                                    Save
                                                </button>
                                                <button 
                                                    type="button" 
                                                    onclick="toggleEditComment({{ reply.id }})" 
                                                    class="bg-gray-600 text-white px-3 py-1 rounded text-xs hover:bg-gray-700"
                                                >
                                                    Cancel
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-comments text-gray-400 text-3xl mb-2"></i>
                            <p>No comments yet. Start the discussion!</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            {% endif %}
            
            <!-- Description Section -->
            <div class="bg-gray-100 rounded p-6">
                <h2 class="text-xl font-semibold mb-3 text-gray-800">Description</h2>
                <div class="prose max-w-none text-gray-700">
                    {{ assignment.description|render_rich_content }}
                </div>
            </div>

            <!-- Instructions Section (if available) -->
            <div class="bg-gray-100 rounded p-6">
                <h2 class="text-xl font-semibold mb-3 text-gray-800">Instructions</h2>
                <div class="prose max-w-none text-gray-700">
                    {% if assignment.instructions %}
                        {{ assignment.instructions|render_rich_content }}
                    {% else %}
                        <p>No specific instructions provided for this assignment.</p>
                    {% endif %}
                    
                    <!-- Attachments Section - Embedded within Instructions -->
                    {% if attachments %}
                        <div class="embedded-attachments">
                            <h3 class="embedded-attachments-title">Attached Files</h3>
                            <div class="text-sm text-gray-600 mb-2">
                                <span class="font-medium">Instructor:</span> {{ assignment.user.get_full_name|default:"System" }}
                            </div>
                            <div class="space-y-4">
                                {% for attachment in attachments|get_attachments %}
                                    <div class="embedded-attachment-card w-full">
                                        <div class="embedded-attachment-header">
                                            <div class="flex items-center space-x-2">
                                                {% if attachment.content_type %}
                                                    {% if attachment.content_type|slice:":5" == "image" %}
                                                        <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                                        </svg>
                                                    {% elif attachment.content_type|slice:":5" == "video" %}
                                                        <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                                        </svg>
                                                    {% elif attachment.content_type|slice:":11" == "application" %}
                                                        <svg class="w-5 h-5 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                                        </svg>
                                                    {% else %}
                                                        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                                                        </svg>
                                                    {% endif %}
                                                {% else %}
                                                    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                                                    </svg>
                                                {% endif %}
                                                <span class="embedded-attachment-name" title="{{ attachment.file_name }}">{{ attachment.file_name }}</span>
                                            </div>
                                            <a href="{{ attachment.file.url }}" class="text-blue-600 hover:text-blue-800 text-sm" download>
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                                </svg>
                                            </a>
                                        </div>
                                        
                                        <!-- Embedded Preview based on file type -->
                                        <div class="embedded-attachment-preview">
                                            {% if attachment.content_type|slice:":5" == "image" %}
                                                <img src="{{ attachment.file.url }}" alt="{{ attachment.file_name }}" class="w-full h-auto">
                                            {% elif attachment.content_type|slice:":5" == "video" %}
                                                <video controls class="w-full h-auto">
                                                    <source src="{{ attachment.file.url }}" type="{{ attachment.content_type }}">
                                                    Your browser does not support video playback.
                                                </video>
                                            {% elif attachment.content_type == "application/pdf" %}
                                                <div class="relative">
                                                    <iframe src="{{ attachment.file.url }}" class="w-full" frameborder="0"></iframe>
                                                </div>
                                            {% elif attachment.content_type == "text/plain" or attachment.content_type == "text/html" or attachment.content_type == "text/css" or attachment.content_type == "text/javascript" %}
                                                <div class="bg-gray-50 p-3 rounded border border-gray-200 overflow-auto max-h-40 text-sm">
                                                    <a href="{{ attachment.file.url }}" target="_blank" class="text-blue-600 hover:underline">Open text file in new tab</a>
                                                </div>
                                            {% else %}
                                                <div class="embedded-attachment-fallback">
                                                    <p class="text-sm text-gray-500">Preview not available</p>
                                                    <a href="{{ attachment.file.url }}" class="embedded-attachment-download mt-2" download>
                                                        Download {{ attachment.file_name }}
                                                    </a>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Assignment Details Table -->
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border">
                    <tr class="bg-gray-100 text-gray-700">
                        <th class="py-2 px-4 border text-left">Due Date</th>
                        <th class="py-2 px-4 border text-left">Assigned to</th>
                        <th class="py-2 px-4 border text-left">Available from</th>
                        <th class="py-2 px-4 border text-left">Available till</th>
                        <th class="py-2 px-4 border text-left">Points</th>
                    </tr>
                    <tr class="text-gray-700">
                        <td class="py-2 px-4 border">{{ assignment.due_date|date:"d/m/Y" }}</td>
                        <td class="py-2 px-4 border">Everyone</td>
                        <td class="py-2 px-4 border">{{ assignment.start_date|date:"d/m/Y"|default:"Immediately" }}</td>
                        <td class="py-2 px-4 border">{{ assignment.due_date|date:"d/m/Y" }}</td>
                        <td class="py-2 px-4 border">{{ assignment.max_score }}</td>
                    </tr>
                </table>
            </div>

            <!-- Rubric Section -->
            <div class="bg-white border rounded">
                <div class="p-3 cursor-pointer border-b flex items-center" onclick="toggleRubric()">
                    <i class="fas fa-chevron-down mr-2 text-gray-600" id="rubricIcon"></i>
                    <span class="font-medium text-gray-700">View Rubric</span>
                </div>
                <div class="hidden p-4" id="rubricSection">
                    {% if rubric_data %}
                    <div class="mb-2 text-gray-700">{{ rubric_data.rubric.title }}</div>
                    {% if rubric_data.rubric.description %}
                    <div class="mb-4 text-sm text-gray-600">{{ rubric_data.rubric.description }}</div>
                    {% endif %}
                    <table class="min-w-full border">
                        <tr class="bg-gray-100 text-gray-700">
                            <th class="py-2 px-4 border text-left">Criteria</th>
                            <th class="py-2 px-4 border text-left">Ratings</th>
                            <th class="py-2 px-4 border text-left">Points</th>
                        </tr>
                        {% for criterion in rubric_data.criteria %}
                        <tr class="text-gray-700">
                            <td class="py-2 px-4 border">{{ criterion.description }}</td>
                            <td class="py-2 px-4 border criterion-ratings-cell" data-criterion-id="{{ criterion.id }}" data-use-range="{{ criterion.use_range|lower }}">
                                {% for rating in criterion|get_criterion_ratings %}
                                <div class="rating-item mb-2" data-points="{{ rating.points }}">
                                    <div class="flex items-center space-x-2">
                                        <span class="rating-title text-black">{{ rating.title }}</span>
                                        <span class="rating-points text-black font-medium">{{ rating.points }} Pts</span>
                                    </div>
                                </div>
                                {% empty %}
                                <div>No ratings defined</div>
                                {% endfor %}
                            </td>
                            <td class="py-2 px-4 border">{{ criterion.points }} pts</td>
                        </tr>
                        {% endfor %}
                    </table>
                    <div class="text-right mt-2 text-gray-700">Total points: {{ rubric_data.total_points }}</div>
                    {% else %}
                    <div class="mb-2 text-gray-700">No rubric has been defined for this assignment.</div>
                    {% if user.role in 'instructor,admin,superadmin'|split:',' or user.is_superuser %}
                    <div class="mt-2">
                        <a href="{% url 'assignments:edit_assignment' assignment.id %}" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-edit mr-1"></i> Assign a rubric
                        </a>
                    {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Unified Submission Form for Both File Upload and Questions -->
            {% if user.role == 'learner' %}
                {% if assignment.submission_type in 'file,both'|split:',' or assignment.text_fields.exists %}
            <!-- Feedback Timeline -->
            {% if submission.feedback_entries.exists and user.role not in 'instructor,admin,superadmin,globaladmin'|split:',' %}
            <div id="feedback-timeline" class="bg-gray-100 rounded p-6">
                <!-- Collapsible Header -->
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 cursor-pointer hover:bg-purple-100 transition-colors mb-4"
                     onclick="toggleInstructorFeedbackTimeline()">
                    <h2 class="text-xl font-semibold text-gray-800 flex items-center justify-between">
                        <div class="flex items-center">
                            <i id="instructor-feedback-icon" class="fas fa-chevron-right mr-2 text-purple-600 transition-transform duration-200"></i>
                            <i class="fas fa-history mr-2 text-purple-600"></i>
                            Instructor Feedback Timeline
                            <span class="text-sm font-normal text-gray-600 ml-2">({{ submission.feedback_entries.count }} feedback{{ submission.feedback_entries.count|pluralize }})</span>
                        </div>
                        <span class="text-sm text-purple-600 font-normal">
                            <i class="fas fa-eye mr-1"></i>Click to view/hide
                        </span>
                    </h2>
                </div>
                
                <!-- Timeline Container (Collapsible) -->
                <div id="instructor-feedback-timeline" class="hidden relative transition-all duration-300 ease-in-out">
                    <!-- Timeline Line -->
                    <div class="absolute left-4 top-0 bottom-0 w-0.5 bg-purple-300"></div>
                    
                    <!-- Timeline Items -->
                    <div class="space-y-6">
                        {% for feedback_entry in submission.feedback_entries.all %}
                        <div class="relative flex items-start space-x-3">
                            <!-- Timeline Node -->
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center relative z-10 shadow-lg">
                                    <i class="fas fa-comment-dots text-white text-sm"></i>
                                </div>
                            </div>
                            
                            <!-- Feedback Content -->
                            <div class="flex-1 bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
                                <!-- Feedback Header -->
                                <div class="bg-purple-50 px-4 py-3 border-b border-purple-100">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-2">
                                            <div class="font-semibold text-purple-800">{{ feedback_entry.created_by.get_full_name }}</div>
                                            <span class="text-purple-600">•</span>
                                            <div class="text-sm text-purple-600">
                                                <i class="fas fa-clock mr-1"></i>
                                                {{ feedback_entry.created_at|date:"M d, Y \a\t g:i A" }}
                                            </div>
                                        </div>
                                        <div class="flex space-x-2">
                                            {% if feedback_entry.feedback %}
                                            <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full font-medium">
                                                <i class="fas fa-keyboard mr-1"></i>Text
                                            </span>
                                            {% endif %}
                                            {% if feedback_entry.audio_feedback %}
                                            <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full font-medium">
                                                <i class="fas fa-microphone mr-1"></i>Audio
                                            </span>
                                            {% endif %}
                                            {% if feedback_entry.video_feedback %}
                                            <span class="px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded-full font-medium">
                                                <i class="fas fa-video mr-1"></i>Video
                                            </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Feedback Body -->
                                <div class="p-4">
                                    <!-- Text Feedback -->
                                    {% if feedback_entry.feedback %}
                                    <div class="mb-4">
                                        <div class="flex items-center mb-2">
                                            <i class="fas fa-keyboard text-blue-600 mr-2"></i>
                                            <span class="font-medium text-blue-800">Written Feedback</span>
                                        </div>
                                        <div class="prose max-w-none text-gray-700 bg-blue-50 p-3 rounded border-l-4 border-blue-400">
                                            <!-- Safe content rendering -->
                                            {{ feedback_entry.feedback|linebreaks }}
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Audio Feedback -->
                                    {% if feedback_entry.audio_feedback %}
                                    <div class="mb-4">
                                        <div class="flex items-center mb-2">
                                            <i class="fas fa-microphone text-green-600 mr-2"></i>
                                            <span class="font-medium text-green-800">Audio Feedback</span>
                                        </div>
                                        <div class="bg-green-50 p-3 rounded border-l-4 border-green-400">
                                            <audio controls class="w-full" controlsList="nodownload">
                                                <source src="{{ feedback_entry.audio_feedback.url }}" type="audio/mpeg">
                                                <source src="{{ feedback_entry.audio_feedback.url }}" type="audio/wav">
                                                <source src="{{ feedback_entry.audio_feedback.url }}" type="audio/mp4">
                                                Your browser does not support the audio element.
                                            </audio>
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Video Feedback -->
                                    {% if feedback_entry.video_feedback %}
                                    <div class="mb-4">
                                        <div class="flex items-center mb-2">
                                            <i class="fas fa-video text-purple-600 mr-2"></i>
                                            <span class="font-medium text-purple-800">Video Feedback</span>
                                        </div>
                                        <div class="bg-purple-50 p-3 rounded border-l-4 border-purple-400">
                                            <video controls class="w-full max-w-2xl rounded-lg" controlsList="nodownload">
                                                <source src="{{ feedback_entry.video_feedback.url }}" type="video/mp4">
                                                <source src="{{ feedback_entry.video_feedback.url }}" type="video/mov">
                                                <source src="{{ feedback_entry.video_feedback.url }}" type="video/avi">
                                                Your browser does not support the video element.
                                            </video>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Rubric Evaluation History Timeline for Learners -->
            {% if submission and rubric_evaluation_history and user.role == 'learner' %}
            <div id="rubric-evaluation-timeline" class="bg-gray-100 rounded p-6 mb-4">
                <!-- Collapsible Header -->
                <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 cursor-pointer hover:bg-amber-100 transition-colors mb-4"
                     onclick="toggleRubricEvaluationTimeline()">
                    <h2 class="text-xl font-semibold text-gray-800 flex items-center justify-between">
                        <div class="flex items-center">
                            <i id="rubric-evaluation-icon" class="fas fa-chevron-right mr-2 text-amber-600 transition-transform duration-200"></i>
                            <i class="fas fa-clipboard-list mr-2 text-amber-600"></i>
                            Rubric Evaluation History
                            {% regroup rubric_evaluation_history|dictsort:"submission.submitted_at" by submission as temp_submission_groups %}
                            <span class="text-sm font-normal text-gray-600 ml-2">({{ temp_submission_groups|length }} submission{{ temp_submission_groups|length|pluralize }})</span>
                        </div>
                        <span class="text-sm text-amber-600 font-normal">
                            <i class="fas fa-eye mr-1"></i>Click to view/hide
                        </span>
                    </h2>
                </div>
                
                <!-- Timeline Container (Collapsible) -->
                <div id="rubric-evaluation-timeline-content" class="hidden relative transition-all duration-300 ease-in-out">
                    <!-- Timeline Line -->
                    <div class="absolute left-4 top-0 bottom-0 w-0.5 bg-amber-300"></div>
                    
                    <!-- Timeline Items grouped by Submission -->
                    <div class="space-y-6">
                        {% regroup rubric_evaluation_history|dictsort:"submission.submitted_at" by submission as submission_groups %}
                        {% for submission_group in submission_groups %}
                        <div class="relative flex items-start space-x-3">
                            <!-- Timeline Node -->
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center relative z-10 shadow-lg">
                                    <i class="fas fa-clipboard text-white text-sm"></i>
                                </div>
                            </div>
                            
                            <!-- Submission Content -->
                            <div class="flex-1 bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
                                <!-- Submission Header -->
                                <div class="bg-blue-50 px-4 py-3 border-b border-blue-100">
                                    <div class="flex items-center justify-between">
                                        <div class="font-semibold text-blue-800">
                                            Submission #{{ forloop.counter }}
                                            {% if submission_group.grouper.id == submission.id %}
                                                <span class="ml-2 px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">Current</span>
                                            {% endif %}
                                        </div>
                                        <div class="text-sm text-blue-600">
                                            <i class="fas fa-clock mr-1"></i>
                                            {{ submission_group.grouper.submitted_at|date:"M d, Y \a\t g:i A" }}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Criteria for this submission -->
                                <div class="p-4 space-y-4">
                                    {% regroup submission_group.list|dictsort:"criterion.position" by criterion as criterion_groups %}
                                    {% for criterion_group in criterion_groups %}
                                    <div class="border border-gray-100 rounded-lg overflow-hidden">
                                        <!-- Criterion Header (Clickable) -->
                                        <div class="bg-amber-50 px-4 py-3 border-b border-amber-100 cursor-pointer hover:bg-amber-100 transition-colors"
                                             onclick="toggleCriterionAccordion('student_criterion_{{ submission_group.grouper.id }}_{{ criterion_group.grouper.id }}')">
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center space-x-2">
                                                    <i id="student_criterion_icon_{{ submission_group.grouper.id }}_{{ criterion_group.grouper.id }}" class="fas fa-chevron-right text-amber-600 transition-transform duration-200"></i>
                                                    <div class="font-semibold text-amber-800">{{ criterion_group.grouper.description }}</div>
                                                    <span class="text-amber-600">•</span>
                                                    <div class="text-sm text-amber-600">
                                                        <i class="fas fa-star mr-1"></i>
                                                        {{ criterion_group.grouper.points }} points max
                                                    </div>
                                                </div>
                                                <div class="text-sm text-amber-600">
                                                    {{ criterion_group.list|length }} evaluation{{ criterion_group.list|length|pluralize }}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Evaluation Versions for this criterion (Collapsible) -->
                                        <div id="student_criterion_{{ submission_group.grouper.id }}_{{ criterion_group.grouper.id }}" class="hidden p-4 space-y-4">
                                            {% for history_item in criterion_group.list|dictsort:"version" reversed %}
                                            <div class="border border-gray-100 rounded-lg p-4 {% if history_item.is_current %}bg-green-50 border-green-200{% else %}bg-gray-50{% endif %}">
                                                <div class="flex items-center justify-between mb-3">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="px-3 py-1 {% if history_item.is_current %}bg-green-100 text-green-800{% else %}bg-gray-100 text-gray-600{% endif %} text-sm rounded-full font-medium">
                                                            {% if history_item.is_current %}
                                                                <i class="fas fa-star mr-1"></i>Current Evaluation
                                                            {% else %}
                                                                <i class="fas fa-history mr-1"></i>Version {{ history_item.version }}
                                                            {% endif %}
                                                        </span>
                                                        {% if history_item.evaluated_by %}
                                                        <span class="text-sm text-gray-600">
                                                            Evaluated by {{ history_item.evaluated_by.get_full_name }}
                                                        </span>
                                                        {% endif %}
                                                    </div>
                                                    <div class="text-sm text-gray-500">
                                                        <i class="fas fa-clock mr-1"></i>
                                                        {{ history_item.evaluation_date|date:"M d, Y \a\t g:i A" }}
                                                    </div>
                                                </div>
                                                
                                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-3">
                                                    <div class="bg-white p-3 rounded border">
                                                        <div class="text-xs text-gray-600 mb-1">Points Awarded</div>
                                                        <div class="text-lg font-bold text-green-600">{{ history_item.points }}</div>
                                                        <div class="text-xs text-gray-500">out of {{ criterion_group.grouper.points }}</div>
                                                    </div>
                                                    <div class="bg-white p-3 rounded border">
                                                        <div class="text-xs text-gray-600 mb-1">Rating Selected</div>
                                                        <div class="text-sm font-medium text-gray-800">
                                                            {% if history_item.rating %}
                                                                {{ history_item.rating.title }}
                                                            {% else %}
                                                                <em class="text-orange-500">No rating selected</em>
                                                            {% endif %}
                                                        </div>
                                                        {% if history_item.rating %}
                                                        <div class="text-xs text-gray-500">{{ history_item.rating.points }} points</div>
                                                        {% endif %}
                                                    </div>
                                                    <div class="bg-white p-3 rounded border">
                                                        <div class="text-xs text-gray-600 mb-1">Performance</div>
                                                        <div class="text-sm font-medium text-gray-800" data-points="{{ history_item.points }}" data-max="{{ criterion_group.grouper.points }}">
                                                            {{ history_item.points }}/{{ criterion_group.grouper.points }}
                                                        </div>
                                                        <div class="text-xs text-gray-500 percentage-display" data-points="{{ history_item.points }}" data-max="{{ criterion_group.grouper.points }}">points earned</div>
                                                    </div>
                                                </div>
                                                
                                                {% if history_item.comments %}
                                                <div class="bg-blue-50 p-3 rounded border-l-4 border-blue-400">
                                                    <div class="flex items-center mb-2">
                                                        <i class="fas fa-comment text-blue-600 mr-2"></i>
                                                        <span class="font-medium text-blue-800 text-sm">Instructor Comments</span>
                                                    </div>
                                                    <div class="text-gray-700">{{ history_item.comments }}</div>
                                                </div>
                                                {% endif %}
                                                
                                                {% if history_item.rating and history_item.rating.description %}
                                                <div class="mt-3 bg-purple-50 p-3 rounded border-l-4 border-purple-400">
                                                    <div class="flex items-center mb-2">
                                                        <i class="fas fa-info-circle text-purple-600 mr-2"></i>
                                                        <span class="font-medium text-purple-800 text-sm">Rating Description</span>
                                                    </div>
                                                    <div class="text-gray-700 text-sm">{{ history_item.rating.description }}</div>
                                                </div>
                                                {% endif %}
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="bg-gray-100 rounded p-6 mt-4">
                <form method="post" action="{% url 'assignments:assignment_detail' assignment.id %}" enctype="multipart/form-data" id="unifiedSubmissionForm" {% if submission %}autocomplete="on"{% else %}autocomplete="off"{% endif %}>
                    {% csrf_token %}
                    <input type="hidden" name="submit_assignment" value="1">
                    
                    <!-- Learner Quiz Responses - Timeline Style (Only show if assignment has been returned for revision or has existing responses) -->
                    {% if assignment.text_fields.exists and submission and submission.status == 'returned' or assignment.text_fields.exists and submission and field_iteration_data %}
                    <div class="bg-white border border-gray-200 rounded-lg shadow-sm mb-6">
                        <div class="border-b border-gray-200 bg-gray-50 px-4 py-3">
                            <h2 class="text-lg font-semibold text-gray-800">
                                <i class="fas fa-comments text-green-500 mr-2"></i>
                                {% if submission and submission.status == 'returned' %}
                                    Submit Revised Response - Timeline
                                {% else %}
                                    Learner Quiz Responses - Timeline
                                {% endif %}
                            </h2>
                            <p class="text-sm text-gray-600 mt-1">
                                {% if submission and submission.status == 'returned' %}
                                    Your assignment has been returned for revision. Please review feedback and submit your revised responses.
                                {% else %}
                                    Your conversation with the instructor
                                {% endif %}
                            </p>
                        </div>
                        <div class="p-4 space-y-4">
                            {% for field in assignment.text_fields.all %}
                                <div class="border border-gray-200 rounded-lg overflow-hidden timeline-container">
                                    <!-- Question Header -->
                                    <div class="bg-gradient-to-r from-green-50 to-blue-50 px-4 py-4 cursor-pointer hover:from-green-100 hover:to-blue-100 transition-all duration-200"
                                         onclick="toggleTimelineAccordion('student_timeline_{{ field.id }}')">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center space-x-3 min-w-0">
                                                <i id="student_timeline_icon_{{ field.id }}" class="fas fa-chevron-right text-gray-500 transition-transform duration-200"></i>
                                                <div class="flex flex-col">
                                                    <span class="font-semibold text-gray-800">Question {{ forloop.counter }}</span>
                                                    {% if submission %}
                                                        {% with field_iteration_data|get_item:field.id as iteration_data %}
                                                            {% if iteration_data and iteration_data.iterations %}
                                                                <span class="text-sm text-gray-600">{{ iteration_data.iterations|length }} response{{ iteration_data.iterations|length|pluralize }}</span>
                                                            {% else %}
                                                                <span class="text-sm text-gray-600">No responses yet</span>
                                                            {% endif %}
                                                        {% endwith %}
                                                    {% else %}
                                                        <span class="text-sm text-gray-600">No responses yet</span>
                                                    {% endif %}
                                                </div>
                                                {% if submission %}
                                                    {% with field_iteration_data|get_item:field.id as iteration_data %}
                                                        {% if iteration_data and iteration_data.iterations %}
                                                            <div class="flex space-x-2">
                                                                <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">
                                                                    <i class="fas fa-reply mr-1"></i>{{ iteration_data.iterations|length }} response{{ iteration_data.iterations|length|pluralize }}
                                                                </span>
                                                                {% for latest_iteration in iteration_data.iterations reversed %}
                                                                    {% if forloop.first %}
                                                                        {% if latest_iteration.feedback_entries.exists %}
                                                                            <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">
                                                                                <i class="fas fa-comment-dots mr-1"></i>Has feedback
                                                                            </span>
                                                                        {% elif latest_iteration.is_submitted and submission.status != 'graded' %}
                                                                            <span class="px-2 py-1 bg-orange-100 text-orange-800 text-xs rounded-full">
                                                                                <i class="fas fa-clock mr-1"></i>Awaiting feedback
                                                                            </span>
                                                                        {% endif %}
                                                                    {% endif %}
                                                                {% endfor %}
                                                            </div>
                                                        {% else %}
                                                            <span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">
                                                                <i class="fas fa-hourglass-start mr-1"></i>Not started
                                                            </span>
                                                        {% endif %}
                                                    {% endwith %}
                                                {% else %}
                                                    <span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">
                                                        <i class="fas fa-hourglass-start mr-1"></i>Not started
                                                    </span>
                                                {% endif %}
                                            </div>
                                            <div class="text-sm text-gray-500 flex items-center">
                                                <i class="fas fa-history mr-1"></i>
                                                View Timeline
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Timeline Content -->
                                    <div id="student_timeline_{{ field.id }}" class="hidden">
                                        <div class="p-6 bg-white">
                                            <!-- Question Display -->
                                            <div class="mb-6 p-4 bg-gray-50 rounded-lg border-l-4 border-gray-400">
                                                <div class="flex items-start space-x-3">
                                                    <div class="flex-shrink-0">
                                                        <div class="w-8 h-8 bg-gray-400 rounded-full flex items-center justify-center">
                                                            <i class="fas fa-question text-white text-sm"></i>
                                                        </div>
                                                    </div>
                                                    <div class="flex-1">
                                                        <div class="flex items-center space-x-2 mb-2">
                                                            <span class="font-medium text-gray-700">Instructor Question</span>
                                                            <span class="text-xs text-gray-500">•</span>
                                                            <span class="text-xs text-gray-500">Assignment created</span>
                                                        </div>
                                                        <div class="text-gray-800 bg-white p-3 rounded border">
                                                            {% if field.content.html %}
                                                                {{ field.content.html|safe }}
                                                            {% elif field.label %}
                                                                {{ field.label }}
                                                            {% else %}
                                                                Question content not available
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Timeline of Interactions -->
                                            <div class="relative">
                                                <!-- Timeline Line -->
                                                <div class="absolute left-4 top-0 bottom-0 w-0.5 bg-gray-300"></div>
                                                
                                                {% if submission %}
                                                    {% with field_iteration_data|get_item:field.id as iteration_data %}
                                                        {% if iteration_data and iteration_data.iterations %}
                                                            <!-- Show all previous iterations and feedback -->
                                                            {% for iteration in iteration_data.iterations %}
                                                                {% if not iteration.is_submitted and iteration.iteration_number == 0 and iteration.feedback_entries.exists %}
                                                                    <!-- Initial Instructor Guidance -->
                                                                    {% for feedback in iteration.feedback_entries.all %}
                                                                        <div class="relative mb-8">
                                                                            <div class="flex items-start space-x-3">
                                                                                <div class="flex-shrink-0">
                                                                                    <div class="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center relative z-10">
                                                                                        <i class="fas fa-lightbulb text-white text-sm"></i>
                                                                                    </div>
                                                                                </div>
                                                                                <div class="flex-1">
                                                                                    <div class="bg-purple-50 rounded-lg p-4 border-l-4 border-purple-500">
                                                                                        <div class="flex items-center justify-between mb-2">
                                                                                            <div class="flex items-center space-x-2">
                                                                                                <span class="font-medium text-purple-700">Instructor Guidance</span>
                                                                                                <span class="text-xs text-purple-600">•</span>
                                                                                                <span class="text-xs text-purple-600">Initial feedback</span>
                                                                                            </div>
                                                                                            <span class="text-xs text-purple-600">
                                                                                                <i class="fas fa-clock mr-1"></i>
                                                                                                {{ feedback.created_at|date:"M d, Y \a\t g:i A" }}
                                                                                            </span>
                                                                                        </div>
                                                                                        <div class="text-gray-800 bg-white p-3 rounded border">
                                                                                            {{ feedback.feedback_text|safe }}
                                                                                        </div>
                                                                                        <div class="mt-2 flex items-center space-x-2">
                                                                                            <span class="inline-flex items-center px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">
                                                                                                <i class="fas fa-info-circle mr-1"></i>Please review before starting
                                                                                            </span>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    {% endfor %}
                                                                {% elif iteration.is_submitted %}
                                                                    <!-- Your Response -->
                                                                    <div class="relative mb-8">
                                                                        <div class="flex items-start space-x-3">
                                                                            <div class="flex-shrink-0">
                                                                                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center relative z-10">
                                                                                    <i class="fas fa-user text-white text-sm"></i>
                                                                                </div>
                                                                            </div>
                                                                            <div class="flex-1">
                                                                                <div class="bg-blue-50 rounded-lg p-4 border-l-4 border-blue-500">
                                                                                    <div class="flex items-center justify-between mb-2">
                                                                                        <div class="flex items-center space-x-2">
                                                                                            <span class="font-medium text-blue-700">Your Response</span>
                                                                                            <span class="text-xs text-blue-600">•</span>
                                                                                            <span class="text-xs text-blue-600">
                                                                                                {% if forloop.first and forloop.last %}
                                                                                                    Response
                                                                                                {% else %}
                                                                                                    Response #{{ iteration.iteration_number }}
                                                                                                {% endif %}
                                                                                            </span>
                                                                                        </div>
                                                                                        <span class="text-xs text-blue-600">
                                                                                            <i class="fas fa-clock mr-1"></i>
                                                                                            {{ iteration.submitted_at|date:"M d, Y \a\t g:i A" }}
                                                                                        </span>
                                                                                    </div>
                                                                                    <div class="text-gray-800 bg-white p-3 rounded border">
                                                                                        {{ iteration.answer_text|safe }}
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    
                                                                    <!-- Instructor Feedback -->
                                                                    {% for feedback in iteration.feedback_entries.all %}
                                                                        <div class="relative mb-8">
                                                                            <div class="flex items-start space-x-3">
                                                                                <div class="flex-shrink-0">
                                                                                    <div class="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center relative z-10">
                                                                                        <i class="fas fa-chalkboard-teacher text-white text-sm"></i>
                                                                                    </div>
                                                                                </div>
                                                                                <div class="flex-1">
                                                                                    <div class="bg-purple-50 rounded-lg p-4 border-l-4 border-purple-500">
                                                                                        <div class="flex items-center justify-between mb-2">
                                                                                            <div class="flex items-center space-x-2">
                                                                                                <span class="font-medium text-purple-700">Instructor Feedback</span>
                                                                                                <span class="text-xs text-purple-600">•</span>
                                                                                                <span class="text-xs text-purple-600">
                                                                                                    Feedback provided
                                                                                                </span>
                                                                                            </div>
                                                                                            <span class="text-xs text-purple-600">
                                                                                                <i class="fas fa-clock mr-1"></i>
                                                                                                {{ feedback.created_at|date:"M d, Y \a\t g:i A" }}
                                                                                            </span>
                                                                                        </div>
                                                                                        <div class="text-gray-800 bg-white p-3 rounded border">
                                                                                            {{ feedback.feedback_text|safe }}
                                                                                        </div>

                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    {% empty %}
                                                                        <!-- Awaiting Feedback -->
                                                                        {% if submission.status != 'graded' %}
                                                                        <div class="relative mb-8">
                                                                            <div class="flex items-start space-x-3">
                                                                                <div class="flex-shrink-0">
                                                                                    <div class="w-8 h-8 bg-orange-400 rounded-full flex items-center justify-center relative z-10">
                                                                                        <i class="fas fa-hourglass-half text-white text-sm"></i>
                                                                                    </div>
                                                                                </div>
                                                                                <div class="flex-1">
                                                                                    <div class="bg-orange-50 rounded-lg p-4 border-l-4 border-orange-400 border-dashed">
                                                                                        <div class="flex items-center space-x-2 mb-2">
                                                                                            <span class="font-medium text-orange-700">Awaiting Instructor Feedback</span>
                                                                                            <span class="text-xs text-orange-600">•</span>
                                                                                            <span class="text-xs text-orange-600">Response submitted</span>
                                                                                        </div>
                                                                                        <p class="text-sm text-orange-600">
                                                                                            <i class="fas fa-clock mr-1"></i>
                                                                                            Your instructor will review your response and provide feedback.
                                                                                        </p>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        {% endif %}
                                                                    {% endfor %}
                                                                {% endif %}
                                                            {% endfor %}
                                                            
                                                            <!-- New Response Section (if allowed) -->
                                                            {% if iteration_data.can_add_new %}
                                                                <div class="relative">
                                                                    <div class="flex items-start space-x-3">
                                                                        <div class="flex-shrink-0">
                                                                            <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center relative z-10">
                                                                                <i class="fas fa-plus text-white text-sm"></i>
                                                                            </div>
                                                                        </div>
                                                                        <div class="flex-1">
                                                                            <div class="bg-green-50 rounded-lg p-4 border-l-4 border-green-500">
                                                                                <div class="mb-3">
                                                                                    {% if submission.status == 'returned' %}
                                                                                        <span class="font-medium text-green-700">Submit Revised Response</span>
                                                                                        <span class="text-xs text-green-600 ml-2">• Assignment returned for revision</span>
                                                                                    {% else %}
                                                                                        <span class="font-medium text-green-700">Continue the Conversation</span>
                                                                                        <span class="text-xs text-green-600 ml-2">• Respond to instructor feedback</span>
                                                                                    {% endif %}
                                                                                </div>
                                                                                <textarea 
                                                                                    id="text_field_{{ field.id }}" 
                                                                                    name="text_field_{{ field.id }}" 
                                                                                    rows="5" 
                                                                                    class="w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 resize-y"
                                                                                    placeholder="{{ field.placeholder|default:'Enter your response here based on the instructor feedback...' }}"
                                                                                    {% if submission and submission.status == 'returned' %}autocomplete="on"{% else %}autocomplete="off"{% endif %} autocorrect="off" autocapitalize="off" spellcheck="false"></textarea>
                                                                                <div class="flex justify-between items-center mt-2">
                                                                                    <div class="text-sm text-green-600">
                                                                                        <i class="fas fa-info-circle mr-1"></i>This will be response #{{ iteration_data.total_iterations|add:1 }}
                                                                                    </div>
                                                                                    <div id="charCount_{{ field.id }}" class="text-xs text-gray-500">
                                                                                        <span id="charCountNumber_{{ field.id }}">0</span> characters
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            {% else %}
                                                                <!-- Cannot add new response -->
                                                                <div class="relative">
                                                                    <div class="flex items-start space-x-3">
                                                                        <div class="flex-shrink-0">
                                                                            <div class="w-8 h-8 bg-gray-400 rounded-full flex items-center justify-center relative z-10">
                                                                                <i class="fas fa-clock text-white text-sm"></i>
                                                                            </div>
                                                                        </div>
                                                                        <div class="flex-1">
                                                                            <div class="bg-gray-50 rounded-lg p-4 border-l-4 border-gray-400">
                                                                                <div class="text-sm text-gray-700">
                                                                                    <i class="fas fa-info-circle mr-1"></i>
                                                                                    Waiting for instructor feedback to continue the conversation
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            {% endif %}
                                                        {% else %}
                                                            <!-- Check for initial instructor guidance even if no iterations -->
                                                            {% for field_data in text_field_submissions %}
                                                                {% if field_data.field.id == field.id and field_data.answer and field_data.answer.iteration_number == 0 and not field_data.answer.is_submitted %}
                                                                    {% for feedback in field_data.answer.feedback_entries.all %}
                                                                        <div class="relative mb-8">
                                                                            <div class="flex items-start space-x-3">
                                                                                <div class="flex-shrink-0">
                                                                                    <div class="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center relative z-10">
                                                                                        <i class="fas fa-lightbulb text-white text-sm"></i>
                                                                                    </div>
                                                                                </div>
                                                                                <div class="flex-1">
                                                                                    <div class="bg-purple-50 rounded-lg p-4 border-l-4 border-purple-500">
                                                                                        <div class="flex items-center justify-between mb-2">
                                                                                            <div class="flex items-center space-x-2">
                                                                                                <span class="font-medium text-purple-700">Instructor Guidance</span>
                                                                                                <span class="text-xs text-purple-600">•</span>
                                                                                                <span class="text-xs text-purple-600">Initial feedback</span>
                                                                                            </div>
                                                                                            <span class="text-xs text-purple-600">
                                                                                                <i class="fas fa-clock mr-1"></i>
                                                                                                {{ feedback.created_at|date:"M d, Y \a\t g:i A" }}
                                                                                            </span>
                                                                                        </div>
                                                                                        <div class="text-gray-800 bg-white p-3 rounded border">
                                                                                            {{ feedback.feedback_text|safe }}
                                                                                        </div>
                                                                                        <div class="mt-2 flex items-center space-x-2">
                                                                                            <span class="inline-flex items-center px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">
                                                                                                <i class="fas fa-info-circle mr-1"></i>Please review before starting
                                                                                            </span>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    {% endfor %}
                                                                {% endif %}
                                                            {% endfor %}
                                                            <!-- No responses yet - first time -->
                                                            <div class="relative">
                                                                <div class="flex items-start space-x-3">
                                                                    <div class="flex-shrink-0">
                                                                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center relative z-10">
                                                                            <i class="fas fa-pencil-alt text-white text-sm"></i>
                                                                        </div>
                                                                    </div>
                                                                    <div class="flex-1">
                                                                        <div class="bg-blue-50 rounded-lg p-4 border-l-4 border-blue-500">
                                                                            <div class="mb-3">
                                                                                <span class="font-medium text-blue-700">Your Response</span>
                                                                                <span class="text-xs text-blue-600 ml-2">• First response</span>
                                                                            </div>
                                                                            <textarea 
                                                                                id="text_field_{{ field.id }}" 
                                                                                name="text_field_{{ field.id }}" 
                                                                                rows="5" 
                                                                                class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 resize-y"
                                                                                placeholder="{{ field.placeholder|default:'Enter your answer here...' }}"
                                                                                {% if submission %}autocomplete="on"{% else %}autocomplete="off"{% endif %} autocorrect="off" autocapitalize="off" spellcheck="false"></textarea>
                                                                            <div class="flex justify-end items-center mt-2">
                                                                                <div id="charCount_{{ field.id }}" class="text-xs text-gray-500">
                                                                                    <span id="charCountNumber_{{ field.id }}">0</span> characters
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        {% endif %}
                                                    {% endwith %}
                                                {% else %}
                                                    <!-- No submission yet - first time -->
                                                    <div class="relative">
                                                        <div class="flex items-start space-x-3">
                                                            <div class="flex-shrink-0">
                                                                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center relative z-10">
                                                                    <i class="fas fa-pencil-alt text-white text-sm"></i>
                                                                </div>
                                                            </div>
                                                            <div class="flex-1">
                                                                <div class="bg-blue-50 rounded-lg p-4 border-l-4 border-blue-500">
                                                                    <div class="mb-3">
                                                                        <span class="font-medium text-blue-700">Your Response</span>
                                                                        <span class="text-xs text-blue-600 ml-2">• First response</span>
                                                                    </div>
                                                                    <textarea 
                                                                        id="text_field_{{ field.id }}" 
                                                                        name="text_field_{{ field.id }}" 
                                                                        rows="5" 
                                                                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 resize-y"
                                                                        placeholder="{{ field.placeholder|default:'Enter your answer here...' }}"></textarea>
                                                                    <div class="flex justify-end items-center mt-2">
                                                                        <div id="charCount_{{ field.id }}" class="text-xs text-gray-500">
                                                                            <span id="charCountNumber_{{ field.id }}">0</span> characters
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Initial Response Section (Only show if assignment has not been returned and has text fields) -->
                    {% if assignment.text_fields.exists and not submission or assignment.text_fields.exists and submission and submission.status != 'returned' and not field_iteration_data %}
                    <div class="bg-white border border-gray-200 rounded-lg shadow-sm mb-6">
                        <div class="border-b border-gray-200 bg-blue-50 px-4 py-3">
                            <h2 class="text-lg font-semibold text-gray-800">
                                <i class="fas fa-edit text-blue-500 mr-2"></i>
                                Assignment Questions
                            </h2>
                            <p class="text-sm text-gray-600 mt-1">Please answer all questions below</p>
                        </div>
                        <div class="p-4 space-y-6">
                            {% for field in assignment.text_fields.all %}
                                <div class="border border-gray-200 rounded-lg p-4">
                                    <div class="mb-3">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            Question {{ forloop.counter }}
                                        </label>
                                        <div class="text-gray-800 bg-gray-50 p-3 rounded border mb-4">
                                            {% if field.content.html %}
                                                {{ field.content.html|safe }}
                                            {% elif field.label %}
                                                {{ field.label }}
                                            {% else %}
                                                Question content not available
                                            {% endif %}
                                        </div>
                                    </div>
                                    <textarea 
                                        id="text_field_{{ field.id }}" 
                                        name="text_field_{{ field.id }}" 
                                        rows="5" 
                                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 resize-y"
                                        placeholder="{{ field.placeholder|default:'Enter your answer here...' }}"></textarea>
                                    <div class="flex justify-end items-center mt-2">
                                        <div id="charCount_{{ field.id }}" class="text-xs text-gray-500">
                                            <span id="charCountNumber_{{ field.id }}">0</span> characters
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- File Upload Section with Timeline (if applicable) -->
                    {% if assignment.submission_type in 'file,both'|split:',' %}
                    <div class="mb-6">
                        <!-- Collapsible Header -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 cursor-pointer hover:bg-blue-100 transition-colors mb-3"
                             onclick="toggleFileUploadTimeline()">
                            <h3 class="text-lg font-medium text-gray-700 flex items-center justify-between">
                                <div class="flex items-center">
                                    <i id="file-upload-icon" class="fas fa-chevron-right mr-2 text-blue-600 transition-transform duration-200"></i>
                                    <i class="fas fa-upload mr-2 text-blue-600"></i>
                                    File Upload Timeline
                                    {% if assignment.submission_type == 'file' and not submission.submission_file and not file_iteration_data.has_iterations %}
                                        <span class="text-red-600 ml-1">*</span>
                                        <span class="ml-2 px-2 py-0.5 bg-red-100 text-red-700 text-xs font-semibold rounded-full">Required</span>
                                    {% endif %}
                                    {% if file_iteration_data.has_iterations %}
                                        <span class="text-sm font-normal text-gray-600 ml-2">({{ file_iteration_data.iterations|length }} file{{ file_iteration_data.iterations|length|pluralize }})</span>
                                    {% else %}
                                        <span class="text-sm font-normal text-gray-600 ml-2">(No files uploaded yet)</span>
                                    {% endif %}
                                </div>
                                <span class="text-sm text-blue-600 font-normal">
                                    <i class="fas fa-eye mr-1"></i>Click to view/hide
                                </span>
                            </h3>
                        </div>
                        
                        <!-- File Timeline Container (Collapsible) -->
                        <div id="file-upload-timeline" class="hidden bg-white border border-gray-200 rounded-lg shadow-sm transition-all duration-300 ease-in-out">
                            <div class="border-b border-gray-200 bg-gray-50 px-4 py-3">
                                <h4 class="text-base font-medium text-gray-800">
                                    <i class="fas fa-history text-blue-500 mr-2"></i>
                                    File Submission History
                                </h4>
                                <p class="text-sm text-gray-600 mt-1">Track your file uploads and instructor feedback</p>
                            </div>
                            
                            <div class="p-4">
                                <!-- Timeline Content -->
                                <div class="relative">
                                    <!-- Timeline Line -->
                                    <div class="absolute left-4 top-0 bottom-0 w-0.5 bg-gray-300"></div>
                                    
                                    {% if file_iteration_data.has_iterations %}
                                        <!-- Display file iterations in timeline -->
                                        {% for iteration_data in file_iteration_data.iterations %}
                                            <!-- File Upload Item -->
                                            <div class="relative mb-8">
                                                <div class="flex items-start space-x-3">
                                                    <div class="flex-shrink-0">
                                                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center relative z-10">
                                                            <i class="fas fa-file text-white text-sm"></i>
                                                        </div>
                                                    </div>
                                                    <div class="flex-1">
                                                        <div class="bg-blue-50 rounded-lg p-4 border-l-4 border-blue-500">
                                                            <div class="flex justify-between items-start mb-2">
                                                                <div>
                                                                    <span class="font-medium text-blue-700">File Upload #{{ iteration_data.iteration.iteration_number }}</span>
                                                                    <span class="text-xs text-blue-600 ml-2">• {{ iteration_data.iteration.submitted_at|date:"M d, Y H:i" }}</span>
                                                                </div>
                                                                <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">
                                                                    Submitted
                                                                </span>
                                                            </div>
                                                            
                                                            <!-- File Details -->
                                                            {% if iteration_data.iteration.file %}
                                                            <div class="flex items-center space-x-4 text-sm">
                                                                <span class="flex items-center text-gray-700">
                                                                    <i class="fas fa-file-{% if iteration_data.file_extension == 'pdf' %}pdf{% elif iteration_data.file_extension in 'jpg,jpeg,png,gif'|split:',' %}image{% elif iteration_data.file_extension in 'mp4,mov,avi'|split:',' %}video{% else %}alt{% endif %} mr-1"></i>
                                                                    {{ iteration_data.iteration.file_name|default:iteration_data.iteration.file.name|truncatechars:30 }}
                                                                </span>
                                                                <span class="text-gray-500">
                                                                    {{ iteration_data.iteration.file_size|default:iteration_data.iteration.file|safe_file_size|filesizeformat }}
                                                                </span>
                                                                <a href="{{ iteration_data.iteration.file.url }}" 
                                                                   class="text-blue-600 hover:text-blue-800 underline" 
                                                                   target="_blank">
                                                                    <i class="fas fa-download mr-1"></i>Download
                                                                </a>
                                                            </div>
                                                            {% else %}
                                                            <div class="text-sm text-gray-500 italic">
                                                                File not available
                                                            </div>
                                                            {% endif %}
                                                            
                                                            {% if iteration_data.iteration.description %}
                                                            <div class="mt-2 text-sm text-gray-600">
                                                                {{ iteration_data.iteration.description }}
                                                            </div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Instructor Feedback for this iteration -->
                                            {% if iteration_data.latest_feedback %}
                                            <div class="relative mb-8">
                                                <div class="flex items-start space-x-3">
                                                    <div class="flex-shrink-0">
                                                        <div class="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center relative z-10">
                                                            <i class="fas fa-user-tie text-white text-sm"></i>
                                                        </div>
                                                    </div>
                                                    <div class="flex-1">
                                                        <div class="bg-purple-50 rounded-lg p-4 border-l-4 border-purple-500">
                                                            <div class="flex justify-between items-start mb-2">
                                                                <div>
                                                                    <span class="font-medium text-purple-700">Instructor Feedback</span>
                                                                    <span class="text-xs text-purple-600 ml-2">• {{ iteration_data.latest_feedback.created_at|date:"M d, Y H:i" }}</span>
                                                                </div>
                                                                <span class="px-2 py-1 {% if iteration_data.latest_feedback.allows_new_iteration %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %} text-xs rounded-full">
                                                                    {% if iteration_data.latest_feedback.allows_new_iteration %}
                                                                        <i class="fas fa-check mr-1"></i>Revision Allowed
                                                                    {% else %}
                                                                        <i class="fas fa-times mr-1"></i>No Revision
                                                                    {% endif %}
                                                                </span>
                                                            </div>
                                                            <div class="text-sm text-gray-700">
                                                                {{ iteration_data.latest_feedback.feedback_text|safe }}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                    
                                    <!-- Current Upload Section -->
                                    {% if not submission or submission.can_be_edited_by_student or submission.status == 'returned' %}
                                        {% if not file_iteration_data.has_iterations or file_iteration_data.can_upload_new %}
                                        <div class="relative">
                                            <div class="flex items-start space-x-3">
                                                <div class="flex-shrink-0">
                                                    <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center relative z-10">
                                                        <i class="fas fa-plus text-white text-sm"></i>
                                                    </div>
                                                </div>
                                                <div class="flex-1">
                                                    <div class="bg-green-50 rounded-lg p-4 border-l-4 border-green-500">
                                                        <div class="mb-3">
                                                            <span class="font-medium text-green-700">
                                                                {% if file_iteration_data.has_iterations %}Upload New Version{% else %}Upload Your File{% endif %}
                                                                {% if assignment.submission_type == 'file' and not submission.submission_file and not file_iteration_data.has_iterations %}
                                                                    <span class="text-red-600">*</span>
                                                                {% elif assignment.submission_type == 'file' and submission and submission.status == 'returned' and file_iteration_data.has_iterations %}
                                                                    <span class="text-red-600">*</span>
                                                                {% endif %}
                                                            </span>
                                                            <span class="text-xs text-green-600 ml-2">
                                                                • {% if file_iteration_data.has_iterations %}Version {{ file_iteration_data.iterations|length|add:1 }}{% else %}First submission{% endif %}
                                                            </span>
                                                            {% if assignment.submission_type == 'file' and not submission.submission_file and not file_iteration_data.has_iterations %}
                                                                <span class="text-xs text-red-600 block mt-1">
                                                                    <i class="fas fa-exclamation-circle mr-1"></i>Required field
                                                                </span>
                                                            {% elif assignment.submission_type == 'file' and submission and submission.status == 'returned' and file_iteration_data.has_iterations %}
                                                                <span class="text-xs text-red-600 block mt-1">
                                                                    <i class="fas fa-exclamation-circle mr-1"></i>Required - Please upload a new version
                                                                </span>
                                                            {% endif %}
                                                        </div>
                                                        
                                                        <div class="relative">
                                                            <input type="file" 
                                                                   id="submission_file" 
                                                                   name="submission_file" 
                                                                   accept="{{ assignment.allowed_file_types }}"
                                                                   {% if assignment.submission_type == 'file' and not submission.submission_file and not file_iteration_data.has_iterations %}required{% endif %}
                                                                   {% if assignment.submission_type == 'file' and submission and submission.status == 'returned' and file_iteration_data.has_iterations %}required{% endif %}
                                                                   class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-green-50 file:text-green-700 hover:file:bg-green-100 border border-green-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                                        </div>
                                                        
                                                        <!-- File Validation Message -->
                                                        <div id="fileValidationMessage" class="hidden mt-2 text-sm font-medium"></div>
                                                        
                                                        <!-- File Type and Size Information -->
                                                        <div class="mt-2 text-xs text-green-600">
                                                            <div>Allowed file types: {{ assignment.allowed_file_types }}</div>
                                                            <div>Maximum file size: {% if assignment.max_file_size %}{{ assignment.max_file_size|add:0|filesizeformat }}{% else %}100 MB{% endif %}</div>
                                                        </div>
                                                        
                                                        <!-- File Upload Validation Messages -->
                                                        <div id="fileValidationMessage" class="mt-2 text-sm hidden"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% else %}
                                        <!-- Upload Disabled Message -->
                                        <div class="relative">
                                            <div class="flex items-start space-x-3">
                                                <div class="flex-shrink-0">
                                                    <div class="w-8 h-8 bg-gray-400 rounded-full flex items-center justify-center relative z-10">
                                                        <i class="fas fa-ban text-white text-sm"></i>
                                                    </div>
                                                </div>
                                                <div class="flex-1">
                                                    <div class="bg-gray-50 rounded-lg p-4 border-l-4 border-gray-400">
                                                        <div class="mb-2">
                                                            <span class="font-medium text-gray-700">Upload Disabled</span>
                                                            <span class="text-xs text-gray-600 ml-2">• Awaiting instructor feedback</span>
                                                        </div>
                                                        <div class="text-sm text-gray-600">
                                                            Your instructor needs to review your latest submission before you can upload a new version.
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    

                    
                    <!-- Unified Submit Button -->
                    <div class="flex justify-end">
                        {% if submission and not submission.can_be_edited_by_student and submission.status != 'returned' %}
                            <!-- No submit button when locked -->
                        {% else %}
                            <button type="submit" 
                                    name="submit_assignment" 
                                    id="unifiedSubmitBtn"
                                    class="{% if submission and submission.status == 'returned' %}px-8 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700{% else %}px-8 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700{% endif %} shadow-md flex items-center justify-center transition-all font-medium">
                                {% if submission and submission.status == 'returned' %}
                                    <i class="fas fa-redo mr-2"></i>
                                    Submit Revised Response
                                {% else %}
                                    <i class="fas fa-paper-plane mr-2"></i>
                                    {% if submission %}
                                        {% if submission.status == 'draft' %}Update Submission{% else %}Update Submission{% endif %}
                                    {% else %}
                                        Submit Assignment
                                    {% endif %}
                                {% endif %}
                            </button>
                        {% endif %}
                    </div>
                </form>
            </div>
                {% endif %}
            {% endif %}



            <!-- Display Text Submission Content -->
            {% if submission and submission.submission_text %}
            <div class="bg-gray-100 rounded p-6 mt-4">
                <h2 class="text-xl font-semibold mb-3 text-gray-800">Text Submission Content</h2>
                <div class="prose max-w-none bg-white p-4 rounded-lg border text-gray-700">
                    {{ submission.submission_text|render_rich_content }}
                </div>
            </div>
            {% endif %}


        </div>
    </div>
</div>

<script>
function countChars(textarea) {
    const fieldId = textarea.id.split('_')[2];
    const counter = document.getElementById('charCount_' + fieldId);
    const count = textarea.value.length;
    
    counter.textContent = count + ' characters';
    
    if (count < 10) {
        counter.classList.add('text-red-500');
        counter.classList.remove('text-gray-500');
    } else {
        counter.classList.remove('text-red-500');
        counter.classList.add('text-gray-500');
    }
}

// Toggle rubric section visibility
function toggleRubric() {
    const rubricSection = document.getElementById('rubricSection');
    const rubricIcon = document.getElementById('rubricIcon');
    
    if (rubricSection.classList.contains('hidden')) {
        rubricSection.classList.remove('hidden');
        rubricIcon.classList.remove('fa-chevron-down');
        rubricIcon.classList.add('fa-chevron-up');
    } else {
        rubricSection.classList.add('hidden');
        rubricIcon.classList.remove('fa-chevron-up');
        rubricIcon.classList.add('fa-chevron-down');
    }
}

// Initialize character counts on page load and add auto-save
document.addEventListener('DOMContentLoaded', function() {
    // Handle text fields with combined functionality
    const textareas = document.querySelectorAll('textarea[id^="text_field_"]');
    textareas.forEach(function(textarea) {
        // Initial character count
        countChars(textarea);
        updateCharacterCount(textarea);
        
        // Auto-save functionality with restored content check
        const fieldId = textarea.id.split('_')[2];
        const storageKey = `assignment_{{ assignment.id|escapejs }}_field_${fieldId}_autosave`;
        
        // Restore from localStorage if no server value
        if (!textarea.value.trim()) {
            const savedValue = localStorage.getItem(storageKey);
            if (savedValue) {
                textarea.value = savedValue;
                countChars(textarea);
                updateCharacterCount(textarea);
            }
        }
        
        // Combined input event handler for character counting and auto-save
        let saveTimeout;
        textarea.addEventListener('input', function() {
            // Update character counts
            countChars(this);
            updateCharacterCount(this);
            
            // Auto-save with debounce
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                localStorage.setItem(storageKey, this.value);
                
                // Show auto-save indicator
                const indicator = document.getElementById(`autosave_${fieldId}`);
                if (!indicator) {
                    const newIndicator = document.createElement('div');
                    newIndicator.id = `autosave_${fieldId}`;
                    newIndicator.className = 'text-xs text-green-600 mt-1';
                    newIndicator.innerHTML = '<i class="fas fa-save mr-1"></i>Auto-saved';
                    this.parentNode.appendChild(newIndicator);
                    
                    // Remove indicator after 3 seconds
                    setTimeout(() => {
                        newIndicator.remove();
                    }, 3000);
                }
            }, 1000);
        });
    });
    
    // Handle text questions
    const questionTextareas = document.querySelectorAll('textarea[id^="text_question_"]');
    questionTextareas.forEach(function(textarea) {
        // Initial character count
        countQuestionChars(textarea);
        
        // Auto-save functionality
        textarea.addEventListener('input', function() {
            countQuestionChars(this);
            const questionId = this.id.split('_')[2]; // Extract question ID from text_question_X
            const storageKey = `assignment_{{ assignment.id|escapejs }}_question_${questionId}_autosave`;
            
            // Save to localStorage
            localStorage.setItem(storageKey, this.value);
            
            // Show auto-save indicator
            const indicator = document.getElementById(`autosave_question_${questionId}`);
            if (!indicator) {
                const newIndicator = document.createElement('div');
                newIndicator.id = `autosave_question_${questionId}`;
                newIndicator.className = 'text-xs text-green-600 mt-1';
                newIndicator.innerHTML = '<i class="fas fa-save mr-1"></i>Auto-saved';
                this.parentNode.appendChild(newIndicator);
                
                // Remove indicator after 3 seconds
                setTimeout(() => {
                    newIndicator.remove();
                }, 3000);
            }
        });
        
        // Restore from localStorage if no server value
        if (!textarea.value.trim()) {
            const questionId = textarea.id.split('_')[2];
            const storageKey = `assignment_{{ assignment.id|escapejs }}_question_${questionId}_autosave`;
            const savedValue = localStorage.getItem(storageKey);
            if (savedValue) {
                textarea.value = savedValue;
                countQuestionChars(textarea);
            }
        }
    });
});

// Character count function for text questions
function countQuestionChars(textarea) {
    const questionId = textarea.id.split('_')[2];
    const counter = document.getElementById('charCountQuestionNumber_' + questionId);
    if (counter) {
        const count = textarea.value.length;
        counter.textContent = count;
        
        const counterContainer = document.getElementById('charCountQuestion_' + questionId);
        if (counterContainer) {
            if (count < 10) {
                counterContainer.classList.add('text-red-500');
                counterContainer.classList.remove('text-gray-500');
            } else {
                counterContainer.classList.remove('text-red-500');
                counterContainer.classList.add('text-gray-500');
            }
        }
    }
}

// Unified form validation and handling
document.addEventListener('DOMContentLoaded', function() {
    const unifiedSubmissionForm = document.getElementById('unifiedSubmissionForm');
    const unifiedSubmitBtn = document.getElementById('unifiedSubmitBtn');
    const textareas = document.querySelectorAll('textarea[id^="text_field_"]');
    const fileInput = document.getElementById('submission_file');
    const submissionType = '{{ assignment.submission_type|escapejs }}';
    const hasExistingFile = {% if submission and submission.submission_file %}true{% else %}false{% endif %};
    
    if (unifiedSubmissionForm) {
        unifiedSubmissionForm.addEventListener('submit', function(event) {
            let valid = true;
            let firstInvalidField = null;
            
            // File validation function
            function validateFile(file) {
                const allowedTypes = '{{ assignment.allowed_file_types|escapejs }}'.split(',');
                const maxSize = {{ assignment.max_file_size|default:104857600 }}; // Default to 100MB
                
                // Check file type
                const fileExtension = file.name.split('.').pop().toLowerCase();
                if (!allowedTypes.includes('.' + fileExtension)) {
                    return {
                        valid: false,
                        message: `File type not allowed. Allowed types: {{ assignment.allowed_file_types }}`
                    };
                }
                
                // Check file size
                if (file.size > maxSize) {
                    const maxSizeMB = maxSize / (1024 * 1024);
                    return {
                        valid: false,
                        message: `File size exceeds the maximum allowed size (${maxSizeMB}MB)`
                    };
                }
                
                return { valid: true };
            }
            
            // Show validation message
            function showValidationMessage(message, isError) {
                const messageDiv = document.getElementById('fileValidationMessage');
                if (messageDiv) {
                    messageDiv.innerHTML = message;
                    messageDiv.classList.remove('hidden', 'text-green-600', 'text-red-600');
                    messageDiv.classList.add(isError ? 'text-red-600' : 'text-green-600');
                }
            }
            
            // Reset submit button to original state
            function resetSubmitButton() {
                if (unifiedSubmitBtn) {
                    unifiedSubmitBtn.disabled = false;
                    if ({% if submission and submission.status == 'returned' %}true{% else %}false{% endif %}) {
                        unifiedSubmitBtn.innerHTML = '<i class="fas fa-redo mr-2"></i>Submit Revised Response';
                    } else {
                        unifiedSubmitBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>{% if submission %}Update Submission{% else %}Submit Assignment{% endif %}';
                    }
                }
            }
            
            // Enhanced validation based on submission_type
            const file = fileInput ? fileInput.files[0] : null;
            const hasFileIterations = {% if file_iteration_data.has_iterations %}true{% else %}false{% endif %};
            const isReturnedForRevision = {% if submission and submission.status == 'returned' %}true{% else %}false{% endif %};
            const hasSubmissionText = document.getElementById('submission_text');
            const submissionTextValue = hasSubmissionText ? hasSubmissionText.value.trim() : '';
            let validationErrors = [];
            
            // Check if any text fields have content
            let hasTextFieldContent = false;
            textareas.forEach(function(textarea) {
                if (textarea.value.trim().length > 0) {
                    hasTextFieldContent = true;
                }
            });
            
            // Validation for 'file' type assignments
            if (submissionType === 'file') {
                // If assignment is returned for revision with file iterations, require new file upload
                if (isReturnedForRevision && hasFileIterations && !file) {
                    validationErrors.push('Please upload a new version of your file for the revised submission.');
                    valid = false;
                }
                // Original validation for first submission
                else if (!file && !hasExistingFile && !hasFileIterations) {
                    validationErrors.push('A file submission is required for this assignment.');
                    valid = false;
                }
            }
            
            // Validation for 'both' type assignments
            else if (submissionType === 'both') {
                if (!file && !submissionTextValue && !hasExistingFile && !hasFileIterations && !hasTextFieldContent) {
                    validationErrors.push('Either a file or text submission (or both) is required for this assignment.');
                    valid = false;
                }
            }
            
            // Validation for 'text' type assignments
            else if (submissionType === 'text') {
                if (!submissionTextValue && !hasTextFieldContent) {
                    validationErrors.push('A text submission is required for this assignment.');
                    valid = false;
                }
            }
            
            // If file is provided, validate its properties
            if (file) {
                const validation = validateFile(file);
                if (!validation.valid) {
                    validationErrors.push(validation.message);
                    valid = false;
                }
            }
            
            // Handle validation errors
            if (!valid) {
                event.preventDefault();
                resetSubmitButton();
                
                // Show validation errors
                if (validationErrors.length > 0) {
                    // Create user-friendly alert message
                    let alertMessage = 'Please fix the following issues before submitting:\n\n';
                    validationErrors.forEach((error, index) => {
                        alertMessage += `• ${error}\n`;
                    });
                    
                    // Show alert
                    alert(alertMessage);
                    
                    // Show inline validation message
                    showValidationMessage(validationErrors[0], true);
                    
                    // Scroll to the relevant field
                    if (validationErrors.some(e => e.includes('file'))) {
                        if (fileInput) {
                            fileInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            setTimeout(() => {
                                const fileUploadContainer = fileInput.closest('.mb-6');
                                if (fileUploadContainer) {
                                    fileUploadContainer.classList.add('ring-2', 'ring-red-500', 'rounded-lg');
                                    setTimeout(() => {
                                        fileUploadContainer.classList.remove('ring-2', 'ring-red-500');
                                    }, 3000);
                                }
                            }, 100);
                        }
                    } else if (hasSubmissionText) {
                        hasSubmissionText.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
                return;
            } else {
                // Clear any previous validation messages
                showValidationMessage('', false);
            }
            
            // Show loading state
            if (unifiedSubmitBtn) {
                unifiedSubmitBtn.disabled = true;
                unifiedSubmitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Submitting...';
            }
            
            // Clear auto-save data on successful submission
            textareas.forEach(function(textarea) {
                const fieldId = textarea.id.split('_')[2];
                const storageKey = `assignment_{{ assignment.id|escapejs }}_field_${fieldId}_autosave`;
                localStorage.removeItem(storageKey);
            });
        });
    }
    
    // Add safety mechanism to reset button state on page unload
    window.addEventListener('beforeunload', function() {
        if (unifiedSubmitBtn) {
            unifiedSubmitBtn.disabled = false;
            if ({% if submission and submission.status == 'returned' %}true{% else %}false{% endif %}) {
                unifiedSubmitBtn.innerHTML = '<i class="fas fa-redo mr-2"></i>Submit Revised Response';
            } else {
                unifiedSubmitBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>{% if submission %}Update Submission{% else %}Submit Assignment{% endif %}';
            }
        }
    });
    
    // Real-time file validation feedback
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            const messageDiv = document.getElementById('fileValidationMessage');
            
            if (!messageDiv) return;
            
            if (!file) {
                messageDiv.classList.add('hidden');
                return;
            }
            
            // Validate file type
            const allowedTypes = '{{ assignment.allowed_file_types|escapejs }}'.split(',').map(t => t.trim());
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            
            if (!allowedTypes.includes(fileExtension)) {
                messageDiv.innerHTML = '<i class="fas fa-exclamation-circle mr-1"></i>File type not allowed. Allowed types: {{ assignment.allowed_file_types }}';
                messageDiv.classList.remove('hidden', 'text-green-600');
                messageDiv.classList.add('text-red-600');
                return;
            }
            
            // Validate file size
            const maxSize = {{ assignment.max_file_size|default:104857600 }};
            if (file.size > maxSize) {
                const maxSizeMB = (maxSize / (1024 * 1024)).toFixed(1);
                messageDiv.innerHTML = '<i class="fas fa-exclamation-circle mr-1"></i>File size exceeds the maximum allowed size (' + maxSizeMB + ' MB)';
                messageDiv.classList.remove('hidden', 'text-green-600');
                messageDiv.classList.add('text-red-600');
                return;
            }
            
            // File is valid
            const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
            messageDiv.innerHTML = '<i class="fas fa-check-circle mr-1"></i>File selected: ' + file.name + ' (' + fileSizeMB + ' MB)';
            messageDiv.classList.remove('hidden', 'text-red-600');
            messageDiv.classList.add('text-green-600');
        });
    }
});

// Character counting functionality for text fields
function updateCharacterCount(textarea) {
    const fieldId = textarea.id.split('_')[2];
    const charCountElement = document.getElementById('charCountNumber_' + fieldId);
    if (charCountElement) {
        charCountElement.textContent = textarea.value.length;
    }
}

// Comment functionality
function toggleEditComment(commentId) {
    const content = document.getElementById('comment-content-' + commentId);
    const editForm = document.getElementById('edit-form-' + commentId);
    
    if (editForm.classList.contains('hidden')) {
        content.classList.add('hidden');
        editForm.classList.remove('hidden');
        // Focus on the textarea
        const textarea = editForm.querySelector('textarea');
        if (textarea) {
            textarea.focus();
        }
    } else {
        content.classList.remove('hidden');
        editForm.classList.add('hidden');
    }
}

function toggleReplyForm(commentId) {
    const replyForm = document.getElementById('reply-form-' + commentId);
    
    if (replyForm.classList.contains('hidden')) {
        replyForm.classList.remove('hidden');
        const textarea = replyForm.querySelector('textarea');
        if (textarea) {
            textarea.focus();
        }
    } else {
        replyForm.classList.add('hidden');
    }
}

// This auto-save functionality is now handled by the main implementation above
// to avoid conflicts and duplicate event listeners

// Quiz Accordion Toggle Function
function toggleQuizAccordion(contentId) {
    const content = document.getElementById(contentId);
    const icon = document.getElementById('quiz_icon_' + contentId.replace('quiz_field_', ''));
    
    if (content) {
        if (content.classList.contains('hidden')) {
            // Close all other accordions first
            document.querySelectorAll('[id^="quiz_field_"]').forEach(function(el) {
                if (el.id !== contentId) {
                    el.classList.add('hidden');
                    const otherIcon = document.getElementById('quiz_icon_' + el.id.replace('quiz_field_', ''));
                    if (otherIcon) {
                        otherIcon.classList.remove('fa-chevron-down');
                        otherIcon.classList.add('fa-chevron-right');
                    }
                }
            });
            
            // Open this accordion
            content.classList.remove('hidden');
            if (icon) {
                icon.classList.remove('fa-chevron-right');
                icon.classList.add('fa-chevron-down');
            }
        } else {
            // Close this accordion
            content.classList.add('hidden');
            if (icon) {
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-right');
            }
        }
    }
}

// Timeline Accordion Toggle Function
function toggleTimelineAccordion(contentId) {
    const content = document.getElementById(contentId);
    const icon = document.getElementById('student_timeline_icon_' + contentId.replace('student_timeline_', ''));
    
    if (content) {
        if (content.classList.contains('hidden')) {
            // Close all other accordions first
            document.querySelectorAll('[id^="student_timeline_"]').forEach(function(el) {
                if (el.id !== contentId) {
                    el.classList.add('hidden');
                    const otherIcon = document.getElementById('student_timeline_icon_' + el.id.replace('student_timeline_', ''));
                    if (otherIcon) {
                        otherIcon.classList.remove('fa-chevron-down');
                        otherIcon.classList.add('fa-chevron-right');
                    }
                }
            });
            
            // Open this accordion
            content.classList.remove('hidden');
            if (icon) {
                icon.classList.remove('fa-chevron-right');
                icon.classList.add('fa-chevron-down');
            }
        } else {
            // Close this accordion
            content.classList.add('hidden');
            if (icon) {
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-right');
            }
        }
    }
}

// Instructor Feedback Timeline Toggle Function
function toggleInstructorFeedbackTimeline() {
    const timeline = document.getElementById('instructor-feedback-timeline');
    const icon = document.getElementById('instructor-feedback-icon');
    
    if (timeline && icon) {
        if (timeline.classList.contains('hidden')) {
            timeline.classList.remove('hidden');
            icon.classList.remove('fa-chevron-right');
            icon.classList.add('fa-chevron-down');
        } else {
            timeline.classList.add('hidden');
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-right');
        }
    }
}

// Rubric Evaluation Timeline Toggle Function
function toggleRubricEvaluationTimeline() {
    const timeline = document.getElementById('rubric-evaluation-timeline-content');
    const icon = document.getElementById('rubric-evaluation-icon');
    
    if (timeline && icon) {
        if (timeline.classList.contains('hidden')) {
            timeline.classList.remove('hidden');
            icon.classList.remove('fa-chevron-right');
            icon.classList.add('fa-chevron-down');
            // Calculate percentages when timeline is opened
            calculateRubricPercentages();
        } else {
            timeline.classList.add('hidden');
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-right');
        }
    }
}

// Criterion Accordion Toggle Function
function toggleCriterionAccordion(contentId) {
    const content = document.getElementById(contentId);
    const iconId = contentId.replace('student_criterion_', 'student_criterion_icon_');
    const icon = document.getElementById(iconId);
    
    if (content) {
        if (content.classList.contains('hidden')) {
            // Open this criterion
            content.classList.remove('hidden');
            if (icon) {
                icon.classList.remove('fa-chevron-right');
                icon.classList.add('fa-chevron-down');
            }
        } else {
            // Close this criterion
            content.classList.add('hidden');
            if (icon) {
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-right');
            }
        }
    }
}

// Calculate and display rubric evaluation percentages
function calculateRubricPercentages() {
    const percentageDisplays = document.querySelectorAll('.percentage-display');
    percentageDisplays.forEach(display => {
        const points = parseFloat(display.dataset.points) || 0;
        const maxPoints = parseFloat(display.dataset.max) || 1;
        const percentage = Math.round((points / maxPoints) * 100);
        
        // Update the text to show percentage
        display.textContent = `${percentage.toFixed(1)}% (${points}/${maxPoints})`;
        
        // Add color coding to the parent performance div
        const performanceDiv = display.previousElementSibling;
        if (performanceDiv) {
            performanceDiv.classList.remove('text-gray-800', 'text-green-600', 'text-yellow-600', 'text-red-600');
            if (percentage >= 80) {
                performanceDiv.classList.add('text-green-600');
            } else if (percentage >= 60) {
                performanceDiv.classList.add('text-yellow-600');
            } else {
                performanceDiv.classList.add('text-red-600');
            }
        }
    });
}

// File Upload Timeline Toggle Function
function toggleFileUploadTimeline() {
    const timeline = document.getElementById('file-upload-timeline');
    const icon = document.getElementById('file-upload-icon');
    
    if (timeline && icon) {
        if (timeline.classList.contains('hidden')) {
            timeline.classList.remove('hidden');
            icon.classList.remove('fa-chevron-right');
            icon.classList.add('fa-chevron-down');
        } else {
            timeline.classList.add('hidden');
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-right');
        }
    }
}

// Toggle submission comments section for learners
function toggleSubmissionComments(submissionId) {
    const commentsSection = document.getElementById(`submission-comments-${submissionId}`);
    const btnText = document.getElementById(`comments-btn-text-${submissionId}`);
    const commentsCount = document.getElementById(`comments-count-${submissionId}`);
    
    // Check if there are any comments by looking for the count element
    const hasComments = commentsCount && commentsCount.textContent.trim() !== '0';
    
    if (commentsSection && commentsSection.classList.contains('hidden')) {
        // Show comments
        commentsSection.classList.remove('hidden');
        if (btnText) {
            btnText.textContent = hasComments ? 'Hide Feedback' : 'Hide Discussion';
        }
        
        // Scroll to the comments section smoothly
        setTimeout(() => {
            commentsSection.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'nearest' 
            });
        }, 100);
    } else if (commentsSection) {
        // Hide comments
        commentsSection.classList.add('hidden');
        if (btnText) {
            btnText.textContent = hasComments ? 'View Feedback' : 'Discussion';
        }
    }
}

// Rubric Range Display Functionality (simple text display)
document.addEventListener('DOMContentLoaded', function() {
    // Initialize rubric range display
    initializeRubricRangeDisplay();
});

function initializeRubricRangeDisplay() {
    document.querySelectorAll('.criterion-ratings-cell').forEach(cell => {
        const criterionId = cell.dataset.criterionId;
        const useRange = cell.dataset.useRange === 'true';
        
        if (useRange) {
            updateRatingPointsDisplay(criterionId, useRange);
        }
    });
}

function updateRatingPointsDisplay(criterionId, useRange) {
    const cell = document.querySelector(`[data-criterion-id="${criterionId}"]`);
    if (!cell) return;
    
    const ratingItems = cell.querySelectorAll('.rating-item');
    
    // Create an array of ratings sorted by points (descending)
    const ratings = Array.from(ratingItems).map(item => {
        return {
            element: item,
            points: parseFloat(item.dataset.points) || 0
        };
    }).sort((a, b) => b.points - a.points);
    
    if (useRange) {
        // Display in range format
        ratings.forEach((rating, index) => {
            const pointsElement = rating.element.querySelector('.rating-points');
            const currentPoints = rating.points;
            
            if (index < ratings.length - 1) {
                // Not the last rating - show range to next lower rating
                const nextLowerPoints = ratings[index + 1].points;
                pointsElement.textContent = `${currentPoints} to >${nextLowerPoints} Pts`;
            } else {
                // Last rating - show range to 0
                pointsElement.textContent = `${currentPoints} to >0 Pts`;
            }
        });
    } else {
        // Display in standard format
        ratings.forEach((rating, index) => {
            const pointsElement = rating.element.querySelector('.rating-points');
            const points = rating.points;
            pointsElement.textContent = `${points} Pts`;
        });
    }
}
</script>

<style>
/* Simple range mode styling */
.criterion-ratings-cell .rating-points {
    font-weight: 500;
}
</style>
{% endblock %} 