{% extends 'base.html' %}
{% load static %}

{% block title %}{% if is_edit %}Edit{% else %}Create{% endif %} Quiz{% endblock %}

{% block extra_css %}
{% include 'components/tinymce_includes.html' %}
<style>
    .status-toggle {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .status-toggle input {
        width: auto;
    }
    
    .form-group {
        margin-bottom: 1rem;
    }
    
    .form-label {
        display: block;
        font-weight: 500;
        font-size: 0.875rem;
        line-height: 1.25rem;
        color: #374151;
        margin-bottom: 0.5rem;
    }

    /* Mobile-first responsive improvements */
    @media (max-width: 640px) {
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            font-size: 1rem;
            margin-bottom: 0.75rem;
        }
        
        /* Make form inputs touch-friendly */
        input[type="text"],
        input[type="number"],
        input[type="email"],
        select,
        textarea {
            min-height: 44px !important;
            font-size: 16px !important; /* Prevents zoom on iOS */
            padding: 12px 16px !important;
        }
        
        /* Touch-friendly checkboxes and radio buttons */
        input[type="checkbox"],
        input[type="radio"] {
            min-width: 20px !important;
            min-height: 20px !important;
            margin-right: 12px !important;
        }
    }
    
    .form-error {
        margin-top: 0.25rem;
        font-size: 0.875rem;
        color: #dc2626;
        font-weight: 500;
        display: block;
    }
    
    .field-error {
        border-color: #dc2626 !important;
        box-shadow: 0 0 0 1px #dc2626;
    }
    
    .form-help {
        margin-top: 0.25rem;
        font-size: 0.75rem;
        color: #6b7280;
    }
    
    .required-field::after {
        content: "*";
        color: #dc2626;
        margin-left: 0.25rem;
    }
    
    .empty-state {
        text-align: center;
        padding: 2rem;
        background-color: #F9FAFB;
    }
    
    /* Quiz Questions */
    .questions-container {
        margin-top: 2rem;
    }
    
    .question-card {
        border: 1px solid #E5E7EB;
        border-radius: 0.375rem;
        margin-bottom: 1rem;
        overflow: hidden;
    }
    
    .question-card-header {
        background-color: #F9FAFB;
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #E5E7EB;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .question-card-body {
        padding: 1rem;
    }

    /* Mobile improvements for question cards */
    @media (max-width: 640px) {
        .question-card {
            margin-bottom: 1.5rem;
            border-radius: 0.5rem;
        }
        
        .question-card-header {
            padding: 1rem;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.75rem;
        }
        
        .question-card-body {
            padding: 1.25rem;
        }
        
        .answer-item {
            padding: 0.75rem 0;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }
        
        /* Touch-friendly buttons */
        .btn, button {
            min-height: 44px !important;
            min-width: 44px !important;
            padding: 12px 16px !important;
            font-size: 16px !important;
        }
        
        /* Improve button groups on mobile */
        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .btn-group .btn {
            width: 100%;
        }
    }
    
    .answer-list {
        list-style-type: none;
        margin: 0;
        padding: 0;
    }
    
    .answer-item {
        padding: 0.5rem 0;
        display: flex;
        align-items: center;
    }
    
    .answer-item-correct {
        font-weight: 500;
        color: #047857;
    }
    
    .question-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .question-actions {
        display: flex;
        gap: 0.5rem;
    }

    .empty-state {
        text-align: center;
        padding: 2rem;
        background-color: #F9FAFB;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Breadcrumbs -->
    {% include 'components/breadcrumb.html' with breadcrumbs=breadcrumbs %}

    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
        <!-- Header -->
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-semibold text-gray-900">{% if is_edit %}Edit{% else %}Create{% endif %} Quiz</h1>
                    <p class="mt-1 text-sm text-gray-600">Configure your quiz settings below.</p>
                </div>
            </div>
        </div>

        <!-- Form -->
        <form method="post" class="divide-y divide-gray-200" id="quizForm">
            {% csrf_token %}

            {% if form.non_field_errors %}
            <div class="px-6 py-4 bg-red-50 border-l-4 border-red-500">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-red-500" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-red-800">Form Validation Errors</h3>
                        <div class="mt-2 text-sm text-red-700">
                            {% for error in form.non_field_errors %}
                                <p class="mb-1">{{ error }}</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="px-6 py-4 space-y-6">
                <!-- Title -->
                <div class="form-group">
                    <label for="{{ form.title.id_for_label }}" class="form-label">
                        Title <span class="text-red-500">*</span>
                    </label>
                    {{ form.title }}
                    {% if form.title.errors %}
                    <p class="form-error">{{ form.title.errors.0 }}</p>
                    {% endif %}
                </div>

                <!-- Description -->
                <div class="form-group">
                    <label for="{{ form.description.id_for_label }}" class="form-label">
                        Description <span class="text-red-500">*</span>
                    </label>
                    <div id="tinymce-toolbar-container-{{ form.description.id_for_label }}"></div>
                    {{ form.description }}
                    {% if form.description.errors %}
                    <p class="form-error">{{ form.description.errors.0 }}</p>
                    {% endif %}
                </div>

                <!-- Instructions -->
                <div class="form-group">
                    <label for="{{ form.instructions.id_for_label }}" class="form-label">
                        Instructions
                    </label>
                    <div id="tinymce-toolbar-container-{{ form.instructions.id_for_label }}"></div>
                    {{ form.instructions }}
                    {% if form.instructions.errors %}
                    <p class="form-error">{{ form.instructions.errors.0 }}</p>
                    {% endif %}
                    <p class="form-help">Instructions for taking the quiz. This will be shown to students.</p>
                </div>

                <!-- Quiz Settings -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Time Limit -->
                    <div class="form-group">
                        <label for="{{ form.time_limit.id_for_label }}" class="form-label">
                            Time Limit
                        </label>
                        {{ form.time_limit }}
                        {% if form.time_limit.errors %}
                        <p class="form-error">{{ form.time_limit.errors.0 }}</p>
                        {% endif %}
                        <p class="form-help">Time limit in minutes. Set to 0 for no limit.</p>
                    </div>

                    <!-- Passing Score -->
                    <div class="form-group" id="passing-score-field">
                        <label for="{{ form.passing_score.id_for_label }}" class="form-label">
                            Passing Score <span class="text-red-500" id="passing-score-required">*</span>
                        </label>
                        {{ form.passing_score }}
                        {% if form.passing_score.errors %}
                        <p class="form-error">{{ form.passing_score.errors.0 }}</p>
                        {% endif %}
                        <p class="form-help">Passing score in percentage (0-100). Not required for VAK Test.</p>
                    </div>

                    <!-- Attempts -->
                    <div class="form-group">
                        <label for="{{ form.attempts_allowed.id_for_label }}" class="form-label">
                            Attempts
                        </label>
                        {{ form.attempts_allowed }}
                        {% if form.attempts_allowed.errors %}
                        <p class="form-error">{{ form.attempts_allowed.errors.0 }}</p>
                        {% endif %}
                        <p class="form-help">Number of attempts allowed per user. Default is 1.</p>
                    </div>

                    <!-- Status -->
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <div class="status-toggle">
                            {{ form.is_active }}
                            <span>Active</span>
                        </div>
                        <p class="form-help">Active quizzes are visible to students and can be taken.</p>
                    </div>
                </div>
                
                <!-- Rubric Selection -->
                <div class="form-group" id="rubric-field-group">
                    <label for="{{ form.rubric.id_for_label }}" class="form-label">
                        Rubric
                    </label>
                    {{ form.rubric }}
                    {% if form.rubric.errors %}
                    <p class="form-error">{{ form.rubric.errors.0 }}</p>
                    {% endif %}
                    <p class="form-help" id="rubric-normal-help">Optional: Select a rubric for additional grading criteria or 
                        <a href="{% url 'lms_rubrics:create' %}" class="text-blue-600 hover:text-blue-800" target="_blank">
                            create a new one
                        </a>
                    </p>
                    {% if is_edit and quiz.rubric %}
                    <div class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded-md">
                        <p class="text-sm text-blue-700">
                            <svg class="inline w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            Currently assigned: <strong>{{ quiz.rubric.title }}</strong>
                            {% if quiz.rubric.branch and quiz.rubric.branch != user.branch %}
                                (from {{ quiz.rubric.branch.name }})
                            {% endif %}
                        </p>
                    </div>
                    {% endif %}
                    <div id="rubric-disabled-message" class="mt-2 p-3 bg-orange-50 border border-orange-200 rounded-md" style="display: none;">
                        <p class="text-sm text-orange-700">
                            <svg class="inline w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 14c-.77.833.192 2.5 1.732 2.5z"/>
                            </svg>
                            <span id="rubric-message-text">Assessment quizzes use standardized scoring and cannot use custom rubrics.</span>
                        </p>
                    </div>
                </div>
                
                <!-- Quiz Type Selection -->
                {% if user.role in 'admin,instructor' %}
                <div class="form-group">
                    <label class="form-label">Quiz Type</label>
                    <div class="space-y-3">
                        {% if form.is_initial_assessment %}
                        <div class="flex items-center">
                            {{ form.is_initial_assessment }}
                            <label for="{{ form.is_initial_assessment.id_for_label }}" class="ml-2 text-sm text-gray-700">
                                Initial Assessment
                            </label>
                        </div>
                        {% if form.is_initial_assessment.errors %}
                        <p class="form-error">{{ form.is_initial_assessment.errors.0 }}</p>
                        {% endif %}
                        {% endif %}
                        
                        {% if form.is_vak_test %}
                        <div class="flex items-center">
                            {{ form.is_vak_test }}
                            <label for="{{ form.is_vak_test.id_for_label }}" class="ml-2 text-sm text-gray-700">
                                VAK Test
                            </label>
                        </div>
                        {% if form.is_vak_test.errors %}
                        <p class="form-error">{{ form.is_vak_test.errors.0 }}</p>
                        {% endif %}
                        {% endif %}
                    </div>
                    {% if form.is_initial_assessment or form.is_vak_test %}
                    <p class="form-help mt-2">Branch admins and instructors can create multiple assessments of each type per branch.</p>
                    {% endif %}
                    
                    <!-- Show helpful message about unlimited quiz types -->
                    {% if user.role in 'admin,instructor' %}
                    <div class="mt-2 p-3 bg-green-50 border border-green-200 rounded-md">
                        <p class="text-sm text-green-700">
                            <svg class="inline w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            You can now create unlimited Initial Assessment and VAK Test quizzes for your branch.
                        </p>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Percentage Configuration for Initial Assessment -->
                <div id="percentage-config" class="mt-6 border-t pt-6" style="display: none;">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                        <div class="flex items-center mb-4">
                            <div class="flex-shrink-0">
                                <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-xl font-bold text-blue-900">Assessment Classification Configuration</h3>
                                <p class="text-sm text-blue-700">Configure the percentage thresholds that determine how students are classified based on their performance.</p>
                            </div>
                        </div>

                        <!-- Instructor Instructions -->
                        <div class="bg-white border border-blue-200 rounded-md p-5 mb-6">
                            <h4 class="text-lg font-semibold text-gray-900 mb-4">
                                <svg class="inline w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                                </svg>
                                How Initial Assessment Classification Works
                            </h4>
                            
                            <div class="space-y-4 text-sm text-gray-700">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                        <h5 class="font-bold text-green-800 mb-2 text-center">Level 2 (University Ready)</h5>
                                        <ul class="text-xs space-y-1">
                                            <li>✓ L2 Score ≥ L2 Threshold</li>
                                            <li>✓ Total Score ≥ Total Threshold</li>
                                            <li>✓ L1 Score ≥ L1 Threshold</li>
                                        </ul>
                                        <p class="text-xs text-green-700 mt-2 font-medium">All conditions must be met</p>
                                    </div>
                                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                        <h5 class="font-bold text-yellow-800 mb-2 text-center">Level 1 (Needs Support)</h5>
                                        <ul class="text-xs space-y-1">
                                            <li>✓ L1 Score ≥ L1 Threshold</li>
                                            <li>✓ L2 Score &lt; L2 Threshold</li>
                                            <li>✓ Below L1 ≥ Below L1 Threshold</li>
                                        </ul>
                                        <p class="text-xs text-yellow-700 mt-2 font-medium">All conditions must be met</p>
                                    </div>
                                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                        <h5 class="font-bold text-red-800 mb-2 text-center">Below Level 1 (Foundation Required)</h5>
                                        <ul class="text-xs space-y-1">
                                            <li>• L1 Score &lt; L1 Threshold</li>
                                            <li class="font-bold">OR</li>
                                            <li>• Below L1 &lt; Below L1 Threshold</li>
                                        </ul>
                                        <p class="text-xs text-red-700 mt-2 font-medium">Either condition triggers this level</p>
                                    </div>
                                </div>
                                
                                <div class="mt-4 p-4 bg-gray-100 border border-gray-300 rounded-lg">
                                    <p class="font-bold text-gray-800 mb-3">📊 Score Calculations Explained:</p>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs">
                                        <div>
                                            <span class="font-semibold">L2 Percentage:</span><br>
                                            (L2 Points Scored ÷ L2 Total Points) × 100
                                        </div>
                                        <div>
                                            <span class="font-semibold">L1 Percentage:</span><br>
                                            (L1 Points Scored ÷ L1 Total Points) × 100
                                        </div>
                                        <div>
                                            <span class="font-semibold">Below L1 Percentage:</span><br>
                                            (Below L1 Points ÷ Below L1 Total) × 100
                                        </div>
                                        <div>
                                            <span class="font-semibold">Total Percentage:</span><br>
                                            (Total Points Scored ÷ Total Possible) × 100
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Configuration Fields -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="form-group">
                                <label for="{{ form.level_2_percentage.id_for_label }}" class="form-label text-lg font-bold text-gray-900">
                                    <span class="inline-flex items-center">
                                        <span class="w-5 h-5 bg-green-500 rounded-full mr-3"></span>
                                        Level 2 Minimum %
                                    </span>
                                </label>
                                <div class="mt-2">
                                    {{ form.level_2_percentage }}
                                </div>
                                {% if form.level_2_percentage.errors %}
                                <p class="form-error">{{ form.level_2_percentage.errors.0 }}</p>
                                {% endif %}
                                <p class="form-help text-green-700 font-medium">Threshold for university-ready classification (typically 70-80%)</p>
                            </div>
                            
                            <div class="form-group">
                                <label for="{{ form.total_threshold.id_for_label }}" class="form-label text-lg font-bold text-gray-900">
                                    <span class="inline-flex items-center">
                                        <span class="w-5 h-5 bg-blue-500 rounded-full mr-3"></span>
                                        Overall Performance %
                                    </span>
                                </label>
                                <div class="mt-2">
                                    {{ form.total_threshold }}
                                </div>
                                {% if form.total_threshold.errors %}
                                <p class="form-error">{{ form.total_threshold.errors.0 }}</p>
                                {% endif %}
                                <p class="form-help text-blue-700 font-medium">Required total score for Level 2 classification (typically 65-75%)</p>
                            </div>
                            
                            <div class="form-group">
                                <label for="{{ form.level_1_percentage.id_for_label }}" class="form-label text-lg font-bold text-gray-900">
                                    <span class="inline-flex items-center">
                                        <span class="w-5 h-5 bg-yellow-500 rounded-full mr-3"></span>
                                        Level 1 Minimum %
                                    </span>
                                </label>
                                <div class="mt-2">
                                    {{ form.level_1_percentage }}
                                </div>
                                {% if form.level_1_percentage.errors %}
                                <p class="form-error">{{ form.level_1_percentage.errors.0 }}</p>
                                {% endif %}
                                <p class="form-help text-yellow-700 font-medium">Threshold for students needing support (typically 50-65%)</p>
                            </div>
                            
                            <div class="form-group">
                                <label for="{{ form.below_level_1_percentage.id_for_label }}" class="form-label text-lg font-bold text-gray-900">
                                    <span class="inline-flex items-center">
                                        <span class="w-5 h-5 bg-red-500 rounded-full mr-3"></span>
                                        Below Level 1 Minimum %
                                    </span>
                                </label>
                                <div class="mt-2">
                                    {{ form.below_level_1_percentage }}
                                </div>
                                {% if form.below_level_1_percentage.errors %}
                                <p class="form-error">{{ form.below_level_1_percentage.errors.0 }}</p>
                                {% endif %}
                                <p class="form-help text-red-700 font-medium">Minimum threshold for foundational skills (typically 40-55%)</p>
                            </div>
                        </div>

                        <!-- Configuration Notes -->
                        <div class="mt-6 p-5 bg-yellow-50 border-l-4 border-yellow-400 rounded-r-md">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg class="h-6 w-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 14c-.77.833.192 2.5 1.732 2.5z"/>
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <h5 class="text-lg font-bold text-yellow-800"> Important Configuration Rules:</h5>
                                    <div class="mt-2 text-sm text-yellow-700 space-y-2">
                                        <div class="flex items-center">
                                            <span class="w-2 h-2 bg-yellow-500 rounded-full mr-2"></span>
                                            <span><strong>Descending Order Required:</strong> Level 2 % > Level 1 % > Below Level 1 %</span>
                                        </div>
                                        <div class="flex items-center">
                                            <span class="w-2 h-2 bg-yellow-500 rounded-full mr-2"></span>
                                            <span><strong>Question Assignment:</strong> Assign assessment levels to your questions in the question editor</span>
                                        </div>
                                        <div class="flex items-center">
                                            <span class="w-2 h-2 bg-yellow-500 rounded-full mr-2"></span>
                                            <span><strong>Balanced Distribution:</strong> Include questions from all three levels for accurate assessment</span>
                                        </div>
                                        <div class="flex items-center">
                                            <span class="w-2 h-2 bg-yellow-500 rounded-full mr-2"></span>
                                            <span><strong>Total Threshold:</strong> Used specifically for Level 2 classification (university readiness)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Example Section -->
                        <div class="mt-6 p-5 bg-gray-50 border border-gray-300 rounded-lg">
                            <h5 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
                                <svg class="inline w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                                </svg>
                                 Example Classification
                            </h5>
                            <div class="bg-white p-4 rounded border">
                                <p class="text-sm text-gray-700 mb-2">
                                    <strong>Student Performance:</strong> L2=80%, L1=65%, Below L1=55%, Total=72%<br>
                                    <strong>Your Thresholds:</strong> L2=75%, L1=60%, Below L1=50%, Total=70%
                                </p>
                                <p class="text-sm">
                                    <strong>Result:</strong> <span class="font-bold text-green-600 bg-green-100 px-2 py-1 rounded">Level 2 Classification</span> 
                                    (meets all Level 2 criteria: L2≥75%✓, Total≥70%✓, L1≥60%✓)
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Form Actions -->
            <div class="px-6 py-4 bg-gray-50 flex justify-end space-x-3">
                <a href="{{ back_url }}" 
                   class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Cancel
                </a>
                <button type="submit" id="submitButton"
                        class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <span id="submitButtonText">{% if is_edit %}Save Changes{% else %}Create Quiz{% endif %}</span>
                    <span id="submitButtonLoader" class="hidden">
                        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        {% if is_edit %}Saving...{% else %}Creating...{% endif %}
                    </span>
                </button>
            </div>
        </form>

        {% if is_edit %}
        <!-- Questions Section -->
        <div class="border-t border-gray-200">
            <div class="px-6 py-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-medium text-gray-900">Questions</h2>
                    <a href="{% url 'quiz:create_question' quiz_id=quiz.id %}" 
                       class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Add Question
                    </a>
                </div>

                {% if questions %}
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">
                                    #
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">
                                    Question
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">
                                    Type
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">
                                    Points
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">
                                    Order
                                </th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200">
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for question in questions %}
                            <tr class="hover:bg-gray-50 transition-colors duration-200">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 border-r border-gray-100">
                                    {{ forloop.counter }}
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-900 border-r border-gray-100">
                                    <div class="max-w-xs">
                                        <p class="font-medium truncate" title="{{ question.question_text|striptags }}">
                                            {{ question.question_text|striptags|truncatechars:60 }}
                                        </p>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 border-r border-gray-100">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                        {% if question.question_type == 'multiple_choice' %}bg-blue-100 text-blue-800
                                        {% elif question.question_type == 'true_false' %}bg-green-100 text-green-800
                                        {% elif question.question_type == 'fill_blank' %}bg-yellow-100 text-yellow-800
                                        {% elif question.question_type == 'multi_blank' %}bg-orange-100 text-orange-800
                                        {% elif question.question_type == 'matching' %}bg-purple-100 text-purple-800
                                        {% elif question.question_type == 'drag_drop_matching' %}bg-pink-100 text-pink-800
                                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                                        {{ question.get_question_type_display }}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 border-r border-gray-100">
                                    <span class="font-medium">{{ question.points }}</span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 border-r border-gray-100">
                                    {{ question.order|default:"-" }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                    <div class="flex items-center justify-end space-x-3">
                                        <a href="{% url 'quiz:edit_question' question_id=question.id %}" 
                                           class="inline-flex items-center px-3 py-1 border border-transparent text-xs leading-4 font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:border-blue-700 focus:shadow-outline-blue transition ease-in-out duration-150">
                                            <i class="fas fa-edit mr-1"></i>
                                            Edit
                                        </a>
                                        <form method="post" action="{% url 'quiz:delete_question' question_id=question.id %}"
                                              class="inline"
                                              onsubmit="return confirm('Are you sure you want to delete this question? This action cannot be undone.');">
                                            {% csrf_token %}
                                            <button type="submit" 
                                                    class="inline-flex items-center px-3 py-1 border border-transparent text-xs leading-4 font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:border-red-700 focus:shadow-outline-red transition ease-in-out duration-150">
                                                <i class="fas fa-trash mr-1"></i>
                                                Delete
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-8">
                    <i class="fas fa-question-circle text-gray-400 text-4xl mb-3"></i>
                    <p class="text-lg font-medium text-gray-900 mb-2">No questions yet</p>
                    <p class="text-sm text-gray-500">Click the "Add Question" button to create your first question.</p>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ form.media.js }}
<script src="{% static 'tinymce_editor/js/tinymce-json-handler.js' %}"></script>
<script src="{% static 'tinymce_editor/js/toolbar-fixer.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const descriptionField = document.getElementById('{{ form.description.id_for_label }}');
        
        // Process JSON content if present
        if (descriptionField) {
            window.TinyMCEJsonHandler.processJsonContentField(descriptionField);
        }

        // Handle quiz type changes for rubric field, percentage configuration, and passing score
        function handleQuizTypeChange() {
            const initialAssessmentCheckbox = document.getElementById('{{ form.is_initial_assessment.id_for_label }}');
            const vakTestCheckbox = document.getElementById('{{ form.is_vak_test.id_for_label }}');
            const rubricField = document.getElementById('{{ form.rubric.id_for_label }}');
            const rubricNormalHelp = document.getElementById('rubric-normal-help');
            const rubricDisabledMessage = document.getElementById('rubric-disabled-message');
            const rubricMessageText = document.getElementById('rubric-message-text');
            const percentageConfig = document.getElementById('percentage-config');
            const passingScoreField = document.getElementById('passing-score-field');
            const passingScoreRequired = document.getElementById('passing-score-required');
            const passingScoreInput = document.getElementById('{{ form.passing_score.id_for_label }}');

            if (!initialAssessmentCheckbox || !vakTestCheckbox || !rubricField) {
                return; // Elements not found, exit early
            }

            let isInitialAssessment = initialAssessmentCheckbox.checked;
            let isVakTest = vakTestCheckbox.checked;
            
            // Ensure only one quiz type is selected at a time
            if (isInitialAssessment && isVakTest) {
                // If both are checked, determine which one was just clicked and uncheck the other
                const target = window.event ? window.event.target : null;
                if (target === initialAssessmentCheckbox) {
                    vakTestCheckbox.checked = false;
                    isVakTest = false;
                } else if (target === vakTestCheckbox) {
                    initialAssessmentCheckbox.checked = false;
                    isInitialAssessment = false;
                }
            }
            
            const isAssessmentType = isInitialAssessment || isVakTest;
            
            // Show/hide percentage configuration section
            if (percentageConfig) {
                if (isInitialAssessment) {
                    percentageConfig.style.display = 'block';
                } else {
                    percentageConfig.style.display = 'none';
                }
            }
            
            // Show/hide passing score field based on quiz type (only VAK Test hides it)
            if (passingScoreField && passingScoreRequired && passingScoreInput) {
                if (isVakTest) {
                    // Hide passing score field only for VAK Test
                    passingScoreField.style.display = 'none';
                    passingScoreRequired.style.display = 'none';
                    // Clear the value when hidden
                    passingScoreInput.value = '';
                } else {
                    // Show passing score field for regular quizzes and Initial Assessment
                    passingScoreField.style.display = 'block';
                    passingScoreRequired.style.display = 'inline';
                    // Set default value if empty
                    if (!passingScoreInput.value) {
                        passingScoreInput.value = '70';
                    }
                }
            }

            if (isAssessmentType) {
                // Check if there's currently a rubric selected
                const hasCurrentRubric = rubricField.value && rubricField.value !== '';
                
                if (hasCurrentRubric) {
                    // Warn user about rubric removal
                    const rubricName = rubricField.options[rubricField.selectedIndex].text;
                    if (confirm(`Changing to an assessment type will remove the currently assigned rubric "${rubricName}". Do you want to continue?`)) {
                        // User confirmed, clear the rubric
                        rubricField.value = '';
                    } else {
                        // User cancelled, revert the quiz type change
                        if (isInitialAssessment) {
                            initialAssessmentCheckbox.checked = false;
                        }
                        if (isVakTest) {
                            vakTestCheckbox.checked = false;
                        }
                        return; // Exit early
                    }
                } else {
                    // No current rubric, just clear the field
                    rubricField.value = '';
                }
                
                // Disable rubric selection for assessment types
                rubricField.disabled = true;
                rubricField.style.opacity = '0.5';
                
                // Show appropriate message
                rubricNormalHelp.style.display = 'none';
                rubricDisabledMessage.style.display = 'block';
                
                // Update message text based on type
                if (isInitialAssessment) {
                    rubricMessageText.textContent = 'Initial Assessment quizzes use standardized scoring and cannot use custom rubrics.';
                } else if (isVakTest) {
                    rubricMessageText.textContent = 'VAK Test quizzes use standardized scoring and cannot use custom rubrics.';
                }
            } else {
                // Enable rubric selection for regular quizzes
                rubricField.disabled = false;
                rubricField.style.opacity = '1';
                
                // Show normal help text
                rubricNormalHelp.style.display = 'block';
                rubricDisabledMessage.style.display = 'none';
            }
        }

        // Add event listeners to quiz type checkboxes
        const initialAssessmentCheckbox = document.getElementById('{{ form.is_initial_assessment.id_for_label }}');
        const vakTestCheckbox = document.getElementById('{{ form.is_vak_test.id_for_label }}');
        
        if (initialAssessmentCheckbox) {
            initialAssessmentCheckbox.addEventListener('change', function(event) {
                window.event = event; // Store event globally for handleQuizTypeChange
                handleQuizTypeChange();
            });
        }
        if (vakTestCheckbox) {
            vakTestCheckbox.addEventListener('change', function(event) {
                window.event = event; // Store event globally for handleQuizTypeChange
                handleQuizTypeChange();
            });
        }

                // Initial check on page load
        handleQuizTypeChange();
        
        // Reset form state if there are server-side errors
        {% if form.errors %}
        setTimeout(function() {
            resetFormState();
        }, 100);
        {% endif %}
        
        // Function to reset form state
        function resetFormState() {
            const submitButton = document.getElementById('submitButton');
            const submitButtonText = document.getElementById('submitButtonText');
            const submitButtonLoader = document.getElementById('submitButtonLoader');
            
            if (submitButton && submitButtonText && submitButtonLoader) {
                submitButton.disabled = false;
                submitButtonText.classList.remove('hidden');
                submitButtonLoader.classList.add('hidden');
            }
        }

        // Form validation and submission handler
        const quizForm = document.getElementById('quizForm');
        if (quizForm) {
            quizForm.addEventListener('submit', function(event) {
                // Sync TinyMCE content before form submission
                if (typeof tinymce !== 'undefined') {
                    tinymce.get('{{ form.description.id_for_label }}')?.save();
                    tinymce.get('{{ form.instructions.id_for_label }}')?.save();
                }
                
                // Basic form validation
                const titleField = document.getElementById('{{ form.title.id_for_label }}');
                const descriptionField = document.getElementById('{{ form.description.id_for_label }}');
                const passingScoreField = document.getElementById('{{ form.passing_score.id_for_label }}');
                
                let isValid = true;
                let errorMessage = '';
                
                // Validate title
                if (!titleField.value.trim()) {
                    isValid = false;
                    errorMessage += 'Title is required.\n';
                    titleField.classList.add('field-error');
                } else {
                    titleField.classList.remove('field-error');
                }
                
                // Validate description
                if (!descriptionField.value.trim()) {
                    isValid = false;
                    errorMessage += 'Description is required.\n';
                    descriptionField.classList.add('field-error');
                } else {
                    descriptionField.classList.remove('field-error');
                }
                
                // Validate passing score (only skip for VAK Test)
                const vakTestCheckbox = document.getElementById('{{ form.is_vak_test.id_for_label }}');
                const isVakTest = vakTestCheckbox && vakTestCheckbox.checked;
                
                if (!isVakTest) {
                    // Validate passing score for regular quizzes and Initial Assessment
                    if (!passingScoreField.value || isNaN(passingScoreField.value) || passingScoreField.value < 0 || passingScoreField.value > 100) {
                        isValid = false;
                        errorMessage += 'Passing score is required and must be between 0 and 100.\n';
                        passingScoreField.classList.add('field-error');
                    } else {
                        passingScoreField.classList.remove('field-error');
                    }
                } else {
                    // Clear any validation errors for VAK Test
                    passingScoreField.classList.remove('field-error');
                }
                
                if (!isValid) {
                    event.preventDefault();
                    alert('Please correct the following errors:\n' + errorMessage);
                    resetFormState();
                    return false;
                }
                
                // Show loading state
                const submitButton = document.getElementById('submitButton');
                const submitButtonText = document.getElementById('submitButtonText');
                const submitButtonLoader = document.getElementById('submitButtonLoader');
                
                if (submitButton && submitButtonText && submitButtonLoader) {
                    submitButton.disabled = true;
                    submitButtonText.classList.add('hidden');
                    submitButtonLoader.classList.remove('hidden');
                }
                
                return true;
            });
        }

        // Initialize TinyMCE for description field
        if (typeof tinymce !== 'undefined') {
            tinymce.init({
                selector: '#{{ form.description.id_for_label }}',
                height: 300,
                menubar: 'edit view insert format tools table',
                plugins: 'advlist autolink link image lists charmap preview anchor searchreplace visualblocks code fullscreen insertdatetime media table wordcount help',
                toolbar: 'formatselect bold italic underline strikethrough | forecolor backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | link image media table | code fullscreen help',
                toolbar_mode: 'sliding',
                toolbar_sticky: true,
                branding: false,
                promotion: false,
                statusbar: true,
                resize: 'both',
                automatic_uploads: true,
                setup: function(editor) {
                    // Sync content when form is submitted
                    editor.on('init', function() {
                        editor.save();
                    });
                }
            });
            
            // Initialize TinyMCE for instructions field
            tinymce.init({
                selector: '#{{ form.instructions.id_for_label }}',
                height: 300,
                menubar: 'edit view insert format tools table',
                plugins: 'advlist autolink link image lists charmap preview anchor searchreplace visualblocks code fullscreen insertdatetime media table wordcount help',
                toolbar: 'formatselect bold italic underline strikethrough | forecolor backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | link image media table | code fullscreen help',
                toolbar_mode: 'sliding',
                toolbar_sticky: true,
                branding: false,
                promotion: false,
                statusbar: true,
                resize: 'both',
                automatic_uploads: true,
                setup: function(editor) {
                    // Sync content when form is submitted
                    editor.on('init', function() {
                        editor.save();
                    });
                }
            });
        }
    });
</script>
{% endblock %}