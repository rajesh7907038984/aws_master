{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="{% static 'css/calendar.css' %}">
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    {% include 'components/breadcrumb.html' with breadcrumbs=breadcrumbs %}
    
    <!-- Full Calendar Implementation using Dashboard Pattern -->
    <div class="calendar-main-widget">
        <div class="calendar-header">
            <h1 class="calendar-title">Activity Calendar</h1>
            <div class="calendar-controls">
                <button class="nav-btn prev-month" id="prevMonth">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <span class="current-month-year" id="currentMonthYear"></span>
                <button class="nav-btn next-month" id="nextMonth">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
                         <div class="calendar-actions">
                 <button class="today-btn" id="todayBtn">
                     <i class="fas fa-calendar-day"></i> Today
                 </button>
                 <button class="add-event-btn" onclick="window.location.href='{% url 'calendar_app:add_event' %}'" style="display: none;">
                     <i class="fas fa-plus"></i> Add Event
                 </button>
             </div>
        </div>
        
        <div class="calendar-grid" id="mainCalendar">
            <!-- Calendar will be populated by JavaScript -->
        </div>
        
        <div class="calendar-legend">
            <div class="legend-item">
                <span class="legend-dot high"></span>
                <span>High Priority</span>
            </div>
            <div class="legend-item">
                <span class="legend-dot medium"></span>
                <span>Medium Priority</span>
            </div>
            <div class="legend-item">
                <span class="legend-dot low"></span>
                <span>Low Priority</span>
            </div>

        </div>
    </div>
</div>

<!-- Daily Activities Modal -->
<div id="mainActivityModal" class="activity-modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h4 id="modalDateTitle">Activities for Date</h4>
            <button class="modal-close" id="closeActivityModal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div id="modalLoading" class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
                <span>Loading activities...</span>
            </div>
            <div id="modalActivities" style="display: none;">
                <!-- Activities will be populated here -->
            </div>
            <div id="modalNoActivities" class="no-activities" style="display: none;">
                <i class="fas fa-calendar-day"></i>
                <p>No activities scheduled for this date.</p>
            </div>
        </div>
    </div>
</div>

<style>
.calendar-main-widget {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
    margin-bottom: 2rem;
}

.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.calendar-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1f2937;
    margin: 0;
}

.calendar-controls {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.nav-btn {
    background: #f8fafc;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    padding: 0.5rem 0.75rem;
    cursor: pointer;
    color: #64748b;
    transition: all 0.2s;
    font-size: 0.9rem;
}

.nav-btn:hover {
    background: #e2e8f0;
    color: #475569;
    border-color: #cbd5e1;
}

.current-month-year {
    font-size: 1.1rem;
    font-weight: 600;
    color: #374151;
    min-width: 160px;
    text-align: center;
}

.calendar-actions {
    display: flex;
    gap: 0.75rem;
}

.today-btn, .add-event-btn {
    background: #3b82f6;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 0.5rem 1rem;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s;
}

.today-btn:hover, .add-event-btn:hover {
    background: #2563eb;
    transform: translateY(-1px);
}

.add-event-btn {
    background: #10b981;
}

.add-event-btn:hover {
    background: #059669;
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
    background: #e5e7eb;
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 2rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.calendar-day-header {
    background: #f1f5f9;
    padding: 0.75rem 0.5rem;
    text-align: center;
    font-size: 0.85rem;
    font-weight: 700;
    color: #475569;
    text-transform: uppercase;
    letter-spacing: 0.025em;
}

.calendar-day {
    background: white;
    min-height: 4rem;
    padding: 0.5rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    border: 2px solid transparent;
}

.calendar-day:hover {
    background: #f8fafc;
    border-color: #e2e8f0;
}

.calendar-day.today {
    background: #dbeafe;
    border-color: #3b82f6;
}

.calendar-day.other-month {
    background: #f9fafb;
    color: #9ca3af;
}

.calendar-day-number {
    font-size: 0.9rem;
    font-weight: 600;
    line-height: 1;
    margin-bottom: 0.5rem;
}

.calendar-day.today .calendar-day-number {
    color: #1d4ed8;
    font-weight: 700;
}

.activity-indicators {
    display: flex;
    gap: 3px;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    max-width: 100%;
}

.activity-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
}

.activity-dot.high {
    background: #dc2626;
}

.activity-dot.medium {
    background: #f59e0b;
}

.activity-dot.low {
    background: #10b981;
}



.calendar-legend {
    display: flex;
    justify-content: center;
    gap: 1.5rem;
    flex-wrap: wrap;
    padding: 1rem;
    background: #f8fafc;
    border-radius: 8px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.85rem;
    color: #64748b;
    font-weight: 500;
}

.legend-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
}

.legend-dot.high {
    background: #dc2626;
}

.legend-dot.medium {
    background: #f59e0b;
}

.legend-dot.low {
    background: #10b981;
}



/* Activity Modal Styles */
.activity-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
}

.modal-content {
    background: white;
    border-radius: 12px;
    width: 100%;
    max-width: 600px;
    max-height: 85vh;
    overflow: hidden;
    box-shadow: 0 20px 25px rgba(0, 0, 0, 0.25);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 2px solid #e5e7eb;
    background: #f8fafc;
}

.modal-header h4 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 700;
    color: #1f2937;
}

.modal-close {
    background: none;
    border: none;
    color: #6b7280;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 6px;
    transition: all 0.2s;
}

.modal-close:hover {
    color: #374151;
    background: #e5e7eb;
}

.modal-body {
    padding: 1.5rem;
    max-height: 65vh;
    overflow-y: auto;
}

.loading-spinner {
    text-align: center;
    padding: 3rem;
    color: #6b7280;
}

.loading-spinner i {
    font-size: 2rem;
    margin-bottom: 1rem;
    display: block;
}

.no-activities {
    text-align: center;
    padding: 3rem;
    color: #6b7280;
}

.no-activities i {
    font-size: 3rem;
    margin-bottom: 1rem;
    display: block;
    color: #9ca3af;
}

.activity-item {
    padding: 1rem;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    margin-bottom: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
}

.activity-item:hover {
    background: #f9fafb;
    border-color: #cbd5e1;
    transform: translateY(-1px);
}

.activity-item:last-child {
    margin-bottom: 0;
}

.activity-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.5rem;
}

.activity-icon {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 0.8rem;
    flex-shrink: 0;
}

.activity-title {
    font-weight: 700;
    color: #1f2937;
    font-size: 1rem;
}

.activity-time {
    font-size: 0.85rem;
    color: #6b7280;
    margin-left: auto;
    font-weight: 500;
}

.activity-description {
    font-size: 0.9rem;
    color: #4b5563;
    margin-bottom: 0.75rem;
    line-height: 1.5;
}

.activity-meta {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
}

.activity-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 16px;
    font-size: 0.75rem;
    font-weight: 600;
}

.activity-badge.type {
    background: #f3f4f6;
    color: #374151;
}

.activity-badge.priority {
    color: white;
}

.activity-badge.priority.high {
    background: #dc2626;
}

.activity-badge.priority.medium {
    background: #f59e0b;
}

.activity-badge.priority.low {
    background: #10b981;
}

/* Responsive Design */
@media (max-width: 1024px) {
    .calendar-header {
        flex-direction: column;
        align-items: stretch;
        text-align: center;
    }
    
    .calendar-controls {
        justify-content: center;
    }
    
    .calendar-actions {
        justify-content: center;
    }
}

@media (max-width: 768px) {
    .calendar-main-widget {
        padding: 1rem;
    }
    
    .calendar-header {
        gap: 0.75rem;
    }
    
    .calendar-day {
        min-height: 3rem;
        padding: 0.25rem;
    }
    
    .calendar-day-number {
        font-size: 0.8rem;
    }
    
    .activity-dot {
        width: 6px;
        height: 6px;
    }
    
    .calendar-legend {
        gap: 1rem;
    }
    
    .legend-item {
        font-size: 0.8rem;
    }
    
    .modal-content {
        margin: 0.5rem;
    }
    
    .current-month-year {
        font-size: 1rem;
        min-width: 140px;
    }
}

@media (max-width: 480px) {
    .calendar-main-widget {
        padding: 0.75rem;
    }
    
    .calendar-day {
        min-height: 2.5rem;
    }
    
    .calendar-day-number {
        font-size: 0.75rem;
    }
    
    .current-month-year {
        font-size: 0.9rem;
        min-width: 120px;
    }
    
    .calendar-actions {
        flex-direction: column;
    }
    
    .today-btn, .add-event-btn {
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const MainCalendar = {
        currentDate: new Date(),
        activitiesData: {},
        
        init() {
            this.render();
            this.bindEvents();
            this.loadActivities();
        },
        
        bindEvents() {
            const prevMonth = document.getElementById('prevMonth');
            if (prevMonth) {
                prevMonth.addEventListener('click', () => {
                    this.currentDate.setMonth(this.currentDate.getMonth() - 1);
                    this.render();
                    this.loadActivities();
                });
            }
            
            const nextMonth = document.getElementById('nextMonth');
            if (nextMonth) {
                nextMonth.addEventListener('click', () => {
                    this.currentDate.setMonth(this.currentDate.getMonth() + 1);
                    this.render();
                    this.loadActivities();
                });
            }
            
            const todayBtn = document.getElementById('todayBtn');
            if (todayBtn) {
                todayBtn.addEventListener('click', () => {
                    this.currentDate = new Date();
                    this.render();
                    this.loadActivities();
                });
            }
            
            const closeActivityModal = document.getElementById('closeActivityModal');
            if (closeActivityModal) {
                closeActivityModal.addEventListener('click', () => {
                    this.closeModal();
                });
            }
            
            // Close modal when clicking outside
            const mainActivityModal = document.getElementById('mainActivityModal');
            if (mainActivityModal) {
                mainActivityModal.addEventListener('click', (e) => {
                    if (e.target.id === 'mainActivityModal') {
                        this.closeModal();
                    }
                });
            }
            
            // Close modal with Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    this.closeModal();
                }
            });
        },
        
        render() {
            const calendar = document.getElementById('mainCalendar');
            const monthYear = document.getElementById('currentMonthYear');
            
            if (!calendar || !monthYear) {
                console.error('Calendar: Required DOM elements not found');
                return;
            }
            
            // Update month/year display
            monthYear.textContent = this.currentDate.toLocaleDateString('default', {
                month: 'long',
                year: 'numeric'
            });
            
            // Clear calendar
            calendar.innerHTML = '';
            
            // Add day headers
            const dayHeaders = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            dayHeaders.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                calendar.appendChild(dayHeader);
            });
            
            // Get first day of month and number of days
            const firstDay = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth(), 1);
            const lastDay = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() + 1, 0);
            const today = new Date();
            
            // Add empty cells for days before month starts
            for (let i = 0; i < firstDay.getDay(); i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day other-month';
                const prevMonthDate = new Date(firstDay);
                prevMonthDate.setDate(prevMonthDate.getDate() - (firstDay.getDay() - i));
                emptyDay.innerHTML = `<span class="calendar-day-number">${prevMonthDate.getDate()}</span>`;
                calendar.appendChild(emptyDay);
            }
            
            // Add days of current month
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dayElement = document.createElement('div');
                // Create date string manually to avoid timezone issues
                const year = this.currentDate.getFullYear();
                const month = String(this.currentDate.getMonth() + 1).padStart(2, '0');
                const dayStr = String(day).padStart(2, '0');
                const dateString = `${year}-${month}-${dayStr}`;
                const dayDate = new Date(year, this.currentDate.getMonth(), day);
                
                dayElement.className = 'calendar-day';
                if (this.isSameDay(dayDate, today)) {
                    dayElement.classList.add('today');
                }
                
                dayElement.innerHTML = `
                    <span class="calendar-day-number">${day}</span>
                    <div class="activity-indicators" id="activities-${dateString}"></div>
                `;
                
                dayElement.addEventListener('click', () => {
                    this.showDayActivities(dateString);
                });
                
                calendar.appendChild(dayElement);
            }
            
            // Add empty cells for days after month ends
            const totalCells = calendar.children.length - 7; // Subtract header row
            const remainingCells = 42 - totalCells; // 6 rows * 7 days
            for (let i = 1; i <= remainingCells; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day other-month';
                emptyDay.innerHTML = `<span class="calendar-day-number">${i}</span>`;
                calendar.appendChild(emptyDay);
            }
        },
        
        isSameDay(date1, date2) {
            return date1.getDate() === date2.getDate() &&
                   date1.getMonth() === date2.getMonth() &&
                   date1.getFullYear() === date2.getFullYear();
        },
        
        loadActivities() {
            const startDate = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth(), 1);
            const endDate = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() + 1, 0);
            
            const params = new URLSearchParams({
                start_date: startDate.toISOString().split('T')[0],
                end_date: endDate.toISOString().split('T')[0]
            });
            
            // Get CSRF token safely
            const csrfTokenMeta = document.querySelector('meta[name=csrf-token]');
            const csrfToken = csrfTokenMeta ? csrfTokenMeta.getAttribute('content') : '';
            
            fetch(`/api/calendar/activities/?${params}`, {
                credentials: 'same-origin',
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        this.activitiesData = {};
                        if (data.activities && data.activities.length > 0) {
                            data.activities.forEach(activity => {
                                // Skip personal events
                                if (activity.type !== 'personal_event') {
                                    if (!this.activitiesData[activity.date]) {
                                        this.activitiesData[activity.date] = [];
                                    }
                                    this.activitiesData[activity.date].push(activity);
                                }
                            });
                        }
                        this.renderActivityIndicators();
                    } else {
                        console.log('Calendar API returned success: false, activities:', data.activities);
                        this.activitiesData = {};
                        this.renderActivityIndicators();
                    }
                })
                .catch(error => {
                    console.error('Error loading activities:', error);
                });
        },
        
        renderActivityIndicators() {
            Object.keys(this.activitiesData).forEach(dateString => {
                const indicatorContainer = document.getElementById(`activities-${dateString}`);
                if (indicatorContainer) {
                    indicatorContainer.innerHTML = '';
                    
                    const activities = this.activitiesData[dateString];
                    const priorityCounts = { high: 0, medium: 0, low: 0 };
                    
                    activities.forEach(activity => {
                        if (activity.type !== 'personal_event') {
                            priorityCounts[activity.priority]++;
                        }
                    });
                    
                    // Show max 3 dots, prioritizing high priority
                    let dotsShown = 0;
                    ['high', 'medium', 'low'].forEach(priority => {
                        let count = priorityCounts[priority];
                        while (count > 0 && dotsShown < 3) {
                            const dot = document.createElement('div');
                            dot.className = `activity-dot ${priority}`;
                            indicatorContainer.appendChild(dot);
                            count--;
                            dotsShown++;
                        }
                    });
                }
            });
        },
        
        showDayActivities(dateString) {
            const modal = document.getElementById('mainActivityModal');
            const dateTitle = document.getElementById('modalDateTitle');
            const loading = document.getElementById('modalLoading');
            const activities = document.getElementById('modalActivities');
            const noActivities = document.getElementById('modalNoActivities');
            
            if (!modal || !dateTitle || !loading || !activities || !noActivities) {
                console.error('Calendar: Modal elements not found');
                return;
            }
            
            // Fix date parsing to avoid timezone issues - completely avoid Date objects
            const dateParts = dateString.split('-');
            const year = parseInt(dateParts[0]);
            const month = parseInt(dateParts[1]);
            const day = parseInt(dateParts[2]);
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            
            const weekdayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            
            // Create a simple Date object just to get the weekday, but use local date parts
            const tempDate = new Date(year, month - 1, day);
            const weekday = weekdayNames[tempDate.getDay()];
            
            dateTitle.textContent = `Activities for ${weekday}, ${monthNames[month - 1]} ${day}, ${year}`;
            
            modal.style.display = 'flex';
            loading.style.display = 'block';
            activities.style.display = 'none';
            noActivities.style.display = 'none';
            
            fetch(`/api/calendar/daily/${dateString}/`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    loading.style.display = 'none';
                    
                    if (data.success && data.activities && data.activities.length > 0) {
                        activities.style.display = 'block';
                        activities.innerHTML = '';
                        
                        data.activities.forEach(activity => {
                            // Skip personal events
                            if (activity.type !== 'personal_event') {
                                const activityElement = this.createActivityElement(activity);
                                activities.appendChild(activityElement);
                            }
                        });
                    } else {
                        noActivities.style.display = 'block';
                        console.log('No activities found for date:', dateString, 'Response:', data);
                    }
                })
                .catch(error => {
                    console.error('Error loading daily activities:', error);
                    loading.style.display = 'none';
                    activities.style.display = 'block';
                    activities.innerHTML = '<p style="color: #dc2626; text-align: center;">Error loading activities. Please try again.</p>';
                });
        },
        
        createActivityElement(activity) {
            const div = document.createElement('div');
            div.className = 'activity-item';
            
            const iconMap = {
                'assignment': 'fa-tasks',
                'quiz': 'fa-question-circle',
                'conference': 'fa-video',
                'course_deadline': 'fa-clock',
                'topic_deadline': 'fa-bookmark',
                'grading': 'fa-edit',
                'default': 'fa-circle'
            };
            
            const icon = iconMap[activity.icon] || iconMap['default'];
            
            const priorityColors = {
                'high': '#dc2626',
                'medium': '#f59e0b',
                'low': '#10b981'
            };
            const priorityColor = priorityColors[activity.priority];
            
            div.innerHTML = `
                <div class="activity-header">
                    <div class="activity-icon" style="background-color: ${priorityColor};">
                        <i class="fas ${icon}"></i>
                    </div>
                    <span class="activity-title">${activity.title}</span>
                    ${activity.time ? `<span class="activity-time">${activity.time}</span>` : ''}
                </div>
                <div class="activity-description">${activity.description}</div>
                ${activity.course ? `<div style="font-size: 0.9rem; color: #6b7280; margin-bottom: 0.75rem;">Course: ${activity.course}</div>` : ''}
                <div class="activity-meta">
                    <span class="activity-badge type">${activity.type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>
                    <span class="activity-badge priority ${activity.priority}">${activity.priority.charAt(0).toUpperCase() + activity.priority.slice(1)} Priority</span>
                </div>
            `;
            
            if (activity.url && activity.url !== '#') {
                div.addEventListener('click', () => {
                    window.location.href = activity.url;
                });
            }
            
            return div;
        },
        
        closeModal() {
            const modal = document.getElementById('mainActivityModal');
            if (modal) {
                modal.style.display = 'none';
            }
        },
        
        destroy() {
            // Clean up event listeners to prevent memory leaks
            const elements = [
                'prevMonth', 'nextMonth', 'todayBtn', 'closeActivityModal', 'mainActivityModal'
            ];
            
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.replaceWith(element.cloneNode(true));
                }
            });
            
            // Clear activities data
            this.activitiesData = {};
        }
    };
    
    // Initialize the main calendar with error handling
    try {
        MainCalendar.init();
    } catch (error) {
        console.error('Failed to initialize calendar:', error);
    }
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (MainCalendar && typeof MainCalendar.destroy === 'function') {
            MainCalendar.destroy();
        }
    });
});
</script>

<!-- Calendar JavaScript -->
<script src="{% static 'js/calendar.js' %}"></script>
{% endblock %} 