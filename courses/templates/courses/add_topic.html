{% extends "base.html" %}
{% load static %}
{% load course_filters %}

{% block title %}{% if action == 'Create' %}Create Topic{% else %}Edit Topic{% endif %}{% endblock %}

{% block extra_head %}
<!-- PREVENT BROWSER CACHING FOR TOPIC CREATION FORM -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="robots" content="noindex, nofollow">
{% endblock %}

{% block extra_css %}
<!-- Add error handling script -->
<script>
    console.log('Setting up global error handler');
    window.addEventListener('error', function(event) {
        console.error('JavaScript Error:', event.message, 'at', event.filename, 'line', event.lineno, 'column', event.colno);
        console.error('Error details:', event.error);
    });
</script>

<!-- Load CSS files -->
<link href="{% static 'core/css/courses/course_edit.css' %}" rel="stylesheet">
<link href="{% static 'core/css/courses/add_topic.css' %}" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="{% static 'admin/css/topic_admin.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'admin/css/forms.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'admin/css/widgets.css' %}">
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<!-- Include TinyMCE CSS - Same as course edit page -->
<link rel="stylesheet" href="{% static 'tinymce_editor/css/tinymce-widget.css' %}">
<!-- Mobile Tabs Accordion CSS -->
<link rel="stylesheet" href="{% static 'core/css/mobile-tabs-accordion.css' %}">

<style>
    /* Hide help text in TinyMCE statusbar */
    .tox-statusbar__help-text {
        display: none !important;
    }
    
    /* Force text content editor height - inline override */
    #text-content .tox.tox-tinymce {
        min-height: 450px !important;
        height: 450px !important;
        border: 2px solid #3b82f6 !important; /* Debug border */
    }
    
    #text-content .tox-edit-area__iframe {
        min-height: 400px !important;
        height: 400px !important;
        border: 1px solid #10b981 !important; /* Debug border */
    }
    
    #text_content.tinymce-editor {
        min-height: 450px !important;
        height: 450px !important;
        border: 1px solid #f59e0b !important; /* Debug border */
    }
    
    /* Ensure TinyMCE container has proper dimensions */
    #text-content.active .tox.tox-tinymce {
        min-height: 450px !important;
        height: 450px !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    #text-content.active .tox-edit-area {
        min-height: 400px !important;
        height: 400px !important;
    }
    
    #text-content.active .tox-edit-area__iframe {
        min-height: 400px !important;
        height: 400px !important;
    }
</style>

<!-- Fix for sidebar and header issues -->
<style>
    /* Site-wide fix for critical elements that should never be hidden */
    #sidebar,
    #sidebar .menu-item,
    #sidebar .submenu,
    #sidebar .menu-text,
    #sidebar svg,
    header .flex.items-center.gap-4,
    header .header-icon,
    header a[title="Discussions"],
    header a[title="Notifications"],
    header .hidden.md\:flex.flex-1.max-w-3xl,
    #sidebarToggle {
        display: block !important;
    }
    
    /* Exceptions for flex displays */
    #sidebar .menu-item,
    header .flex.items-center.gap-4,
    header .header-icon,
    header a[title="Discussions"],
    header a[title="Notifications"],
    header .hidden.md\:flex.flex-1.max-w-3xl {
        display: flex !important;
    }
    
    /* Exception for submenu hidden states */
    #sidebar .submenu.hidden {
        display: none !important;
    }
    
    /* Exception for mobile view */
    @media (max-width: 767px) {
        #sidebar {
            display: none !important;
        }
    }
    
    /* Custom CSS for 2-column topic form layout - 75/25 split with resize */
    .topic-form-custom-grid {
        display: flex;
        gap: 0;
        position: relative;
    }
    
    .topic-form-column-left {
        width: 75%;
        padding-right: 1rem;
        min-width: 50%;
        max-width: 90%;
    }
    
    .topic-form-column-right {
        width: 25%;
        padding-left: 1rem;
        min-width: 10%;
        max-width: 50%;
    }
    
    .column-resizer {
        width: 6px;
        background: #e5e7eb;
        cursor: col-resize;
        position: relative;
        border-radius: 3px;
        transition: background-color 0.2s;
        flex-shrink: 0;
    }
    
    .column-resizer:hover {
        background: #9ca3af;
    }
    
    .column-resizer:active {
        background: #6b7280;
    }
    
    .column-resizer::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 3px;
        height: 20px;
        background: repeating-linear-gradient(
            to bottom,
            #9ca3af 0px,
            #9ca3af 2px,
            transparent 2px,
            transparent 4px
        );
        border-radius: 1px;
    }
    
    @media (max-width: 1024px) {
        .topic-form-custom-grid {
            flex-direction: column;
        }
        
        .topic-form-column-left,
        .topic-form-column-right {
            width: 100%;
            padding: 0;
            margin-bottom: 1.5rem;
        }
        
        .column-resizer {
            display: none;
        }
    }
    
    /* Legacy grid class for backward compatibility */
    .topic-form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
    }
    
    @media (max-width: 1024px) {
        .topic-form-grid {
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
    }
    
    /* Enhanced Mobile Responsive Improvements */
    @media (max-width: 768px) {
        /* Ensure full width usage */
        .main-content {
            padding: 0 !important;
            width: 100% !important;
            max-width: none !important;
        }
        
        /* Override any page-level constraints */
        .container, .container-fluid {
            padding: 0 !important;
            margin: 0 !important;
            max-width: none !important;
            width: 100% !important;
        }
        
        .content-type-options {
            grid-template-columns: 1fr !important;
            gap: 0.75rem;
        }
        
        .content-type-option {
            width: 100%;
        }
        
        .content-type-option label {
            padding: 0.875rem 1rem;
            font-size: 0.9rem;
            min-height: 48px; /* Better touch target */
            width: 100%;
            display: block;
        }
        
        .tab-header {
            padding: 0.75rem 1rem !important;
            font-size: 0.875rem !important;
            min-height: 44px;
        }
        
        /* File upload area improvements */
        .file-upload-container .border-dashed {
            padding: 2rem 1rem;
        }
        
        /* Form input improvements */
        input[type="text"],
        input[type="url"],
        input[type="number"],
        select,
        textarea {
            font-size: 16px !important; /* Prevent zoom on iOS */
            min-height: 44px;
            padding: 0.75rem;
            width: 100% !important;
        }
        
        /* Button improvements */
        .btn,
        button {
            min-height: 44px;
            padding: 0.75rem 1rem;
            touch-action: manipulation;
        }
        
        /* Remove any constraining containers */
        .bg-white.rounded-lg.shadow-md {
            padding: 1rem !important;
            margin: 0 !important;
            border-radius: 0 !important;
        }
    }
    
    @media (max-width: 480px) {
        /* Complete mobile layout reset for full screen width */
        html, body {
            padding: 0 !important;
            margin: 0 !important;
            width: 100% !important;
            max-width: 100% !important;
            overflow-x: hidden !important;
        }
        
        /* Override any wrapper or container constraints */
        .wrapper, .page-wrapper, .content-wrapper,
        [class*="container"], [class*="wrapper"] {
            padding: 0 !important;
            margin: 0 !important;
            width: 100% !important;
            max-width: 100% !important;
        }
        
        /* Force mobile viewport behavior */
        @supports (-webkit-touch-callout: none) {
            /* iOS Safari specific */
            body {
                -webkit-text-size-adjust: 100% !important;
                width: 100vw !important;
            }
        }
        
        /* Bootstrap and framework overrides */
        .container-fluid,
        .container-sm,
        .container-md,
        .container-lg,
        .container-xl,
        .container-xxl {
            max-width: none !important;
            padding: 0 !important;
            margin: 0 !important;
            width: 100% !important;
        }
        
        /* Remove all container padding */
        .main-content {
            padding: 0 !important;
            margin: 0 !important;
            width: 100vw !important;
            max-width: 100vw !important;
        }
        
        .main-content > .bg-white.rounded-lg.shadow-md {
            margin: 0 !important;
            padding: 0.75rem !important;
            border-radius: 0 !important;
            box-shadow: none !important;
            width: 100% !important;
            max-width: 100% !important;
        }
        
        /* Remove breadcrumb padding completely */
        .px-6.py-4 {
            padding: 0.5rem 0.75rem !important;
            margin: 0 !important;
            width: 100% !important;
        }
        
        /* Ensure breadcrumb container uses full width */
        .px-6.py-4,
        .px-6,
        .py-4 {
            padding-left: 0.75rem !important;
            padding-right: 0.75rem !important;
            width: 100% !important;
            box-sizing: border-box !important;
        }
        
        /* Full width form grid */
        .topic-form-custom-grid {
            width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        .topic-form-column-left,
        .topic-form-column-right {
            padding: 0 !important;
            margin: 0 !important;
            width: 100% !important;
        }
        
        /* Full width content sections */
        .space-y-6,
        .space-y-4 {
            width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        /* Content type tabs edge-to-edge */
        .content-type-tabs {
            margin: 0 -0.75rem !important;
            width: calc(100% + 1.5rem) !important;
        }
        
        .tab-headers {
            padding: 0 0.75rem !important;
            margin: 0 !important;
        }
        
        .tab-content-wrapper {
            padding: 0.75rem !important;
            margin: 0 !important;
        }
        
        /* Content type options full width */
        .content-type-options {
            gap: 0.5rem;
            width: 100% !important;
            margin: 0 !important;
        }
        
        .content-type-option {
            width: 100% !important;
            margin: 0 !important;
        }
        
        .content-type-option label {
            padding: 0.75rem 0.875rem;
            font-size: 0.85rem;
            width: 100% !important;
            margin: 0 !important;
            display: block !important;
            box-sizing: border-box !important;
        }
        
        /* Tab header adjustments */
        .tab-header {
            padding: 0.625rem 0.75rem !important;
            font-size: 0.8rem !important;
            margin: 0 !important;
        }
        
        /* Form inputs edge-to-edge */
        input[type="text"],
        input[type="url"], 
        input[type="number"],
        select,
        textarea {
            width: 100% !important;
            box-sizing: border-box !important;
            margin: 0 !important;
            border-left: 0 !important;
            border-right: 0 !important;
            border-radius: 0 !important;
        }
        
        /* Title input full width */
        #topic_title {
            width: 100% !important;
            margin: 0 !important;
            border-radius: 0.375rem !important;
        }
        
        /* Flex layout adjustments */
        .flex.justify-end.space-x-4 {
            flex-direction: column;
            gap: 0.75rem;
            width: 100% !important;
            margin: 0 !important;
        }
        
        .flex.justify-end.space-x-4 > * {
            margin-left: 0 !important;
            width: 100% !important;
        }
        
        /* Form labels full width */
        label {
            width: 100% !important;
            margin: 0 0 0.5rem 0 !important;
        }
        
        /* Ensure no hidden overflow and proper viewport fitting */
        * {
            max-width: 100vw !important;
            box-sizing: border-box !important;
        }
        
        /* Specific overrides for common problematic elements */
        div, section, main, article, aside,
        .row, .col, .col-*, .grid, .flex {
            width: 100% !important;
            max-width: 100% !important;
            margin-left: 0 !important;
            margin-right: 0 !important;
        }
        
        /* Force viewport constraints */
        body > *,
        #app > *,
        .app-wrapper > *,
        main > * {
            max-width: 100vw !important;
            overflow-x: hidden !important;
        }
    }
    
    /* Touch device optimizations */
    @media (hover: none) and (pointer: coarse) {
        .content-type-option input[type="radio"] + label {
            -webkit-tap-highlight-color: rgba(0,0,0,0.1);
        }
        
        button, .btn, input[type="submit"], input[type="button"] {
            -webkit-tap-highlight-color: rgba(0,0,0,0.1);
        }
        
        /* Ensure all interactive elements meet touch target minimums */
        a, button, input, select, textarea, .btn, .tab-header {
            min-height: 44px;
            touch-action: manipulation;
        }
    }
    
    /* Ensure TinyMCE editor fits well in column layout */
    .content-type-field .mce-container {
        max-width: 100%;
    }
    
    /* Fix for sidebar submenu visibility issue */
    #sidebar .submenu:not(.hidden) {
        max-height: none !important;
        overflow: visible !important;
    }
    
    #sidebar .submenu:not(.hidden) {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        max-height: 1000px !important;
    }
    
    /* Fix for header icons */
    .header-icon, 
    a[title="Discussions"],
    a[title="Notifications"] {
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    /* Fix discussion icon specifically - override Tailwind hidden class */
    .hidden.sm\:flex[title="Discussions"] {
        display: flex !important;
    }
    
    /* Fix SVG icons */
    .header-icon svg,
    a[title="Discussions"] svg,
    a[title="Notifications"] svg {
        display: inline !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    /* Fix for notification dots */
    .header-icon span,
    a[title="Discussions"] span,
    a[title="Notifications"] span {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    /* Mobile menu button fix - enhanced for better visibility and interaction */
    #mobile-menu-toggle {
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: relative;
        z-index: 100;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    #mobile-menu-toggle:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }
    
    #mobile-menu-toggle svg {
        display: inline !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    /* Enhanced sidebar submenu functionality */
    #sidebar button.menu-item.has-submenu {
        cursor: pointer;
        width: 100%;
        display: flex !important;
        align-items: center;
        justify-content: space-between;
    }
    
    #sidebar .menu-item.has-submenu .arrow-icon {
        transition: transform 0.3s ease;
    }
    
    #sidebar .menu-item.has-submenu.expanded .arrow-icon {
        transform: rotate(180deg);
    }
    
    /* Explicitly scoped content-type-field hidden class to avoid affecting sidebar menus */
    .content-type-field.hidden {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        max-height: 0 !important;
        overflow: hidden !important;
    }
    
    /* But make sure submenu's hidden class is properly applied and doesn't affect content fields */
    #sidebar .submenu.hidden {
        display: none !important;
    }
    
    #sidebar .submenu:not(.hidden) {
        display: block !important;
    }
    
    #sidebar .submenu a {
        display: flex !important;
        align-items: center;
        padding-left: 2.5rem;
    }
    
    /* Ensure menu item text is visible */
    #sidebar .menu-text {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    /* Logo position fix */
    header .flex.items-center.gap-4 {
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    header .flex.items-center.gap-4 a {
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    header .flex.items-center.gap-4 a img {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        height: 2.25rem !important; /* Ensures the logo height is consistent */
    }
    
    /* Fix for collapsed sidebar in mobile view */
    @media (max-width: 767px) {
        #sidebar {
            display: none !important;
        }
        
        #main-content {
            margin-left: 0 !important;
            width: 100% !important;
        }
        .hidden.md\:flex.flex-1.max-w-3xl.px-6 {
    display: none !important;
}
    }
    
    /* Main layout styles - FIXED to not affect header search box */
    #main-content .max-w-3xl {
        max-width: 100%;
    }

    /* Fix for search box in header - KEEP THIS VISIBLE */
    header .hidden.md\:flex.flex-1.max-w-3xl {
        display: flex !important;
        max-width: 48rem !important; /* 3xl = 48rem */
        visibility: visible !important;
        opacity: 1 !important;
    }

    /* Fix for mobile search container */
    #mobile-search-toggle:focus + #mobile-search-container,
    #mobile-search-container.open {
        display: block !important;
    }

    .main-content {
        max-width: 100%;
        margin: 0 auto;
        padding: 1rem;
    }

    /* Content type tabs */
    .content-type-tabs {
        margin-top: 1.5rem;
        margin-bottom: 2rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        overflow: hidden;
    }
    
    .tab-headers {
        display: flex;
        background-color: #f9fafb;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .tab-header {
        flex: 1;
        padding: 0.875rem 1rem;
        background-color: transparent;
        border: none;
        border-right: 1px solid #e5e7eb;
        color: #6b7280;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .tab-header:last-child {
        border-right: none;
    }
    
    .tab-header:hover {
        background-color: #f3f4f6;
        color: #374151;
    }
    
    .tab-header.active {
        background-color: #ffffff;
        color: #1f2937;
        font-weight: 600;
        border-bottom: 2px solid #3b82f6;
        margin-bottom: -1px;
    }
    
    .tab-content-wrapper {
        background-color: #ffffff;
    }
    
    .tab-content {
        padding: 1.5rem;
        display: none;
        min-height: 0;
        height: auto;
    }
    
    .tab-content.active {
        display: block;
        min-height: 0;
        height: auto;
    }
    
    @media (min-width: 768px) {
        .main-content {
            padding: 2rem;
        }
    }

    /* Progress Animation Styles */
    #progress-container {
        transition: all 0.3s ease;
        min-width: 200px;
    }
    
    #progress-bar {
        transition: width 0.3s ease;
    }
    
    @media (max-width: 768px) {
        .flex.justify-end.space-x-4 {
            flex-direction: column;
            align-items: stretch;
            gap: 10px;
        }
        
        #progress-container {
            margin-right: 0;
            margin-bottom: 10px;
        }
    }

    /* Content type options */
    .content-type-options {
        display: flex;
        flex-wrap: wrap;
        gap: 0.25rem;
    }

    .content-type-option {
        position: relative;
    }

    .content-type-option input[type="radio"] {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
    }

    .content-type-option label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.375rem 0.5rem;
        background-color: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 0.25rem;
        color: #374151;
        font-weight: 500;
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .content-type-option label i {
        font-size: 0.875rem;
        width: 14px;
        text-align: center;
    }

    .content-type-option input[type="radio"]:checked + label {
        background-color: #eef2ff;
        border-color: #3b82f6;
        color: #1f2937;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .content-type-option input[type="radio"]:focus + label {
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
    }

    .content-type-option label:hover {
        background-color: #f3f4f6;
        border-color: #d1d5db;
    }

    /* Disabled content type options */
    .content-type-option input[type="radio"]:disabled + label,
    .content-type-option .disabled-label {
        background-color: #f3f4f6;
        border-color: #e5e7eb;
        color: #9ca3af;
        cursor: not-allowed;
        opacity: 0.6;
    }

    .content-type-option input[type="radio"]:disabled + label:hover,
    .content-type-option .disabled-label:hover {
        background-color: #f3f4f6;
        border-color: #e5e7eb;
    }

    /* Content type fields */
    .content-type-field {
        display: none;
        margin-top: 1rem;
        padding: 1.5rem;
        background-color: #ffffff;
        border-radius: 0.5rem;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        border: 1px solid #e5e7eb;
    }
    
    /* Limit the hidden class to content type fields specifically, not affecting header */
    .content-type-field.active {
        display: block !important;
        opacity: 1 !important;
        visibility: visible !important;
        height: auto !important;
        min-height: auto !important;
        overflow: visible !important;
        margin-bottom: 1.5rem;
    }

    /* Specific fix for text content field to ensure proper height */
    #text-content.active {
        display: block !important;
        opacity: 1 !important;
        visibility: visible !important;
        height: auto !important;
        min-height: 500px !important;
        overflow: visible !important;
        padding: 1.5rem !important;
        margin-top: 1rem !important;
    }

    /* Form elements */
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: #374151;
        font-weight: 500;
    }
    
    .form-group input[type="text"],
    .form-group input[type="url"],
    .form-group input[type="file"],
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 0.75rem;
        background-color: #ffffff;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        color: #1f2937;
        font-size: 0.875rem;
        transition: all 0.2s ease;
    }
    
    .form-group input[type="text"]:focus,
    .form-group input[type="url"]:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        background-color: #ffffff;
    }

    /* Make hidden class more specific to content areas, not for header elements */
    /* #main-content .hidden:not(header *) {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
    } */
    /* Instead, only hide content-type fields */
    .content-type-field.hidden {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
    }
    
    /* Toast notification container */
    #toast-container {
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        max-width: 90%;
        width: 25rem;
    }
    
    /* Toast animations */
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
    
    .toast-enter {
        animation: slideIn 0.3s ease-out forwards;
    }
    
    .toast-leave {
        animation: slideOut 0.3s ease-in forwards;
    }
    
    /* Form validation */
    .validation-error {
        color: #ef4444;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }
    
    .global-form-error {
        background-color: #fee2e2;
        border-left: 4px solid #ef4444;
        color: #b91c1c;
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 0.25rem;
    }
    
    input.border-red-500, 
    select.border-red-500, 
    textarea.border-red-500 {
        border-color: #ef4444 !important;
    }
    
    /* Quill Editor Styles */
    #quill-editor {
        height: 400px !important;
        display: block !important;
        visibility: visible !important;
    }
    
    .ql-toolbar.ql-snow {
        border: 1px solid #d1d5db;
        border-top-left-radius: 0.375rem;
        border-top-right-radius: 0.375rem;
        background-color: #f9fafb;
        display: block !important;
    }
    
    .ql-container.ql-snow {
        border: 1px solid #d1d5db;
        border-bottom-left-radius: 0.375rem;
        border-bottom-right-radius: 0.375rem;
        background-color: #ffffff;
        font-family: inherit;
        font-size: 1rem;
    }
    
    /* Ensure the text-content field is always properly displayed when active */
    #text-content.active {
        display: block !important;
        opacity: 1 !important;
        visibility: visible !important;
    }
    
    /* Ensure the quill editor container is visible */
    #text-content.active #quill-editor {
        display: block !important;
        visibility: visible !important;
    }
    
    /* Fix for duplicate toolbars */
    .ql-toolbar + .ql-toolbar {
        display: none !important;
    }
    
    /* Remove any { characters that might appear */
    .ql-editor:not(.ql-blank)::before {
        content: none !important;
    }
    
    /* Additional fixes for preventing { character from appearing */
    .ql-editor::before {
        content: none !important;
    }
    
    .ql-editor p:first-child:only-child:empty,
    .ql-editor > p:first-child:empty {
        display: none !important;
    }
    
    /* Fix for the default placeholder behavior */
    .ql-editor.ql-blank::before {
        content: attr(data-placeholder) !important;
        color: rgba(0, 0, 0, 0.6) !important;
        font-style: italic !important;
        pointer-events: none !important;
        position: absolute !important;
    }

    /* Hide any unwanted characters */
    .ql-editor > p:empty,
    .ql-editor > p:only-child:empty {
        display: none;
    }

    /* Image styles in Quill editor */
    .ql-editor img {
        max-width: 100%;
        height: auto;
        display: block;
        margin: 1rem 0;
    }
    
    /* Image upload progress styles */
    .ql-image-uploading {
        color: #3b82f6;
        font-style: italic;
        background-color: #f3f4f6;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        display: inline-block;
    }
    
    /* Responsive section layout */
    @media (max-width: 640px) {
        .section-grid {
            display: block;
        }
        
        .section-grid > div {
            margin-bottom: 1rem;
        }
        
        .flex.space-x-2 {
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .flex.space-x-2 > * {
            margin-left: 0 !important;
            width: 100%;
        }
        
        .flex.space-x-4 {
            flex-wrap: wrap;
            gap: 0.5rem;
        }
    }

    .field-wrapper {
        margin-bottom: 1.5rem;
    }
    .field-wrapper label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }
    .field-wrapper input[type="text"],
    .field-wrapper input[type="url"],
    .field-wrapper textarea,
    .field-wrapper select {
        width: 100%;
        padding: 0.75rem;
        border-radius: 0.375rem;
        border: 1px solid #e5e7eb;
    }
    .content-options {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-top: 1rem;
    }
    .content-option {
        display: flex;
        align-items: center;
    }
    .content-option input[type="radio"] {
        margin-right: 0.5rem;
    }
    .file-upload-container {
        position: relative;
    }
    .file-upload-btn {
        display: inline-block;
        padding: 0.5rem 1rem;
        background-color: #4b5563;
        color: white;
        border-radius: 0.375rem;
        cursor: pointer;
    }
    .file-input {
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
    }
    .selected-filename {
        margin-top: 0.5rem;
        font-size: 0.875rem;
    }
    .btn-primary {
        background-color: #3b82f6;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 0.375rem;
        border: none;
        cursor: pointer;
        font-weight: 500;
    }
    #text-content.active #quill-editor,
    #text-content.active .ql-container,
    #text-content.active .ql-editor {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    /* Ensure TinyMCE editor is visible in text content field */
    #text-content.active .tox.tox-tinymce {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        min-height: 450px !important;
    }
    
    /* Ensure TinyMCE iframe is visible */
    #text-content.active iframe[id*="text_content"] {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        min-height: 400px !important;
    }
    
    /* Additional fixes for TinyMCE visibility when text content is selected */
    #text-content.active .tox-tinymce {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        min-height: 450px !important;
    }
    
    #text-content.active .tox-edit-area {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    #text-content.active .tox-edit-area__iframe {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        min-height: 300px !important;
    }
    
    /* Ensure Quill toolbar is visible */
    .ql-toolbar.ql-snow {
        display: block !important;
        visibility: visible !important;
    }

    /* Dropdown menu styling */
    .dropdown-menu {
        display: block;
        visibility: visible;
        opacity: 1;
        z-index: 50;
    }
    
    /* Fix for dropdown menus */
    #quiz-dropdown,
    #assignment-dropdown,
    #conference-dropdown,
    #discussion-dropdown {
        z-index: 100;
        position: absolute;
        background-color: white;
    }
    
    /* Remove display: none from initially hidden dropdowns so our JS can control them properly */
    #quiz-dropdown.hidden,
    #assignment-dropdown.hidden,
    #conference-dropdown.hidden,
    #discussion-dropdown.hidden {
        display: none !important;
    }

    /* --- Sidebar submenu visibility fix --- */
    #sidebar .submenu:not(.hidden) {
        display: block !important;
        max-height: 1200px !important;
        opacity: 1 !important;
        visibility: visible !important;
        overflow: visible !important;
    }
    #sidebar .submenu.hidden {
        display: none !important;
        max-height: 0 !important;
        opacity: 0 !important;
        visibility: hidden !important;
    }
    
    /* Hide assignment description and instructions fields */
    .assignment-content-fields {
        display: none !important;
        visibility: hidden !important;
        height: 0 !important;
        overflow: hidden !important;
        opacity: 0 !important;
        max-height: 0 !important;
        margin: 0 !important;
        padding: 0 !important;
        border: 0 !important;
    }
    
    /* Hide the assignment description and instructions fields within tinymce too */
    #assignment_description,
    #assignment_instructions,
    textarea[name="assignment_description"],
    textarea[name="assignment_instructions"] {
        display: none !important;
        visibility: hidden !important;
        height: 0 !important;
        overflow: hidden !important;
        opacity: 0 !important;
        max-height: 0 !important;
    }
    
    /* Also hide any surrounding elements */
    #assignment_description + *,
    #assignment_instructions + *,
    textarea[name="assignment_description"] + *,
    textarea[name="assignment_instructions"] + * {
        display: none !important;
        visibility: hidden !important;
    }
    
    /* Toast notification animations */
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
    
    .toast-enter {
        animation: slideIn 0.3s ease-out forwards;
    }
    
    .toast-leave {
        animation: slideOut 0.3s ease-in forwards;
    }
    
    #toast-container {
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        max-width: 90%;
        width: 25rem;
    }

    /* Ensure the status section is always visible */
    #status-section,
    #status-section div,
    #topic_status {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    /* Make sure no CSS rule accidentally hides the status dropdown */
    select#topic_status {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        height: auto !important;
        min-height: 2.5rem !important;
    }
</style>
{% endblock %}

{% block content %}


<!-- Breadcrumbs -->
<div class="px-6 py-4">
    {% include 'components/breadcrumb.html' with breadcrumbs=breadcrumbs %}
</div>

<div class="main-content">
    <div class="bg-white rounded-lg shadow-md p-6">
        <h1 class="text-2xl font-bold mb-6">{% if action == 'Create' %}Create Topic{% else %}Edit Topic{% endif %}</h1>
        
        <form id="topicForm" data-form-id="{% if topic.id %}topic_edit_{{ topic.id }}{% else %}topic_create_{{ course.id }}{% if section_id %}_section_{{ section_id }}{% endif %}{% endif %}" method="POST" action="{% if topic.id and section_id %}{% url 'courses:topic_section_edit' topic.id section_id %}{% elif topic.id %}{% url 'courses:topic_edit' topic.id %}{% else %}{% url 'courses:topic_create' course.id %}{% endif %}" enctype="multipart/form-data" class="space-y-6" autocomplete="off" data-no-autocomplete="true">
            {% csrf_token %}
            <div class="hidden">
                {% if topic.id %}<input type="hidden" name="topic_id" value="{{ topic.id }}">{% endif %}
                {% if course.id %}<input type="hidden" name="course" value="{{ course.id }}">{% endif %}
                {% if section_id %}<input type="hidden" name="section" value="{{ section_id }}">{% endif %}
                {% if has_assignment and assignment_id %}<input type="hidden" name="assignment_id" value="{{ assignment_id }}">{% endif %}
                {% if has_quiz and quiz_id %}<input type="hidden" name="quiz_id" value="{{ quiz_id }}">{% endif %}
                {% if has_conference and conference_id %}<input type="hidden" name="conference_id" value="{{ conference_id }}">{% endif %}
                {% if has_discussion and discussion_id %}<input type="hidden" name="discussion_id" value="{{ discussion_id }}">{% endif %}
            </div>
            
            <!-- Form Errors -->
            {% if form_errors %}
            <div class="p-4 mb-4 border-l-4 border-red-500 bg-red-50 text-red-700">
                <h3 class="text-lg font-medium">Please correct the following errors:</h3>
                <ul class="list-disc ml-5 mt-2">
                    {% for field, errors in form_errors.items %}
                        {% for error in errors %}
                            <li>{{ field }}: {{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <!-- Debug Form Data -->
            {% if debug_mode %}
            <div class="bg-gray-100 p-4 rounded mb-4">
                <h3 class="font-bold">Debug Form Data</h3>
                <pre>{{ form.data|pprint }}</pre>
            </div>
            {% endif %}
            
            <!-- Create 2-Column Layout -->
            <div class="topic-form-custom-grid">
                <!-- First Column: Basic Info, Content Type, and Text Content -->
                <div class="topic-form-column-left space-y-6">
                    <!-- Basic Information -->
                    <div class="space-y-4">
                        <div>
                            <label for="topic_title" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                            <input type="text" id="topic_title" name="title" value="{% if topic.id %}{{ topic.title|default:'' }}{% else %}{{ form.title.value|default:'' }}{% endif %}" required
                                   class="w-full px-3 py-2 text-sm rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                                   autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" data-no-autofill="true">
                        </div>
                        

                        
                        <!-- Content Type Selection -->
                        {% if topic.id %}
                        <div class="mb-4 p-3 bg-blue-50 border-l-4 border-blue-500 text-blue-700">
                            <p><i class="fas fa-info-circle mr-2"></i> Content type cannot be changed after a topic is created. The selected content type is locked.</p>
                        </div>
                        <!-- Hidden input to ensure content type is submitted even when radio buttons are disabled -->
                        <input type="hidden" name="content_type" value="{{ topic.content_type }}">
                        {% endif %}
                        
                        <!-- Content Type Selection Header -->
                        <div class="content-type-header">
                            <h3 class="text-base font-semibold text-gray-900 mb-2">Select Topic Content Type</h3>
                            <p class="text-sm text-gray-600 mb-3">Choose the type of content you want to add to this topic</p>
                        </div>
                        
                        <!-- Content Type Tabs -->
                        <div class="content-type-tabs" id="contentTypeTabs">
                            <!-- Tab Headers -->
                            <div class="tab-headers">
                                <button type="button" class="tab-header active" onclick="switchTab('learningContent')">
                                    <i class="fas fa-book mr-2"></i>Learning Content
                                </button>
                                <button type="button" class="tab-header" onclick="switchTab('assessments')">
                                    <i class="fas fa-clipboard-check mr-2"></i>Assessments
                                </button>
                            </div>
                            
                            <!-- Tab Content -->
                            <div class="tab-content-wrapper">
                                <!-- Learning Content Tab -->
                                <div class="tab-content active" id="learningContent">
                                    <div class="content-type-options">
                                        {% for type, label in content_types %}
                                            {% if type in 'Text,Audio,Video,Web,Document,EmbedVideo'|split:',' %}
                                            <div class="content-type-option">
                                                <input type="radio" id="type_{{ type }}" name="content_type" value="{{ type }}"
                                                       {% if topic.content_type == type or not topic and forloop.first %}checked{% endif %}>
                                                <label for="type_{{ type }}">
                                                    {% if type == 'Text' %}<i class="fas fa-font"></i>
                                                    {% elif type == 'Audio' %}<i class="fas fa-volume-up"></i>
                                                    {% elif type == 'Video' %}<i class="fas fa-video"></i>
                                                    {% elif type == 'Web' %}<i class="fas fa-globe"></i>
                                                    {% elif type == 'Document' %}<i class="fas fa-file-alt"></i>
                                                    {% elif type == 'EmbedVideo' %}<i class="fab fa-youtube"></i>
                                                    {% endif %}
                                                    {{ label }}
                                                </label>
                                            </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>

                                <!-- Assessments Tab -->
                                <div class="tab-content" id="assessments">
                                    <div class="content-type-options">
                                        {% for type, label in content_types %}
                                            {% if type in 'Quiz,Assignment,Conference,Discussion'|split:',' %}
                                            <div class="content-type-option">
                                                {# Quiz topics are now unlimited per course - no restriction notice needed #}
                                                {# Assignment topics are now unlimited per course - no restriction notice needed #}
                                                <input type="radio" id="type_{{ type }}" name="content_type" value="{{ type }}"
                                                       {% if topic.content_type == type %}checked{% endif %}>
                                                <label for="type_{{ type }}">
                                                    {% if type == 'Quiz' %}<i class="fas fa-question-circle"></i>
                                                    {% elif type == 'Assignment' %}<i class="fas fa-tasks"></i>
                                                    {% elif type == 'Conference' %}<i class="fas fa-users"></i>
                                                    {% elif type == 'Discussion' %}<i class="fas fa-comments"></i>
                                                    {% endif %}
                                                    {{ label }}
                                                </label>
                                            </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Text Content -->
                        <div id="text-content" class="content-type-field">
                            <div>
                                <label for="{{ form.text_content.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Text Content</label>
                                {{ form.text_content }}
                                <p class="mt-1 text-xs text-gray-500">
                                    Format your content using the toolbar. Press ESC to exit fullscreen editing.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- File Upload Sections -->

                    <!-- File Upload Sections -->
                    {% for type in 'audio,video,document'|split:',' %}
                    <div id="{{ type }}-content" class="content-type-field">
                        <div class="file-upload-container">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Upload {{ type|title }}</label>
                            <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md hover:border-gray-400 transition-colors">
                                <div class="space-y-1 text-center">
                                    <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                        {% if type == 'audio' %}
                                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                        {% elif type == 'video' %}
                                        <path d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2v-8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                        {% else %}
                                        <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                        {% endif %}
                                    </svg>
                                    <div class="flex text-sm text-gray-600">
                                        <label for="{{ type }}-file-input" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500">
                                            <span>Upload a {{ type }} file</span>
                                            <input id="{{ type }}-file-input" name="content_file" type="file" accept="{{ type }}/*" class="file-input sr-only">
                                        </label>
                                        <p class="pl-1">or drag and drop</p>
                                    </div>
                                    <p class="text-xs text-gray-500">
                                        {% if type == 'audio' %}MP3, WAV, OGG up to 100MB{% elif type == 'video' %}MP4, AVI, MOV up to 500MB{% else %}PDF, DOC, DOCX, XLS, XLSX up to 50MB{% endif %}
                                    </p>
                                </div>
                            </div>
                            {% if topic.content_file and topic.content_type.lower == type %}
                            <div class="selected-filename mt-2 text-sm text-gray-600">
                                Current file: {{ topic.content_file|last_part }}
                            </div>
                            <div class="file-preview mt-2 text-sm">
                                <a href="{{ topic.content_file.url }}" target="_blank" class="text-blue-600 hover:underline">
                                    View current file
                                </a>
                            </div>
                            <p class="mt-1 text-sm text-gray-500">Upload a new file to replace the current one.</p>
                            {% else %}
                            <div class="selected-filename mt-2 text-sm text-gray-600 hidden"></div>
                            <div class="file-preview mt-4 hidden"></div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}

                    <!-- Web Content -->
                    <div id="web-content" class="content-type-field">
                        <div>
                            <label for="web_url" class="block text-sm font-medium text-gray-700 mb-1">URL</label>
                            <input type="url" id="web_url" name="web_url" value="{{ topic.web_url|default:'' }}"
                                   class="w-full px-3 py-2 text-sm rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                    </div>

                    <!-- EmbedVideo Content -->
                    <div id="embedvideo-content" class="content-type-field">
                        <div>
                            <label for="embed_code" class="block text-sm font-medium text-gray-700 mb-1">Embed Code</label>
                            <textarea id="embed_code" name="embed_code" rows="4" 
                                      class="w-full px-3 py-2 text-sm rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">{{ topic.embed_code|default:'' }}</textarea>
                            <p class="mt-1 text-xs text-gray-500">Paste the embed code from YouTube, Vimeo, etc. For YouTube, click 'Share' > 'Embed' and copy the code.</p>
                        </div>
                    </div>

                    <!-- Quiz Selection -->
                    <div id="quiz-content" class="content-type-field">
                        <div>
                            <label for="quiz-select" class="block text-sm font-medium text-gray-700 mb-1">Select Quiz</label>
                            
                            <!-- Help Note for Quiz Creation -->
                            <div class="mb-3 p-3 bg-blue-50 border-l-4 border-blue-400 text-blue-800 rounded-r-md">
                                <div class="flex items-start">
                                    <svg class="w-4 h-4 mt-0.5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                    </svg>
                                    <div class="text-sm">
                                        <p class="font-medium">Need to create a quiz first?</p>
                                        <p class="mt-1">If you haven't already created a quiz, click the button below to create one, then return here to add it as a topic.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <select name="quiz" id="quiz-select" 
                                    class="w-full px-3 py-2 text-sm rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 content-item-select">
                                <option value="">Select a quiz</option>
                                {% for quiz in quizzes %}
                                <option value="{{ quiz.id }}" {% if quiz_id == quiz.id %}selected{% endif %}>{{ quiz.title }}</option>
                                {% endfor %}
                            </select>
                            
                            <div class="flex mt-3 space-x-2">
                                <div class="relative inline-block text-left">
                                    <a href="{% url 'quiz:create_quiz' %}" target="_blank" 
                                       class="inline-flex items-center px-4 py-2 bg-primary-600 text-white text-sm font-medium rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors duration-200">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                        </svg>
                                        Create Quiz
                                    </a>
                                </div>
                                <button type="button" onclick="location.reload()" 
                                        class="inline-flex items-center px-3 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors duration-200">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    Refresh List
                                </button>
                            </div>
                        </div>
                        
                        <!-- Removed Quiz Description and Instructions section -->
                    </div>

                    
                    <!-- Assignment Selection -->
                    <div id="assignment-content" class="content-type-field">
                        <div>
                            <label for="assignment-select" class="block text-sm font-medium text-gray-700 mb-1">Select Assignment</label>
                            
                            <!-- Help Note for Assignment Creation -->
                            <div class="mb-3 p-3 bg-green-50 border-l-4 border-green-400 text-green-800 rounded-r-md">
                                <div class="flex items-start">
                                    <svg class="w-4 h-4 mt-0.5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                    </svg>
                                    <div class="text-sm">
                                        <p class="font-medium">Need to create an assignment first?</p>
                                        <p class="mt-1">If you haven't already created an assignment, click the button below to create one, then return here to add it as a topic.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <select name="assignment" id="assignment-select" 
                                    class="w-full px-3 py-2 text-sm rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 content-item-select">
                                <option value="">Select an assignment</option>
                                {% for assignment in assignments %}
                                <option value="{{ assignment.id }}" {% if assignment_id == assignment.id %}selected{% endif %}>{{ assignment.title }}</option>
                                {% endfor %}
                            </select>
                            
                            <div class="flex mt-3 space-x-2">
                                <div class="relative inline-block text-left">
                                    <a href="{% url 'assignments:create_assignment' %}" target="_blank" 
                                       class="inline-flex items-center px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors duration-200">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                        </svg>
                                        Create Assignment
                                    </a>
                                </div>
                                <button type="button" onclick="location.reload()" 
                                        class="inline-flex items-center px-3 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors duration-200">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    Refresh List
                                </button>
                            </div>
                        </div>
                        
                        <!-- Assignment Description and Instructions section removed -->
                    </div>

                    <!-- Conference Selection -->
                    <div id="conference-content" class="content-type-field">
                        <div>
                            <label for="conference-select" class="block text-sm font-medium text-gray-700 mb-1">Select Conference</label>
                            
                            <!-- Help Note for Conference Creation -->
                            <div class="mb-3 p-3 bg-purple-50 border-l-4 border-purple-400 text-purple-800 rounded-r-md">
                                <div class="flex items-start">
                                    <svg class="w-4 h-4 mt-0.5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                    </svg>
                                    <div class="text-sm">
                                        <p class="font-medium">Need to create a conference first?</p>
                                        <p class="mt-1">If you haven't already created a conference/meeting, click the button below to create one, then return here to add it as a topic.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <select name="conference" id="conference-select" 
                                    class="w-full px-3 py-2 text-sm rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 content-item-select">
                                <option value="">Select a conference</option>
                                {% for conference in conferences %}
                                <option value="{{ conference.id }}" {% if conference_id == conference.id %}selected{% endif %}>{{ conference.title }}</option>
                                {% endfor %}
                            </select>
                            
                            <div class="flex mt-3 space-x-2">
                                <div class="relative inline-block text-left">
                                    <a href="{% url 'conferences:new_conference_course' course.id %}" target="_blank" 
                                       class="inline-flex items-center px-4 py-2 bg-purple-600 text-white text-sm font-medium rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-colors duration-200">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                        </svg>
                                        Create Conference
                                    </a>
                                </div>
                                <button type="button" onclick="location.reload()" 
                                        class="inline-flex items-center px-3 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors duration-200">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    Refresh List
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Discussion Selection -->
                    <div id="discussion-content" class="content-type-field">
                        <div>
                            <label for="discussion-select" class="block text-sm font-medium text-gray-700 mb-1">Select Discussion</label>
                            
                            <!-- Help Note for Discussion Creation -->
                            <div class="mb-3 p-3 bg-orange-50 border-l-4 border-orange-400 text-orange-800 rounded-r-md">
                                <div class="flex items-start">
                                    <svg class="w-4 h-4 mt-0.5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                    </svg>
                                    <div class="text-sm">
                                        <p class="font-medium">Need to create a discussion first?</p>
                                        <p class="mt-1">If you haven't already created a discussion topic, click the button below to create one, then return here to add it as a topic.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <select name="discussion" id="discussion-select" 
                                    class="w-full px-3 py-2 text-sm rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 content-item-select">
                                <option value="">Select a discussion</option>
                                {% for discussion in discussions %}
                                <option value="{{ discussion.id }}" {% if discussion_id == discussion.id %}selected{% endif %}>{{ discussion.title }}</option>
                                {% endfor %}
                            </select>
                            
                            <div class="flex mt-3 space-x-2">
                                <div class="relative inline-block text-left">
                                    <a href="{% url 'discussions:new_discussion_with_course' %}" target="_blank" 
                                       class="inline-flex items-center px-4 py-2 bg-orange-600 text-white text-sm font-medium rounded-md hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 transition-colors duration-200">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                        </svg>
                                        Create Discussion
                                    </a>
                                </div>
                                <button type="button" onclick="location.reload()" 
                                        class="inline-flex items-center px-3 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors duration-200">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    Refresh List
                                </button>
                            </div>
                        </div>
                        
                        <!-- Removed Discussion Description and Instructions section -->
                    </div>
                    
                    <!-- Description field - Shows only for specific content types -->
                    <div id="description-field-wrapper" class="mb-4" style="display: none !important;">
                        <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            Description
                            <span class="text-gray-500 text-xs">(Optional - will be displayed to learners alongside the content)</span>
                        </label>
                        {{ form.description }}
                        <p class="mt-1 text-xs text-gray-500">
                            Add a description to provide context and additional information about this topic to your learners.
                        </p>
                    </div>
                    
                    <div id="instructions-field-wrapper" style="display: none !important;">
                        <label for="{{ form.instructions.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Instructions</label>
                        {{ form.instructions }}
                    </div>
                </div>

                <!-- Column Resizer -->
                <div class="column-resizer" id="columnResizer"></div>

                <!-- Second Column: Status, Section, and Access Period -->
                <div class="topic-form-column-right space-y-6">
                    <!-- Status -->
                    <div class="form-group">
                        <label>Status</label>
                        <select name="status">
                            <option value="draft" {% if topic.status == 'draft' %}selected{% endif %}>Draft</option>
                            <option value="active" {% if topic.status == 'active' %}selected{% endif %}>Publish</option>
                        </select>
                    </div>

                    <!-- Section Selection -->
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label for="section" class="block text-sm font-medium text-gray-700 mb-1">Section (Optional)</label>
                            
                            <!-- New section input field - initially hidden -->
                            <div id="new-section-input" class="mb-2" style="display: none;">
                                <input type="text" id="new_section_name" name="new_section_name" 
                                    class="w-full px-3 py-2 text-sm rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                                    placeholder="Enter new section name (optional)">
                            </div>
                            
                            <div class="flex space-x-2 section-grid">
                                <select id="section" name="section" 
                                    class="w-full px-3 py-2 text-sm rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                    <option value="">-- No Section (Standalone Topic) --</option>
                                    {% for section in sections %}
                                    <option value="{{ section.id }}" {% if section_id|stringformat:"s" == section.id|stringformat:"s" %}selected{% endif %}>{{ section.name }}</option>
                                    {% endfor %}
                                    <option value="new_section">-- Create New Section --</option>
                                </select>
                            </div>
                            <p class="mt-1 text-xs text-gray-500">Sections are completely optional. You can create topics without assigning them to any section.</p>
                        </div>
                    </div>

                    <!-- Access Period -->
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="topic_start_date" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                                <input type="datetime-local" id="topic_start_date" name="start_date"
                                       class="w-full px-3 py-2 text-sm rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                                       value="{% if topic.start_date %}{{ topic.start_date|date:'Y-m-d' }}T00:00{% endif %}">
                            </div>
                            <div>
                                <label for="topic_end_date" class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                                <input type="datetime-local" id="topic_end_date" name="end_date"
                                       class="w-full px-3 py-2 text-sm rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                                       value="{% if topic.end_date %}{{ topic.end_date|date:'Y-m-d' }}T00:00{% endif %}"
                                       {% if topic.endless_access %}disabled{% endif %}>
                            </div>
                        </div>

                        <div class="flex items-center">
                            <input type="checkbox" id="topic_endless_access" name="endless_access" 
                                   {% if topic.endless_access %}checked{% endif %}
                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="topic_endless_access" class="ml-2 text-sm text-gray-700">
                                Endless Access (No End Date)
                            </label>
                        </div>
                    </div>

                    <!-- Learner Restrictions -->
                    <div class="space-y-4 mt-6">
                        <div class="flex items-center">
                            <input type="checkbox" id="topic_restrict_learners" name="restrict_to_learners" 
                                   {% if topic.restrict_to_learners %}checked{% endif %}
                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                                   onchange="toggleLearnerRestrictions()">
                            <label for="topic_restrict_learners" class="ml-2 text-sm text-gray-700">
                                Restrict this topic for specific learners (optional)
                            </label>
                        </div>
                        
                        <div id="learner_restrictions_section" class="{% if not topic.restrict_to_learners %}hidden{% endif %}">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Select learners to restrict from viewing this topic:
                            </label>
                            <!-- BEGIN: dual-list select box -->
                            {% if course.courseenrollment_set.all %}
                            <div class="space-y-4">
                                <!-- Available learners -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-1">Available Learners</label>
                                    <select id="available_learners" class="w-full h-32 border border-gray-300 rounded-md p-2 bg-white text-gray-700 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 text-xs" multiple>
                                        {% for enrollment in course.courseenrollment_set.all %}
                                            {% if enrollment.user.role == 'learner' %}
                                                {% with user_is_restricted=enrollment.user.id|stringformat:"s" %}
                                                    {% if not topic or not topic.restricted_learners.all|contains:enrollment.user %}
                                                        <option value="{{ enrollment.user.id }}">
                                                            {{ enrollment.user.get_full_name|default:enrollment.user.username }} {% if enrollment.user.branch %}({{ enrollment.user.branch.name }}){% endif %}
                                                        </option>
                                                    {% endif %}
                                                {% endwith %}
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <!-- Transfer buttons -->
                                <div class="flex justify-center space-x-4">
                                    <button type="button" onclick="transferLearners('down')" class="p-2 bg-gray-100 hover:bg-gray-200 rounded">
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                    <button type="button" onclick="transferLearners('up')" class="p-2 bg-gray-100 hover:bg-gray-200 rounded">
                                        <i class="fas fa-chevron-up"></i>
                                    </button>
                                </div>
                                
                                <!-- Restricted learners -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-600 mb-1">Restricted Learners</label>
                                    <select id="restricted_learners_select" name="restricted_learners" multiple
                                            class="w-full h-32 border border-gray-300 rounded-md p-2 bg-white text-gray-700 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 text-xs">
                                        {% for enrollment in course.courseenrollment_set.all %}
                                            {% if enrollment.user.role == 'learner' %}
                                                {% with user_is_restricted=enrollment.user.id|stringformat:"s" %}
                                                    {% if topic and topic.restricted_learners.all|contains:enrollment.user %}
                                                        <option value="{{ enrollment.user.id }}" selected>
                                                            {{ enrollment.user.get_full_name|default:enrollment.user.username }} {% if enrollment.user.branch %}({{ enrollment.user.branch.name }}){% endif %}
                                                        </option>
                                                    {% endif %}
                                                {% endwith %}
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            {% else %}
                            <p class="text-sm text-gray-500">No learners enrolled in this course.</p>
                            {% endif %}
                            <!-- END: dual-list select box -->
                            <p class="mt-2 text-xs text-gray-500">
                                Selected learners will not be able to see or access this topic.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-end space-x-4">
                {% if course_id %}
                <a href="{% url 'courses:course_edit' course_id %}" 
                   class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                    Cancel
                </a>
                {% else %}
                <a href="{% url 'courses:course_list' %}" 
                   class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                    Cancel
                </a>
                {% endif %}
                
                <!-- View Topic Button (only show when editing) -->
                {% if action == 'Edit' and topic.id %}
                <a href="{% url 'courses:topic_view' topic.id %}" 
                   class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50"
                   target="_blank"
                   title="View topic in a new tab">
                    <i class="fas fa-eye mr-2"></i>View Topic
                </a>
                {% endif %}
                
                <!-- Progress Bar Container (hidden by default) -->
                <div id="progress-container" class="hidden flex-1 flex items-center mr-4">
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div id="progress-bar" class="bg-primary-600 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                    <span id="progress-text" class="ml-2 text-sm font-medium text-gray-700">0%</span>
                </div>
                
                <button type="submit" 
                        id="topic-submit-button"
                        class="btn-submit px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700">
                    <span class="submit-text">{% if action == 'Edit' %}Update Topic{% else %}{{ action }} Topic{% endif %}</span>
                    <span class="spinner hidden">
                        <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </span>
                </button>
                
                <a href="{% url 'courses:course_edit' course.id %}" 
                   class="ml-3 px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    <i class="fas fa-times mr-2"></i>Cancel
                </a>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Check if Quill is already loaded from base.html -->
<script>
    // We're using TinyMCE instead of Quill, so we don't need to load Quill
    console.log('Using TinyMCE for rich text editing, Quill is not needed');
    window.quillLoaded = true; // Prevent Quill from being loaded
</script>


<!-- Other scripts -->
<!-- Removed topic_form_updated.js to prevent conflicts -->
<script src="{% static 'js/courses/topic_actions.js' %}"></script>

<!-- Debug script for web URL issue -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== Web URL Debug Script ===');
    
    // Monitor content type changes
    const contentTypeRadios = document.querySelectorAll('input[name="content_type"]');
    console.log('Found content type radios:', contentTypeRadios.length);
    
    contentTypeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.checked && this.value === 'Web') {
                console.log('Web content selected!');
                
                // Check web content div
                const webDiv = document.getElementById('web-content');
                console.log('Web content div:', webDiv);
                console.log('Web div display:', webDiv ? window.getComputedStyle(webDiv).display : 'N/A');
                
                // Check web URL field
                const webUrlField = document.querySelector('[name="web_url"]');
                console.log('Web URL field:', webUrlField);
                console.log('Web URL value:', webUrlField ? webUrlField.value : 'N/A');
                
                // Force show the field
                if (webDiv) {
                    webDiv.style.display = 'block';
                    webDiv.style.visibility = 'visible';
                    webDiv.style.opacity = '1';
                    webDiv.classList.add('active');
                }
            }
        });
    });
    
    // Monitor form submission
    const form = document.getElementById('topicForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            console.log('=== Form Submission Debug ===');
            const selectedType = document.querySelector('input[name="content_type"]:checked');
            console.log('Selected content type:', selectedType ? selectedType.value : 'None');
            
            if (selectedType && selectedType.value === 'Web') {
                const webUrlField = document.querySelector('[name="web_url"]');
                console.log('Web URL field exists:', !!webUrlField);
                console.log('Web URL value on submit:', webUrlField ? webUrlField.value : 'N/A');
                console.log('Web URL field disabled:', webUrlField ? webUrlField.disabled : 'N/A');
                
                const webDiv = document.getElementById('web-content');
                console.log('Web div display on submit:', webDiv ? window.getComputedStyle(webDiv).display : 'N/A');
            }
        });
    }
});
</script>

<!-- Special handling for the Quill editor initialization -->
<script>
    // This function is intentionally left empty as we've replaced Quill with TinyMCE
    function initializeTopicForm() {
        console.log('Quill initialization skipped - using TinyMCE instead');
    }
    
    // Execute initialization when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        // TinyMCE is initialized in the TinyMCE Setup section
        console.log('Using TinyMCE for text content editing');
        
        // Initialize tabs - show the tab containing the selected content type
        initializeTabs();
        
        // Fix any initial spacing issues
        setTimeout(() => {
            const allContents = document.querySelectorAll('#contentTypeTabs .tab-content');
            allContents.forEach(content => {
                if (!content.classList.contains('active')) {
                    content.style.display = 'none';
                    content.style.height = '0';
                    content.style.minHeight = '0';
                    content.style.padding = '0';
                    content.style.margin = '0';
                }
            });
        }, 100);
        
        // Immediately check and hide instructions if needed
        const selectedRadio = document.querySelector('input[name="content_type"]:checked');
        if (selectedRadio) {
            toggleInstructionsVisibility(selectedRadio.value);
            toggleDescriptionVisibility(selectedRadio.value);
        }
        
        // Override or extend the existing toggleContentFields function if it exists
        const originalToggleContentFields = window.toggleContentFields;
        if (typeof originalToggleContentFields === 'function') {
            window.toggleContentFields = function(selectedType) {
                // Call the original function
                originalToggleContentFields.apply(this, arguments);
                // Then handle instructions and description visibility
                toggleInstructionsVisibility(selectedType);
                toggleDescriptionVisibility(selectedType);
            };
        }
    });
    
    // Also run immediately when script loads (before DOM ready)
    (function() {
        setTimeout(function() {
            const selectedRadio = document.querySelector('input[name="content_type"]:checked');
            if (selectedRadio) {
                toggleInstructionsVisibility(selectedRadio.value);
                toggleDescriptionVisibility(selectedRadio.value);
            }
        }, 100);
    })();
    
    // Tab switching function - Enhanced with better targeting
    function switchTab(tabId) {
        console.log('switchTab called with tabId:', tabId);
        
        // Preserve title field value before switching tabs
        const titleField = document.querySelector('input[name="title"], #topic_title');
        const titleValue = titleField ? titleField.value : '';
        
        // Remove active class from all tab headers and contents within the content-type-tabs container
        const tabContainer = document.getElementById('contentTypeTabs');
        if (!tabContainer) {
            console.error('Content type tabs container not found!');
            return;
        }
        
        const allHeaders = tabContainer.querySelectorAll('.tab-header');
        const allContents = tabContainer.querySelectorAll('.tab-content');
        
        // Remove active from all headers and contents
        allHeaders.forEach(header => header.classList.remove('active'));
        allContents.forEach(content => content.classList.remove('active'));
        
        // Add active class to clicked tab (use event.target if available, otherwise find by onclick)
        let clickedHeader = null;
        if (typeof event !== 'undefined' && event.target) {
            clickedHeader = event.target.closest('.tab-header');
        } else {
            // Find the header that should be active based on tabId
            clickedHeader = Array.from(allHeaders).find(header => {
                const onclick = header.getAttribute('onclick');
                return onclick && onclick.includes(tabId);
            });
        }
        
        const targetContent = document.getElementById(tabId);
        
        if (clickedHeader && targetContent) {
            clickedHeader.classList.add('active');
            targetContent.classList.add('active');
            console.log('Tab switched to:', tabId);
        } else {
            console.error('Failed to find clicked header or target content for:', tabId);
        }
        
        // Restore title field value if it was cleared during tab switch
        if (titleField && titleValue && !titleField.value) {
            titleField.value = titleValue;
            console.log('Restored title field value after tab switch');
        }
        
        // Force a style recalculation to ensure CSS changes take effect
        setTimeout(() => {
            const activeContent = document.querySelector('#contentTypeTabs .tab-content.active');
            const inactiveContents = document.querySelectorAll('#contentTypeTabs .tab-content:not(.active)');
            
            if (activeContent) {
                // Ensure the active content is actually visible and compact
                activeContent.style.display = 'block';
                activeContent.style.visibility = 'visible';
                activeContent.style.opacity = '1';
                activeContent.style.height = 'auto';
                activeContent.style.minHeight = '0';
            }
            
            // Ensure inactive contents are completely hidden and take no space
            inactiveContents.forEach(content => {
                content.style.display = 'none';
                content.style.visibility = 'hidden';
                content.style.opacity = '0';
                content.style.height = '0';
                content.style.minHeight = '0';
                content.style.padding = '0';
                content.style.margin = '0';
            });
        }, 10);
    }
    
    // Initialize tabs on page load
    function initializeTabs() {
        // Check which content type is selected
        const selectedRadio = document.querySelector('input[name="content_type"]:checked');
        
        if (selectedRadio) {
            const selectedType = selectedRadio.value;
            const learningTypes = ['Text', 'Audio', 'Video', 'Web', 'Document', 'EmbedVideo'];
            const assessmentTypes = ['Quiz', 'Assignment', 'Conference', 'Discussion'];
            
            // Show the appropriate tab
            if (assessmentTypes.includes(selectedType)) {
                // Switch to assessments tab
                document.querySelectorAll('.tab-header').forEach(header => header.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                document.querySelector('.tab-header:nth-child(2)').classList.add('active');
                document.getElementById('assessments').classList.add('active');
            }
            // Learning content tab is active by default
            
            // Handle instructions and description field visibility
            toggleInstructionsVisibility(selectedType);
            toggleDescriptionVisibility(selectedType);
        }
    }
    
    // Function to toggle instructions field visibility based on content type
    function toggleInstructionsVisibility(contentType) {
        console.log('toggleInstructionsVisibility called with:', contentType);
        const instructionsWrapper = document.getElementById('instructions-field-wrapper');
        const hideInstructionsTypes = ['Quiz', 'Assignment', 'Conference', 'Discussion'];
        
        if (instructionsWrapper) {
            if (hideInstructionsTypes.includes(contentType)) {
                console.log('Hiding instructions for content type:', contentType);
                // Force hide with important styles
                instructionsWrapper.style.setProperty('display', 'none', 'important');
                instructionsWrapper.style.setProperty('visibility', 'hidden', 'important');
                instructionsWrapper.style.setProperty('opacity', '0', 'important');
                instructionsWrapper.style.setProperty('height', '0', 'important');
                instructionsWrapper.style.setProperty('overflow', 'hidden', 'important');
                instructionsWrapper.style.setProperty('margin', '0', 'important');
                instructionsWrapper.style.setProperty('padding', '0', 'important');
                
                // Also hide any TinyMCE wrapper inside
                const tinymceWrapper = instructionsWrapper.querySelector('.tox-tinymce');
                if (tinymceWrapper) {
                    tinymceWrapper.style.setProperty('display', 'none', 'important');
                }
                
                // Hide the label too
                const label = instructionsWrapper.querySelector('label');
                if (label) {
                    label.style.setProperty('display', 'none', 'important');
                }
            } else {
                console.log('Showing instructions for content type:', contentType);
                instructionsWrapper.style.removeProperty('display');
                instructionsWrapper.style.removeProperty('visibility');
                instructionsWrapper.style.removeProperty('opacity');
                instructionsWrapper.style.removeProperty('height');
                instructionsWrapper.style.removeProperty('overflow');
                instructionsWrapper.style.removeProperty('margin');
                instructionsWrapper.style.removeProperty('padding');
                
                // Show TinyMCE wrapper
                const tinymceWrapper = instructionsWrapper.querySelector('.tox-tinymce');
                if (tinymceWrapper) {
                    tinymceWrapper.style.removeProperty('display');
                }
                
                // Show the label
                const label = instructionsWrapper.querySelector('label');
                if (label) {
                    label.style.removeProperty('display');
                }
            }
        } else {
            console.log('Instructions wrapper not found!');
        }
    }


    // Function to toggle description field visibility based on content type
    function toggleDescriptionVisibility(contentType) {
        console.log('toggleDescriptionVisibility called with:', contentType);
        const descriptionWrapper = document.getElementById('description-field-wrapper');
        const showDescriptionTypes = ['Video', 'Document', 'Audio', 'Web', 'EmbedVideo'];
        
        if (descriptionWrapper) {
            if (showDescriptionTypes.includes(contentType)) {
                console.log('Showing description for content type:', contentType);
                // Show with proper styles
                descriptionWrapper.style.removeProperty('display');
                descriptionWrapper.style.removeProperty('visibility');
                descriptionWrapper.style.removeProperty('opacity');
                descriptionWrapper.style.removeProperty('height');
                descriptionWrapper.style.removeProperty('overflow');
                descriptionWrapper.style.removeProperty('margin');
                descriptionWrapper.style.removeProperty('padding');
                
                // Show TinyMCE wrapper
                const tinymceWrapper = descriptionWrapper.querySelector('.tox-tinymce');
                if (tinymceWrapper) {
                    tinymceWrapper.style.removeProperty('display');
                }
                
                // Show the label
                const label = descriptionWrapper.querySelector('label');
                if (label) {
                    label.style.removeProperty('display');
                }
            } else {
                console.log('Hiding description for content type:', contentType);
                // Force hide with important styles
                descriptionWrapper.style.setProperty('display', 'none', 'important');
                descriptionWrapper.style.setProperty('visibility', 'hidden', 'important');
                descriptionWrapper.style.setProperty('opacity', '0', 'important');
                descriptionWrapper.style.setProperty('height', '0', 'important');
                descriptionWrapper.style.setProperty('overflow', 'hidden', 'important');
                descriptionWrapper.style.setProperty('margin', '0', 'important');
                descriptionWrapper.style.setProperty('padding', '0', 'important');
                
                // Also hide any TinyMCE wrapper inside
                const tinymceWrapper = descriptionWrapper.querySelector('.tox-tinymce');
                if (tinymceWrapper) {
                    tinymceWrapper.style.setProperty('display', 'none', 'important');
                }
                
                // Hide the label too
                const label = descriptionWrapper.querySelector('label');
                if (label) {
                    label.style.setProperty('display', 'none', 'important');
                }
            }
        } else {
            console.log('Description wrapper not found!');
        }
    }
    
    // Add event listeners to radio buttons for dynamic hiding
    document.addEventListener('DOMContentLoaded', function() {
        const contentTypeRadios = document.querySelectorAll('input[name="content_type"]');
        
        contentTypeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.checked) {
                    toggleInstructionsVisibility(this.value);
                    toggleDescriptionVisibility(this.value);
                }
            });
        });
        
        // Check initial state
        const selectedRadio = document.querySelector('input[name="content_type"]:checked');
        if (selectedRadio) {
            toggleInstructionsVisibility(selectedRadio.value);
            toggleDescriptionVisibility(selectedRadio.value);
        }
        
    });
</script>

<!-- Initialize the global sidebar toggle function -->
<script>
    // Define global toggleSidebar function if not already defined
    if (typeof window.toggleSidebar !== 'function') {
        console.log('Initializing global toggleSidebar function');
        window.toggleSidebar = function() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');
            if (sidebar && mainContent) {
                sidebar.classList.toggle('collapsed');
                mainContent.classList.toggle('sidebar-collapsed');
                // Store sidebar state in localStorage
                const isCollapsed = sidebar.classList.contains('collapsed');
                localStorage.setItem('sidebar_collapsed', isCollapsed);
                console.log('Sidebar toggled:', isCollapsed ? 'collapsed' : 'expanded');
            }
        };
    }
    
    // Define global toggleSubmenu function if not already defined
    if (typeof window.toggleSubmenu !== 'function') {
        console.log('Initializing global toggleSubmenu function');
        window.toggleSubmenu = function(submenuId, event) {
            // Prevent the event from propagating up to parent elements
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            console.log(`Toggling submenu: ${submenuId}`);
            
            const submenu = document.getElementById(submenuId);
            if (!submenu) {
                console.error(`Submenu with ID ${submenuId} not found`);
                return;
            }
            
            // Find the button that triggered this submenu
            // First try to find it via the event target
            let button;
            if (event && event.currentTarget) {
                button = event.currentTarget;
            } else {
                // Fallback to finding it via data-submenu attribute
                button = document.querySelector(`[data-submenu="${submenuId}"]`);
                
                // If that fails, try to find it via previous element sibling
                if (!button) {
                    button = submenu.previousElementSibling;
                }
            }
            
            if (!button) {
                console.error('Could not find button for submenu:', submenuId);
                return;
            }
            
            const arrow = button.querySelector('.arrow-icon');
            
            // Toggle submenu visibility
            const wasHidden = submenu.classList.contains('hidden');
            if (wasHidden) {
                submenu.classList.remove('hidden');
            } else {
                submenu.classList.add('hidden');
            }
            console.log(`Submenu ${submenuId} was hidden: ${wasHidden}, is now hidden: ${submenu.classList.contains('hidden')}`);
            
            // Toggle button active state and arrow rotation
            if (wasHidden) {
                button.classList.add('active', 'expanded');
            } else {
                button.classList.remove('active', 'expanded');
            }
            
            // Close other submenus
            document.querySelectorAll('.submenu').forEach(menu => {
                if (menu.id !== submenuId && !menu.classList.contains('hidden')) {
                    menu.classList.add('hidden');
                    
                    // Find and update the button for this menu
                    const otherButton = document.querySelector(`[data-submenu="${menu.id}"]`) 
                        || menu.previousElementSibling;
                        
                    if (otherButton) {
                        otherButton.classList.remove('active', 'expanded');
                    }
                }
            });
            
            // Ensure submenu is visible - scroll parent if needed
            if (!submenu.classList.contains('hidden')) {
                const sidebar = document.getElementById('sidebar');
                if (sidebar) {
                    const submenuRect = submenu.getBoundingClientRect();
                    const sidebarRect = sidebar.getBoundingClientRect();
                    
                    // If submenu extends beyond sidebar bottom, scroll it into view
                    if (submenuRect.bottom > sidebarRect.bottom) {
                        const sidebarContent = sidebar.querySelector('.flex.flex-col');
                        if (sidebarContent) {
                            sidebarContent.scrollTo({
                                top: sidebarContent.scrollTop + (submenuRect.bottom - sidebarRect.bottom),
                                behavior: 'smooth'
                            });
                        }
                    }
                }
            }
        };
    }
</script>

<!-- Learner Restrictions JavaScript -->
<script>
function toggleLearnerRestrictions() {
    const checkbox = document.getElementById('topic_restrict_learners');
    const section = document.getElementById('learner_restrictions_section');
    
    if (checkbox.checked) {
        section.classList.remove('hidden');
    } else {
        section.classList.add('hidden');
    }
}

function transferLearners(direction) {
    const availableSelect = document.getElementById('available_learners');
    const restrictedSelect = document.getElementById('restricted_learners_select');
    
    if (direction === 'down') {
        // Move selected learners from available to restricted
        for (let option of [...availableSelect.selectedOptions]) {
            restrictedSelect.appendChild(option);
            option.selected = true;
        }
    } else {
        // Move selected learners from restricted to available
        for (let option of [...restrictedSelect.selectedOptions]) {
            availableSelect.appendChild(option);
            option.selected = false;
        }
    }
}

// Initialize on page load if checkbox is already checked
document.addEventListener('DOMContentLoaded', function() {
    const checkbox = document.getElementById('topic_restrict_learners');
    if (checkbox && checkbox.checked) {
        // Learner list is already rendered in template
        console.log('Learner restrictions checkbox is checked');
    }
    
    // Select all restricted learners before form submission
    document.getElementById('topicForm').addEventListener('submit', function() {
        const restrictedSelect = document.getElementById('restricted_learners_select');
        for (let option of restrictedSelect.options) {
            option.selected = true;
        }
    });
});
</script>

<!-- Column Resizer JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const resizer = document.getElementById('columnResizer');
    const leftColumn = document.querySelector('.topic-form-column-left');
    const rightColumn = document.querySelector('.topic-form-column-right');
    const container = document.querySelector('.topic-form-custom-grid');
    
    if (!resizer || !leftColumn || !rightColumn || !container) {
        console.log('Column resizer elements not found');
        return;
    }
    
    let isResizing = false;
    let startX = 0;
    let startLeftWidth = 0;
    let startRightWidth = 0;
    
    // Load saved column widths from localStorage
    const savedLeftWidth = localStorage.getItem('topic-form-left-width');
    const savedRightWidth = localStorage.getItem('topic-form-right-width');
    
    if (savedLeftWidth && savedRightWidth) {
        leftColumn.style.width = savedLeftWidth;
        rightColumn.style.width = savedRightWidth;
    }
    
    resizer.addEventListener('mousedown', function(e) {
        isResizing = true;
        startX = e.clientX;
        
        const containerRect = container.getBoundingClientRect();
        const leftRect = leftColumn.getBoundingClientRect();
        const rightRect = rightColumn.getBoundingClientRect();
        
        startLeftWidth = leftRect.width;
        startRightWidth = rightRect.width;
        
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
        
        e.preventDefault();
    });
    
    document.addEventListener('mousemove', function(e) {
        if (!isResizing) return;
        
        const containerRect = container.getBoundingClientRect();
        const containerWidth = containerRect.width - 6; // Subtract resizer width
        const deltaX = e.clientX - startX;
        
        const newLeftWidth = startLeftWidth + deltaX;
        const newRightWidth = startRightWidth - deltaX;
        
        // Calculate percentages
        const leftPercent = (newLeftWidth / containerWidth) * 100;
        const rightPercent = (newRightWidth / containerWidth) * 100;
        
        // Enforce min/max constraints
        if (leftPercent >= 50 && leftPercent <= 90 && rightPercent >= 10 && rightPercent <= 50) {
            leftColumn.style.width = leftPercent + '%';
            rightColumn.style.width = rightPercent + '%';
        }
        
        e.preventDefault();
    });
    
    document.addEventListener('mouseup', function() {
        if (isResizing) {
            isResizing = false;
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
            
            // Save current widths to localStorage
            localStorage.setItem('topic-form-left-width', leftColumn.style.width);
            localStorage.setItem('topic-form-right-width', rightColumn.style.width);
        }
    });
    
    // Handle double-click to reset to default
    resizer.addEventListener('dblclick', function() {
        leftColumn.style.width = '75%';
        rightColumn.style.width = '25%';
        
        // Save reset values
        localStorage.setItem('topic-form-left-width', '75%');
        localStorage.setItem('topic-form-right-width', '25%');
    });
});
</script>

<!-- Re-attach sidebar submenu event listeners in case sidebar JS was not properly initialized -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded - initializing sidebar submenu listeners');
    
    // Function to attach submenu listeners
    function attachSubmenuListeners() {
      // Target both desktop and mobile menu buttons
      const allSubmenuButtons = document.querySelectorAll('.menu-item.has-submenu[data-submenu]');
      console.log(`Found ${allSubmenuButtons.length} submenu buttons to initialize`);
      
      allSubmenuButtons.forEach(button => {
        // Check if this button already has our event listener
        if (!button._submenuListenerAttached) {
          // Get the submenu ID
          const submenuId = button.getAttribute('data-submenu');
          console.log(`Attaching listener to button for submenu: ${submenuId}`);
          
          // Clone and replace to remove any existing listeners
          const newButton = button.cloneNode(true);
          button.parentNode.replaceChild(newButton, button);
          
          // Add event listener to the new button
          newButton.addEventListener('click', function(event) {
            event.preventDefault();
            event.stopPropagation();
            console.log(`Button clicked for submenu: ${submenuId}`);
            
            // Call the toggleSubmenu function if it exists
            if (typeof window.toggleSubmenu === 'function') {
              window.toggleSubmenu(submenuId, event);
            } else {
              console.error('toggleSubmenu function not found');
              // Fallback implementation
              const submenu = document.getElementById(submenuId);
              if (submenu) {
                submenu.classList.toggle('hidden');
                newButton.classList.toggle('active');
                newButton.classList.toggle('expanded');
              }
            }
          });
          
          // Mark as having listener attached
          newButton._submenuListenerAttached = true;
          
          // Also handle clicks on SVG elements and other child elements
          const clickableChildren = newButton.querySelectorAll('svg, path, div, span');
          clickableChildren.forEach(child => {
            child.addEventListener('click', function(e) {
              e.stopPropagation();
              // Manually trigger click on parent button
              newButton.click();
            });
          });
        }
      });
    }
    
    // Initial attachment
    attachSubmenuListeners();
    
    // Also try again after a delay to catch late-loaded elements
    setTimeout(attachSubmenuListeners, 500);
    setTimeout(attachSubmenuListeners, 1000);
    
    // Watch for DOM changes that might add new submenu buttons
    const observer = new MutationObserver(function(mutations) {
      attachSubmenuListeners();
    });
    
    // Start observing
    observer.observe(document.body, {
      childList: true,
      subtree: true
    });
  });
</script>

<!-- Initialize everything after DOM load -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, checking form fields:');
        const formFields = [
            'topic_title', 
            'topic_description', 
            'status', 
            'topic_start_date', 
            'topic_end_date',
            'topic_endless_access'
        ];
        
        formFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            console.log(`Field ${fieldId} exists: ${!!field}`);
        });
        
        // Additional debugging for form
        const topicForm = document.getElementById('topicForm');
        if (topicForm) {
            console.log('Found form with action:', topicForm.action);
            console.log('Form has data-ajax attribute:', topicForm.hasAttribute('data-ajax'));
            console.log('Form data-ajax value:', topicForm.getAttribute('data-ajax'));
            
            // Listen for submit events directly here for debugging
            topicForm.addEventListener('submit', function(e) {
                console.log('Form submit event detected in HTML template');
                console.log('Form action URL:', this.action);
                console.log('Form method:', this.method);
                console.log('Form enctype:', this.enctype);
                
                // Don't prevent default, let the handler in topic_form_updated.js handle that
            });
        } else {
            console.error('Could not find topic form!');
        }

        // Check if we're on an edit page
        const pathParts = window.location.pathname.split('/');
        const topicId = pathParts[pathParts.indexOf('topics') + 1];
        
        if (topicId && window.location.pathname.includes('/edit')) {
            console.log('DOM loaded, waiting for editTopic function...');
            // Wait for editTopic function to be available
            const waitForEditFunction = function() {
                if (typeof editTopic === 'function') {
                    console.log('editTopic function found, proceeding with data loading');
                    editTopic(topicId);
                } else {
                    console.log('editTopic function not found yet, waiting...');
                    setTimeout(waitForEditFunction, 100);
                }
            };
            waitForEditFunction();
        }
        
        // Progress animation variables
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        let progressTimer = null;
        
        // Add direct form submission handler
        const topicSubmitButton = document.getElementById('topic-submit-button');
        if (topicSubmitButton) {
            topicSubmitButton.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Submit button clicked, submitting form directly');
                
                // Hide submit text, show spinner
                const submitText = this.querySelector('.submit-text');
                const spinner = this.querySelector('.spinner');
                if (submitText) submitText.style.display = 'none';
                if (spinner) spinner.classList.remove('hidden');
                
                // Show progress container
                progressContainer.classList.remove('hidden');
                progressContainer.classList.add('flex');
                
                // Start progress animation
                let progress = 0;
                progressTimer = setInterval(() => {
                    // Increment based on current progress value (slower as it approaches 100%)
                    if (progress < 30) {
                        progress += 3;
                    } else if (progress < 60) {
                        progress += 2;
                    } else if (progress < 85) {
                        progress += 1;
                    } else if (progress < 95) {
                        progress += 0.5;
                    }
                    
                    // Cap at 95% - the final 5% happens on completion
                    if (progress > 95) progress = 95;
                    
                    // Update progress UI
                    progressBar.style.width = `${progress}%`;
                    progressText.textContent = `${Math.round(progress)}%`;
                }, 100);
                
                // Prepare text content if needed
                if (document.querySelector('input[name="content_type"]:checked')?.value.toLowerCase() === 'text') {
                    // Make sure TinyMCE content is saved
                    if (tinymce && tinymce.get('text_content')) {
                        tinymce.get('text_content').save();
                    }
                }
                
                // FIXED: Use requestSubmit() instead of submit() to properly handle file uploads
                // requestSubmit() triggers validation and fires submit events, allowing files to be uploaded
                // Unlike submit(), requestSubmit() properly handles multipart/form-data encoding
                if (topicForm.requestSubmit) {
                    // Modern browsers support requestSubmit
                    console.log('Using requestSubmit() for proper file upload handling');
                    topicForm.requestSubmit();
                } else {
                    // Fallback for older browsers: create and click a submit button
                    console.log('Using fallback submit method for file uploads');
                    const submitEvent = new Event('submit', {bubbles: true, cancelable: true});
                    if (topicForm.dispatchEvent(submitEvent)) {
                        // If not cancelled by validation, submit natively
                        HTMLFormElement.prototype.submit.call(topicForm);
                    }
                }
                
                // Track completion
                setTimeout(() => {
                    progressBar.style.width = '100%';
                    progressText.textContent = '100%';
                    
                    // Clear the interval timer to prevent memory leaks
                    if (progressTimer) {
                        clearInterval(progressTimer);
                        progressTimer = null;
                    }
                }, 500);
            });
        }

        // Auto-select section based on URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const sectionParam = urlParams.get('section');
        
        if (sectionParam) {
            const sectionSelect = document.getElementById('section');
            if (sectionSelect) {
                const sectionOption = Array.from(sectionSelect.options).find(option => option.value === sectionParam);
                if (sectionOption) {
                    sectionOption.selected = true;
                    console.log(`Auto-selected section: ${sectionOption.text}`);
                } else {
                    console.log(`Section ID ${sectionParam} not found in dropdown options`);
                }
            }
        }

        // Handle section dropdown change to show/hide new section input
        const sectionSelect = document.getElementById('section');
        const newSectionInput = document.getElementById('new-section-input');
        const newSectionNameField = document.getElementById('new_section_name');
        
        if (sectionSelect && newSectionInput) {
            // Function to toggle new section input visibility
            function toggleNewSectionInput() {
                if (sectionSelect.value === 'new_section') {
                    console.log(' "Create New Section" selected - showing input field');
                    newSectionInput.style.display = 'block';
                    if (newSectionNameField) {
                        newSectionNameField.focus(); // Auto-focus the input field
                        newSectionNameField.required = true; // Make it required when visible
                    }
                } else {
                    console.log(' Regular section selected - hiding new section input');
                    newSectionInput.style.display = 'none';
                    if (newSectionNameField) {
                        newSectionNameField.value = ''; // Clear the input
                        newSectionNameField.required = false; // Remove required attribute
                    }
                }
            }
            
            // Add event listener for section dropdown changes
            sectionSelect.addEventListener('change', toggleNewSectionInput);
            
            // Check initial state (in case "new_section" is pre-selected)
            toggleNewSectionInput();
            
            console.log(' Section dropdown change handler initialized');
            
            // Debug: Log current section selection state for editing
            if (sectionSelect.value) {
                console.log(' Section currently selected:', sectionSelect.value, sectionSelect.selectedOptions[0]?.text);
            } else {
                console.log(' No section selected (standalone topic)');
            }
        } else {
            console.warn('  Section dropdown or new section input not found');
            console.log('Debug - sectionSelect:', sectionSelect);
            console.log('Debug - newSectionInput:', newSectionInput);
        }
        
        // Clean any unwanted characters from the textarea directly
        const textContentArea = document.getElementById('text_content');
        if (textContentArea) {
            const content = textContentArea.value;
            if (content === '{' || content === '{' || content.trim() === '{' || 
                content === '}' || content.trim() === '}' || 
                content === '{}' || content.trim() === '{}') {
                console.log('Removing unwanted braces from textarea content');
                textContentArea.value = '';
            }
        }
    });
</script>

<!-- Fix for sidebar and header issues on topic creation page -->
<script>
    // Fix for sidebar and header issues on topic creation page
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Running sidebar and header fix script');
        
        // Fix for sidebar toggle button
        const sidebarToggle = document.getElementById('sidebarToggle');
        if (sidebarToggle) {
            // Remove any existing click handlers
            const newToggle = sidebarToggle.cloneNode(true);
            sidebarToggle.parentNode.replaceChild(newToggle, sidebarToggle);
            
            // Add new click handler
            newToggle.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                if (window.toggleSidebar) {
                    window.toggleSidebar();
                } else {
                    // Fallback implementation
                    const sidebar = document.getElementById('sidebar');
                    const mainContent = document.getElementById('main-content');
                    
                    if (sidebar) {
                        sidebar.classList.toggle('collapsed');
                        if (mainContent) {
                            mainContent.classList.toggle('sidebar-collapsed');
                        }
                    }
                }
            });
        }
    });
</script>

<!-- Fix header search visibility issue -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Function to ensure header search is visible
        function fixHeaderSearchVisibility() {
            const headerSearch = document.querySelector('header .hidden.md\\:flex.flex-1.max-w-3xl');
            if (headerSearch) {
                headerSearch.style.display = 'flex';
                headerSearch.style.visibility = 'visible';
                headerSearch.style.opacity = '1';
                console.log('Header search visibility fixed');
            }
        }
        
        // Run immediately
        fixHeaderSearchVisibility();
        
        // Also run after a short delay to catch any dynamic DOM changes
        setTimeout(fixHeaderSearchVisibility, 500);
        
        // Create a MutationObserver to watch for DOM changes
        const observer = new MutationObserver(function(mutations) {
            fixHeaderSearchVisibility();
        });
        
        // Start observing the document body for DOM changes
        observer.observe(document.body, { 
            childList: true, 
            subtree: true 
        });
    });
</script>

<!-- Last attempt fix for menu issue -->
<script>
// Use an immediately-invoked function expression (IIFE) to avoid global variables
(function() {
    // Add specific CSS to ensure sidebar submenu visibility
    try {
        var styleEl = document.createElement('style');
        styleEl.textContent = `
            /* Enhanced submenu visibility fixes */
            #sidebar .submenu:not(.hidden) {
                display: block !important;
                max-height: 1200px !important;
                opacity: 1 !important;
                visibility: visible !important;
                overflow: visible !important;
                position: static !important;
                height: auto !important;
                width: 100% !important;
                z-index: 50 !important;
            }
            
            /* Force submenu display for specific IDs */
            #coursesSubmenu:not(.hidden),
            #userManagementSubmenu:not(.hidden),
            #communicationSubmenu:not(.hidden),
            #reportsSubmenu:not(.hidden) {
                display: block !important;
                max-height: 1200px !important;
                opacity: 1 !important;
                visibility: visible !important;
                height: auto !important;
            }
            
            /* Ensure submenu items are visible */
            #sidebar .submenu:not(.hidden) a,
            #sidebar .submenu:not(.hidden) .menu-item {
                display: flex !important;
                visibility: visible !important;
                opacity: 1 !important;
            }
            
            /* Arrow rotation for expanded submenus */
            #sidebar .menu-item.expanded .arrow-icon {
                transform: rotate(180deg) !important;
            }
            
            /* Fix for mobile menu */
            #mobile-menu .submenu:not(.hidden) {
                display: block !important;
                max-height: 1200px !important;
                opacity: 1 !important;
                visibility: visible !important;
            }
        `;
        document.head.appendChild(styleEl);
    } catch (e) {
        console.log("Style application error:", e);
    }
    
    // CHROME-SPECIFIC FIX: Direct DOM manipulation approach
    function setupDirectMenuHandlers() {
        console.log("Setting up direct menu handlers for Chrome");
        
        // Get all menu buttons with submenus
        var menuButtons = document.querySelectorAll('#sidebar [data-submenu]');
        console.log(`Found ${menuButtons.length} menu buttons`);
        
        // For each button, set up a completely direct event handler
        menuButtons.forEach(function(button) {
            var submenuId = button.getAttribute('data-submenu');
            var submenu = document.getElementById(submenuId);
            
            if (!submenu) {
                console.error(`Could not find submenu ${submenuId}`);
                return;
            }
            
            // Remove existing handlers
            var newButton = button.cloneNode(true);
            if (button.parentNode) {
                // Replace the button with a clone to remove existing handlers
                button.parentNode.replaceChild(newButton, button);
                
                // Set up our own handler using onclick property (most direct approach)
                newButton.onclick = function(e) {
                    // Prevent any event bubbling
                    if (e && e.stopPropagation) e.stopPropagation();
                    if (e && e.preventDefault) e.preventDefault();
                    
                    console.log(`Clicked menu: ${submenuId}`);
                    
                    // Direct manipulation of DOM - force show/hide
                    var isHidden = submenu.classList.contains('hidden');
                    
                    // Close all submenus first
                    document.querySelectorAll('#sidebar .submenu').forEach(function(menu) {
                        // Reset all menus
                        menu.classList.add('hidden');
                        menu.style.display = 'none';
                        menu.style.visibility = 'hidden';
                        menu.style.opacity = '0';
                        menu.style.maxHeight = '0';
                        
                        // Reset all buttons
                        var menuBtn = document.querySelector(`[data-submenu="${menu.id}"]`);
                        if (menuBtn) {
                            menuBtn.classList.remove('active', 'expanded');
                        }
                    });
                    
                    // Toggle this submenu
                    if (isHidden) {
                        // Show this submenu
                        submenu.classList.remove('hidden');
                        submenu.style.display = 'block';
                        submenu.style.visibility = 'visible';
                        submenu.style.opacity = '1';
                        submenu.style.maxHeight = '1000px';
                        newButton.classList.add('active', 'expanded');
                        
                        // Even more direct approach - add !important inline styles
                        var menuItems = submenu.querySelectorAll('a');
                        menuItems.forEach(function(item) {
                            item.style.cssText = "display: flex !important; visibility: visible !important; opacity: 1 !important;";
                        });
                    }
                    
                    return false;
                };
                
                // For all child elements (icons, spans, etc), forward clicks to the button
                newButton.querySelectorAll('*').forEach(function(el) {
                    el.onclick = function(e) {
                        if (e && e.stopPropagation) e.stopPropagation();
                        if (e && e.preventDefault) e.preventDefault();
                        newButton.click();
                        return false;
                    };
                });
            }
        });
        
        // Also set up global click handler to help with event bubbling issues
        document.addEventListener('click', function(e) {
            // If clicking outside menus, close all menus
            if (!e.target.closest('#sidebar')) {
                document.querySelectorAll('#sidebar .submenu').forEach(function(menu) {
                    menu.classList.add('hidden');
                    menu.style.display = 'none';
                    
                    var btn = document.querySelector(`[data-submenu="${menu.id}"]`);
                    if (btn) btn.classList.remove('active', 'expanded');
                });
            }
        }, true);
    }
    
    // Add a direct toggle function to window for emergency use
    window.toggleMenu = function(menuId) {
        var submenu = document.getElementById(menuId);
        var button = document.querySelector(`[data-submenu="${menuId}"]`);
        
        if (submenu && button) {
            // Force direct manipulation
            if (submenu.classList.contains('hidden')) {
                // Close all others first
                document.querySelectorAll('#sidebar .submenu').forEach(function(menu) {
                    menu.classList.add('hidden');
                    menu.style.display = 'none';
                    
                    var btn = document.querySelector(`[data-submenu="${menu.id}"]`);
                    if (btn) btn.classList.remove('active', 'expanded');
                });
                
                // Show this one
                submenu.classList.remove('hidden');
                submenu.style.display = 'block';
                submenu.style.visibility = 'visible';
                submenu.style.opacity = '1';
                submenu.style.maxHeight = '1000px';
                button.classList.add('active', 'expanded');
                
                // Even more direct approach - add !important inline styles
                var menuItems = submenu.querySelectorAll('a');
                menuItems.forEach(function(item) {
                    item.style.cssText = "display: flex !important; visibility: visible !important; opacity: 1 !important;";
                });
            } else {
                // Hide this one
                submenu.classList.add('hidden');
                submenu.style.display = 'none';
                button.classList.remove('active', 'expanded');
            }
        }
    };

    // Run our code after small delay to ensure DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(setupDirectMenuHandlers, 300);
        });
    } else {
        // DOM already loaded
        setTimeout(setupDirectMenuHandlers, 300);
    }
})();
</script>

<!-- Emergency button fix - console access for manual operation -->
<script>
console.log("MENU EMERGENCY ACCESS: Use these in your console if needed:");
console.log("window.toggleMenu('coursesSubmenu') - Toggle Courses menu");
console.log("window.toggleMenu('userManagementSubmenu') - Toggle User Management menu");
console.log("window.toggleMenu('communicationSubmenu') - Toggle Communication menu");
console.log("window.toggleMenu('reportsSubmenu') - Toggle Reports menu");
</script>

<!-- Fix for sidebar submenu visibility issue -->
<script>
// Fix for sidebar submenu visibility issue
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing submenu fix on topic creation page');
    
    // Force re-initialization of submenu toggles
    if (window.reinitializeSubmenuToggles) {
        window.reinitializeSubmenuToggles();
    }
    
    // Force submenus that should be visible to be visible
    document.querySelectorAll('#sidebar .menu-item.has-submenu.active, #sidebar .menu-item.has-submenu.expanded').forEach(item => {
        const submenuId = item.getAttribute('data-submenu');
        if (submenuId) {
            const submenu = document.getElementById(submenuId);
            if (submenu) {
                console.log('Force showing submenu:', submenuId);
                submenu.classList.remove('hidden');
                item.classList.add('expanded');
                
                // Rotate arrow if present
                const arrow = item.querySelector('.arrow-icon');
                if (arrow) {
                    arrow.style.transform = 'rotate(180deg)';
                }
            }
        }
    });
    
    // Set up a periodic check to ensure submenus stay visible
    setInterval(function() {
        document.querySelectorAll('#sidebar .menu-item.has-submenu.active, #sidebar .menu-item.has-submenu.expanded').forEach(item => {
            const submenuId = item.getAttribute('data-submenu');
            if (submenuId) {
                const submenu = document.getElementById(submenuId);
                if (submenu && submenu.classList.contains('hidden')) {
                    console.log('Re-showing hidden submenu:', submenuId);
                    submenu.classList.remove('hidden');
                }
            }
        });
    }, 1000);
});
</script>

<!-- Include TinyMCE Global Components - Same as course edit page -->
{% include 'components/tinymce_includes.html' %}

<!-- TinyMCE is already included via global components above -->
<script src="{% static 'core/js/courses/tinymce-simple-init.js' %}"></script>
<script>
// Additional topic-specific TinyMCE handling - Same pattern as course edit page
(function() {
    console.log('=== TinyMCE Setup for Topic Creation (Standardized) ===');
    
    // Wait for TinyMCE to be available
    function waitForTinyMCE(callback) {
        let attempts = 0;
        const maxAttempts = 50;
        
        function checkTinyMCE() {
            attempts++;
            if (typeof tinymce !== 'undefined' && tinymce.init) {
                console.log('TinyMCE available, proceeding with initialization');
                callback();
            } else if (attempts < maxAttempts) {
                setTimeout(checkTinyMCE, 100);
            } else {
                console.error('TinyMCE failed to load after maximum attempts');
            }
        }
        checkTinyMCE();
    }
    
    // Declare TinyMCE initialization flag
    let tinymceInitialized = false;
    
    // Initialize TinyMCE editors using global widget system
    function initializeTinyMCEEditors() {
        if (tinymceInitialized) {
            console.log('TinyMCE already initialized, skipping');
            return;
        }
        
        console.log('Initializing TinyMCE editors for topic creation');
        
        // Use TinyMCE widget system for text content field - Same as course edit
        if (typeof window.TinyMCEWidget !== 'undefined' && window.TinyMCEWidget.initializeAll) {
            console.log('Initializing TinyMCE widgets');
            window.TinyMCEWidget.initializeAll();
        }
        
        const textareas = document.querySelectorAll('textarea.tinymce-editor:not([data-tinymce-config])');
        console.log('Found textareas for manual TinyMCE init:', textareas.length);
        
        if (textareas.length === 0) {
            console.log('No textareas found for manual TinyMCE initialization');
            tinymceInitialized = true;
            return;
        }
        
        textareas.forEach(function(textarea) {
            // Skip if already initialized
            if (textarea.classList.contains('tinymce-initialized')) {
                console.log('Textarea already initialized:', textarea.id);
                return;
            }
            
            // Skip if no ID
            if (!textarea.id) {
                console.log('Textarea has no ID, skipping:', textarea);
                return;
            }
            
            console.log('Initializing TinyMCE for:', textarea.id);
            
            // Mark as being initialized
            textarea.classList.add('tinymce-initialized');
            
            const config = {
                selector: '#' + textarea.id,
                plugins: 'link image lists table code',
                toolbar: 'undo redo | styles | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image | table | code',
                menubar: 'edit view insert format table',
                statusbar: true,
                resize: true,
                height: 450,
                min_height: 450,
                license_key: 'gpl',
                setup: function(editor) {
                    editor.on('init', function() {
                        console.log('TinyMCE editor initialized:', editor.id);
                        // Force height after initialization
                        setTimeout(function() {
                            const container = editor.getContainer();
                            if (container) {
                                container.style.minHeight = '450px';
                                container.style.height = '450px';
                                const iframe = container.querySelector('.tox-edit-area__iframe');
                                if (iframe) {
                                    iframe.style.minHeight = '400px';
                                    iframe.style.height = '400px';
                                }
                            }
                        }, 100);
                    });
                }
            };
            
            // Initialize TinyMCE
            try {
                tinymce.init(config).then(function(editors) {
                    if (editors && editors.length > 0) {
                        console.log('TinyMCE initialized successfully for:', textarea.id);
                    }
                }).catch(function(error) {
                    console.error('Failed to initialize TinyMCE for:', textarea.id, error);
                    // Remove the initialization flag so it can be retried
                    textarea.classList.remove('tinymce-initialized');
                });
            } catch (error) {
                console.error('Error calling tinymce.init for:', textarea.id, error);
                textarea.classList.remove('tinymce-initialized');
            }
        });
        
        tinymceInitialized = true;
    }
    
    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, waiting for TinyMCE');
        waitForTinyMCE(initializeTinyMCEEditors);
    });
    
    // Global function to force TinyMCE visibility for text content
    window.ensureTinyMCEVisible = function() {
        console.log('Ensuring TinyMCE is visible for text content...');
        const textContentField = document.getElementById('text-content');
        if (textContentField && textContentField.classList.contains('active')) {
            const textArea = textContentField.querySelector('textarea');
            if (textArea && typeof tinymce !== 'undefined') {
                const editorId = textArea.id || 'id_text_content';
                const editor = tinymce.get(editorId);
                if (editor) {
                    console.log('TinyMCE editor found, making visible:', editorId);
                    
                    // Force height settings
                    const container = editor.getContainer();
                    if (container) {
                        container.style.minHeight = '450px';
                        container.style.height = '450px';
                        container.style.display = 'block';
                        container.style.visibility = 'visible';
                        container.style.opacity = '1';
                        
                        const iframe = container.querySelector('.tox-edit-area__iframe');
                        if (iframe) {
                            iframe.style.minHeight = '400px';
                            iframe.style.height = '400px';
                        }
                    }
                    console.log('TinyMCE container made visible');
                } else {
                    console.log('TinyMCE editor not found for:', editorId);
                }
            }
        }
    };
    
    // Expose function globally for reinitializing if needed
    window.reinitializeTinyMCE = function() {
        console.log('Reinitializing TinyMCE...');
        tinymceInitialized = false;
        
        // Remove initialization flags
        document.querySelectorAll('textarea.tinymce-initialized').forEach(function(textarea) {
            textarea.classList.remove('tinymce-initialized');
        });
        
        // Reinitialize
        waitForTinyMCE(initializeTinyMCEEditors);
    };
    
})();
</script>

<!-- Load course edit JS for form change detection - only if not already loaded -->
<script>
if (typeof formHasUnsavedChanges === 'undefined') {
    document.write('<script src="{% static "js/courses/course_edit.js" %}"><\/script>');
} else {
    console.log('Course edit JS already loaded, skipping duplicate load');
}
</script>

<!-- Fix form submission to include TinyMCE content -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const topicForm = document.getElementById('topicForm');
        if (topicForm) {
            topicForm.addEventListener('submit', function(e) {
                // Make sure all TinyMCE content is saved to the form fields
                if (typeof tinymce !== 'undefined' && tinymce.editors) {
                    // Save all active TinyMCE editors
                    tinymce.editors.forEach(function(editor) {
                        try {
                            editor.save();
                            console.log('Saved content for editor:', editor.id);
                        } catch (error) {
                            console.warn('Error saving editor content:', editor.id, error);
                        }
                    });
                }
            });
        }
    });
</script>

<!-- Clean textarea content at page load -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Clean any unwanted characters from the textarea directly
        const textContentArea = document.getElementById('id_text_content');
        if (textContentArea) {
            const content = textContentArea.value;
            if (content === '{' || content === '{' || content.trim() === '{' || 
                content === '}' || content.trim() === '}' || 
                content === '{}' || content.trim() === '{}') {
                console.log('Removing unwanted braces from textarea content');
                textContentArea.value = '';
            }
        }
    });
</script>

<!-- Handle content type changes -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get all content type radio buttons
        const contentTypeRadios = document.querySelectorAll('input[name="content_type"]');
        
        // Function to show/hide content type fields
        function showContentTypeField(contentType) {
            // Define content types that should hide the Instructions field
            const hideInstructionsTypes = ['video', 'document', 'text', 'audio', 'web', 'embedvideo', 'quiz', 'assignment', 'conference', 'discussion'];
            
            console.log('showContentTypeField called with:', contentType);
            console.log('contentType type:', typeof contentType);
            console.log('contentType.toLowerCase():', contentType.toLowerCase());
            console.log('hideInstructionsTypes contains:', hideInstructionsTypes);
            
            // Handle Instructions field visibility - multiple selector attempts
            let instructionsDiv = null;
            
            // Try multiple ways to find the instructions field
            const instructionsField = document.querySelector('label[for*="instructions"]') || 
                                     document.querySelector('label[for="id_instructions"]');
            
            if (instructionsField) {
                instructionsDiv = instructionsField.parentElement;
                console.log('Found instructions field via label, parent div:', instructionsDiv);
            } else {
                // Fallback: look for the textarea directly
                const instructionsTextarea = document.querySelector('textarea[name="instructions"]') ||
                                            document.querySelector('#id_instructions');
                if (instructionsTextarea) {
                    instructionsDiv = instructionsTextarea.closest('div');
                    console.log('Found instructions field via textarea, closest div:', instructionsDiv);
                }
            }
            
            const shouldHide = hideInstructionsTypes.includes(contentType.toLowerCase());
            console.log('Should hide instructions for', contentType + ':', shouldHide);
            
            if (shouldHide) {
                console.log(' Using force hide for content type:', contentType);
                forceHideInstructionsField();
            } else {
                console.log(' Using force show for content type:', contentType);
                forceShowInstructionsField();
            }
            
            // Hide all content type fields
            document.querySelectorAll('.content-type-field').forEach(function(field) {
                field.style.display = 'none';
                field.style.visibility = 'hidden';
                field.style.opacity = '0';
                field.classList.remove('active');
            });
            
            // Show the selected content type field
            const fieldId = contentType.toLowerCase() + '-content';
            console.log('Looking for field with ID:', fieldId);
            const selectedField = document.getElementById(fieldId);
            if (selectedField) {
                console.log('Found field:', selectedField);
                selectedField.style.display = 'block';
                selectedField.style.visibility = 'visible';
                selectedField.style.opacity = '1';
                selectedField.classList.add('active');
                
                // If Text content type is selected, make sure TinyMCE editor is ready
                if (contentType.toLowerCase() === 'text') {
                    console.log('Text content selected, ensuring TinyMCE is ready');
                    setTimeout(function() {
                        // Force reinitialize TinyMCE for text content when field becomes visible
                        const textArea = selectedField.querySelector('textarea');
                        if (textArea && typeof tinymce !== 'undefined') {
                            const editorId = textArea.id || 'id_text_content';
                            console.log('Looking for TinyMCE editor with ID:', editorId);
                            
                            if (tinymce.get(editorId)) {
                                console.log('TinyMCE already initialized for:', editorId);
                                // Make sure the editor container is visible
                                const editorContainer = tinymce.get(editorId).getContainer();
                                if (editorContainer) {
                                    editorContainer.style.display = 'block';
                                    editorContainer.style.visibility = 'visible';
                                    editorContainer.style.opacity = '1';
                                    console.log('TinyMCE container made visible');
                                }
                            } else {
                                console.log('TinyMCE not found for:', editorId, 'Initializing...');
                                // Initialize TinyMCE if not already done
                                if (typeof window.TinyMCEWidget !== 'undefined' && window.TinyMCEWidget.initialize) {
                                    console.log('Using TinyMCEWidget to initialize');
                                    window.TinyMCEWidget.initialize(textArea);
                                } else {
                                    console.log('TinyMCEWidget not available, trying direct initialization');
                                    // Direct TinyMCE initialization
                                    tinymce.init({
                                        selector: '#' + editorId,
                                        height: 400,
                                        menubar: true,
                                        statusbar: false,
                                        plugins: [
                                            'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
                                            'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
                                            'insertdatetime', 'media', 'table', 'wordcount'
                                        ],
                                        toolbar: 'undo redo | blocks | bold italic forecolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat',
                                        content_style: 'body { font-family:Helvetica,Arial,sans-serif; font-size:14px }',
                                        branding: false,
                                        promotion: false,
                                        base_url: '/static/tinymce_editor/tinymce/'
                                    }).then(function(editors) {
                                        console.log('TinyMCE initialized successfully for:', editorId);
                                        if (editors && editors.length > 0) {
                                            console.log('Editor instance created:', editors[0].id);
                                        }
                                    }).catch(function(error) {
                                        console.error('Failed to initialize TinyMCE for:', editorId, error);
                                    });
                                }
                            }
                        } else {
                            console.log('Textarea not found or TinyMCE not available');
                        }
                        
                        // Additional attempt to ensure visibility
                        setTimeout(function() {
                            if (typeof window.ensureTinyMCEVisible === 'function') {
                                window.ensureTinyMCEVisible();
                            }
                        }, 500);
                    }, 200); // Increased timeout to ensure DOM is ready
                }
            } else {
                console.log('Field not found with ID:', fieldId);
                console.log('Available fields:');
                document.querySelectorAll('.content-type-field').forEach(field => console.log('ID:', field.id));
            }
        }
        
        // Function to handle instructions field visibility on page load
        function handleInitialInstructionsVisibility() {
            console.log('Handling initial instructions visibility...');
            const checkedRadio = document.querySelector('input[name="content_type"]:checked');
            if (checkedRadio) {
                console.log('Found checked radio with value:', checkedRadio.value);
                showContentTypeField(checkedRadio.value);
            } else {
                console.log('No content type radio is checked');
            }
        }
        
        // Add change event listener to all content type radios
        contentTypeRadios.forEach(function(radio) {
            radio.addEventListener('change', function() {
                console.log('Radio button changed to:', this.value);
                console.log('Radio button checked:', this.checked);
                if (this.checked) {
                    showContentTypeField(this.value);
                }
            });
        });
        
        // Show initial content type field
        const checkedRadio = document.querySelector('input[name="content_type"]:checked');
        if (checkedRadio) {
            showContentTypeField(checkedRadio.value);
        }
        
        // Enhanced function to force hide instructions field (including TinyMCE)
        function forceHideInstructionsField() {
            console.log(' Force hiding instructions field...');
            
            // Method 1: Hide by label
            const instructionsLabel = document.querySelector('label[for="topic_instructions"]') || 
                                     document.querySelector('label[for*="instructions"]');
            
            if (instructionsLabel) {
                const instructionsContainer = instructionsLabel.closest('div');
                if (instructionsContainer) {
                    instructionsContainer.style.cssText = 'display: none !important; visibility: hidden !important; opacity: 0 !important; height: 0 !important; overflow: hidden !important;';
                    instructionsContainer.setAttribute('hidden', 'hidden');
                    console.log(' Instructions container hidden via label');
                }
            }
            
            // Method 2: Hide ONLY instructions TinyMCE editor, NOT text content editor
            const instructionsTinyMCE = document.querySelector('#topic_instructions_parent .tox-tinymce') ||
                                      document.querySelector('[data-for="topic_instructions"] .tox-tinymce');
            if (instructionsTinyMCE) {
                const parentDiv = instructionsTinyMCE.closest('div');
                if (parentDiv) {
                    parentDiv.style.cssText = 'display: none !important; visibility: hidden !important; opacity: 0 !important; height: 0 !important; overflow: hidden !important;';
                    parentDiv.setAttribute('hidden', 'hidden');
                    console.log(' Instructions TinyMCE container hidden');
                }
            }
            
            // Method 3: Hide by textarea ID
            const instructionsTextarea = document.querySelector('#topic_instructions');
            if (instructionsTextarea) {
                const textareaContainer = instructionsTextarea.closest('div');
                if (textareaContainer) {
                    textareaContainer.style.cssText = 'display: none !important; visibility: hidden !important; opacity: 0 !important; height: 0 !important; overflow: hidden !important;';
                    textareaContainer.setAttribute('hidden', 'hidden');
                    console.log(' Instructions textarea container hidden');
                }
            }
            
            // Method 4: Hide any element containing "Instructions" text
            const allDivs = document.querySelectorAll('div');
            allDivs.forEach(div => {
                const label = div.querySelector('label');
                if (label && label.textContent && label.textContent.includes('Instructions')) {
                    div.style.cssText = 'display: none !important; visibility: hidden !important; opacity: 0 !important; height: 0 !important; overflow: hidden !important;';
                    div.setAttribute('hidden', 'hidden');
                    console.log(' Instructions div hidden by text content');
                }
            });
        }
        
        // Enhanced function to show instructions field
        function forceShowInstructionsField() {
            console.log(' Force showing instructions field...');
            
            // Method 1: Show by label
            const instructionsLabel = document.querySelector('label[for="topic_instructions"]') || 
                                     document.querySelector('label[for*="instructions"]');
            
            if (instructionsLabel) {
                const instructionsContainer = instructionsLabel.closest('div');
                if (instructionsContainer) {
                    instructionsContainer.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; height: auto !important; overflow: visible !important;';
                    instructionsContainer.removeAttribute('hidden');
                    console.log(' Instructions container shown via label');
                }
            }
            
            // Method 2: Show ONLY instructions TinyMCE editor
            const instructionsTinyMCE = document.querySelector('#topic_instructions_parent .tox-tinymce') ||
                                      document.querySelector('[data-for="topic_instructions"] .tox-tinymce');
            if (instructionsTinyMCE) {
                const parentDiv = instructionsTinyMCE.closest('div');
                if (parentDiv) {
                    parentDiv.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; height: auto !important; overflow: visible !important;';
                    parentDiv.removeAttribute('hidden');
                    console.log(' Instructions TinyMCE container shown');
                }
            }
            
            // Method 3: Show by textarea ID
            const instructionsTextarea = document.querySelector('#topic_instructions');
            if (instructionsTextarea) {
                const textareaContainer = instructionsTextarea.closest('div');
                if (textareaContainer) {
                    textareaContainer.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; height: auto !important; overflow: visible !important;';
                    textareaContainer.removeAttribute('hidden');
                    console.log(' Instructions textarea container shown');
                }
            }
        }
        
        // Also run after a short delay to ensure DOM is fully ready
        setTimeout(function() {
            console.log('Running delayed instructions visibility check...');
            handleInitialInstructionsVisibility();
        }, 500);
        
        // Additional aggressive check after TinyMCE loads
        setTimeout(function() {
            console.log(' Running post-TinyMCE instructions visibility check...');
            const checkedRadio = document.querySelector('input[name="content_type"]:checked');
            if (checkedRadio) {
                const contentType = checkedRadio.value.toLowerCase();
                const hideInstructionsTypes = ['video', 'document', 'text', 'audio', 'web', 'embedvideo', 'quiz', 'assignment', 'conference', 'discussion'];
                
                if (hideInstructionsTypes.includes(contentType)) {
                    console.log(' Force hiding instructions for:', contentType);
                    forceHideInstructionsField();
                } else {
                    console.log(' Force showing instructions for:', contentType);
                    forceShowInstructionsField();
                }
            }
        }, 2000);
        
        // File upload functionality removed - no longer supported
        function setupFileInputHandlers() {
            const fileInputs = document.querySelectorAll('.file-input');
            
            fileInputs.forEach(function(input) {
                // Handle file selection
                input.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    const container = e.target.closest('.content-type-field') || e.target.closest('.file-upload-container');
                    
                    if (!container) return;
                    
                    const selectedFilenameElement = container.querySelector('.selected-filename');
                    const filePreviewElement = container.querySelector('.file-preview');
                    const uploadArea = container.querySelector('.border-dashed');
                    
                    if (file) {
                        // Update upload area styling to show success
                        if (uploadArea) {
                            uploadArea.classList.remove('border-gray-300', 'hover:border-gray-400');
                            uploadArea.classList.add('border-green-400', 'bg-green-50');
                        }
                        
                        // Show selected filename with enhanced styling
                        if (selectedFilenameElement) {
                            selectedFilenameElement.innerHTML = `
                                <div class="flex items-center text-sm text-green-600 bg-green-50 p-2 rounded border border-green-200">
                                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span><strong>Selected:</strong> ${file.name}</span>
                                </div>
                            `;
                            selectedFilenameElement.classList.remove('hidden');
                            selectedFilenameElement.style.display = 'block';
                        }
                        
                        // Show file preview section with enhanced info
                        if (filePreviewElement) {
                            const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
                            const fileType = file.type || 'Unknown';
                            
                            filePreviewElement.innerHTML = `
                                <div class="mt-3 p-3 bg-gray-50 rounded border text-sm text-gray-700">
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <span class="font-medium text-gray-900">File:</span>
                                            <span class="ml-1">${file.name}</span>
                                        </div>
                                        <div>
                                            <span class="font-medium text-gray-900">Size:</span>
                                            <span class="ml-1">${fileSizeMB} MB</span>
                                        </div>
                                        <div>
                                            <span class="font-medium text-gray-900">Type:</span>
                                            <span class="ml-1">${fileType}</span>
                                        </div>
                                        <div>
                                            <span class="font-medium text-gray-900">Status:</span>
                                            <span class="ml-1 text-green-600">Ready to upload</span>
                                        </div>
                                    </div>
                                </div>
                            `;
                            filePreviewElement.classList.remove('hidden');
                            filePreviewElement.style.display = 'block';
                        }
                        
                        console.log(`File selected: ${file.name} (${file.type}, ${file.size} bytes)`);
                    } else {
                        // No file selected - reset to default state
                        if (uploadArea) {
                            uploadArea.classList.remove('border-green-400', 'bg-green-50');
                            uploadArea.classList.add('border-gray-300', 'hover:border-gray-400');
                        }
                        
                        if (selectedFilenameElement) {
                            selectedFilenameElement.innerHTML = '';
                            selectedFilenameElement.classList.add('hidden');
                            selectedFilenameElement.style.display = 'none';
                        }
                        
                        if (filePreviewElement) {
                            filePreviewElement.innerHTML = '';
                            filePreviewElement.classList.add('hidden');
                            filePreviewElement.style.display = 'none';
                        }
                    }
                });
                
                // Handle drag and drop events for enhanced UX
                const uploadArea = input.closest('.file-upload-container')?.querySelector('.border-dashed');
                if (uploadArea) {
                    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                        uploadArea.addEventListener(eventName, preventDefaults, false);
                    });
                    
                    function preventDefaults(e) {
                        e.preventDefault();
                        e.stopPropagation();
                    }
                    
                    ['dragenter', 'dragover'].forEach(eventName => {
                        uploadArea.addEventListener(eventName, highlight, false);
                    });
                    
                    ['dragleave', 'drop'].forEach(eventName => {
                        uploadArea.addEventListener(eventName, unhighlight, false);
                    });
                    
                    function highlight(e) {
                        uploadArea.classList.add('border-indigo-400', 'bg-indigo-50');
                    }
                    
                    function unhighlight(e) {
                        uploadArea.classList.remove('border-indigo-400', 'bg-indigo-50');
                    }
                    
                    uploadArea.addEventListener('drop', handleDrop, false);
                    
                    function handleDrop(e) {
                        const dt = e.dataTransfer;
                        const files = dt.files;
                        
                        if (files.length > 0) {
                            input.files = files;
                            // Trigger change event
                            const event = new Event('change', { bubbles: true });
                            input.dispatchEvent(event);
                        }
                    }
                }
            });
        }
        
        // Initialize file input handlers
        setupFileInputHandlers();
        
        // Also reinitialize when content type changes (in case new file inputs are shown)
        contentTypeRadios.forEach(function(radio) {
            radio.addEventListener('change', function() {
                setTimeout(setupFileInputHandlers, 100);
            });
        });
        
    });
</script>

<!-- Load the main topic form JS file -->
<script src="{% static 'core/js/courses/topic_form.js' %}"></script>

<!-- Mobile Tabs Accordion JavaScript -->
<script src="{% static 'core/js/mobile-tabs-accordion.js' %}"></script>

<!-- Content auto-population script -->

{% endblock %} 
