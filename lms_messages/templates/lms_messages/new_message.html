{% extends 'base.html' %}
{% load course_filters %}
{% load static %}

{% block title %}New Message - Nexsy{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<!-- Quill CSS removed - using TinyMCE -->
<style>
    /* Global styles */
    body {
        background-color: #ffffff !important;
    }
    
    .main-content {
        background-color: #ffffff !important;
    }

    /* Message form styles */
    .message-form {
        background-color: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: #374151;
        margin-bottom: 0.5rem;
    }

    .form-input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.375rem;
        background-color: #f9fafb;
        font-size: 0.875rem;
        color: #1f2937;
    }

    .form-input::placeholder {
        color: #9ca3af;
        font-style: italic;
    }

    .form-input:focus {
        outline: none;
        ring: 2px;
        ring-color: #2563eb;
        border-color: #2563eb;
    }

    /* TinyMCE Editor styles */
    .tox-tinymce {
        border-radius: 0.375rem;
        border: 1px solid #e5e7eb;
    }
    
    .tox .tox-toolbar {
        background-color: #f9fafb;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .tox .tox-editor-container {
        min-height: 200px;
    }

    /* Action buttons */
    .action-buttons {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
    }

    .btn-cancel {
        padding: 0.5rem 1rem;
        background-color: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.375rem;
        color: #374151;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .btn-send {
        padding: 0.5rem 1rem;
        background-color: #2563eb;
        border: none;
        border-radius: 0.375rem;
        color: white;
        font-size: 0.875rem;
        font-weight: 500;
    }

    /* Enhanced Select2 Custom Styles */
    .select2-container {
        width: 100% !important;
    }

    .select2-container--default .select2-selection--single {
        height: 42px;
        border: 1px solid #e5e7eb;
        border-radius: 0.375rem;
        background-color: #f9fafb;
    }

    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 42px;
        padding-left: 0.75rem;
        color: #1f2937;
    }

    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 40px;
    }

    .select2-dropdown {
        border: 1px solid #e5e7eb;
        border-radius: 0.375rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .select2-container--default .select2-results__group {
        padding: 8px 12px;
        font-weight: 600;
        color: #374151;
        background-color: #f3f4f6;
        border-bottom: 1px solid #e5e7eb;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .select2-container--default .select2-results__option {
        padding: 8px 16px;
        font-size: 0.875rem;
    }

    .select2-container--default .select2-results__option--highlighted[aria-selected] {
        background-color: #2563eb;
        color: white;
    }

    .select2-container--default .select2-results__option[aria-selected=true] {
        background-color: #EBF3FE;
        color: #2563eb;
    }

    .select2-container--default .select2-search--dropdown .select2-search__field {
        border: 1px solid #e5e7eb;
        border-radius: 0.25rem;
        padding: 0.5rem;
        margin: 0.5rem;
    }

    .message-recipient-section {
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e5e7eb;
    }

    .recipient-tabs {
        display: flex;
        border-bottom: 1px solid #e5e7eb;
        margin-bottom: 1rem;
    }

    .recipient-tab {
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: #6b7280;
        cursor: pointer;
        border-bottom: 2px solid transparent;
    }

    .recipient-tab.active {
        color: #2563eb;
        border-bottom-color: #2563eb;
    }

    .recipient-tab:hover:not(.active) {
        color: #4b5563;
        border-bottom-color: #e5e7eb;
    }

    .recipient-content {
        display: none;
    }

    .recipient-content.active {
        display: block;
    }

    .tab-icon {
        margin-right: 0.5rem;
    }

    .role-badge {
        display: inline-block;
        font-size: 0.75rem;
        padding: 0.125rem 0.375rem;
        border-radius: 9999px;
        margin-left: 0.5rem;
    }

    .role-badge.admin {
        background-color: #fee2e2;
        color: #b91c1c;
    }

    .role-badge.instructor {
        background-color: #e0f2fe;
        color: #0369a1;
    }

    .role-badge.learner {
        background-color: #d1fae5;
        color: #047857;
    }

    .recipient-option {
        margin-bottom: 1rem;
    }

    .recipient-option label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        font-size: 0.875rem;
        color: #4b5563;
    }
</style>
{{ form.media.css }}
{% endblock %}

{% block content %}
<div class="container mt-4">
        {% include 'components/breadcrumb.html' with breadcrumbs=breadcrumbs %}

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">New Message</h1>
        <a href="{% url 'lms_messages:messages' %}" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-arrow-left"></i> Back to Messages
        </a>
    </div>

    <!-- Message Form -->
    <form method="post" class="message-form p-4">
                            {% csrf_token %}
                            
        <!-- Reply Context Section -->
        {% if reply_to_message %}
        <div class="alert alert-secondary mb-4">
            <div class="d-flex align-items-center">
                <i class="fas fa-reply me-2"></i>
                <div>
                    <strong>Replying to:</strong> "{{ reply_to_message.subject }}" 
                    <br><small class="text-muted">From: {{ reply_to_message.sender.get_full_name|default:reply_to_message.sender.username }}</small>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Recipients Section -->
        <div class="message-recipient-section">
            <h5 class="mb-3">Select Recipients</h5>
            
            {% if user_role == 'learner' %}
                <!-- For Learners: Show users in their branch -->
                <div class="recipient-tabs">
                    <div class="recipient-tab active" data-tab="individuals">
                        <i class="fas fa-user tab-icon"></i> Individual Users
                    </div>
                </div>
                
                <div class="recipient-content active" id="individuals-content">
                    <div class="recipient-option">
                        <label for="individual-recipients">Select Recipients:</label>
                        <select name="recipients[]" id="individual-recipients" class="form-control" multiple>
                            {% for branch_name, users in branch_users.items %}
                                <optgroup label="{{ branch_name }}">
                                    {% for user in users %}
                                        <option value="{{ user.id }}" 
                                                {% if initial_recipients %}
                                                    {% for recipient in initial_recipients %}
                                                        {% if recipient.id == user.id %}selected{% endif %}
                                                    {% endfor %}
                                                {% endif %}>
                                            {{ user.first_name }} {{ user.last_name }} ({{ user.username }})
                                        </option>
                                    {% endfor %}
                                </optgroup>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">You can message instructors and peers in your branch.</small>
                    </div>
                </div>
                
            {% elif user_role == 'instructor' %}
                <!-- For Instructors: Show learners in their branch and groups (if they have manage_groups capability) -->
                <div class="recipient-tabs">
                    <div class="recipient-tab active" data-tab="individuals">
                        <i class="fas fa-user tab-icon"></i> Individual Users
                    </div>
                    {% if user_groups %}
                    <div class="recipient-tab" data-tab="groups">
                        <i class="fas fa-users tab-icon"></i> Groups
                    </div>
                    {% endif %}
                </div>
                
                <div class="recipient-content active" id="individuals-content">
                    <div class="recipient-option">
                        <label for="individual-recipients">Select Recipients:</label>
                        <select name="recipients[]" id="individual-recipients" class="form-control" multiple>
                            {% for branch_name, users in branch_users.items %}
                                <optgroup label="{{ branch_name }}">
                                    {% for user in users %}
                                        <option value="{{ user.id }}" 
                                                {% if initial_recipients %}
                                                    {% for recipient in initial_recipients %}
                                                        {% if recipient.id == user.id %}selected{% endif %}
                                                    {% endfor %}
                                                {% endif %}>
                                            {{ user.first_name }} {{ user.last_name }} ({{ user.username }})
                                        </option>
                                    {% endfor %}
                                </optgroup>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">You can message learners in your branch.</small>
                    </div>
                </div>
                
                {% if user_groups %}
                <div class="recipient-content" id="groups-content">
                    <div class="recipient-option">
                        <label for="user-group">Send to Group:</label>
                        <select name="user_group" id="user-group" class="form-control">
                            <option value="">Select a group...</option>
                            {% for group in user_groups %}
                                <option value="{{ group.id }}">{{ group.name }}</option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">This will send a message to all users in the selected group.</small>
                    </div>
                </div>
                {% endif %}
                
            {% elif user_role == 'admin' %}
                <!-- For Branch Admins: Show users in their assigned branches -->
                <div class="recipient-tabs">
                    <div class="recipient-tab active" data-tab="individuals">
                        <i class="fas fa-user tab-icon"></i> Individual Users
                    </div>
                    {% if user_groups %}
                    <div class="recipient-tab" data-tab="groups">
                        <i class="fas fa-users tab-icon"></i> Groups
                    </div>
                    {% endif %}
                </div>
                
                <div class="recipient-content active" id="individuals-content">
                    <div class="recipient-option">
                        <label for="individual-recipients">Select Recipients:</label>
                        <select name="recipients[]" id="individual-recipients" class="form-control" multiple>
                            {% for branch_name, users in branch_users.items %}
                                <optgroup label="{{ branch_name }}">
                                    {% for user in users %}
                                        <option value="{{ user.id }}" 
                                                {% if initial_recipients %}
                                                    {% for recipient in initial_recipients %}
                                                        {% if recipient.id == user.id %}selected{% endif %}
                                                    {% endfor %}
                                                {% endif %}>
                                            {{ user.first_name }} {{ user.last_name }} ({{ user.username }})
                                        </option>
                                    {% endfor %}
                                </optgroup>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">You can message users in your assigned branches.</small>
                    </div>
                </div>
                
                {% if user_groups %}
                <div class="recipient-content" id="groups-content">
                    <div class="recipient-option">
                        <label for="user-group">Send to Group:</label>
                        <select name="user_group" id="user-group" class="form-control">
                            <option value="">Select a group...</option>
                            {% for group in user_groups %}
                                <option value="{{ group.id }}">{{ group.name }}</option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">This will send a message to all users in the selected group.</small>
                    </div>
                </div>
                {% endif %}
                
            {% elif user_role == 'superadmin' %}
                <!-- For Super Admins: Show users in their assigned businesses -->
                <div class="recipient-tabs">
                    <div class="recipient-tab active" data-tab="branches">
                        <i class="fas fa-building tab-icon"></i> Branches
                    </div>
                    {% if user_groups %}
                    <div class="recipient-tab" data-tab="groups">
                        <i class="fas fa-users tab-icon"></i> Groups
                    </div>
                    {% endif %}
                    <div class="recipient-tab" data-tab="individuals">
                        <i class="fas fa-user tab-icon"></i> Individual Users
                    </div>
                </div>
                
                <div class="recipient-content active" id="branches-content">
                    <div class="recipient-option">
                        <label for="branch-recipients">Select Branches:</label>
                        <select name="recipients[]" id="branch-recipients" class="form-control" multiple>
                            {% for branch_name, users in branch_users.items %}
                                <option value="branch_{{ branch_name }}">
                                    {{ branch_name }} ({{ users|length }} users)
                                </option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">You can message users in branches within your assigned businesses.</small>
                    </div>
                </div>
                
                {% if user_groups %}
                <div class="recipient-content" id="groups-content">
                    <div class="recipient-option">
                        <label for="user-group">Send to Group:</label>
                        <select name="user_group" id="user-group" class="form-control">
                            <option value="">Select a group...</option>
                            {% for group in user_groups %}
                                <option value="{{ group.id }}">{{ group.name }}</option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">This will send a message to all users in the selected group.</small>
                    </div>
                </div>
                {% endif %}
                
                <div class="recipient-content" id="individuals-content">
                    <div class="recipient-option">
                        <label for="individual-recipients">Select Recipients:</label>
                        <select name="recipients[]" id="individual-recipients" class="form-control" multiple>
                            {% for branch_name, users in branch_users.items %}
                                <optgroup label="{{ branch_name }}">
                                    {% for user in users %}
                                        <option value="{{ user.id }}" 
                                                {% if initial_recipients %}
                                                    {% for recipient in initial_recipients %}
                                                        {% if recipient.id == user.id %}selected{% endif %}
                                                    {% endfor %}
                                                {% endif %}>
                                            {{ user.first_name }} {{ user.last_name }} ({{ user.username }})
                                        </option>
                                    {% endfor %}
                                </optgroup>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">You can message users in branches within your assigned businesses.</small>
                    </div>
                </div>
                
            {% else %}
                <!-- For Global Admins: Show all branches, groups, and individuals -->
                <div class="recipient-tabs">
                    <div class="recipient-tab active" data-tab="branches">
                        <i class="fas fa-building tab-icon"></i> Branches
                    </div>
                    <div class="recipient-tab" data-tab="groups">
                        <i class="fas fa-users tab-icon"></i> Groups
                    </div>
                    <div class="recipient-tab" data-tab="individuals">
                        <i class="fas fa-user tab-icon"></i> Individual Users
                    </div>
                </div>
                
                <div class="recipient-content active" id="branches-content">
                    <div class="recipient-option">
                        <label for="branch-recipients">Select Branches:</label>
                        <select name="recipients[]" id="branch-recipients" class="form-control" multiple>
                            {% for branch_name, users in branch_users.items %}
                                <option value="branch_{{ branch_name }}">
                                    {{ branch_name }} ({{ users|length }} users)
                                </option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">You can message users in any branch (Global Admin access).</small>
                    </div>
                </div>
                
                <div class="recipient-content" id="groups-content">
                    <div class="recipient-option">
                        <label for="user-group">Send to Group:</label>
                        <select name="user_group" id="user-group" class="form-control">
                            <option value="">Select a group...</option>
                            {% for group in user_groups %}
                                <option value="{{ group.id }}">{{ group.name }}</option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">This will send a message to all users in the selected group.</small>
                    </div>
                </div>
                
                <div class="recipient-content" id="individuals-content">
                    <div class="recipient-option">
                        <label for="individual-recipients">Select Recipients:</label>
                        <select name="recipients[]" id="individual-recipients" class="form-control" multiple>
                            {% for branch_name, users in branch_users.items %}
                                <optgroup label="{{ branch_name }}">
                                    {% for user in users %}
                                        <option value="{{ user.id }}" 
                                                {% if initial_recipients %}
                                                    {% for recipient in initial_recipients %}
                                                        {% if recipient.id == user.id %}selected{% endif %}
                                                    {% endfor %}
                                                {% endif %}>
                                            {{ user.first_name }} {{ user.last_name }} ({{ user.username }})
                                        </option>
                                    {% endfor %}
                                </optgroup>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">You can message any user in the system (Global Admin access).</small>
                    </div>
                </div>
            {% endif %}
                            </div>

                            <!-- Subject Field -->
                            <div class="form-group">
            <label for="subject" class="form-label">Subject</label>
            <input type="text" id="subject" name="subject" class="form-input" placeholder="Message subject" 
                   value="{{ initial_subject|default:'' }}" required>
                            </div>

        <!-- Message Content Field -->
        <div class="form-group">
            <label for="{{ form.content.id_for_label }}" class="form-label">{{ form.content.label }}</label>
            {{ form.content }}
            {% if form.content.errors %}
                <div class="text-danger mt-1">
                    {% for error in form.content.errors %}
                        <small>{{ error }}</small>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <!-- Action Buttons -->
                            <div class="action-buttons">
                                <a href="{% url 'lms_messages:messages' %}" class="btn-cancel">Cancel</a>
            <button type="submit" class="btn-send">Send Message</button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<!-- TinyMCE editor loaded via form media -->
{{ form.media.js }}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Select2 on recipient dropdowns
    $('#individual-recipients, #user-group, #branch-recipients').select2({
        placeholder: 'Select recipients...',
        allowClear: true
    });

    // Handle reply scenario - show pre-selected recipients
    {% if reply_to_message and initial_recipients %}
    // Trigger Select2 to update with pre-selected values
    $('#individual-recipients').trigger('change');
    
    // Show notification about auto-selected recipients
    var selectedCount = $('#individual-recipients option:selected').length;
    if (selectedCount > 0) {
        var replyNotice = $('<div class="alert alert-info alert-dismissible fade show mt-2" role="alert">' +
            '<i class="fas fa-info-circle"></i> Auto-selected ' + selectedCount + ' recipient(s) from original message. ' +
            '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
            '</div>');
        $('#individual-recipients').parent().after(replyNotice);
    }
    {% endif %}

    // Tab functionality for recipient selection
    const recipientTabs = document.querySelectorAll('.recipient-tab');
    const recipientContents = document.querySelectorAll('.recipient-content');

    recipientTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const targetTab = this.getAttribute('data-tab');
            
            // Remove active class from all tabs
            recipientTabs.forEach(t => t.classList.remove('active'));
            
            // Add active class to clicked tab
            this.classList.add('active');
            
            // Hide all content sections
            recipientContents.forEach(content => {
                content.classList.remove('active');
            });
            
            // Show target content section
            const targetContent = document.getElementById(targetTab + '-content');
            if (targetContent) {
                targetContent.classList.add('active');
            }
        });
    });

    // Form submission handling
    document.querySelector('form').addEventListener('submit', function(e) {
        // Check if recipients are selected
        const checkboxes = document.querySelectorAll('input[name="recipients[]"]:checked');
        const selectedRecipients = document.querySelectorAll('select[name="recipients[]"] option:selected');
        const selectedGroup = document.querySelector('select[name="user_group"]')?.value;
        
        if (checkboxes.length === 0 && selectedRecipients.length === 0 && !selectedGroup) {
            e.preventDefault();
            alert('Please select at least one recipient.');
            return false;
        }
        
        // TinyMCE validation will be handled automatically by the form field
        // No need for manual content validation as TinyMCE handles it
    });
});
</script>
{% endblock %} 